<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="never"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Feign源码学习 | calebzhao的博客</title><meta name="description" content="Feign源码学习"><meta name="keywords" content="spring cloud,feign"><meta name="author" content="calebzhao"><meta name="copyright" content="calebzhao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229155709.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Feign源码学习"><meta name="twitter:description" content="Feign源码学习"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Feign源码学习"><meta property="og:url" content="https://calebzhao.github.io/2019/12/29/Feign%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"><meta property="og:site_name" content="calebzhao的博客"><meta property="og:description" content="Feign源码学习"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://calebzhao.github.io/2019/12/29/Feign%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"><link rel="prev" title="feign使用教程" href="https://calebzhao.github.io/2019/12/29/feign%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"><link rel="next" title="java并发编程入门" href="https://calebzhao.github.io/2019/12/29/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"EU39VTKAPM","apiKey":"9108b7c9e302dddcc64205e00d26f470","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://calebzhao.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">calebzhao的博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#feign介绍"><span class="toc_mobile_items-text">feign介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Feign-build构建接口动态代理"><span class="toc_mobile_items-text">Feign.build构建接口动态代理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Target"><span class="toc_mobile_items-text">Target</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#创建MethodHandler方法处理器"><span class="toc_mobile_items-text">创建MethodHandler方法处理器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Contract解析接口方法生成MethodMetadata"><span class="toc_mobile_items-text">Contract解析接口方法生成MethodMetadata</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#初始化总结"><span class="toc_mobile_items-text">初始化总结</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#接口调用"><span class="toc_mobile_items-text">接口调用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#RquestTemplate构建过程"><span class="toc_mobile_items-text">RquestTemplate构建过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#RequestTemplate解析参数的方法："><span class="toc_mobile_items-text">RequestTemplate解析参数的方法：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#RquestTemplate转换Request"><span class="toc_mobile_items-text">RquestTemplate转换Request</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#http请求发送"><span class="toc_mobile_items-text">http请求发送</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#接口调用过程总结"><span class="toc_mobile_items-text">接口调用过程总结</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#feign扩展点总结"><span class="toc_mobile_items-text">feign扩展点总结</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#feign介绍"><span class="toc-text">feign介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Feign-build构建接口动态代理"><span class="toc-text">Feign.build构建接口动态代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Target"><span class="toc-text">Target</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#创建MethodHandler方法处理器"><span class="toc-text">创建MethodHandler方法处理器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Contract解析接口方法生成MethodMetadata"><span class="toc-text">Contract解析接口方法生成MethodMetadata</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#初始化总结"><span class="toc-text">初始化总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#接口调用"><span class="toc-text">接口调用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RquestTemplate构建过程"><span class="toc-text">RquestTemplate构建过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RequestTemplate解析参数的方法："><span class="toc-text">RequestTemplate解析参数的方法：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RquestTemplate转换Request"><span class="toc-text">RquestTemplate转换Request</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#http请求发送"><span class="toc-text">http请求发送</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#接口调用过程总结"><span class="toc-text">接口调用过程总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#feign扩展点总结"><span class="toc-text">feign扩展点总结</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Feign源码学习</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-12-29<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-01-10</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/spring-cloud/">spring cloud</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">7.9k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 32 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/12/29/Feign%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/12/29/Feign%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="feign介绍"><a href="#feign介绍" class="headerlink" title="feign介绍"></a>feign介绍</h1><p><a href="https://github.com/OpenFeign/feign" target="_blank" rel="noopener" title="`Feign">Feign</a>是一款java的Restful客户端组件，Feign使得 Java HTTP 客户端编写更方便。Feign 灵感来源于Retrofit, JAXRS-2.0和WebSocket。feign在github上有近5K个star，是一款相当优秀的开源组件，虽然相比Retrofit的近30K个star，逊色了太多，但是spring cloud集成了feign，使得feign在java生态中比Retrofit使用的更加广泛。</p>
<p>feign的基本原理是在接口方法上加注解，定义rest请求，构造出接口的动态代理对象，然后通过调用接口方法就可以发送http请求，并且自动解析http响应为方法返回值，极大的简化了客户端调用rest api的代码。官网的示例如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> interface GitHub {</span><br><span class="line">  @RequestLine("GET /repos/{owner}/{repo}/contributors")</span><br><span class="line">  List<contributor> contributors(@Param("owner") String owner, @Param("repo") String repo);</contributor></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">static class Contributor {</span><br><span class="line">  String login;</span><br><span class="line">  int contributions;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public static void main(String... args) {</span><br><span class="line">  GitHub github = Feign.builder()</span><br><span class="line">                       .decoder(new GsonDecoder())</span><br><span class="line">                       .target(GitHub.class, "https://api.github.com");</span><br><span class="line"></span><br><span class="line">  // Fetch and print a list of the contributors to this library.</span><br><span class="line">  List<contributor> contributors = github.contributors("OpenFeign", "feign");</contributor></span><br><span class="line">  for (Contributor contributor : contributors) {</span><br><span class="line">    System.out.println(contributor.login + " (" + contributor.contributions + ")");</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>feign使用教程请参考官网<a href="https://github.com/OpenFeign/feign/" target="_blank" rel="noopener">https://github.com/OpenFeign/feign/</a></p>
<p>本文主要是对feign源码进行分析，根据源码来理解feign的设计架构和内部实现技术。</p>
<h1 id="Feign-build构建接口动态代理"><a href="#Feign-build构建接口动态代理" class="headerlink" title="Feign.build构建接口动态代理"></a>Feign.build构建接口动态代理</h1><p>我们先来看看接口的动态代理是如何构建出来的，下图是主要接口和类的类图：<br><a href="https://oscimg.oschina.net/oscnet/up-0fe8e9d3c45abafd2164a3478432c5cb3f0.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-0fe8e9d3c45abafd2164a3478432c5cb3f0.png" class="lazyload"></a></p>
<p>从上文中的示例可以看到，构建的接口动态代理对象是通过Feign.builder()生成Feign.Builder的构造者对象，然后设置相关的参数，再调用target方法构造的。Feign.Builder的参数包括：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//拦截器，组装完RequestTemplate，发请求之前的拦截处理RequestTemplate</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List<requestinterceptor> requestInterceptors = <span class="keyword">new</span> ArrayList<requestinterceptor>();</requestinterceptor></requestinterceptor></span><br><span class="line"></span><br><span class="line"><span class="comment">//日志级别</span></span><br><span class="line"><span class="keyword">private</span> Logger.Level logLevel = Logger.Level.NONE;</span><br><span class="line"></span><br><span class="line"><span class="comment">//契约模型，默认为Contract.Default，用户创建MethodMetadata，用spring cloud就是扩展这个实现springMVC注解</span></span><br><span class="line"><span class="keyword">private</span> Contract contract = <span class="keyword">new</span> Contract.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端，默认为Client.Default，可以扩展ApacheHttpClient，OKHttpClient，RibbonClient等</span></span><br><span class="line"><span class="keyword">private</span> Client client = <span class="keyword">new</span> Client.Default(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//重试设置，默认不设置</span></span><br><span class="line"><span class="keyword">private</span> Retryer retryer = <span class="keyword">new</span> Retryer.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//日志，可以接入Slf4j</span></span><br><span class="line"><span class="keyword">private</span> Logger logger = <span class="keyword">new</span> NoOpLogger();</span><br><span class="line"></span><br><span class="line"><span class="comment">//编码器，用于body的编码</span></span><br><span class="line"><span class="keyword">private</span> Encoder encoder = <span class="keyword">new</span> Encoder.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//解码器，用户response的解码</span></span><br><span class="line"><span class="keyword">private</span> Decoder decoder = <span class="keyword">new</span> Decoder.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//用@QueryMap注解的参数编码器</span></span><br><span class="line"><span class="keyword">private</span> QueryMapEncoder queryMapEncoder = <span class="keyword">new</span> QueryMapEncoder.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//请求错误解码器</span></span><br><span class="line"><span class="keyword">private</span> ErrorDecoder errorDecoder = <span class="keyword">new</span> ErrorDecoder.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数配置，主要是超时时间之类的</span></span><br><span class="line"><span class="keyword">private</span> Options options = <span class="keyword">new</span> Options();</span><br><span class="line"></span><br><span class="line"><span class="comment">//动态代理工厂</span></span><br><span class="line"><span class="keyword">private</span> InvocationHandlerFactory invocationHandlerFactory = <span class="keyword">new</span> InvocationHandlerFactory.Default();</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否decode404</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> decode404;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> closeAfterDecode = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常隔离策略</span></span><br><span class="line"><span class="keyword">private</span> ExceptionPropagationPolicy propagationPolicy = NONE;</span><br></pre></td></tr></tbody></table></figure></div>

<p>这块是一个典型的构造者模式，<code>target</code>方法内部先调用<code>build</code>方法新建一个<code>ReflectFeign</code>对象，然后调用<code>ReflectFeign</code>的<code>newInstance</code>方法创建动态代理，代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认使用HardCodedTarget</span></span><br><span class="line"><span class="keyword">public</span> <t> <span class="function">T <span class="title">target</span><span class="params">(Class<t> apiType, String url)</t></span> </span>{</t></span><br><span class="line">	<span class="keyword">return</span> target(<span class="keyword">new</span> HardCodedTarget<t>(apiType, url));</t></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <t> <span class="function">T <span class="title">target</span><span class="params">(Target<t> target)</t></span> </span>{</t></span><br><span class="line">	<span class="keyword">return</span> build().newInstance(target);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Feign <span class="title">build</span><span class="params">()</span> </span>{</span><br><span class="line">	SynchronousMethodHandler.Factory synchronousMethodHandlerFactory = <span class="keyword">new</span> SynchronousMethodHandler.Factory(</span><br><span class="line">								client, </span><br><span class="line">								retryer,</span><br><span class="line">								requestInterceptors, </span><br><span class="line">								logger,</span><br><span class="line">								logLevel, </span><br><span class="line">								decode404, </span><br><span class="line">								closeAfterDecode);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 该类中持有的contract非常重要（对接口及接口的方法上的注解解析）</span></span><br><span class="line">	ParseHandlersByName handlersByName = <span class="keyword">new</span> ParseHandlersByName(contract, </span><br><span class="line">								options, </span><br><span class="line">								encoder, </span><br><span class="line">								decoder, </span><br><span class="line">								queryMapEncoder,</span><br><span class="line">								errorDecoder, </span><br><span class="line">								synchronousMethodHandlerFactory);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// handlersByName将所有参数进行封装，并提供解析接口方法的逻辑</span></span><br><span class="line">	<span class="comment">// invocationHandlerFactory是Builder的属性，默认值是InvocationHandlerFactory.Default</span></span><br><span class="line">	<span class="comment">// 用创建java动态代理的InvocationHandler实现</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ReflectiveFeign(handlersByName, invocationHandlerFactory, queryMapEncoder);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>ReflectiveFeign</code>构造函数有三个参数：</p>
<ul>
<li><code>ParseHandlersByName</code>将builder所有参数进行封装，并提供解析接口方法的逻辑</li>
<li><code>InvocationHandlerFactory</code> java动态代理的InvocationHandler的工厂类，默认值是<code>InvocationHandlerFactory.Default</code></li>
<li><code>QueryMapEncoder</code> 接口参数注解<code>@QueryMap</code>时，参数的编码器</li>
</ul>
<p><code>ReflectiveFeign.newInstance</code>方法创建接口动态代理对象：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <t> <span class="function">T <span class="title">newInstance</span><span class="params">(Target<t> target)</t></span> </span>{</t></span><br><span class="line">	<span class="comment">//targetToHandlersByName是构造器传入的ParseHandlersByName对象，根据target对象生成MethodHandler映射</span></span><br><span class="line">	<span class="comment">// 这里的MethodHandler的具体类型是在targetToHandlersByName.apply方法中使用工厂</span></span><br><span class="line">	<span class="comment">// SynchronousMethodHandler.Factory创建的SynchronousMethodHandler</span></span><br><span class="line">	Map<string, methodhandler> nameToHandler = targetToHandlersByName.apply(target);</string,></span><br><span class="line">	Map<method, methodhandler> methodToHandler = <span class="keyword">new</span> LinkedHashMap<method, methodhandler>();</method,></method,></span><br><span class="line">	List<defaultmethodhandler> defaultMethodHandlers = <span class="keyword">new</span> LinkedList<defaultmethodhandler>();</defaultmethodhandler></defaultmethodhandler></span><br><span class="line">	<span class="comment">//遍历接口所有方法，构建Method->MethodHandler的映射</span></span><br><span class="line">	<span class="keyword">for</span> (Method method : target.type().getMethods()) {</span><br><span class="line">		<span class="keyword">if</span> (method.getDeclaringClass() == Object<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">			<span class="comment">// Object类中的方法跳过</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		} <span class="keyword">else</span> <span class="keyword">if</span>(Util.isDefault(method)) {</span><br><span class="line">			<span class="comment">//接口default方法的Handler，这类方法直接调用</span></span><br><span class="line">			DefaultMethodHandler handler = <span class="keyword">new</span> DefaultMethodHandler(method);</span><br><span class="line">			defaultMethodHandlers.add(handler);</span><br><span class="line">			methodToHandler.put(method, handler);</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//这里factory是构造其中传入的，创建InvocationHandler</span></span><br><span class="line">	InvocationHandler handler = factory.create(target, methodToHandler);</span><br><span class="line">	<span class="comment">//java的动态代理</span></span><br><span class="line">	T proxy = (T) Proxy.newProxyInstance(target.type().getClassLoader(), <span class="keyword">new</span> Class<!--?-->[]{target.type()}, handler);</span><br><span class="line">	<span class="comment">//将default方法直接绑定到动态代理上</span></span><br><span class="line">	<span class="keyword">for</span>(DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) {</span><br><span class="line">		<span class="comment">// 用到了java7的MethodHandler、Lookup</span></span><br><span class="line">		defaultMethodHandler.bindTo(proxy);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> proxy;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这段代码主要的逻辑是：</p>
<ul>
<li>创建MethodHandler的映射，这里创建的是实现类SynchronousMethodHandler</li>
<li>通过InvocationHandlerFatory创建InvocationHandler</li>
<li>绑定接口的default方法，通过DefaultMethodHandler绑定</li>
</ul>
<p>类图中已经画出，<code>SynchronousMethodHandler</code>和<code>DefaultMethodHandler</code>实现了<code>InvocationHandlerFactory.MethodHandler</code>接口，动态代理对象调用方法时，如果是default方法，会直接调用接口方法，因为这里将接口的default方法绑定到动态代理对象上了，其他方法根据方法签名找到<code>SynchronousMethodHandler</code>对象，调用其invoke方法。</p>
<p><code>Feign.configKey(Class targetType, Method method)</code>的实现源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 例如User类中有 void list(Map map，int pageSize)将会生成User#list(User,int)签名</span></span><br><span class="line"><span class="comment">* 例如User类中有 void list()将会生成User#list()签名</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">configKey</span><span class="params">(Class targetType, Method method)</span> </span>{</span><br><span class="line">	StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">	<span class="comment">// 拼接类名</span></span><br><span class="line">	builder.append(targetType.getSimpleName());</span><br><span class="line">	<span class="comment">// 拼接#(</span></span><br><span class="line">	builder.append(<span class="string">'#'</span>).append(method.getName()).append(<span class="string">'('</span>);</span><br><span class="line">	<span class="keyword">for</span> (Type param : method.getGenericParameterTypes()) {</span><br><span class="line">		param = Types.resolve(targetType, targetType, param);</span><br><span class="line">		<span class="comment">// 拼接参数类型及1个逗号，例如int,</span></span><br><span class="line">		builder.append(Types.getRawType(param).getSimpleName()).append(<span class="string">','</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 删除最后1个逗号</span></span><br><span class="line">	<span class="keyword">if</span> (method.getParameterTypes().length > <span class="number">0</span>) {</span><br><span class="line">		builder.deleteCharAt(builder.length() - <span class="number">1</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//拼接反括号)</span></span><br><span class="line">	<span class="keyword">return</span> builder.append(<span class="string">')'</span>).toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h1 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h1><p><code>Target</code>源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span><<span class="title">T</span>> </span>{</span><br><span class="line">	<span class="comment">// api 接口类</span></span><br><span class="line">	<span class="function">Class<t> <span class="title">type</span><span class="params">()</span></t></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 名称</span></span><br><span class="line">	<span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// api接口路径的前缀地址(例如http://localhost:8080)， 发送请求时会用这个地址和@RequestLine中的url路径（/user/list）</span></span><br><span class="line">	<span class="comment">// 拼接在一起作为请求url(http://localhost:8080/user/list)</span></span><br><span class="line">	<span class="function">String <span class="title">url</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Request <span class="title">apply</span><span class="params">(RequestTemplate input)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Target的默认实现，什么也不做</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HardCodedTarget</span><<span class="title">T</span>> <span class="keyword">implements</span> <span class="title">Target</span><<span class="title">T</span>> </span>{</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Class<t> type;</t></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">HardCodedTarget</span><span class="params">(Class<t> type, String url)</t></span> </span>{</span><br><span class="line">			<span class="comment">// 可以看到这里name默认和url一样</span></span><br><span class="line">			<span class="keyword">this</span>(type, url, url);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">HardCodedTarget</span><span class="params">(Class<t> type, String name, String url)</t></span> </span>{</span><br><span class="line">			<span class="keyword">this</span>.type = checkNotNull(type, <span class="string">"type"</span>);</span><br><span class="line">			<span class="keyword">this</span>.name = checkNotNull(emptyToNull(name), <span class="string">"name"</span>);</span><br><span class="line">			<span class="keyword">this</span>.url = checkNotNull(emptyToNull(url), <span class="string">"url"</span>);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Request <span class="title">apply</span><span class="params">(RequestTemplate input)</span> </span>{</span><br><span class="line">			<span class="keyword">if</span> (input.url().indexOf(<span class="string">"http"</span>) != <span class="number">0</span>) {</span><br><span class="line">				input.target(url());</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">return</span> input.request();</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>


<h1 id="创建MethodHandler方法处理器"><a href="#创建MethodHandler方法处理器" class="headerlink" title="创建MethodHandler方法处理器"></a>创建MethodHandler方法处理器</h1><p>SynchronousMethodHandler是feign组件的核心，接口方法调用转换为http请求和解析http响应都是通过SynchronousMethodHandler来执行的，相关类图如下：<br><a href="https://oscimg.oschina.net/oscnet/up-668e4a442da56cb48fa3b4cb3bf4fb2ec15.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-668e4a442da56cb48fa3b4cb3bf4fb2ec15.png" class="lazyload"></a></p>
<p>创建MethodHandler实现类<code>ParseHandlersByName</code>的代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ParseHandlersByName</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Contract contract;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Options options;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Encoder encoder;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Decoder decoder;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ErrorDecoder errorDecoder;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> QueryMapEncoder queryMapEncoder;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> SynchronousMethodHandler.Factory factory;</span><br><span class="line"></span><br><span class="line">	ParseHandlersByName(</span><br><span class="line">		Contract contract,</span><br><span class="line">		Options options,</span><br><span class="line">		Encoder encoder,</span><br><span class="line">		Decoder decoder,</span><br><span class="line">		QueryMapEncoder queryMapEncoder,</span><br><span class="line">		ErrorDecoder errorDecoder,</span><br><span class="line">		SynchronousMethodHandler.Factory factory) {</span><br><span class="line">		...省略</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Map<string, methodhandler> <span class="title">apply</span><span class="params">(Target key)</span> </string,></span>{</span><br><span class="line">		 <span class="comment">//通过contract解析接口方法，生成MethodMetadata列表，默认的contract解析Feign自定义的http注解</span></span><br><span class="line">		List<methodmetadata> metadata = contract.parseAndValidatateMetadata(key.type());</methodmetadata></span><br><span class="line">		</span><br><span class="line">		Map<string, methodhandler> result = <span class="keyword">new</span> LinkedHashMap<string, methodhandler>();</string,></string,></span><br><span class="line">		<span class="keyword">for</span> (MethodMetadata md : metadata) {</span><br><span class="line">			<span class="comment">//BuildTemplateByResolvingArgs实现RequestTemplate.Factory，RequestTemplate的工厂</span></span><br><span class="line">			BuildTemplateByResolvingArgs buildTemplate;</span><br><span class="line">			<span class="comment">//根据方法元数据，使用不同的RequestTemplate的工厂</span></span><br><span class="line">			<span class="keyword">if</span> (!md.formParams().isEmpty() && md.template().bodyTemplate() == <span class="keyword">null</span>) {</span><br><span class="line">				 <span class="comment">//如果有formParam，并且bodyTemplate不为空，请求体为x-www-form-urlencoded格式</span></span><br><span class="line">				<span class="comment">//将会解析form参数，填充到bodyTemplate中</span></span><br><span class="line">				buildTemplate = <span class="keyword">new</span> BuildFormEncodedTemplateFromArgs(md, encoder, queryMapEncoder);</span><br><span class="line">			} </span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (md.bodyIndex() != <span class="keyword">null</span>) {</span><br><span class="line">				 <span class="comment">//如果包含请求体，将会用encoder编码请求体对象</span></span><br><span class="line">				buildTemplate = <span class="keyword">new</span> BuildEncodedTemplateFromArgs(md, encoder, queryMapEncoder);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				 <span class="comment">//没有请求体，不需要编码器，使用默认的RequestTemplate的工厂</span></span><br><span class="line">				buildTemplate = <span class="keyword">new</span> BuildTemplateByResolvingArgs(md, queryMapEncoder);</span><br><span class="line">			}</span><br><span class="line">			</span><br><span class="line">			 <span class="comment">//使用工厂SynchronousMethodHandler.Factory创建SynchronousMethodHandler</span></span><br><span class="line">			result.put(md.configKey(),</span><br><span class="line">					   factory.create(key, md, buildTemplate, options, decoder, errorDecoder));</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这段代码的逻辑是：</p>
<ol>
<li>通过<code>Contract</code>解析接口方法，生成<code>MethodMetadata</code>，默认的<code>Contract</code>解析<code>Feign</code>自定义的http注解</li>
<li>根据<code>MethodMetadata</code>方法元数据生成特定的<code>RequestTemplate</code>的工厂</li>
<li>使用<code>SynchronousMethodHandler.Factory</code>工厂创建<code>SynchronousMethodHandler</code></li>
</ol>
<p>这里有两个工厂不要搞混淆了，<code>SynchronousMethodHandler</code>工厂和<code>RequestTemplate```工厂，</code>SynchronousMethodHandler<code>的属性包含</code>RequestTemplate`工厂</p>
<h1 id="Contract解析接口方法生成MethodMetadata"><a href="#Contract解析接口方法生成MethodMetadata" class="headerlink" title="Contract解析接口方法生成MethodMetadata"></a>Contract解析接口方法生成MethodMetadata</h1><p>feign默认的解析器是<code>Contract.Default</code>继承了<code>Contract.BaseContract</code>，解析生成<code>MethodMetadata</code>方法入口：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Contract</span> </span>{</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 解析feign api 类上的所有方法元数据（feign默认是解析其自定义的注解，</span></span><br><span class="line"><span class="comment">	* spring cloud openfeign继承了feign的默认契约，同时支持spring mvc自己的<span class="doctag">@Requestmapping</span>主键）</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function">List<methodmetadata> <span class="title">parseAndValidatateMetadata</span><span class="params">(Class<!--?--> targetType)</span></methodmetadata></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 使用注解实现契约的通用逻辑， SpringMvcContract继承了BaseContract</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseContract</span> <span class="keyword">implements</span> <span class="title">Contract</span> </span>{</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 解析targetType类中的所有方法</span></span><br><span class="line"><span class="comment">		* <span class="doctag">@param</span> targetType 我们自己编写的feign api接口（标有<span class="doctag">@FeignClient</span>注解的类）</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> List<methodmetadata> <span class="title">parseAndValidatateMetadata</span><span class="params">(Class<!--?--> targetType)</span> </methodmetadata></span>{</span><br><span class="line">			<span class="comment">// api接口不能有泛型</span></span><br><span class="line">			checkState(targetType.getTypeParameters().length == <span class="number">0</span>, <span class="string">"Parameterized types unsupported: %s"</span>,</span><br><span class="line">					   targetType.getSimpleName());</span><br><span class="line">			<span class="comment">// 最多只能有1个父接口，多余1个父接口则抛出异常（不能多继承父接口，只允许单继承接口）</span></span><br><span class="line">			checkState(targetType.getInterfaces().length <= <span class="number">1</span>, <span class="string">"Only single inheritance supported: %s"</span>,</span><br><span class="line">					   targetType.getSimpleName());</span><br><span class="line">			<span class="comment">// 只有1个父接口</span></span><br><span class="line">			<span class="keyword">if</span> (targetType.getInterfaces().length == <span class="number">1</span>) </span><br><span class="line">				<span class="comment">// 检查父接口是否还有父接口，如果有则抛出异常（只允许1级父接口）</span></span><br><span class="line">				checkState(targetType.getInterfaces()[<span class="number">0</span>].getInterfaces().length == <span class="number">0</span>,</span><br><span class="line">						   <span class="string">"Only single-level inheritance supported: %s"</span>,</span><br><span class="line">						   targetType.getSimpleName());</span><br><span class="line">			}</span><br><span class="line">			Map<string, methodmetadata> result = <span class="keyword">new</span> LinkedHashMap<string, methodmetadata>();</string,></string,></span><br><span class="line">			<span class="comment">// 通过反射获取自己及父接口中的所有方法然后遍历之</span></span><br><span class="line">			<span class="keyword">for</span> (Method method : targetType.getMethods()) {</span><br><span class="line">				<span class="comment">// 以下几种情况跳过不处理</span></span><br><span class="line">				<span class="keyword">if</span> (method.getDeclaringClass() == Object<span class="class">.<span class="keyword">class</span> || // <span class="title">Object</span>类中的方法、</span></span><br><span class="line"><span class="class">					(<span class="title">method</span>.<span class="title">getModifiers</span>() & <span class="title">Modifier</span>.<span class="title">STATIC</span>) !</span>= <span class="number">0</span> || <span class="comment">// static修饰的方法</span></span><br><span class="line">					Util.isDefault(method)) { <span class="comment">// jdk8的default方法</span></span><br><span class="line">					<span class="comment">// 跳过不处理</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				}</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 关键代码：解析该方法的契约（注解），如果该方法没有@RequestLine注解，解析时会抛出异常</span></span><br><span class="line">				MethodMetadata metadata = parseAndValidateMetadata(targetType, method);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 一个类中的方法不能有相同的configKey</span></span><br><span class="line">				checkState(!result.containsKey(metadata.configKey()), <span class="string">"Overrides unsupported: %s"</span>, metadata.configKey());</span><br><span class="line">				<span class="comment">// 存储configKey与方法元数据的对应关系</span></span><br><span class="line">				result.put(metadata.configKey(), metadata);</span><br><span class="line">			}</span><br><span class="line">		</span><br><span class="line">			<span class="comment">// 返回方法的所有元数据列表（不包括static、default、Object类中的方法）</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ArrayList<>(result.values());</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 解析feign api接口上中的某个方法上的所有注解及类上注解（类上的注解作用于所有方法）</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> MethodMetadata <span class="title">parseAndValidateMetadata</span><span class="params">(Class<!--?--> targetType, Method method)</span> </span>{</span><br><span class="line">			MethodMetadata data = <span class="keyword">new</span> MethodMetadata();</span><br><span class="line">			<span class="comment">// 设置方法的返回值类型</span></span><br><span class="line">			data.returnType(Types.resolve(targetType, targetType, method.getGenericReturnType()));</span><br><span class="line">			<span class="comment">//设置方法的签名（例如UserFeignClient#list(User,Map)）</span></span><br><span class="line">			data.configKey(Feign.configKey(targetType, method));</span><br><span class="line">			<span class="comment">// 只有1个父接口</span></span><br><span class="line">			<span class="keyword">if</span> (targetType.getInterfaces().length == <span class="number">1</span>) {</span><br><span class="line">				<span class="comment">// 处理父接口上的注解（@Headers）</span></span><br><span class="line">				processAnnotationOnClass(data, targetType.getInterfaces()[<span class="number">0</span>]);</span><br><span class="line">			}</span><br><span class="line">			 <span class="comment">// 处理Class上的注解(@Headers)</span></span><br><span class="line">			processAnnotationOnClass(data, targetType);</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 一个方法上可能有多个注解（@RequestLine、@Body、@Headers）</span></span><br><span class="line">			<span class="keyword">for</span> (Annotation methodAnnotation : method.getAnnotations()) {</span><br><span class="line">				<span class="comment">//处理方法上的注解（@RequestLine、@Body、@Headers）</span></span><br><span class="line">				processAnnotationOnMethod(data, methodAnnotation, method);</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// 方法上没有@RequestLine注解，或者注解没有GET、POST这种method时抛出异常</span></span><br><span class="line">			checkState(data.template().method() != <span class="keyword">null</span>, </span><br><span class="line">					   <span class="string">"Method %s not annotated with HTTP method type (ex. GET, POST)"</span>, method.getName());</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 获得所有参数的Class对象</span></span><br><span class="line">			Class<!--?-->[] parameterTypes = method.getParameterTypes();</span><br><span class="line">			<span class="comment">// 获得参数化的参数泛型类型</span></span><br><span class="line">			Type[] genericParameterTypes = method.getGenericParameterTypes();</span><br><span class="line"> 			<span class="comment">// 获得方法的所有参数的注解，一个参数可能有多个注解，所以是个二维数组</span></span><br><span class="line">			<span class="comment">// 如果某个参数没有注解，则该参数的注解是个空数组</span></span><br><span class="line">			Annotation[][] parameterAnnotations = method.getParameterAnnotations();</span><br><span class="line">			<span class="comment">// 方法的参数个数</span></span><br><span class="line">			<span class="keyword">int</span> count = parameterAnnotations.length;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i < count; i++) {</span><br><span class="line">				<span class="comment">// 参数是否有@Param、@QueryMap、@HeaderMap这几个http注解中的任意1个</span></span><br><span class="line">				<span class="keyword">boolean</span> isHttpAnnotation = <span class="keyword">false</span>;</span><br><span class="line">				<span class="keyword">if</span> (parameterAnnotations[i] != <span class="keyword">null</span>) { <span class="comment">//不清楚为什么要判断不为空，难道可能为空？？</span></span><br><span class="line">					<span class="comment">// 处理某个参数上的多个注解（1个参数可能有多个注解）</span></span><br><span class="line">					isHttpAnnotation = processAnnotationsOnParameter(data, parameterAnnotations[i], i);</span><br><span class="line">				}</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 如果当前遍历的参数的类型是URI.class</span></span><br><span class="line">				<span class="keyword">if</span> (parameterTypes[i] == URI<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">					<span class="comment">// 记录URI类型参数在参数列表中的索引，参数类型是URI，后面构造http请求时使用该URI，</span></span><br><span class="line">					<span class="comment">// 而不是使用构建Feign.builder().target(xx, 'http://xxx')时的url</span></span><br><span class="line">					data.urlIndex(i);</span><br><span class="line">				} </span><br><span class="line">				<span class="comment">// 当前遍历的参数没有@Param、@QueryMap、@HeaderMap这几个http注解，</span></span><br><span class="line">				<span class="comment">// 且参数类型不是Request.Options.class， 那么该参数就是http请求的body部分</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (!isHttpAnnotation && parameterTypes[i] != Request.Options<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">					<span class="comment">// 这里存在参数顺序的问题：</span></span><br><span class="line">					<span class="comment">// 1. 先有表单提交参数(表单参数是有条件的，指没有被表达式使用的@Param参数)，就不能再有body参数，</span></span><br><span class="line">					<span class="comment">//    eg: void postUser1(@Param("user_name") String username, User user);是错误的</span></span><br><span class="line">					<span class="comment">// 2.先有body参数，后面可以有表单提交参数(没有被表达式使用的@Param参数)</span></span><br><span class="line">					<span class="comment">//    eg: void postUser2(User user, @Param("user_name") String username);是正确的</span></span><br><span class="line">					checkState(data.formParams().isEmpty(),</span><br><span class="line">							   <span class="string">"Body parameters cannot be used with form parameters."</span>);</span><br><span class="line">					<span class="comment">// 检查是否已经设置过http body参数，即不能有多个htp body参数, 否则抛出异常</span></span><br><span class="line">					<span class="comment">// 例如 void postUser3(User user, Address address);是错误的，因为有多个参数作为body请求体</span></span><br><span class="line">					checkState(data.bodyIndex() == <span class="keyword">null</span>, <span class="string">"Method has too many Body parameters: %s"</span>, method);</span><br><span class="line">					<span class="comment">// 记录作为body请求体参数的位置</span></span><br><span class="line">					data.bodyIndex(i);</span><br><span class="line">					<span class="comment">// 这行代码用于记录body参数的实际类型</span></span><br><span class="line">					<span class="comment">// Types.resolve(targetType, targetType, genericParameterTypes[i])用于获取该参数的实际类型</span></span><br><span class="line">					<span class="comment">// 例如泛型参数则返回实际参数类型，示例如下：</span></span><br><span class="line">					<span class="comment">/**</span></span><br><span class="line"><span class="comment">					*  interface BaseApi<v> {</v></span></span><br><span class="line"><span class="comment">					*      void put(<span class="doctag">@Param</span>("key") String key, V value);</span></span><br><span class="line"><span class="comment">					* }</span></span><br><span class="line"><span class="comment">					*</span></span><br><span class="line"><span class="comment">					* public interface Api extends BaseApi<user> {</user></span></span><br><span class="line"><span class="comment">					*</span></span><br><span class="line"><span class="comment">					* }</span></span><br><span class="line"><span class="comment">					*</span></span><br><span class="line"><span class="comment">					* 当调用api.put("caleb", user);方法时，此时 BaseApi中的put方法的第2个参数value作为body，</span></span><br><span class="line"><span class="comment">					* Types.resolve(Api.class, Api.class,  vlaue)得到的value的类型是User.class类型</span></span><br><span class="line"><span class="comment">					*/</span></span><br><span class="line">					data.bodyType(Types.resolve(targetType, targetType, genericParameterTypes[i]));</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (data.headerMapIndex() != <span class="keyword">null</span>) {</span><br><span class="line">				checkMapString(<span class="string">"HeaderMap"</span>, parameterTypes[data.headerMapIndex()],</span><br><span class="line">							   genericParameterTypes[data.headerMapIndex()]);</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (data.queryMapIndex() != <span class="keyword">null</span>) {</span><br><span class="line">				if (Map.class.isAssignableFrom(parameterTypes[data.queryMapIndex()])) {</span><br><span class="line">					checkMapKeys(<span class="string">"QueryMap"</span>, genericParameterTypes[data.queryMapIndex()]);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> data;</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 处理类上的注解， 默认由子类Contract.Default实现</span></span><br><span class="line"><span class="comment">		/</span></span><br><span class="line"><span class="comment">		protected abstract void processAnnotationOnClass(MethodMetadata data, Class<!--?--> clz);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		/**</span></span><br><span class="line"><span class="comment">		* 处理方法上的注解， 默认由子类Contract.Default实现</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">processAnnotationOnMethod</span><span class="params">(MethodMetadata data,</span></span></span><br><span class="line"><span class="function"><span class="params">											Annotation annotation,</span></span></span><br><span class="line"><span class="function"><span class="params">											Method method)</span></span>;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 处理参数上的注解， 默认由子类Contract.Default实现</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">processAnnotationsOnParameter</span><span class="params">(MethodMetadata data,</span></span></span><br><span class="line"><span class="function"><span class="params">											Annotation[] annotations,</span></span></span><br><span class="line"><span class="function"><span class="params">											<span class="keyword">int</span> paramIndex)</span></span>;</span><br><span class="line">	</span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">nameParam</span><span class="params">(MethodMetadata data, String name, <span class="keyword">int</span> i)</span> </span>{</span><br><span class="line">			Collection<string> names =</string></span><br><span class="line">				data.indexToName().containsKey(i) ? data.indexToName().get(i) : <span class="keyword">new</span> ArrayList<string>();</string></span><br><span class="line">			names.add(name);</span><br><span class="line">			data.indexToName().put(i, names);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 契约的默认实现，spring-cloud-opengeign的实现为org.springframework.cloud.openfeign.support.SpringMvcContract</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Default</span> <span class="keyword">extends</span> <span class="title">BaseContract</span> </span>{</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 处理类上的注解（<span class="doctag">@Headers</span>）</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAnnotationOnClass</span><span class="params">(MethodMetadata data, Class<!--?--> targetType)</span> </span>{</span><br><span class="line">			<span class="comment">//判断类上是否存在@Headers注解</span></span><br><span class="line">			<span class="keyword">if</span> (targetType.isAnnotationPresent(Headers<span class="class">.<span class="keyword">class</span>)) </span>{</span><br><span class="line">				<span class="comment">//获得@Headers注解的value属性的值</span></span><br><span class="line">				String[] headersOnType = targetType.getAnnotation(Headers<span class="class">.<span class="keyword">class</span>).<span class="title">value</span>()</span>;</span><br><span class="line">				<span class="comment">//检查注解是否有值，无值则抛出异常</span></span><br><span class="line">				checkState(headersOnType.length > <span class="number">0</span>, <span class="string">"Headers annotation was empty on type %s."</span>,</span><br><span class="line">						   targetType.getName());</span><br><span class="line">				<span class="comment">// 把注解的值(http请求头)用冒号(:)分割，因为http允许重复的header</span></span><br><span class="line">				<span class="comment">// (比如set-cookie:uid=12、set-cookie:sid=22)，所以一个name对应多个value， </span></span><br><span class="line">				<span class="comment">// 这里的headers这个Map对象的key就是http header的name， 值就是http header的</span></span><br><span class="line">				<span class="comment">// 多个相同header的值集合</span></span><br><span class="line">				Map<string, collection<string>> headers = toMap(headersOnType);</string,></span><br><span class="line">				<span class="comment">//将metadata中原有headers放到新headers中</span></span><br><span class="line">				headers.putAll(data.template().headers());</span><br><span class="line">				data.template().headers(<span class="keyword">null</span>); </span><br><span class="line">				<span class="comment">//将metadata的headers属性替换为新的headers</span></span><br><span class="line">				data.template().headers(headers);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 处理方法上的注解（<span class="doctag">@RequestLine</span>、<span class="doctag">@Body</span>、<span class="doctag">@Headers</span>）</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAnnotationOnMethod</span><span class="params">(MethodMetadata data, Annotation methodAnnotation, Method method)</span> </span>{</span><br><span class="line">			Class<!--? extends Annotation--> annotationType = methodAnnotation.annotationType();</span><br><span class="line">			<span class="comment">// 判断是否是@RequestLine注解</span></span><br><span class="line">			<span class="keyword">if</span> (annotationType == RequestLine<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">				<span class="comment">//获取@RequestLine注解的value属性的值</span></span><br><span class="line">				String requestLine = RequestLine<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">methodAnnotation</span>).<span class="title">value</span>()</span>;</span><br><span class="line">				<span class="comment">// @RequestLine注解的value属性的值若为空，则抛出异常</span></span><br><span class="line">				checkState(emptyToNull(requestLine) != <span class="keyword">null</span>,</span><br><span class="line">						   <span class="string">"RequestLine annotation was empty on method %s."</span>, method.getName());</span><br><span class="line">				<span class="comment">// 正则表达式匹配注解的值</span></span><br><span class="line">				Matcher requestLineMatcher = REQUEST_LINE_PATTERN.matcher(requestLine);</span><br><span class="line">				<span class="comment">//判断@RequestLine注解的value属性的值是否匹配正则表达式</span></span><br><span class="line">				<span class="keyword">if</span> (!requestLineMatcher.find()) {</span><br><span class="line">					<span class="comment">// @RequestLine注解的value属性的值不匹配给定的正则表达式，抛出异常</span></span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(</span><br><span class="line">						<span class="string">"RequestLine annotation didn't start with an HTTP verb on method %s"</span>,</span><br><span class="line">						method.getName()));</span><br><span class="line">				} </span><br><span class="line">				<span class="keyword">else</span> {</span><br><span class="line">					<span class="comment">// 获取@RequestLine注解value属性值的的method部分，例如GET /user/list获取到的就是GET</span></span><br><span class="line">					data.template().method(HttpMethod.valueOf(requestLineMatcher.group(<span class="number">1</span>)));</span><br><span class="line">					<span class="comment">// 获取url部分，对于上一行的示例获取到的就是/user/list</span></span><br><span class="line">					data.template().uri(requestLineMatcher.group(<span class="number">2</span>));</span><br><span class="line">				}</span><br><span class="line">				 <span class="comment">// 是否将'%2F'反转为'/'</span></span><br><span class="line">				data.template().decodeSlash(RequestLine<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">methodAnnotation</span>).<span class="title">decodeSlash</span>())</span>;</span><br><span class="line">				<span class="comment">// 参数集合格式化方式，默认使用key=value0&key=value1</span></span><br><span class="line">				data.template().collectionFormat(RequestLine<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">methodAnnotation</span>).<span class="title">collectionFormat</span>())</span>;</span><br><span class="line"></span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// 判断处理的注解是否是@Body</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (annotationType == Body<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">				String body = Body<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">methodAnnotation</span>).<span class="title">value</span>()</span>;</span><br><span class="line">				<span class="comment">// @Body注解的value必须有内容(不能为空字符串)</span></span><br><span class="line">				checkState(emptyToNull(body) != <span class="keyword">null</span>, <span class="string">"Body annotation was empty on method %s."</span>,</span><br><span class="line">						   method.getName());</span><br><span class="line">				<span class="comment">// 是否有{这种表达式(模板变量)</span></span><br><span class="line">				<span class="keyword">if</span> (body.indexOf(<span class="string">'{'</span>) == -<span class="number">1</span>) {</span><br><span class="line">					<span class="comment">// @Body注解的内容不包含需要解析的变量，不需要额外处理</span></span><br><span class="line">					data.template().body(body);</span><br><span class="line">				} <span class="keyword">else</span> {</span><br><span class="line">					<span class="comment">// 是模板，含有表达式变量，{expression}这种表达式需要插值替换成成真正的值</span></span><br><span class="line">					<span class="comment">//（用方法的参数值替换）</span></span><br><span class="line">					data.template().bodyTemplate(body);</span><br><span class="line">				}</span><br><span class="line">			} </span><br><span class="line">			<span class="comment">//判断处理的注解是否是@Headers注解</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (annotationType == Headers<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">				String[] headersOnMethod = Headers<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">methodAnnotation</span>).<span class="title">value</span>()</span>;</span><br><span class="line">				<span class="comment">//@Headers注解的value属性必须有值，若无值则抛出异常</span></span><br><span class="line">				checkState(headersOnMethod.length > <span class="number">0</span>, <span class="string">"Headers annotation was empty on method %s."</span>,</span><br><span class="line">						   method.getName());</span><br><span class="line">				<span class="comment">// 由于类和方法上都可以有@Headers注解，所以内部实现（appendHeader）是合并</span></span><br><span class="line">				<span class="comment">// 之前已有的headers和这里新增的headers</span></span><br><span class="line">				data.template().headers(toMap(headersOnMethod));</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 处理某个参数上的多个注解（1个参数可能有多个注解）,</span></span><br><span class="line"><span class="comment">		* 总结，主要处理了如下几个属性:</span></span><br><span class="line"><span class="comment">		* indexToName            --> <span class="doctag">@Param</span>注解的value属性</span></span><br><span class="line"><span class="comment">		* indexToExpanderClass   --> <span class="doctag">@Param</span>注解的expander属性</span></span><br><span class="line"><span class="comment">		* indexToEncoded         --> <span class="doctag">@Param</span>注解的encoded属性</span></span><br><span class="line"><span class="comment">		* formParams             --> <span class="doctag">@Param</span>注解的value属性</span></span><br><span class="line"><span class="comment">		* queryMapIndex          --> <span class="doctag">@QueryMap</span>注解</span></span><br><span class="line"><span class="comment">		* queryMapEncoded        --> <span class="doctag">@QueryMap</span>注解的encoded属性</span></span><br><span class="line"><span class="comment">		* headerMapIndex         --> <span class="doctag">@HeaderMap</span>注解</span></span><br><span class="line"><span class="comment">		</span></span><br><span class="line"><span class="comment">		*</span></span><br><span class="line"><span class="comment">		* <span class="doctag">@param</span> data 元数据，存储方法的相关数据(uri、headers、queries、body。。。)</span></span><br><span class="line"><span class="comment">		* <span class="doctag">@param</span> annotations 某1个参数上的所有所有注解（1个参数可能有多个注解）</span></span><br><span class="line"><span class="comment">		* <span class="doctag">@param</span> paramIndex 该参数在方法的所有参数中的索引, 从0开始</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processAnnotationsOnParameter</span><span class="params">(MethodMetadata data, </span></span></span><br><span class="line"><span class="function"><span class="params">									Annotation[] annotations,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="keyword">int</span> paramIndex)</span> </span>{</span><br><span class="line">			<span class="comment">// 参数是否有@Param、@QueryMap、@HeaderMap这几个http注解</span></span><br><span class="line">			<span class="keyword">boolean</span> isHttpAnnotation = <span class="keyword">false</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">for</span> (Annotation annotation : annotations) {</span><br><span class="line">				<span class="comment">// 获取注解的Class对象</span></span><br><span class="line">				Class<!--? extends Annotation--> annotationType = annotation.annotationType();</span><br><span class="line">				<span class="comment">// 如果处理的是@Param注解</span></span><br><span class="line">				<span class="keyword">if</span> (annotationType == Param<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">					Param paramAnnotation = (Param) annotation;</span><br><span class="line">					<span class="comment">// 获得@Param注解的value属性值</span></span><br><span class="line">					String name = paramAnnotation.value();</span><br><span class="line">					<span class="comment">// value属性值不能为空</span></span><br><span class="line">					checkState(emptyToNull(name) != <span class="keyword">null</span>, <span class="string">"Param annotation was empty on param %s."</span>, </span><br><span class="line">							   paramIndex);</span><br><span class="line">					<span class="comment">// 追加（不是替换indexToName）到MethodMetadata的indexToName属性中，</span></span><br><span class="line">					<span class="comment">// key为参数位置索引， values为@Param注解的value属性值</span></span><br><span class="line">					nameParam(data, name, paramIndex);</span><br><span class="line">					<span class="comment">// @Param注解的expander参数，定义参数的解释器，默认是ToStringExpander，</span></span><br><span class="line">					<span class="comment">// 调用参数的toString方法</span></span><br><span class="line">					Class<!--? extends Param.Expander--> expander = paramAnnotation.expander();</span><br><span class="line">					<span class="comment">// 判断是否自定义了expander解析器</span></span><br><span class="line">					<span class="keyword">if</span> (expander != Param.ToStringExpander<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">						<span class="comment">// 参数自定义了expander解析器，存储起来</span></span><br><span class="line">						data.indexToExpanderClass().put(paramIndex, expander);</span><br><span class="line">					}</span><br><span class="line">					<span class="comment">// 参数是否已经urlEncoded，如果没有，会使用urlEncoded方式编码</span></span><br><span class="line">					data.indexToEncoded().put(paramIndex, paramAnnotation.encoded());</span><br><span class="line">					<span class="comment">// 参数上存在http注解</span></span><br><span class="line">					isHttpAnnotation = <span class="keyword">true</span>;</span><br><span class="line">					<span class="keyword">if</span> (!data.template().hasRequestVariable(name)) {</span><br><span class="line">						<span class="comment">// 如果参数不在path里面，不在query里面，不在header里面，就设置到formParam中</span></span><br><span class="line">						data.formParams().add(name);</span><br><span class="line">					}</span><br><span class="line">				} </span><br><span class="line">				<span class="comment">// 如果处理的是@QueryMap注解，注解参数对象时，将该参数转换为http请求参数格式发送</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (annotationType == QueryMap<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">					<span class="comment">// 1个方法不能在多个参数上存在@QueryMap注解</span></span><br><span class="line">					checkState(data.queryMapIndex() == <span class="keyword">null</span>,</span><br><span class="line">							   <span class="string">"QueryMap annotation was present on multiple parameters."</span>);</span><br><span class="line">					<span class="comment">// 记录@QueryMap注解参数的索引</span></span><br><span class="line">					data.queryMapIndex(paramIndex);</span><br><span class="line">					<span class="comment">// @QueryMap注解的对像的值是否已经编码过，如果未编码则后续将url编码</span></span><br><span class="line">					data.queryMapEncoded(QueryMap<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">annotation</span>).<span class="title">encoded</span>())</span>;</span><br><span class="line">					<span class="comment">// 参数上存在http注解</span></span><br><span class="line">					isHttpAnnotation = <span class="keyword">true</span>;</span><br><span class="line">				}</span><br><span class="line">				<span class="comment">// 如果处理的是@HeaderMap注解，注解一个Map类型的参数，放入http header中发送</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (annotationType == HeaderMap<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">					<span class="comment">// 1个方法中不能在多个参数上存在@HeaderMap注解</span></span><br><span class="line">					checkState(data.headerMapIndex() == <span class="keyword">null</span>,</span><br><span class="line">							   <span class="string">"HeaderMap annotation was present on multiple parameters."</span>);</span><br><span class="line">					<span class="comment">// 记录@HeaderMap注解参数的索引</span></span><br><span class="line">					data.headerMapIndex(paramIndex);</span><br><span class="line">					<span class="comment">// 参数上存在http注解</span></span><br><span class="line">					isHttpAnnotation = <span class="keyword">true</span>;</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 参数是否有@Param、@QueryMap、@HeaderMap这几个http注解</span></span><br><span class="line">			<span class="keyword">return</span> isHttpAnnotation;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 将http header用冒号分割</span></span><br><span class="line"><span class="comment">		* 例如 Content-Type:text/html、Set-Cookie:uid=123、Set-Cookie:sid=456将变成如下的Map对象</span></span><br><span class="line"><span class="comment">		* Content-Type   ---->   text/html</span></span><br><span class="line"><span class="comment">		* Set-Cookie     ---->   uid=123、sid=456</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> Map<string, collection<string>> toMap(String[] input) {</string,></span><br><span class="line">			Map<string, collection<string>> result = <span class="keyword">new</span> LinkedHashMap<string, collection<string>>(input.length);</string,></string,></span><br><span class="line">			<span class="keyword">for</span> (String header : input) {</span><br><span class="line">				<span class="keyword">int</span> colon = header.indexOf(<span class="string">':'</span>);</span><br><span class="line">				String name = header.substring(<span class="number">0</span>, colon);</span><br><span class="line">				<span class="keyword">if</span> (!result.containsKey(name)) {</span><br><span class="line">					result.put(name, <span class="keyword">new</span> ArrayList<string>(<span class="number">1</span>));</string></span><br><span class="line">				}</span><br><span class="line">				result.get(name).add(header.substring(colon + <span class="number">1</span>).trim());</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>代码稍微有点多，但是逻辑很清晰，先处理类上的注解，再处理方法上注解，最后处理方法参数注解，把所有注解的情况都处理到就可以了。</p>
<p>生成的MethodMetadata的结构如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodMetadata</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//标识方法的key，接口名加方法签名：GitHub#contributors(String,String)</span></span><br><span class="line">	<span class="keyword">private</span> String configKey;</span><br><span class="line">	<span class="comment">//方法返回值类型</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> Type returnType;</span><br><span class="line">	<span class="comment">//uri参数的位置，方法中可以提供1个java.net.URI类型的参数，发请求时直接使用这个参数</span></span><br><span class="line">	<span class="keyword">private</span> Integer urlIndex;</span><br><span class="line">	<span class="comment">//body参数的位置，只能有一个未注解的参数为body，否则报错</span></span><br><span class="line">	<span class="keyword">private</span> Integer bodyIndex;</span><br><span class="line">	<span class="comment">//@HeaderMap注解参数的位置</span></span><br><span class="line">	<span class="keyword">private</span> Integer headerMapIndex;</span><br><span class="line">	<span class="comment">//@QueryMap注解参数位置</span></span><br><span class="line">	<span class="keyword">private</span> Integer queryMapIndex;</span><br><span class="line">	<span class="comment">//@QueryMap注解里面encode参数，是否已经urlEncode编码过了</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> queryMapEncoded;</span><br><span class="line">	<span class="comment">//body参数的类型</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> Type bodyType;</span><br><span class="line">	<span class="comment">//RequestTemplate 原型</span></span><br><span class="line">	<span class="keyword">private</span> RequestTemplate template = <span class="keyword">new</span> RequestTemplate();</span><br><span class="line">	<span class="comment">//form请求参数</span></span><br><span class="line">	<span class="keyword">private</span> List<string> formParams = <span class="keyword">new</span> ArrayList<string>();</string></string></span><br><span class="line">	<span class="comment">//方法参数位置和名称的map</span></span><br><span class="line">	<span class="keyword">private</span> Map<integer, collection<string>> indexToName ;</integer,></span><br><span class="line">	<span class="comment">//@Param中注解的expander方法，可以指定解析参数类</span></span><br><span class="line">	<span class="keyword">private</span> Map<integer, class<? extends expander>> indexToExpanderClass ;</integer,></span><br><span class="line">	<span class="comment">//参数是否被urlEncode编码过了，@Param中encoded方法</span></span><br><span class="line">	<span class="keyword">private</span> Map<integer, boolean> indexToEncoded ;</integer,></span><br><span class="line">	<span class="comment">//自定义的Expander</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> Map<integer, expander> indexToExpander;</integer,></span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<blockquote>
<p><code>Contract</code>也是feign的一个扩展点，一个优秀组件的架构通常是具有很强的扩展性，feign的架构本身很简单，设计的扩展点也很简单方便，所以受到spring的青睐，将其集成到spring cloud中。spring cloud就是通过<code>Contract</code>的扩展(<code>org.springframework.cloud.openfeign.support.SpringMvcContract</code>)，实现使用springMVC的注解接入feign。feign自己还实现了使用jaxrs注解接入feign。</p>
</blockquote>
<h1 id="初始化总结"><a href="#初始化总结" class="headerlink" title="初始化总结"></a>初始化总结</h1><p>上文已经完成了feign初始化结构为动态代理的整个过程，简单的捋一遍：</p>
<ol>
<li>初始化<code>Feign.Builder</code>传入参数，构造<code>ReflectiveFeign</code></li>
<li><code>ReflectiveFeign</code>通过内部类<code>ParseHandlersByName</code>的<code>Contract</code>属性，解析接口生成<code>MethodMetadata</code></li>
<li><code>ParseHandlersByName</code>根据<code>MethodMetadata</code>生成<code>RequestTemplate</code>工厂</li>
<li><code>ParseHandlersByName</code>创建<code>SynchronousMethodHandler</code>，传入<code>MethodMetadata</code>、<code>RequestTemplate</code>工厂和<code>Feign.Builder</code>相关参数</li>
<li><code>ReflectiveFeign</code>创建<code>FeignInvocationHandler</code>，传入参数<code>SynchronousMethodHandler</code>，绑定<code>DefaultMethodHandler</code></li>
<li><code>ReflectiveFeign</code>根据<code>FeignInvocationHandler</code>创建<code>Proxy</code></li>
</ol>
<p>关键的几个类是：</p>
<ul>
<li><code>ReflectiveFeign</code> 初始化入口</li>
<li><code>FeignInvocationHandler</code> 实现动态代理的InvocHandler</li>
<li><code>SynchronousMethodHandler</code> 方法处理器，方法调用处理器</li>
<li><code>MethodMetadata</code> 方法元数据</li>
<li><code>Contract.Default</code>契约解析默认实现</li>
</ul>
<h1 id="接口调用"><a href="#接口调用" class="headerlink" title="接口调用"></a>接口调用</h1><p>为方便理解，分析完feign源码后，我将feign执行过程分成三层，如下图：<br><a href="https://oscimg.oschina.net/oscnet/up-9d5d9d57db923dc0643764f2db79c6a9e5a.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-9d5d9d57db923dc0643764f2db79c6a9e5a.png" class="lazyload"></a></p>
<p>三层分别为：</p>
<ul>
<li>代理层  jdk动态代理调用层</li>
<li>转换层 方法转http请求，解码http响应</li>
<li>网络层 http请求发送</li>
</ul>
<p>java动态代理接口方法调用，会调用到InvocaHandler的invoke方法，feign里面实现类是FeignInvocationHandler，invoke代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectiveFeign</span> <span class="keyword">extends</span> <span class="title">Feign</span> </span>{</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br><span class="line">		<span class="comment">// 要代理的feign api接口，包含class、host信息</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Target target;</span><br><span class="line">		<span class="comment">// MethodHandler的具体类型位SynchronousMethodHandler或DefaultMethodHandler</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Map<method, methodhandler> dispatch;</method,></span><br><span class="line"></span><br><span class="line">		FeignInvocationHandler(Target target, Map<method, methodhandler> dispatch) {</method,></span><br><span class="line">			<span class="keyword">this</span>.target = checkNotNull(target, <span class="string">"target"</span>);</span><br><span class="line">			<span class="keyword">this</span>.dispatch = checkNotNull(dispatch, <span class="string">"dispatch for %s"</span>, target);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">			...省略 部分代码</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> dispatch.get(method).invoke(args);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>根据方法找到<code>MethodHandler</code>，除接口的<code>default</code>方法外(<code>default</code>方法直接调用，无需feign处理)，找到的是<code>SynchronousMethodHandler</code>对象，然后调用<code>SynchronousMethodHandlerd.invoke</code>方法：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronousMethodHandler</span> <span class="keyword">implements</span> <span class="title">MethodHandler</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> MethodMetadata metadata;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Target<!--?--> target;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Client client;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Retryer retryer;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List<requestinterceptor> requestInterceptors;</requestinterceptor></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Logger.Level logLevel;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RequestTemplate.Factory buildTemplateFromArgs;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Options options;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Decoder decoder;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ErrorDecoder errorDecoder;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> decode404;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> closeAfterDecode;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ExceptionPropagationPolicy propagationPolicy;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">		<span class="comment">//buildTemplateFromArgs是RequestTemplate工程对象，根据方法参数创建RequestTemplate</span></span><br><span class="line">		RequestTemplate template = buildTemplateFromArgs.create(argv);</span><br><span class="line">		Options options = findOptions(argv);</span><br><span class="line">		<span class="comment">//重试设置</span></span><br><span class="line">		Retryer retryer = <span class="keyword">this</span>.retryer.clone();</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">			<span class="keyword">try</span> {</span><br><span class="line">				<span class="comment">//执行和解码</span></span><br><span class="line">				<span class="keyword">return</span> executeAndDecode(template, options);</span><br><span class="line">			} </span><br><span class="line">			<span class="keyword">catch</span> (RetryableException e) {</span><br><span class="line">				<span class="keyword">try</span> {</span><br><span class="line">					<span class="comment">// 执行executeAndDecode时发生异常，由retryer决定是否继续重试</span></span><br><span class="line">					<span class="comment">//（若continueOrPropagate的实现抛出异常则停止重试，否则继续重试）</span></span><br><span class="line">					retryer.continueOrPropagate(e);</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">catch</span> (RetryableException th) {</span><br><span class="line">					<span class="comment">// continueOrPropagate的实现抛出了异常，停止重试</span></span><br><span class="line">					Throwable cause = th.getCause();</span><br><span class="line">					<span class="keyword">if</span> (propagationPolicy == UNWRAP && cause != <span class="keyword">null</span>) {</span><br><span class="line">						<span class="keyword">throw</span> cause;</span><br><span class="line">					} </span><br><span class="line">					<span class="keyword">else</span> {</span><br><span class="line">						<span class="keyword">throw</span> th;</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span> (logLevel != Logger.Level.NONE) {</span><br><span class="line">					logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function">Object <span class="title">executeAndDecode</span><span class="params">(RequestTemplate template, Options options)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">		<span class="comment">//RequestTemplate转换为Request</span></span><br><span class="line">		Request request = targetRequest(template);</span><br><span class="line"></span><br><span class="line">		...省略部分代码</span><br><span class="line"></span><br><span class="line">		Response response;</span><br><span class="line">		<span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			response = client.execute(request, options);</span><br><span class="line">		} </span><br><span class="line">		<span class="keyword">catch</span> (IOException e) {</span><br><span class="line">			...省略部分代码</span><br><span class="line">			<span class="keyword">throw</span> errorExecuting(request, e);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">long</span> elapsedTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">boolean</span> shouldClose = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			...省略部分代码</span><br><span class="line">				</span><br><span class="line">			  <span class="comment">//如果接口方法返回的是Response类	</span></span><br><span class="line">			<span class="keyword">if</span> (Response<span class="class">.<span class="keyword">class</span> </span>== metadata.returnType()) {</span><br><span class="line">				<span class="keyword">if</span> (response.body() == <span class="keyword">null</span>) {</span><br><span class="line">					<span class="keyword">return</span> response;</span><br><span class="line">				}</span><br><span class="line">				<span class="comment">//body不为空，且length>最大缓存值，返回response，但是不能关闭response</span></span><br><span class="line">				<span class="keyword">if</span> (response.body().length() == <span class="keyword">null</span> ||</span><br><span class="line">					response.body().length() > MAX_RESPONSE_BUFFER_SIZE) {</span><br><span class="line">					shouldClose = <span class="keyword">false</span>;</span><br><span class="line">					<span class="keyword">return</span> response;</span><br><span class="line">				}</span><br><span class="line">				<span class="comment">// body的length小于最大缓存值，可以直接读取body字节数组，返回response，可以自动关闭response</span></span><br><span class="line">				<span class="keyword">byte</span>[] bodyData = Util.toByteArray(response.body().asInputStream());</span><br><span class="line">				<span class="keyword">return</span> response.toBuilder().body(bodyData).build();</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">//判断响应成功</span></span><br><span class="line">			<span class="keyword">if</span> (response.status() >= <span class="number">200</span> && response.status() < <span class="number">300</span>) {</span><br><span class="line">				<span class="comment">// 响应成功，方法是否没有返回值</span></span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">void</span><span class="class">.<span class="keyword">class</span> </span>== metadata.returnType()) {</span><br><span class="line">					<span class="comment">// 方法返回void类型</span></span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				} </span><br><span class="line">				<span class="comment">// 方法需要返回值</span></span><br><span class="line">				<span class="keyword">else</span> {</span><br><span class="line">					<span class="comment">// 解码响应，直接调用decoder解码</span></span><br><span class="line">					Object result = decode(response);</span><br><span class="line">					<span class="comment">//是否应该自动关闭response响应</span></span><br><span class="line">					shouldClose = closeAfterDecode;</span><br><span class="line">					<span class="comment">// 方法最终的返回值</span></span><br><span class="line">					<span class="keyword">return</span> result;</span><br><span class="line">				}</span><br><span class="line">			} </span><br><span class="line">			<span class="comment">// 请求返回了404状态码并且应该解码404响应，并且方法需要返回值</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (decode404 && response.status() == <span class="number">404</span> && <span class="keyword">void</span><span class="class">.<span class="keyword">class</span> !</span>= metadata.returnType()) {</span><br><span class="line">				<span class="comment">// 解码404状态的response响应，直接调用decoder解码</span></span><br><span class="line">				Object result = decode(response);</span><br><span class="line">				shouldClose = closeAfterDecode;</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			} </span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="comment">// 非2xx的状态或者404状态不解码时，使用errorDecoder解析要抛出的异常</span></span><br><span class="line">				<span class="keyword">throw</span> errorDecoder.decode(metadata.configKey(), response);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (IOException e) {</span><br><span class="line">			...省略部分代码</span><br><span class="line">			<span class="keyword">throw</span> errorReading(request, response, e);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">finally</span> {</span><br><span class="line">			 <span class="comment">//是否需要关闭response，根据Feign.Builder 参数设置是否要关闭流</span></span><br><span class="line">			<span class="keyword">if</span> (shouldClose) {</span><br><span class="line">				<span class="comment">//关闭响应</span></span><br><span class="line">				ensureClosed(response.body());</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function">Request <span class="title">targetRequest</span><span class="params">(RequestTemplate template)</span> </span>{</span><br><span class="line">		<span class="keyword">for</span> (RequestInterceptor interceptor : requestInterceptors) {</span><br><span class="line">			interceptor.apply(template);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> target.apply(template);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>过程比较简单，生成RquestTemplate -> 转换为Request -> client发请求 -> Decoder解析Response</p>
<h1 id="RquestTemplate构建过程"><a href="#RquestTemplate构建过程" class="headerlink" title="RquestTemplate构建过程"></a>RquestTemplate构建过程</h1><p>先看看RequestTemplate的结构：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestTemplate</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern QUERY_STRING_PATTERN = Pattern.compile(<span class="string">"(?<!--\\{)\\?"</span-->);</span><br><span class="line">	<span class="comment">// 请求参数 ?后面的name=value</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<string, querytemplate> queries = <span class="keyword">new</span> LinkedHashMap<>();</string,></span><br><span class="line">	<span class="comment">// 请求头</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<string, headertemplate> headers = <span class="keyword">new</span> TreeMap<>(String.CASE_INSENSITIVE_ORDER);</string,></span><br><span class="line">	<span class="comment">// 基础url部分</span></span><br><span class="line">	<span class="keyword">private</span> String target;</span><br><span class="line">	<span class="comment">// url中的#及其后面的部分</span></span><br><span class="line">	<span class="keyword">private</span> String fragment;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// @RequestLine注解中的请求路径对象，只有路径部分(/user/list)，不包含?后的部分</span></span><br><span class="line">	<span class="keyword">private</span> UriTemplate uriTemplate;</span><br><span class="line">	<span class="comment">//请求方法 GET/POST等</span></span><br><span class="line">	<span class="keyword">private</span> HttpMethod method;</span><br><span class="line">	<span class="comment">//字符集</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> Charset charset = Util.UTF_8;</span><br><span class="line">	<span class="comment">//请求体</span></span><br><span class="line">	<span class="keyword">private</span> Request.Body body = Request.Body.empty();</span><br><span class="line">	<span class="comment">//是否decode斜杠，将"%2F"反转为"/"</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> decodeSlash = <span class="keyword">true</span>;</span><br><span class="line">	<span class="comment">//集合格式化，a=b&c=d</span></span><br><span class="line">	<span class="keyword">private</span> CollectionFormat collectionFormat = CollectionFormat.EXPLODED;</span><br><span class="line"></span><br><span class="line">}</span><br></span></pre></td></tr></tbody></table></figure></div>

<p>在<code>SynchronousMethodHandler.invoke</code>方法中生成<code>RequestTemplate</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//buildTemplateFromArgs是RequestTemplate.Factory实现类</span></span><br><span class="line">RequestTemplate template = buildTemplateFromArgs.create(argv);</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">- ```BuildTemplateByResolvingArgs``` ```RequestTemplate```工厂</span><br><span class="line">- ```BuildEncodedTemplateFromArgs``` ```BuildTemplateByResolvingArgs```的子类 重载```resolve```方法，解析form表单请求</span><br><span class="line">- ```BuildFormEncodedTemplateFromArgs``` ```BuildTemplateByResolvingArgs```的子类，重载```resolve```方法，解析body请求</span><br><span class="line">----</span><br><span class="line"></span><br><span class="line">- **BuildTemplateByResolvingArgs的实现**</span><br><span class="line"></span><br><span class="line">默认的RequestTemplate的工厂，没有请求体，不需要编码器</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">private static class BuildTemplateByResolvingArgs implements RequestTemplate.Factory {</span><br><span class="line">	// @QueryMap注解的参数的编码器</span><br><span class="line">	private final QueryMapEncoder queryMapEncoder;</span><br><span class="line">	// 方法的元数据</span><br><span class="line">	protected final MethodMetadata metadata;</span><br><span class="line">	// @Param注解的expander属性，用于参数转换</span><br><span class="line">	private final Map<integer, expander> indexToExpander = new LinkedHashMap<integer, expander>();</integer,></integer,></span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	* @params argv 调用方法时传递的参数列表</span><br><span class="line">	*/</span><br><span class="line">	@Override</span><br><span class="line">	public RequestTemplate create(Object[] argv) {</span><br><span class="line">		RequestTemplate mutable = RequestTemplate.from(metadata.template());</span><br><span class="line">		// 方法中有java.net.URI类型的参数, 例如void list(String username, URI url, String queryKey)</span><br><span class="line">		if (metadata.urlIndex() != null) {</span><br><span class="line">			// 获取URI类型的参数在参数列表中的位置</span><br><span class="line">			int urlIndex = metadata.urlIndex();</span><br><span class="line">			// URI类型的参数的实际值不为null</span><br><span class="line">			checkArgument(argv[urlIndex] != null, "URI parameter %s was null", urlIndex);</span><br><span class="line">			// 使用指定的参数的地址作为请求的基础地址</span><br><span class="line">			//（不使用Feign.builder().target(Api.class, 'http://localhost:8080')）中的url地址</span><br><span class="line">			mutable.target(String.valueOf(argv[urlIndex]));</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		// 存储  @Param注解value值 --> 参数实际值  的映射关系，用于后续表达式{expression}的求值</span><br><span class="line">		Map<string, object> varBuilder = new LinkedHashMap<string, object>();</string,></string,></span><br><span class="line">		// indexToName属性是解析@Param注解产生的， </span><br><span class="line">		// key为@Param注解的参数在参数列表中的索引</span><br><span class="line">		// value为@Param注解的value属性</span><br><span class="line">		for (Entry<integer, collection<string>> entry : metadata.indexToName().entrySet()) {</integer,></span><br><span class="line">			// 获得@Param主键的参数索引</span><br><span class="line">			int i = entry.getKey();</span><br><span class="line">			// 该位置参数的实际调用时传递的值</span><br><span class="line">			Object value = argv[entry.getKey()];</span><br><span class="line">			if (value != null) { // 跳过null值</span><br><span class="line">				// @Param注解是否有expander属性，即参数值是否需要转换处理（如Date -> String、Enum -> int等等）</span><br><span class="line">				if (indexToExpander.containsKey(i)) {</span><br><span class="line">					// 使用expander属性指定的class来转换输入值为另一个值</span><br><span class="line">					//（例如传入Date类型的参数，实际请求时需要的是yyyy-MM-dd这种格式的字符串，</span><br><span class="line">					// 那么就需要写一个DateFormatExpander类来进行转换参数）</span><br><span class="line">					value = expandElements(indexToExpander.get(i), value);</span><br><span class="line">				}</span><br><span class="line">				for (String name : entry.getValue()) {</span><br><span class="line">					// 存储@Param注解value值 --> 参数实际值  的映射关系，用于后续表达式{expression}的求值</span><br><span class="line">					varBuilder.put(name, value);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		//解析RequestTemplate</span><br><span class="line">		RequestTemplate template = resolve(argv, mutable, varBuilder);</span><br><span class="line">		// 为什么单独把queryMap放在这里解析，而不是在resolve方法中，或者在RequestTemplate中？(该问题来源于拍拍贷的博客内容)</span><br><span class="line">		// 因为@QueryMap注解的参数不需要解析表达式</span><br><span class="line">		if (metadata.queryMapIndex() != null) { //判断是否有@QueryMap注解的参数</span><br><span class="line">			// 获取@QueryMap注解的参数的实际值</span><br><span class="line">			Object value = argv[metadata.queryMapIndex()];</span><br><span class="line">			// value可能是Map或者java bean对象，如果参数不是Map类型的则用queryMapEncoder进行编码</span><br><span class="line">			Map<string, object> queryMap = toQueryMap(value);</string,></span><br><span class="line">			// 合并已有的查询参数和queryMap的参数，追加到RequestTemplate的queries属性中</span><br><span class="line">			template = addQueryMapQueryParameters(queryMap, template);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		// 为什么单独把headerMap放在这里解析，而不是在resolve方法中，或者在RequestTemplate中？</span><br><span class="line">		// 因为@HeaderMap注解的参数不需要解析表达式</span><br><span class="line">		// 参数中是否有@HeaderMap注解的参数</span><br><span class="line">		if (metadata.headerMapIndex() != null) {</span><br><span class="line">			// 将@HeaderMap注解的参数的实际值与已有的(@Headers的)header参数合并，</span><br><span class="line">			// 追加到RequestTemplate的headers属性中</span><br><span class="line">			template = addHeaderMapHeaders((Map<string, object>) argv[metadata.headerMapIndex()], template);</string,></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		return template;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	* 注解的表达书求值</span><br><span class="line">	*</span><br><span class="line">	* @params variables 指的是@Param注解value值 --> 参数实际值  的映射关系，用于后续表达式{expression}的求值</span><br><span class="line">	*/</span><br><span class="line">	protected RequestTemplate resolve(Object[] argv, RequestTemplate mutable, Map<string, object> variables) {</string,></span><br><span class="line">		// 由RequestTemplate.resolve(Map<string, object>)实现，真正的去解析注解中的表达式{expression}</string,></span><br><span class="line">		return mutable.resolve(variables);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<ul>
<li><p><strong>BuildFormEncodedTemplateFromArgs的实现</strong></p>
<p>如果有formParam，并且bodyTemplate不为空，请求体为x-www-form-urlencoded格式</p>
<p>将会解析form参数，填充到bodyTemplate中</p>
</li>
</ul>
<p>该类用于对参数列表中的form参数(<strong>未被表达式使用</strong>的<code>@Param</code>参数)使用encoder编码</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BuildFormEncodedTemplateFromArgs</span> <span class="keyword">extends</span> <span class="title">BuildTemplateByResolvingArgs</span> </span>{</span><br><span class="line">	<span class="comment">// Feign.builder().encoder(xx)时设置的编码器</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Encoder encoder;</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 注意这里重写了父类BuildTemplateByResolvingArgs中的resolve方法， </span></span><br><span class="line"><span class="comment">	* create的逻辑仍然使用父类的，这里是使用了模板方法设计模式</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> variables  指参数上的<span class="doctag">@Param</span>注解的键值对</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RequestTemplate <span class="title">resolve</span><span class="params">(Object[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">							RequestTemplate mutable,</span></span></span><br><span class="line"><span class="function"><span class="params">							Map<string, object> variables)</string,></span> </span>{</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 存储所有的form表单参数的name、value</span></span><br><span class="line">		Map<string, object> formVariables = <span class="keyword">new</span> LinkedHashMap<string, object>();</string,></string,></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (Entry<string, object> entry : variables.entrySet()) {</string,></span><br><span class="line">			<span class="comment">// 判断该参数是否是form表单参数，为什么有这个判断?</span></span><br><span class="line">			<span class="comment">//  因为@Param注解的参数作为form表单参数是有条件的，不是所有的@Param注解的参数都会作为form表单参数</span></span><br><span class="line">			<span class="comment">// @Param注解的参数有2种作用：</span></span><br><span class="line">			<span class="comment">// 1. 如果@Param注解的参数被表达式所使用，则不会作为form参数, 仅仅是为了解析表达式变量使用的</span></span><br><span class="line">			<span class="comment">// 2. 如果@Param注解的参数没有被表达式所使用，则作为form表单参数</span></span><br><span class="line">			<span class="keyword">if</span> (metadata.formParams().contains(entry.getKey())) {</span><br><span class="line">				<span class="comment">// 拿到所有的form表单参数的name、value</span></span><br><span class="line">				formVariables.put(entry.getKey(), entry.getValue());</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="comment">// 使用encoder对参数编码</span></span><br><span class="line">			encoder.encode(formVariables, Encoder.MAP_STRING_WILDCARD, mutable);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (EncodeException e) {</span><br><span class="line">			<span class="keyword">throw</span> e;</span><br><span class="line">		} </span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException e) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> EncodeException(e.getMessage(), e);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//调用父类BuildTemplateByResolvingArgs.reslove()处理，对注解中的表达式求值</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.resolve(argv, mutable, variables);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><strong>BuildEncodedTemplateFromArgs的实现</strong></li>
</ul>
<p>如果包含请求体，将会用encoder编码请求体对象（参数列表中的参数<strong>无任何注解</strong>会作为请求体）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BuildEncodedTemplateFromArgs</span> <span class="keyword">extends</span> <span class="title">BuildTemplateByResolvingArgs</span> </span>{</span><br><span class="line">	<span class="comment">// Feign.builder().encoder(xx)时设置的编码器</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Encoder encoder;</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> RequestTemplate <span class="title">resolve</span><span class="params">(Object[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">						RequestTemplate mutable,</span></span></span><br><span class="line"><span class="function"><span class="params">						Map<string, object> variables)</string,></span> </span>{</span><br><span class="line">		<span class="comment">// 获取作为body的参数的值</span></span><br><span class="line">		Object body = argv[metadata.bodyIndex()];</span><br><span class="line">		<span class="comment">// 值不能为空</span></span><br><span class="line">		checkArgument(body != <span class="keyword">null</span>, <span class="string">"Body parameter %s was null"</span>, metadata.bodyIndex());</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="comment">// 编码并设置RequestTemplate的body</span></span><br><span class="line">			encoder.encode(body, metadata.bodyType(), mutable);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (EncodeException e) {</span><br><span class="line">			<span class="keyword">throw</span> e;</span><br><span class="line">		} </span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException e) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> EncodeException(e.getMessage(), e);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//调用父类BuildTemplateByResolvingArgs.reslove()处理，对注解中的表达式求值</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.resolve(argv, mutable, variables);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h1 id="RequestTemplate解析参数的方法："><a href="#RequestTemplate解析参数的方法：" class="headerlink" title="RequestTemplate解析参数的方法："></a>RequestTemplate解析参数的方法：</h1><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestTemplate</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern QUERY_STRING_PATTERN = Pattern.compile(<span class="string">"(?<!--\\{)\\?"</span-->);</span><br><span class="line">	<span class="comment">// 请求参数 ?后面的name=value</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<string, querytemplate> queries = <span class="keyword">new</span> LinkedHashMap<>();</string,></span><br><span class="line">	<span class="comment">// 请求头</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<string, headertemplate> headers = <span class="keyword">new</span> TreeMap<>(String.CASE_INSENSITIVE_ORDER);</string,></span><br><span class="line">	<span class="comment">// 基础url部分</span></span><br><span class="line">	<span class="keyword">private</span> String target;</span><br><span class="line">	<span class="comment">// url中的#及其后面的部分</span></span><br><span class="line">	<span class="keyword">private</span> String fragment;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">// @RequestLine注解中的请求路径对象，只有路径部分(/user/list)，不包含?后的部分</span></span><br><span class="line">	<span class="keyword">private</span> UriTemplate uriTemplate;</span><br><span class="line">	<span class="comment">//请求方法 GET/POST等</span></span><br><span class="line">	<span class="keyword">private</span> HttpMethod method;</span><br><span class="line">	<span class="comment">//字符集</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> Charset charset = Util.UTF_8;</span><br><span class="line">	<span class="comment">//请求体</span></span><br><span class="line">	<span class="keyword">private</span> Request.Body body = Request.Body.empty();</span><br><span class="line">	<span class="comment">//是否decode斜杠，将"%2F"反转为"/"</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> decodeSlash = <span class="keyword">true</span>;</span><br><span class="line">	<span class="comment">//集合格式化，a=b&c=d</span></span><br><span class="line">	<span class="keyword">private</span> CollectionFormat collectionFormat = CollectionFormat.EXPLODED;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 表达式{expression}解析</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> variables 所有的<span class="doctag">@Param</span>注解value值 --> 参数实际值  的映射关系，用于表达式{expression}求值</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RequestTemplate <span class="title">resolve</span><span class="params">(Map<string, ?> variables)</string,></span> </span>{</span><br><span class="line"></span><br><span class="line">		StringBuilder uri = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="comment">// 得到当前对象一份新的拷贝</span></span><br><span class="line">		RequestTemplate resolved = RequestTemplate.from(<span class="keyword">this</span>);</span><br><span class="line">		<span class="comment">// 为什么要判断是否非null？, 所有的方法必须要有@RequestLine注解啊，</span></span><br><span class="line">		<span class="comment">// 即使如@RequestLine("GET")这样不写path这里的uriTemplate也会是空字符串""，而不可能是null啊</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.uriTemplate == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">this</span>.uriTemplate = UriTemplate.create(<span class="string">""</span>, !<span class="keyword">this</span>.decodeSlash, <span class="keyword">this</span>.charset);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 解析@RequestLine的属性中的表达式为实际值, 此时的uri为具体url，</span></span><br><span class="line">		<span class="comment">// 例如 /user/{username} 解析后变成 /user/calebzhao</span></span><br><span class="line">		uri.append(<span class="keyword">this</span>.uriTemplate.expand(variables));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 判断@RequestLine("GET /user/{username}")是否有查询参数, 注意此时@QueryMap的参数还不在queries属性中</span></span><br><span class="line">		<span class="comment">// 为什么不把@QueryMap的处理放在这个方法里就是因为@QueryMap的参数不需要解析表达式变量</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.queries.isEmpty()) {</span><br><span class="line">			<span class="comment">// 初始化1个空Map</span></span><br><span class="line">			resolved.queries(Collections.emptyMap());</span><br><span class="line">			StringBuilder query = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">			Iterator<querytemplate> queryTemplates = <span class="keyword">this</span>.queries.values().iterator();</querytemplate></span><br><span class="line"></span><br><span class="line">			<span class="keyword">while</span> (queryTemplates.hasNext()) {</span><br><span class="line">				QueryTemplate queryTemplate = queryTemplates.next();</span><br><span class="line">				<span class="comment">// 解析@QueryMap注解标注的参数的值，然后变成查询字符串，格式如a=b</span></span><br><span class="line">				String queryExpanded = queryTemplate.expand(variables);</span><br><span class="line">				<span class="comment">// 有值，需要拼接在url中</span></span><br><span class="line">				<span class="keyword">if</span> (Util.isNotBlank(queryExpanded)) {</span><br><span class="line">					query.append(queryExpanded);</span><br><span class="line">					<span class="keyword">if</span> (queryTemplates.hasNext()) {</span><br><span class="line">						<span class="comment">// 多个url参数之间的分隔符，如a=b&c=d</span></span><br><span class="line">						query.append(<span class="string">"&"</span>);</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			String queryString = query.toString();</span><br><span class="line">			<span class="keyword">if</span> (!queryString.isEmpty()) {</span><br><span class="line">				Matcher queryMatcher = QUERY_STRING_PATTERN.matcher(uri);</span><br><span class="line">				<span class="comment">// 判断uri中是否已有查询字符串?</span></span><br><span class="line">				<span class="keyword">if</span> (queryMatcher.find()) {</span><br><span class="line">					<span class="comment">// @RequestLine("GET /user/{username}?appId=123")中的url路径已有查询字符串?</span></span><br><span class="line">					uri.append(<span class="string">"&"</span>);</span><br><span class="line">				} </span><br><span class="line">				.<span class="comment">// 还没有字符串?，则拼接?</span></span><br><span class="line">				<span class="keyword">else</span> {</span><br><span class="line">					uri.append(<span class="string">"?"</span>);</span><br><span class="line">				}</span><br><span class="line">				<span class="comment">// 拼接查询参数到url中</span></span><br><span class="line">				uri.append(queryString);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 到这里uri已经变成/user/calebzhao?appId=123&a=b&c=d这种形式了</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将上述uri的各部分添加到当前RequestTemplate中，</span></span><br><span class="line">		<span class="comment">// 重新计算当前RequestTemplate的各个部分的值(uri路径覆盖当前值、queries查询参数覆盖当前值、frament覆盖)</span></span><br><span class="line">		<span class="comment">// RequestTemplate的各个部分的值如下：</span></span><br><span class="line">		<span class="comment">// uri  ---> /user/calebzhao</span></span><br><span class="line">		<span class="comment">// quries ---> appId=123、appId=123、a=b、c=d</span></span><br><span class="line">		<span class="comment">// frament --->空</span></span><br><span class="line">		resolved.uri(uri.toString());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 有@Headers注解的值，注意此时@HeaderMap注解的参数值还不在headers，</span></span><br><span class="line">		<span class="comment">// 为什么不把@HeaderMap的处理放在这个方法里就是因为因为@HeaderMap注解的参数值不需要解析表达式</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.headers.isEmpty()) {</span><br><span class="line">			<span class="comment">// header属性初始化为空Map</span></span><br><span class="line">			resolved.headers(Collections.emptyMap());</span><br><span class="line">			<span class="keyword">for</span> (HeaderTemplate headerTemplate : <span class="keyword">this</span>.headers.values()) {</span><br><span class="line">				<span class="comment">// HeaderTemplate的template形如：name空格value1逗号空格value2 ，</span></span><br><span class="line">				<span class="comment">// 例如set-cookie rid={roleId}, sid={sessionId}</span></span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 解析@Headers("x-user:{username}")注解中的表达式{username}</span></span><br><span class="line">				String header = headerTemplate.expand(variables);</span><br><span class="line">				<span class="keyword">if</span> (!header.isEmpty()) {</span><br><span class="line">					<span class="comment">// 得到的值形如：set-cookie rid=1, sid=2</span></span><br><span class="line">					<span class="comment">// 得到第一个空格后面的部分，例如上面例子的rid=1, sid=2</span></span><br><span class="line">					String headerValues = header.substring(header.indexOf(<span class="string">" "</span>) + <span class="number">1</span>);</span><br><span class="line">					<span class="keyword">if</span> (!headerValues.isEmpty()) {</span><br><span class="line">						<span class="comment">// 存储解析后的header</span></span><br><span class="line">						resolved.header(headerTemplate.getName(), headerValues);</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 处理body中的表达式</span></span><br><span class="line">		resolved.body(<span class="keyword">this</span>.body.expand(variables));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//标记为已解析</span></span><br><span class="line">		resolved.resolved = <span class="keyword">true</span>;</span><br><span class="line">		<span class="comment">//返回解析后的RequestTemplate</span></span><br><span class="line">		<span class="keyword">return</span> resolved;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 这个方法的作用就是复制requestTemplate，得到一份新的拷贝</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestTemplate <span class="title">from</span><span class="params">(RequestTemplate requestTemplate)</span> </span>{</span><br><span class="line">		RequestTemplate template = <span class="keyword">new</span> RequestTemplate(requestTemplate.target, requestTemplate.fragment,</span><br><span class="line">								requestTemplate.uriTemplate,</span><br><span class="line">								requestTemplate.method, requestTemplate.charset,</span><br><span class="line">								requestTemplate.body, requestTemplate.decodeSlash, </span><br><span class="line">								requestTemplate.collectionFormat);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!requestTemplate.queries().isEmpty()) {</span><br><span class="line">			template.queries.putAll(requestTemplate.queries);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!requestTemplate.headers().isEmpty()) {</span><br><span class="line">			template.headers.putAll(requestTemplate.headers);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> template;</span><br><span class="line">	}</span><br><span class="line">}</span><br></span></pre></td></tr></tbody></table></figure></div>

<p>我们回到SynchronousMethodHandler的invoke方法继续看executeAndDecode的实现</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">   RequestTemplate template = buildTemplateFromArgs.create(argv);</span><br><span class="line">  </span><br><span class="line">...省略</span><br><span class="line"><span class="keyword">return</span> executeAndDecode(template, options);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h1 id="RquestTemplate转换Request"><a href="#RquestTemplate转换Request" class="headerlink" title="RquestTemplate转换Request"></a>RquestTemplate转换Request</h1><p>先来看看Request的结构，完整的http请求信息的定义：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> HttpMethod httpMethod;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<string, collection<string>> headers;</string,></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Body body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Body</span> </span>{</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] data;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Charset encoding;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> BodyTemplate bodyTemplate;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	Request(HttpMethod method, String url, Map<string, collection<string>> headers, Body body) {</string,></span><br><span class="line">		<span class="keyword">this</span>.httpMethod = checkNotNull(method, <span class="string">"httpMethod of %s"</span>, method.name());</span><br><span class="line">		<span class="keyword">this</span>.url = checkNotNull(url, <span class="string">"url"</span>);</span><br><span class="line">		<span class="keyword">this</span>.headers = checkNotNull(headers, <span class="string">"headers of %s %s"</span>, method, url);</span><br><span class="line">		<span class="keyword">this</span>.body = body;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>SynchronousMethodHandler的targetRequest方法将RequestTemplate转换为Request</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Request <span class="title">targetRequest</span><span class="params">(RequestTemplate template)</span> </span>{</span><br><span class="line">	<span class="comment">//先应用所用拦截器，拦截器是在Feign.Builder中传入的，拦截器可以修改RequestTemplate信息</span></span><br><span class="line">	<span class="keyword">for</span> (RequestInterceptor interceptor : requestInterceptors) {</span><br><span class="line">		interceptor.apply(template);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//调用Target的apply方法，默认Target是HardCodedTarget</span></span><br><span class="line">	<span class="keyword">return</span> target.apply(template);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这块先应用所有拦截器，然后target的apply方法。拦截器和target都是扩展点，拦截器可以在构造好RequestTemplate后和发请求前修改请求信息，target默认使用HardCodedTarget直接发请求，feign还提供了LoadBalancingTarget，适配Ribbon来发请求，实现客户端的负载均衡。</p>
<ul>
<li><p><code>HardCodedTarget</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HardCodedTarget</span><<span class="title">T</span>> <span class="keyword">implements</span> <span class="title">Target</span><<span class="title">T</span>> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Class<t> type;</t></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Request <span class="title">apply</span><span class="params">(RequestTemplate input)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (input.url().indexOf(<span class="string">"http"</span>) != <span class="number">0</span>) {</span><br><span class="line">			input.target(url());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> input.request();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>RequestTemplate</code>的<code>input</code>方法</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Request <span class="title">request</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.resolved) {</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"template has not been resolved."</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> Request.create(<span class="keyword">this</span>.method, <span class="keyword">this</span>.url(), <span class="keyword">this</span>.headers(), <span class="keyword">this</span>.requestBody());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>Reques``的</code>create`方法</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Request <span class="title">create</span><span class="params">(HttpMethod httpMethod,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String url,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Map<string, collection<string>> headers,</string,></span></span></span><br><span class="line"><span class="function"><span class="params">                               Body body)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Request(httpMethod, url, headers, body);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure></div>
<p>从代码上可以看到，RequestTemplate基本上直接转为Request，没有做什么逻辑操作。</p>
</li>
</ul>
<h1 id="http请求发送"><a href="#http请求发送" class="headerlink" title="http请求发送"></a>http请求发送</h1><p>SynchronousMethodHandler中构造好Request后，直接调用client的execute方法发送请求：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">executeAndDecode</span><span class="params">(RequestTemplate template, Options options)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">	...省略部分代码</span><br><span class="line">		</span><br><span class="line">	response = client.execute(request, options);</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>client是一个<code>Client</code>接口，默认实现类是<code>Client.Default</code>，使用java api中的<code>HttpURLConnection</code>发送http请求。feign还实现了：</p>
<ul>
<li>feign.Client.Proxied</li>
<li>ApacheHttpClient</li>
<li>OkHttpClient</li>
<li>LoadBalancerFeignClient</li>
<li>FeignBlockingLoadBalancerClient</li>
</ul>
<h1 id="接口调用过程总结"><a href="#接口调用过程总结" class="headerlink" title="接口调用过程总结"></a>接口调用过程总结</h1><p>我们再将接口调用过程捋一遍：</p>
<p>1、接口的动态代理<code>Proxy</code>调用接口方法会执行的<code>FeignInvocationHandler</code><br>2、<code>FeignInvocationHandler</code>通过方法签名在属性<code>Map<method, methodhandler> dispatch</method,></code>中找到<code>SynchronousMethodHandler</code>，调用<code>invoke</code>方法<br>3、<code>SynchronousMethodHandler</code>的<code>invoke</code>方法根据传入的方法参数，通过自身属性工厂对象<code>RequestTemplate.Factory</code>创建<code>RequestTemplate</code>，工厂里面会用根据需要进行<code>Encode</code><br>4、<code>SynchronousMethodHandler</code>遍历自身属性<code>RequestInterceptor</code>列表，对<code>RequestTemplate</code>进行改造<br>4、<code>SynchronousMethodHandler</code>调用自身<code>Target</code>属性的<code>apply</code>方法，将<code>RequestTemplate</code>转换为<code>Request</code>对象<br>5、<code>SynchronousMethodHandler</code>调用自身<code>Client</code>的<code>execute</code>方法，传入<code>Request</code>对象<br>6、<code>Client</code>将<code>Request</code>转换为http请求，发送后将http响应转换为<code>Response</code>对象<br>7、<code>SynchronousMethodHandler</code>调用<code>Decoder</code>的方法对<code>Response</code>对象解码后返回<br>8、返回的对象最后返回到<code>Proxy</code> </p>
<p>时序图如下：<br><a href="https://oscimg.oschina.net/oscnet/up-5a078b81830db03301f33d1dbc860f3ef05.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-5a078b81830db03301f33d1dbc860f3ef05.png" class="lazyload"></a></p>
<h1 id="feign扩展点总结"><a href="#feign扩展点总结" class="headerlink" title="feign扩展点总结"></a>feign扩展点总结</h1><p>前文分析源代码时，已经提到了feign的扩展点，最后我们再将feign的主要扩展点进行总结一下：</p>
<ul>
<li><p><strong>Contract</strong> 契约</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   - ```feign.Contract.Default``` feign默认实现</span><br><span class="line">    - ```JAXRSContract``` javax.ws.rs注解接口实现</span><br><span class="line">    - ```SpringMvcContract```是spring cloud提供SpringMVC注解实现方式。</span><br><span class="line">	- ```HystrixDelegatingContract``` hyxtrix注解的实现</span><br><span class="line">	</span><br><span class="line">- **InvocationHandler** 动态代理handler  </span><br><span class="line">通过```InvocationHandlerFactory```注入到```Feign.Builder```中，feign提供了Hystrix的扩展，实现Hystrix接入</span><br><span class="line"></span><br><span class="line">- **Encoder** 请求body编码器</span><br><span class="line">feign已经提供扩展包含：</span><br><span class="line"></span><br><span class="line">  - 默认编码器，只能处理String和byte[]</span><br><span class="line">  - json编码器```GsonEncoder```、```JacksonEncoder</span><br></pre></td></tr></tbody></table></figure></div>
<ul>
<li>XML编码器<code>JAXBEncoder</code></li>
<li><code>FormEncoder</code></li>
<li><code>SpringEncoder</code></li>
<li><code>SpringFormEncoder</code></li>
<li><code>PageableSpringEncoder</code></li>
</ul>
</li>
<li><p><strong>Decoder</strong> http响应解码器<br>最基本的有：  </p>
<ul>
<li>feign默认的 <code>StringDecoder</code>、<code>OptionalDecoder</code>、<code>feign.codec.Decoder.Default</code>、<code>feign.Feign.ResponseMappingDecoder</code></li>
<li>json解码器 <code>GsonDecoder</code>、<code>JacksonDecoder</code>、<code>JacksonIteratorDecoder</code></li>
<li>XML解码器 <code>JAXBDecoder</code></li>
<li>Stream流解码器 <code>StreamDecoder</code></li>
<li>spring的 <code>SpringDecoder</code>、<code>ResponseEntityDecoder</code></li>
</ul>
</li>
<li><p><strong>ErrorDecoder</strong> 错误解码器  </p>
</li>
<li><p><strong>Target</strong> 请求转换器<br>feign提供的实现有：</p>
<ul>
<li><code>HardCodedTarget</code> 默认Target，不做任何处理。</li>
<li><code>EmptyTarget</code> feign提供的</li>
</ul>
</li>
<li><p><strong>Client</strong> 发送http请求的客户端<br>feign提供的Client实现有：</p>
<ul>
<li><code>Client.Default</code> 默认实现，使用java api的<code>HttpClientConnection</code>发送http请求</li>
<li><code>ApacheHttpClient</code> 使用apache的Http客户端发送请求</li>
<li><code>OkHttpClient</code> 使用OKHttp客户端发送请求</li>
<li><code>LoadBalancerFeignClient</code> spring-cloud-openfeign的通过负载均衡选择服务发送请求</li>
</ul>
</li>
<li><p><strong>RequestInterceptor</strong> 请求拦截器<br>调用客户端发请求前，修改<code>RequestTemplate</code>，比如为所有请求添加Header就可以用拦截器实现。</p>
<ul>
<li><code>BaseRequestInterceptor</code></li>
<li><code>BasicAuthRequestInterceptor</code></li>
<li><code>FeignAcceptGzipEncodingInterceptor</code></li>
<li><code>FeignContentGzipEncodingInterceptor</code></li>
</ul>
</li>
<li><p><strong>Retryer</strong> 重试策略<br>默认的策略是<code>Retryer.Default</code>，包含3个参数：</p>
<ul>
<li>间隔、</li>
<li>最大间隔</li>
<li>重试次数，第一次失败重试前会sleep输入的间隔时间的，后面每次重试sleep时间是前一次的1.5倍，超过最大时间或者最大重试次数就失败</li>
</ul>
</li>
</ul>
<blockquote>
<p>文章绝大部分内容来源于：<a href="http://techblog.ppdai.com/2018/05/14/20180514/" target="_blank" rel="noopener">http://techblog.ppdai.com/2018/05/14/20180514/</a><br>本人在其基础上加入自己的理解</p>
</blockquote>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">calebzhao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://calebzhao.github.io/2019/12/29/Feign%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">https://calebzhao.github.io/2019/12/29/Feign%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://calebzhao.github.io">calebzhao的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring-cloud/">spring cloud    </a><a class="post-meta__tags" href="/tags/feign/">feign    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229151714.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229152519.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/12/29/feign%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>feign使用教程</span></div></a></div><div class="next-post pull_right"><a href="/2019/12/29/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>java并发编程入门</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/12/29/feign使用教程/" title="feign使用教程"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">feign使用教程</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring-cloud-openfeign源码分析/" title="spring-cloud-openfeign源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring-cloud-openfeign源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/06/spring cloud - bootstrapContext(一)/" title="spring cloud - bootstrapContext(一)"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring cloud - bootstrapContext(一)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/02/Spring中的ResolvableType/" title="Spring中的ResolvableType详解."><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring中的ResolvableType详解.</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring.factories自动化配置归类/" title="spring.factories自动化配置归类"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring.factories自动化配置归类</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/2、spring-cloud-ribbon源码分析/" title="2、spring cloud ribbon源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">2、spring cloud ribbon源码分析</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = '昵称,邮箱,链接'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'HgchHaGng3F6hbefP0mcTaYh-gzGzoHsz',
  appKey:'j47kWakblNYEeDic8riu7flK',
  placeholder:'请留下你的足迹',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By calebzhao</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div><img src="https://api.travis-ci.com/calebzhao/calebzhao.github.io.svg?branch=hexo"></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>