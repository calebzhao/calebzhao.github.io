<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="never"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>spring-cloud-openfeign源码分析 | calebzhao的博客</title><meta name="description" content="spring-cloud-openfeign源码分析"><meta name="keywords" content="spring cloud,feign"><meta name="author" content="calebzhao"><meta name="copyright" content="calebzhao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229155709.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="spring-cloud-openfeign源码分析"><meta name="twitter:description" content="spring-cloud-openfeign源码分析"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="spring-cloud-openfeign源码分析"><meta property="og:url" content="https://calebzhao.github.io/2019/12/29/spring-cloud-openfeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="calebzhao的博客"><meta property="og:description" content="spring-cloud-openfeign源码分析"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://calebzhao.github.io/2019/12/29/spring-cloud-openfeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="prev" title="java并发编程入门" href="https://calebzhao.github.io/2019/12/29/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"EU39VTKAPM","apiKey":"9108b7c9e302dddcc64205e00d26f470","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://calebzhao.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">calebzhao的博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#1、简介"><span class="toc_mobile_items-text">1、简介</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#2、原理分析"><span class="toc_mobile_items-text">2、原理分析</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-1、-EnableFeignClients-注解声明客户端接口"><span class="toc_mobile_items-text">2.1、@EnableFeignClients 注解声明客户端接口</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-2、-FeignClient注解，将接口声明为Feign客户端"><span class="toc_mobile_items-text">2.2、@FeignClient注解，将接口声明为Feign客户端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-3、FeignClientsRegistrar-注册客户端"><span class="toc_mobile_items-text">2.3、FeignClientsRegistrar 注册客户端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-4、registerDefaultConfiguration方法，注册-EnableFeignClients注解的全局默认configuration"><span class="toc_mobile_items-text">2.4、registerDefaultConfiguration方法，注册@EnableFeignClients注解的全局默认configuration</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-5、registerClientConfiguration-注册configuration"><span class="toc_mobile_items-text">2.5、registerClientConfiguration 注册configuration</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-6、FeignClientSpecification-客户端定义"><span class="toc_mobile_items-text">2.6、FeignClientSpecification 客户端定义</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-7、registerFeignClients方法，注册feign客户端"><span class="toc_mobile_items-text">2.7、registerFeignClients方法，注册feign客户端</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-8、registerFeignClient方法，注册单个客户feign端bean"><span class="toc_mobile_items-text">2.8、registerFeignClient方法，注册单个客户feign端bean</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-9、FeignClientFactoryBean-创建feign客户端的工厂"><span class="toc_mobile_items-text">2.9、FeignClientFactoryBean 创建feign客户端的工厂</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-9-1、FeignClientFactoryBean-getObject方法"><span class="toc_mobile_items-text">2.9.1、FeignClientFactoryBean.getObject方法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-9-2、FeignContext-隔离配置"><span class="toc_mobile_items-text">2.9.2、FeignContext 隔离配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-9-3、创建Feign-Builder"><span class="toc_mobile_items-text">2.9.3、创建Feign.Builder</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-9-4、SpringMvcContract-适配feign注解体系"><span class="toc_mobile_items-text">2.9.4、SpringMvcContract 适配feign注解体系</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-9-5、FeignAutoConfiguration"><span class="toc_mobile_items-text">2.9.5、FeignAutoConfiguration</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-9-6、Targeter-生成接口动态代理"><span class="toc_mobile_items-text">2.9.6、Targeter 生成接口动态代理</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3、loadBalance方法，客户端负载均衡"><span class="toc_mobile_items-text">3、loadBalance方法，客户端负载均衡</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-1、loadBalance方法的调用"><span class="toc_mobile_items-text">3.1、loadBalance方法的调用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-2、FeignRibbonClientAutoConfiguration"><span class="toc_mobile_items-text">3.2、FeignRibbonClientAutoConfiguration</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-3、FeignLoadBalancerAutoConfiguration"><span class="toc_mobile_items-text">3.3、FeignLoadBalancerAutoConfiguration</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#4、总结"><span class="toc_mobile_items-text">4、总结</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、简介"><span class="toc-text">1、简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、原理分析"><span class="toc-text">2、原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1、-EnableFeignClients-注解声明客户端接口"><span class="toc-text">2.1、@EnableFeignClients 注解声明客户端接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2、-FeignClient注解，将接口声明为Feign客户端"><span class="toc-text">2.2、@FeignClient注解，将接口声明为Feign客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3、FeignClientsRegistrar-注册客户端"><span class="toc-text">2.3、FeignClientsRegistrar 注册客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4、registerDefaultConfiguration方法，注册-EnableFeignClients注解的全局默认configuration"><span class="toc-text">2.4、registerDefaultConfiguration方法，注册@EnableFeignClients注解的全局默认configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5、registerClientConfiguration-注册configuration"><span class="toc-text">2.5、registerClientConfiguration 注册configuration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6、FeignClientSpecification-客户端定义"><span class="toc-text">2.6、FeignClientSpecification 客户端定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7、registerFeignClients方法，注册feign客户端"><span class="toc-text">2.7、registerFeignClients方法，注册feign客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8、registerFeignClient方法，注册单个客户feign端bean"><span class="toc-text">2.8、registerFeignClient方法，注册单个客户feign端bean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9、FeignClientFactoryBean-创建feign客户端的工厂"><span class="toc-text">2.9、FeignClientFactoryBean 创建feign客户端的工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-1、FeignClientFactoryBean-getObject方法"><span class="toc-text">2.9.1、FeignClientFactoryBean.getObject方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-2、FeignContext-隔离配置"><span class="toc-text">2.9.2、FeignContext 隔离配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-3、创建Feign-Builder"><span class="toc-text">2.9.3、创建Feign.Builder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-4、SpringMvcContract-适配feign注解体系"><span class="toc-text">2.9.4、SpringMvcContract 适配feign注解体系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-5、FeignAutoConfiguration"><span class="toc-text">2.9.5、FeignAutoConfiguration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-6、Targeter-生成接口动态代理"><span class="toc-text">2.9.6、Targeter 生成接口动态代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、loadBalance方法，客户端负载均衡"><span class="toc-text">3、loadBalance方法，客户端负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1、loadBalance方法的调用"><span class="toc-text">3.1、loadBalance方法的调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2、FeignRibbonClientAutoConfiguration"><span class="toc-text">3.2、FeignRibbonClientAutoConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3、FeignLoadBalancerAutoConfiguration"><span class="toc-text">3.3、FeignLoadBalancerAutoConfiguration</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4、总结"><span class="toc-text">4、总结</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">spring-cloud-openfeign源码分析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-12-29<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-01-10</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/spring-cloud/">spring cloud</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">9.1k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 39 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/12/29/spring-cloud-openfeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/12/29/spring-cloud-openfeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h1><p>feign是一个声明式的HTTP客户端，spring-cloud-openfeign将feign集成到spring boot中，在接口上通过注解声明Rest协议，将http调用转换为接口方法的调用，使得客户端调用http服务更加简单。</p>
<h1 id="2、原理分析"><a href="#2、原理分析" class="headerlink" title="2、原理分析"></a>2、原理分析</h1><p>看到客户端测试类中，我们只用了一行代码，就能完成对远程Rest服务的调用，相当的简单。为什么这么神奇，这几段代码是如何做到的呢？</p>
<h2 id="2-1、-EnableFeignClients-注解声明客户端接口"><a href="#2-1、-EnableFeignClients-注解声明客户端接口" class="headerlink" title="2.1、@EnableFeignClients 注解声明客户端接口"></a>2.1、@EnableFeignClients 注解声明客户端接口</h2><p>入口是启动类上的注解<code>@EnableFeignClients</code>，源代码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import</span>(FeignClientsRegistrar<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableFeignClients</span> </span>{</span><br><span class="line">	<span class="comment">//basePackages的别名</span></span><br><span class="line">	String[] value() <span class="keyword">default</span> {};</span><br><span class="line">	<span class="comment">//声明基础包，spring boot启动后，会扫描该包下被@FeignClient注解的接口</span></span><br><span class="line">	String[] basePackages() <span class="keyword">default</span> {};</span><br><span class="line">	<span class="comment">//声明基础包的类，通过该类声明基础包</span></span><br><span class="line">	Class<!--?-->[] basePackageClasses() <span class="keyword">default</span> {};</span><br><span class="line">	<span class="comment">//默认配置类</span></span><br><span class="line">	Class<!--?-->[] defaultConfiguration() <span class="keyword">default</span> {};</span><br><span class="line">	<span class="comment">//直接声明的客户端接口类</span></span><br><span class="line">	Class<!--?-->[] clients() <span class="keyword">default</span> {};</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p><code>@EnableFeignClients</code>的参数声明客户端接口的位置和默认的配置类。</p>
<h2 id="2-2、-FeignClient注解，将接口声明为Feign客户端"><a href="#2-2、-FeignClient注解，将接口声明为Feign客户端" class="headerlink" title="2.2、@FeignClient注解，将接口声明为Feign客户端"></a>2.2、@FeignClient注解，将接口声明为Feign客户端</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> FeignClient {</span><br><span class="line">	<span class="comment">// 要调用的服务的id，对应与eureka上注册的应用名</span></span><br><span class="line">	<span class="comment">// 带有可选协议前缀的服务的名称。name属性的同义词。</span></span><br><span class="line">	<span class="comment">// 必须为所有客户端指定一个name，无论是否提供url。</span></span><br><span class="line">	<span class="comment">// 可以指定为属性的key，例如:${propertyKey}。</span></span><br><span class="line">	<span class="meta">@AliasFor</span>(<span class="string">"name"</span>)</span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 如果存在contextId，contextId将代替name属性用作bean的name，但不会用作服务id。</span></span><br><span class="line">	<span class="comment">// 这个配置非常有用，如果不设置这个属性，那么@FeignClient注解的同1个name属性值不能出现在多个接口上</span></span><br><span class="line">	<span class="comment">// why? 因为不设置contextId属性的话，那么bean的名称就是name属性了，</span></span><br><span class="line">	<span class="comment">// 如果多个接口调用同1个服务（多个接口上的@FeignClient注解的的name属性值相同），那么就会出现相同名称的bean了，</span></span><br><span class="line">	<span class="comment">// 而spring默认是不允许bean覆盖的，当然你可以通过设置spring.bean.allowOverridde=true来允许bean覆盖，</span></span><br><span class="line">	<span class="comment">// 但这是一个隐患非常大的危险做法，强烈建议不要这么做。</span></span><br><span class="line">	<span class="function">String <span class="title">contextId</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 名称，对应与eureka上注册的应用名</span></span><br><span class="line">	<span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span><br><span class="line">	<span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 如果有值，该值作为spring bean的qualifier， 否则使用contextId + 'FeignClient'作为qualifier</span></span><br><span class="line">	<span class="comment">// 另外contextId + 'FeignClient'中的contextId说明：当contextId存在使用contextId，不存在时依次使用serviceId、name、value</span></span><br><span class="line">	<span class="function">String <span class="title">qualifier</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// http服务的url，绝对地址或相对地址，http协议是可选的</span></span><br><span class="line">	<span class="function">String <span class="title">url</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 是否解码404状态码的响应，如果不解码404响应则会抛出FeignExceptions异常</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">decode404</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// feign client的@Configuration配置类，可以包含重写feign配置的@Bean定义，比如Decoder、Encoder、Logger、Contract</span></span><br><span class="line">	<span class="comment">// 参阅FeignClientsConfiguration类查看默认的feign配置</span></span><br><span class="line">	<span class="comment">// 这里设置的配置类是Spring Configuration，将会在FeignContext中创建内部声明的Bean，用于不同的客户端进行隔离</span></span><br><span class="line">	Class<!--?-->[] configuration() <span class="keyword">default</span> {};</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//声明hystrix调用失败后的方法</span></span><br><span class="line">	Class<!--?--> fallback() <span class="keyword">default</span> <span class="keyword">void</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 为指定的feign client定义fallback工厂，这个工厂必须返回一个实现了标有@FeignClient注解的接口的降级策略实例</span></span><br><span class="line">	<span class="comment">// 该工厂必须是一个有效的spring bean</span></span><br><span class="line">	Class<!--?--> fallbackFactory() <span class="keyword">default</span> <span class="keyword">void</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 所有方法级映射使用的路径前缀，是否想与@RibbonClient注解一起使用都可以</span></span><br><span class="line">	<span class="function">String <span class="title">path</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 是否将feign代理对象标记为首要bean，默认值为true。</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">primary</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="2-3、FeignClientsRegistrar-注册客户端"><a href="#2-3、FeignClientsRegistrar-注册客户端" class="headerlink" title="2.3、FeignClientsRegistrar 注册客户端"></a>2.3、FeignClientsRegistrar 注册客户端</h2><p><code>@EnableFeignClients</code>注解上被注解了<code>@Import(FeignClientsRegistrar.class)</code>，<code>@Import</code>注解的作用是将指定的类作为Bean注入到Spring Context中，我们再来看被引入的<code>FeignClientsRegistrar</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">EnvironmentAware</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Environment environment;</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">		registerDefaultConfiguration(metadata, registry);</span><br><span class="line">		registerFeignClients(metadata, registry);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>FeignClientsRegistrar</code>类实现了3个接口:</p>
<ul>
<li>接口<code>ResourceLoaderAware</code>用于注入<code>ResourceLoader</code></li>
<li>接口<code>EnvironmentAware</code>用于注入<code>Environment</code></li>
<li>接口<code>ImportBeanDefinitionRegistrar</code>用于动态向Spring Context中注册bean</li>
</ul>
<p><code>ImportBeanDefinitionRegistrar</code>接口方法<code>registerBeanDefinitions</code>有两个参数</p>
<ul>
<li>AnnotationMetadata 包含被@Import注解类的信息</li>
<li>BeanDefinitionRegistry bean定义注册中心</li>
</ul>
<h2 id="2-4、registerDefaultConfiguration方法，注册-EnableFeignClients注解的全局默认configuration"><a href="#2-4、registerDefaultConfiguration方法，注册-EnableFeignClients注解的全局默认configuration" class="headerlink" title="2.4、registerDefaultConfiguration方法，注册@EnableFeignClients注解的全局默认configuration"></a>2.4、registerDefaultConfiguration方法，注册@EnableFeignClients注解的全局默认configuration</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDefaultConfiguration</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">	<span class="comment">// 获取@EnableFeignClients注解参数</span></span><br><span class="line">	Map<string, object> defaultAttrs = metadata.getAnnotationAttributes(EnableFeignClients<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>(), <span class="title">true</span>)</span>;</string,></span><br><span class="line">	<span class="comment">// 如果参数中包含defaultConfiguration默认配置</span></span><br><span class="line">	<span class="keyword">if</span> (defaultAttrs != <span class="keyword">null</span> && defaultAttrs.containsKey(<span class="string">"defaultConfiguration"</span>)) {</span><br><span class="line">		String name;</span><br><span class="line">		<span class="comment">// 返回该类是否有上级类（即metadata注解的类是内部类/嵌套类、方法中的局部类、匿名类中的一种）</span></span><br><span class="line">		<span class="comment">// 如果此方法返回false，则表明metadata注解的类为顶级类。</span></span><br><span class="line">		<span class="comment">// 关于hasEnclosingClass方法的具体含义见：https://my.oschina.net/zhaopeng2012/blog/3146991</span></span><br><span class="line">		<span class="keyword">if</span> (metadata.hasEnclosingClass()) {</span><br><span class="line">			<span class="comment">// 不是顶级类，注解所标识类的上一级类的全限定类名</span></span><br><span class="line">			name = <span class="string">"default."</span> + metadata.getEnclosingClassName();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			<span class="comment">// 注解所标识的类的全限定类名</span></span><br><span class="line">			name = <span class="string">"default."</span> + metadata.getClassName();</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 注册客户端的配置Bean， </span></span><br><span class="line">		<span class="comment">// 注意这里第3个参数值是@EnableFeignCliens注解的defaultConfiguration属性</span></span><br><span class="line">		registerClientConfiguration(registry, name, defaultAttrs.get(<span class="string">"defaultConfiguration"</span>));</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>取出<code>@EnableFeignClients</code>注解的参数<code>defaultConfiguration</code>，动态注册到spring Context中。  </p>
<h2 id="2-5、registerClientConfiguration-注册configuration"><a href="#2-5、registerClientConfiguration-注册configuration" class="headerlink" title="2.5、registerClientConfiguration 注册configuration"></a>2.5、registerClientConfiguration 注册configuration</h2><p>该方法用于注册feign配置，配置来源有2种：</p>
<ul>
<li><ol>
<li><code>@EnableFeignClients</code>注解的<code>defaultConfiguration</code>属性注册时（全局默认配置），name为default.xxx</li>
</ol>
</li>
<li><ol start="2">
<li><code>@FeignClient</code>注解的<code>configuration</code>属性注册时（服务私有配置），name为contextId、name、value属性的值</li>
</ol>
</li>
</ul>
<p>有2个地方会调用该方法：</p>
<ul>
<li><code>FeignClientsRegistrar.registerDefaultConfiguration()</code></li>
<li><code>FeignClientsRegistrar.registerFeignClients()</code></li>
</ul>
<p><strong>registerClientConfiguration</strong> 方法源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerClientConfiguration</span><span class="params">(BeanDefinitionRegistry registry, Object name, Object configuration)</span> </span>{</span><br><span class="line">	<span class="comment">// 创建一个BeanDefinitionBuilder，注册bean的类为FeignClientSpecification</span></span><br><span class="line">	BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(FeignClientSpecification<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="comment">// 增加构造函数参数</span></span><br><span class="line">	builder.addConstructorArgValue(name);</span><br><span class="line">	<span class="comment">// 关键代码：@EnableFeignCliens注解的defaultConfiguration属性</span></span><br><span class="line">	builder.addConstructorArgValue(configuration);</span><br><span class="line">	<span class="comment">// 调用BeanDefinitionRegistry.registerBeanDefinition方法动态注册Bean</span></span><br><span class="line">	<span class="comment">// 这里的name有2种情况：</span></span><br><span class="line">	<span class="comment">// 1. @EnableFeignClients注解的defaultConfiguration属性注册时（全局默认配置），name为default.xxx</span></span><br><span class="line">	<span class="comment">// 2. @FeignClient注解的configuration属性注册时（服务私有配置），name为contextId、name、value属性的值</span></span><br><span class="line">	registry.registerBeanDefinition(name + <span class="string">"."</span> + FeignClientSpecification<span class="class">.<span class="keyword">class</span>.<span class="title">getSimpleName</span>(), <span class="title">builder</span>.<span class="title">getBeanDefinition</span>())</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这里使用spring 动态注册bean的方式，注册了一个<code>FeignClientSpecification</code>的bean。</p>
<h2 id="2-6、FeignClientSpecification-客户端定义"><a href="#2-6、FeignClientSpecification-客户端定义" class="headerlink" title="2.6、FeignClientSpecification 客户端定义"></a>2.6、FeignClientSpecification 客户端定义</h2><p>一个简单的pojo，继承了<code>NamedContextFactory.Specification</code>，两个属性<code>String name</code> 和 <code>Class<!--?-->[] configuration</code>，用于<code>FeignContext</code>命名空间独立配置，后面会用到。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeignClientSpecification</span> <span class="keyword">implements</span> <span class="title">NamedContextFactory</span>.<span class="title">Specification</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这个属性的值就是@EnableFeignClients的defaultConfiguration的值</span></span><br><span class="line">	<span class="comment">// 或者是@FeignClient注解的configuration属性的值</span></span><br><span class="line">	<span class="keyword">private</span> Class<!--?-->[] configuration;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="2-7、registerFeignClients方法，注册feign客户端"><a href="#2-7、registerFeignClients方法，注册feign客户端" class="headerlink" title="2.7、registerFeignClients方法，注册feign客户端"></a>2.7、registerFeignClients方法，注册feign客户端</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerFeignClients</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">	<span class="comment">// 生成一个scanner，扫描指定定包下的类</span></span><br><span class="line">	ClassPathScanningCandidateComponentProvider scanner = getScanner();</span><br><span class="line">	scanner.setResourceLoader(<span class="keyword">this</span>.resourceLoader);</span><br><span class="line"></span><br><span class="line">	Set<string> basePackages;</string></span><br><span class="line">	<span class="comment">// 获取@EnableFeignClients注解的所有属性</span></span><br><span class="line">	Map<string, object> attrs = metadata.getAnnotationAttributes(EnableFeignClients<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</string,></span><br><span class="line">	<span class="comment">// 包含@FeignClient注解的过滤器</span></span><br><span class="line">	AnnotationTypeFilter annotationTypeFilter = <span class="keyword">new</span> AnnotationTypeFilter(FeignClient<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="comment">// 获取@EnableFeignClients注解的clients属性的值</span></span><br><span class="line">	<span class="keyword">final</span> Class<!--?-->[] clients = attrs == <span class="keyword">null</span> ? <span class="keyword">null</span> : (Class<!--?-->[]) attrs.get(<span class="string">"clients"</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (clients == <span class="keyword">null</span> || clients.length == <span class="number">0</span>) {</span><br><span class="line">		<span class="comment">//@EnableFeignClients没有声明clients，获取basePackages，设置过滤器（扫描包含@FeignClient注解的class）</span></span><br><span class="line">		scanner.addIncludeFilter(annotationTypeFilter);</span><br><span class="line">		<span class="comment">// 根据value、basePackages、basePackageClasses获取要扫描的包</span></span><br><span class="line">		basePackages = getBasePackages(metadata);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">		<span class="comment">// @EnableFeignClients注解声明了clients</span></span><br><span class="line">		<span class="keyword">final</span> Set<string> clientClasses = <span class="keyword">new</span> HashSet<>();</string></span><br><span class="line">		basePackages = <span class="keyword">new</span> HashSet<>();</span><br><span class="line">		<span class="keyword">for</span> (Class<!--?--> clazz : clients) {</span><br><span class="line">			<span class="comment">// basePackages为声明的clients所在的包</span></span><br><span class="line">			basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">			clientClasses.add(clazz.getCanonicalName());</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 增加过滤器，只包含声明的clients</span></span><br><span class="line">		AbstractClassTestingTypeFilter filter = <span class="keyword">new</span> AbstractClassTestingTypeFilter() {</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(ClassMetadata metadata)</span> </span>{</span><br><span class="line">				String cleaned = metadata.getClassName().replaceAll(<span class="string">"\\$"</span>, <span class="string">"."</span>);</span><br><span class="line">				<span class="keyword">return</span> clientClasses.contains(cleaned);</span><br><span class="line">			}</span><br><span class="line">		};</span><br><span class="line">		scanner.addIncludeFilter(</span><br><span class="line">			<span class="keyword">new</span> AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 遍历basePackages</span></span><br><span class="line">	<span class="keyword">for</span> (String basePackage : basePackages) {</span><br><span class="line">		<span class="comment">// 扫描包，根据过滤器找到候选的Bean</span></span><br><span class="line">		Set<beandefinition> candidateComponents = scanner.findCandidateComponents(basePackage);</beandefinition></span><br><span class="line">		<span class="comment">// 遍历候选的bean</span></span><br><span class="line">		<span class="keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) {</span><br><span class="line">			<span class="comment">// 判断候选bean是否是一个标有注解的bean</span></span><br><span class="line">			<span class="keyword">if</span> (candidateComponent <span class="keyword">instanceof</span> AnnotatedBeanDefinition) {</span><br><span class="line">				</span><br><span class="line">				AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;</span><br><span class="line">				AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();</span><br><span class="line">				<span class="comment">// 校验注解是否标识在接口上</span></span><br><span class="line">				Assert.isTrue(annotationMetadata.isInterface(),</span><br><span class="line">							  <span class="string">"@FeignClient can only be specified on an interface"</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 获取@FeignClient注解的所有属性</span></span><br><span class="line">				Map<string, object> attributes = annotationMetadata.getAnnotationAttributes(</string,></span><br><span class="line">										FeignClient<span class="class">.<span class="keyword">class</span>.<span class="title">getCanonicalName</span>())</span>;</span><br><span class="line">				<span class="comment">// name获取顺序按优先级从高到低依次为contextId、value、name、serviceId。</span></span><br><span class="line">				String name = getClientName(attributes);</span><br><span class="line">				<span class="comment">//注册@FeignClient的configuration属性的客户端配置</span></span><br><span class="line">				registerClientConfiguration(registry, name,attributes.get(<span class="string">"configuration"</span>));</span><br><span class="line">				<span class="comment">//注册客户端</span></span><br><span class="line">				registerFeignClient(registry, annotationMetadata, attributes);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这个方法主要逻辑是扫描注解声明的客户端(标有<code>@FeignClient</code>的接口)，调用<code>registerFeignClient</code>方法注册到registry中。<strong>这里是一个典型的spring动态注册bean的例子，可以参考这段代码在spring中轻松的实现类路径下class扫描，动态注册bean到spring中</strong>。想了解spring类的扫描机制，可以断点到<code>ClassPathScanningCandidateComponentProvider.findCandidateComponents</code>方法中，一步步调试。</p>
<h2 id="2-8、registerFeignClient方法，注册单个客户feign端bean"><a href="#2-8、registerFeignClient方法，注册单个客户feign端bean" class="headerlink" title="2.8、registerFeignClient方法，注册单个客户feign端bean"></a>2.8、registerFeignClient方法，注册单个客户feign端bean</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerFeignClient</span><span class="params">(BeanDefinitionRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">				AnnotationMetadata annotationMetadata, </span></span></span><br><span class="line"><span class="function"><span class="params">				Map<string, object> attributes)</string,></span> </span>{</span><br><span class="line">	</span><br><span class="line">	String className = annotationMetadata.getClassName();</span><br><span class="line">	<span class="comment">// 构建一个FeignClientFactoryBean的bean工厂定义</span></span><br><span class="line">	BeanDefinitionBuilder definition = BeanDefinitionBuilder.genericBeanDefinition(FeignClientFactoryBean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	validate(attributes);</span><br><span class="line">	<span class="comment">//根据@FeignClient注解的参数，设置属性</span></span><br><span class="line">	definition.addPropertyValue(<span class="string">"url"</span>, getUrl(attributes));</span><br><span class="line">	definition.addPropertyValue(<span class="string">"path"</span>, getPath(attributes));</span><br><span class="line">	String name = getName(attributes);</span><br><span class="line">	definition.addPropertyValue(<span class="string">"name"</span>, name);</span><br><span class="line">	String contextId = getContextId(attributes);</span><br><span class="line">	definition.addPropertyValue(<span class="string">"contextId"</span>, contextId);</span><br><span class="line">	definition.addPropertyValue(<span class="string">"type"</span>, className);</span><br><span class="line">	definition.addPropertyValue(<span class="string">"decode404"</span>, attributes.get(<span class="string">"decode404"</span>));</span><br><span class="line">	definition.addPropertyValue(<span class="string">"fallback"</span>, attributes.get(<span class="string">"fallback"</span>));</span><br><span class="line">	definition.addPropertyValue(<span class="string">"fallbackFactory"</span>, attributes.get(<span class="string">"fallbackFactory"</span>));</span><br><span class="line">	definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">	<span class="comment">// bean的默认别名</span></span><br><span class="line">	String alias = contextId + <span class="string">"FeignClient"</span>;</span><br><span class="line">	AbstractBeanDefinition beanDefinition = definition.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> primary = (Boolean) attributes.get(<span class="string">"primary"</span>); <span class="comment">// has a default, won't be</span></span><br><span class="line">	<span class="comment">// null</span></span><br><span class="line">	<span class="comment">// 相当于@Primary注解的作用</span></span><br><span class="line">	beanDefinition.setPrimary(primary);</span><br><span class="line">	<span class="comment">//获取@FeignClient注解中指定的qualifier属性</span></span><br><span class="line">	String qualifier = getQualifier(attributes);</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(qualifier)) {</span><br><span class="line">		<span class="comment">// 如果用户自己指定了qualifier属性，则使用注解中的qualifier属性作为bean的别名</span></span><br><span class="line">		<span class="comment">// 否则使用上述默认的 contextId + "FeignClient";</span></span><br><span class="line">		alias = qualifier;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册，这里为了简写，新建一个BeanDefinitionHolder，调用BeanDefinitionReaderUtils静态方法注册</span></span><br><span class="line">	BeanDefinitionHolder holder = <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, className, <span class="keyword">new</span> String[] { alias });</span><br><span class="line">	BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取服务名， 获取顺序为serviceId、name、value</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">String <span class="title">getName</span><span class="params">(Map<string, object> attributes)</string,></span> </span>{</span><br><span class="line">	String name = (String) attributes.get(<span class="string">"serviceId"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(name)) {</span><br><span class="line">		name = (String) attributes.get(<span class="string">"name"</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(name)) {</span><br><span class="line">		name = (String) attributes.get(<span class="string">"value"</span>);</span><br><span class="line">	}</span><br><span class="line">	name = resolve(name);</span><br><span class="line">	<span class="keyword">return</span> getName(name);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 获取contextId， 获取顺序为contextId、serviceId、name、value</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 如果存在contextId，contextId将代替name属性用作bean的name，但不会用作服务id。</span></span><br><span class="line"><span class="comment">* 这个配置非常有用，如果不设置这个属性，那么<span class="doctag">@FeignClient</span>注解的同1个name属性值不能出现在多个接口上</span></span><br><span class="line"><span class="comment">* why? 因为不设置contextId属性的话，那么bean的名称就是name属性了，</span></span><br><span class="line"><span class="comment">* 如果多个接口调用同1个服务（多个接口上的<span class="doctag">@FeignClient</span>注解的的name属性值相同），那么就会出现相同名称的bean了，</span></span><br><span class="line"><span class="comment">* 而spring默认是不允许bean覆盖的，当然你可以通过设置spring.bean.allowOverridde=true来允许bean覆盖，</span></span><br><span class="line"><span class="comment">* 但这是一个隐患非常大的危险做法，强烈建议不要这么做。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 看到这里的getContextId方法就应该知道contextId与name的区别了吧</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getContextId</span><span class="params">(Map<string, object> attributes)</string,></span> </span>{</span><br><span class="line">	String contextId = (String) attributes.get(<span class="string">"contextId"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(contextId)) {</span><br><span class="line">		<span class="comment">// 未设置contextId属性时，使用serviceId、name、value</span></span><br><span class="line">		<span class="keyword">return</span> getName(attributes);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	contextId = resolve(contextId);</span><br><span class="line">	<span class="comment">// 验证contextId是否是有效的URI</span></span><br><span class="line">	<span class="keyword">return</span> getName(contextId);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// @FeignClinet注解的属性(contextId、serviceId、name、value)支持${keyProperty}环境变量</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">resolve</span><span class="params">(String value)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(value)) {</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.environment.resolvePlaceholders(value);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证http[s]://name是否是1个有效的URI</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">getName</span><span class="params">(String name)</span> </span>{</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(name)) {</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	String host = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		String url;</span><br><span class="line">		<span class="keyword">if</span> (!name.startsWith(<span class="string">"http://"</span>) && !name.startsWith(<span class="string">"https://"</span>)) {</span><br><span class="line">			url = <span class="string">"http://"</span> + name;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			url = name;</span><br><span class="line">		}</span><br><span class="line">		host = <span class="keyword">new</span> URI(url).getHost();</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">catch</span> (URISyntaxException e) {</span><br><span class="line">	}</span><br><span class="line">	Assert.state(host != <span class="keyword">null</span>, <span class="string">"Service id not legal hostname ("</span> + name + <span class="string">")"</span>);</span><br><span class="line">	<span class="keyword">return</span> name;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>registerFeignClient</code>方法主要是将<code>FeignClientFactoryBean</code>工厂<code>Bean</code>注册到registry中，spring初始化后，会调用<code>FeignClientFactoryBean</code>的getObject方法创建bean注册到spring context中。</p>
<h2 id="2-9、FeignClientFactoryBean-创建feign客户端的工厂"><a href="#2-9、FeignClientFactoryBean-创建feign客户端的工厂" class="headerlink" title="2.9、FeignClientFactoryBean 创建feign客户端的工厂"></a>2.9、FeignClientFactoryBean 创建feign客户端的工厂</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeignClientFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span><<span class="title">Object</span>>, <span class="title">InitializingBean</span>, <span class="title">ApplicationContextAware</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> Class<!--?--> type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String contextId;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> decode404;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class<!--?--> fallback = <span class="keyword">void</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class<!--?--> fallbackFactory = <span class="keyword">void</span><span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p><code>FeignClientFactoryBean</code>实现了<code>FactoryBean</code>接口，是一个工厂bean</p>
<p>![](<a href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229142123.png" target="_blank" rel="noopener">https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229142123.png</a></p>
<h3 id="2-9-1、FeignClientFactoryBean-getObject方法"><a href="#2-9-1、FeignClientFactoryBean-getObject方法" class="headerlink" title="2.9.1、FeignClientFactoryBean.getObject方法"></a>2.9.1、FeignClientFactoryBean.getObject方法</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">	<span class="keyword">return</span> getTarget();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><t> <span class="function">T <span class="title">getTarget</span><span class="params">()</span> </span>{</t></span><br><span class="line">	<span class="comment">// FeignContext在FeignAutoConfiguration中自动注册，FeignContext用于客户端配置类独立注册，后面具体分析</span></span><br><span class="line">	<span class="comment">// 这行代码会导致FeignAutoConfiguration中的FeignContext创建</span></span><br><span class="line">	FeignContext context = <span class="keyword">this</span>.applicationContext.getBean(FeignContext<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="comment">// 创建Feign.Builder对象</span></span><br><span class="line">	Feign.Builder builder = feign(context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果@FeignClient注解没有设置url参数</span></span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(<span class="keyword">this</span>.url)) {</span><br><span class="line">		<span class="comment">// url为@FeignClient注解的name参数</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.name.startsWith(<span class="string">"http"</span>)) {</span><br><span class="line">			<span class="comment">// 例如 http://md-admin-web</span></span><br><span class="line">			<span class="keyword">this</span>.url = <span class="string">"http://"</span> + <span class="keyword">this</span>.name;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			<span class="comment">// @FeignClient注解的name属性以http开头的</span></span><br><span class="line">			<span class="keyword">this</span>.url = <span class="keyword">this</span>.name;</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//加上path</span></span><br><span class="line">		<span class="keyword">this</span>.url += cleanPath();</span><br><span class="line">		<span class="comment">// 返回loadBlance客户端，也就是ribbon+eureka的客户端</span></span><br><span class="line">		<span class="keyword">return</span> (T) loadBalance(builder, context,</span><br><span class="line">							   <span class="keyword">new</span> HardCodedTarget<>(<span class="keyword">this</span>.type, <span class="keyword">this</span>.name, <span class="keyword">this</span>.url));</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//@FeignClient设置了url参数，不做负载均衡</span></span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.url) && !<span class="keyword">this</span>.url.startsWith(<span class="string">"http"</span>)) {</span><br><span class="line">		<span class="keyword">this</span>.url = <span class="string">"http://"</span> + <span class="keyword">this</span>.url;</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//加上path</span></span><br><span class="line">	String url = <span class="keyword">this</span>.url + cleanPath();</span><br><span class="line">	<span class="comment">//从FeignContext中获取client</span></span><br><span class="line">	Client client = getOptional(context, Client<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">if</span> (client <span class="keyword">instanceof</span> LoadBalancerFeignClient) {</span><br><span class="line">			<span class="comment">// 有url参数，不做负载均衡，但是客户端是ribbon，或者实际的客户端</span></span><br><span class="line">			client = ((LoadBalancerFeignClient) client).getDelegate();</span><br><span class="line">		}</span><br><span class="line">		builder.client(client);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 从FeignContext中获取Targeter</span></span><br><span class="line">	Targeter targeter = get(context, Targeter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	<span class="comment">// 生成客户端代理</span></span><br><span class="line">	<span class="keyword">return</span> (T) targeter.target(<span class="keyword">this</span>, builder, context, <span class="keyword">new</span> HardCodedTarget<>(<span class="keyword">this</span>.type, <span class="keyword">this</span>.name, url));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这段代码有个比较重要的逻辑，如果在<code>@FeignClient</code>注解中设置了url参数，就不走Ribbon，直接url调用，否则通过Ribbon调用，实现客户端负载均衡。</p>
<p>可以看到，生成Feign客户端所需要的各种配置对象，都是通过<code>FeignContex</code>中获取的。</p>
<h3 id="2-9-2、FeignContext-隔离配置"><a href="#2-9-2、FeignContext-隔离配置" class="headerlink" title="2.9.2、FeignContext 隔离配置"></a>2.9.2、FeignContext 隔离配置</h3><p>在<code>@FeignClient</code>注解参数<code>configuration</code>，指定的类是Spring的Configuration Bean，里面方法上加<code>@Bean</code>注解实现Bean的注入，可以指定feign客户端的各种配置，包括<code>Encoder/Decoder/Contract/Feign.Builder</code>等。<strong>不同的客户端指定不同配置类，就需要对配置类进行隔离</strong>，<code>FeignContext</code>就是用于隔离配置的。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignContext</span> <span class="keyword">extends</span> <span class="title">NamedContextFactory</span><<span class="title">FeignClientSpecification</span>> </span>{</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FeignContext</span><span class="params">()</span> </span>{</span><br><span class="line">		super(FeignClientsConfiguration.class, "feign", "feign.client.name");</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p><code>FeignContext</code>继承<code>NamedContextFactory</code>，空参数构造函数指定<code>FeignClientsConfiguration</code>类为默认配置。<br><code>NamedContextFactory</code>实现接口<code>ApplicationContextAware</code>，注入<code>ApplicationContextAware</code>作为parent：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这里的泛型C是FeignClientSpecification</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedContextFactory</span><<span class="title">C</span> <span class="keyword">extends</span> <span class="title">NamedContextFactory</span>.<span class="title">Specification</span>></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">DisposableBean</span>, <span class="title">ApplicationContextAware</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String propertySourceName;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String propertyName;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//命名空间对应的Spring Context</span></span><br><span class="line">	<span class="keyword">private</span> Map<string, annotationconfigapplicationcontext> contexts = <span class="keyword">new</span> ConcurrentHashMap<>();</string,></span><br><span class="line">	<span class="comment">//不同命名空间的定义</span></span><br><span class="line">	<span class="keyword">private</span> Map<string, c> configurations = <span class="keyword">new</span> ConcurrentHashMap<>();</string,></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ApplicationContext parent;</span><br><span class="line">	<span class="comment">//默认配置类</span></span><br><span class="line">	<span class="keyword">private</span> Class<!--?--> defaultConfigType;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 设置配置，在FeignAutoConfiguration中将Spring Context中的所有FeignClientSpecification设置进来</span></span><br><span class="line">	<span class="comment">// 1. 如果@EnableFeignClients有设置参数defaultConfiguration也会加进来，前面已经分析</span></span><br><span class="line">	<span class="comment">// 在registerDefaultConfiguration方法中注册的FeignClientSpecification Bean</span></span><br><span class="line">	<span class="comment">// 2. @FeignClient注解的configuration属性配置也会加进来</span></span><br><span class="line">	<span class="comment">// 在registerFeignClients()方法中注册的FeignClientSpecification Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigurations</span><span class="params">(List<c> configurations)</c></span> </span>{</span><br><span class="line">		<span class="keyword">for</span> (C client : configurations) {</span><br><span class="line">			<span class="keyword">this</span>.configurations.put(client.getName(), client);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取指定命名空间的ApplicationContext，先从缓存中获取，没有就创建</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AnnotationConfigApplicationContext <span class="title">getContext</span><span class="params">(String name)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.contexts.containsKey(name)) {</span><br><span class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>.contexts) {</span><br><span class="line">				<span class="keyword">if</span> (!<span class="keyword">this</span>.contexts.containsKey(name)) {</span><br><span class="line">					<span class="keyword">this</span>.contexts.put(name, createContext(name));</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.contexts.get(name);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 合并默认配置(default.xxx)和私有配置(name对应的配置)</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AnnotationConfigApplicationContext <span class="title">createContext</span><span class="params">(String name)</span> </span>{</span><br><span class="line">		<span class="comment">// 新建AnnotationConfigApplicationContext</span></span><br><span class="line">		AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">		<span class="comment">// 根据name在configurations找到所有的配置类，注册到context中</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.configurations.containsKey(name)) {</span><br><span class="line">			<span class="keyword">for</span> (Class<!--?--> configuration : <span class="keyword">this</span>.configurations.get(name)</span><br><span class="line">					.getConfiguration()) {</span><br><span class="line">				context.register(configuration);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 将default.开头的默认配置也注册到Context中</span></span><br><span class="line">		<span class="keyword">for</span> (Map.Entry<string, c> entry : <span class="keyword">this</span>.configurations.entrySet()) {</string,></span><br><span class="line">			<span class="keyword">if</span> (entry.getKey().startsWith(<span class="string">"default."</span>)) {</span><br><span class="line">				<span class="keyword">for</span> (Class<!--?--> configuration : entry.getValue().getConfiguration()) {</span><br><span class="line">					context.register(configuration);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 注册默认配置bean， 对于feign而言就是FeignContext的构造方法中传入的FeignClientsConfiguration</span></span><br><span class="line">		context.register(PropertyPlaceholderAutoConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">this</span>.<span class="title">defaultConfigType</span>)</span>;</span><br><span class="line">		<span class="comment">// 注册解析feign.client.name配置的MapPropertySource bean</span></span><br><span class="line">		context.getEnvironment().getPropertySources().addFirst(<span class="keyword">new</span> MapPropertySource(</span><br><span class="line">				<span class="keyword">this</span>.propertySourceName,</span><br><span class="line">				Collections.<string, object>singletonMap(<span class="keyword">this</span>.propertyName, name)));</string,></span><br><span class="line">		<span class="comment">// 设置parent</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// Uses Environment from parent as well as beans</span></span><br><span class="line">			context.setParent(<span class="keyword">this</span>.parent);</span><br><span class="line">			<span class="comment">// jdk11 issue</span></span><br><span class="line">			<span class="comment">// https://github.com/spring-cloud/spring-cloud-netflix/issues/3101</span></span><br><span class="line">			context.setClassLoader(<span class="keyword">this</span>.parent.getClassLoader());</span><br><span class="line">		}</span><br><span class="line">		context.setDisplayName(generateDisplayName(name));</span><br><span class="line">		<span class="comment">// 刷新，完成bean生成</span></span><br><span class="line">		context.refresh();</span><br><span class="line">		<span class="keyword">return</span> context;	</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 从命名空间中获取指定类型的Bean</span></span><br><span class="line">	<span class="keyword">public</span> <t> <span class="function">T <span class="title">getInstance</span><span class="params">(String name, Class<t> type)</t></span> </span>{</t></span><br><span class="line">		AnnotationConfigApplicationContext context = getContext(name);</span><br><span class="line">		<span class="keyword">if</span> (BeanFactoryUtils.beanNamesForTypeIncludingAncestors(context,</span><br><span class="line">				type).length > <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">return</span> context.getBean(type);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 从命名空间中获取指定类型的Bean</span></span><br><span class="line">	<span class="keyword">public</span> <t> <span class="function">Map<string, t> <span class="title">getInstances</span><span class="params">(String name, Class<t> type)</t></span> </string,></span>{</t></span><br><span class="line">		AnnotationConfigApplicationContext context = getContext(name);</span><br><span class="line">		<span class="keyword">if</span> (BeanFactoryUtils.beanNamesForTypeIncludingAncestors(context,</span><br><span class="line">				type).length > <span class="number">0</span>) {</span><br><span class="line">			<span class="keyword">return</span> BeanFactoryUtils.beansOfTypeIncludingAncestors(context, type);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>关键的方法是<code>createContext</code>，为每个命名空间独立创建的<code>ApplicationContext</code>，设置parent为外部传入的Context，这样就可以共用外部的Context中的Bean，又有各种独立的配置Bean，熟悉springMVC的同学应该知道，springMVC中创建的<code>WebApplicatonContext</code>里面也有个parent，原理跟这个类似。</p>
<p>从<code>FeignContext</code>中获取Bean，需要传入命名空间，根据命名空间找到缓存中的<code>ApplicationContext</code>，先从自己注册的<code>Bean</code>中获取bean，没有获取到再从到parent中获取。</p>
<h3 id="2-9-3、创建Feign-Builder"><a href="#2-9-3、创建Feign-Builder" class="headerlink" title="2.9.3、创建Feign.Builder"></a>2.9.3、创建Feign.Builder</h3><p>了解了<code>FeignContext</code>的原理，我们再来看feign最重要的构建类创建过程</p>
<p>在<code>FeignClientFactoryBean</code>的<code>getTarget</code>方法中调用了<code>feign()</code>方法返回了<code>Feign.Builder</code>对象：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeignClientFactoryBean</span></span></span><br><span class="line"><span class="class">	<span class="keyword">implements</span> <span class="title">FactoryBean</span><<span class="title">Object</span>>, <span class="title">InitializingBean</span>, <span class="title">ApplicationContextAware</span> </span>{</span><br><span class="line"></span><br><span class="line">	<t> <span class="function">T <span class="title">getTarget</span><span class="params">()</span> </span>{</t></span><br><span class="line">		Feign.Builder builder = feign(context);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">protected</span> Feign.<span class="function">Builder <span class="title">feign</span><span class="params">(FeignContext context)</span> </span>{</span><br><span class="line">		<span class="comment">// 从FeignContext中获取注册的FeignLoggerFactory日志工厂bean</span></span><br><span class="line">		FeignLoggerFactory loggerFactory = get(context, FeignLoggerFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 创建feign的Logger接口的日志实现bean</span></span><br><span class="line">		Logger logger = loggerFactory.create(<span class="keyword">this</span>.type);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 从FeignContext中获取注册的Feign.Builder bean，设置Encoder/Decoder/Contract</span></span><br><span class="line">		Feign.Builder builder = get(context, Feign.Builder<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">			// 这里的都是必须的配置， </span></span><br><span class="line"><span class="class">			// 需要注意的是这里的<span class="title">get</span>(<span class="title">context</span>, <span class="title">xx</span>.<span class="title">class</span>)都是先从自身命名空间上下文中找<span class="title">bean</span>（私有配置），</span></span><br><span class="line"><span class="class">			// 如果找不到会从父上下文中找<span class="title">bean</span>使用全局配置, 这就是为什么@<span class="title">FeignClient</span>的<span class="title">configuration</span>属性可以没有的原因。</span></span><br><span class="line"><span class="class">			</span></span><br><span class="line"><span class="class">			// 配置日志实现，默认<span class="title">Slf4jLogger</span></span></span><br><span class="line"><span class="class">			.<span class="title">logger</span>(<span class="title">logger</span>)</span></span><br><span class="line"><span class="class">			// 配置<span class="title">form</span>、<span class="title">bdoy</span>参数编码器, 默认<span class="title">SpringEncoder</span></span></span><br><span class="line"><span class="class">			.<span class="title">encoder</span>(<span class="title">get</span>(<span class="title">context</span>, <span class="title">Encoder</span>.<span class="title">class</span>)) </span></span><br><span class="line"><span class="class">			 // 配置响应解码器,默认<span class="title">OptionalDecoder</span>(持有<span class="title">SpringDecoder</span>)</span></span><br><span class="line"><span class="class">			.<span class="title">decoder</span>(<span class="title">get</span>(<span class="title">context</span>, <span class="title">Decoder</span>.<span class="title">class</span>))</span></span><br><span class="line"><span class="class">			// 配置契约实现<span class="title">SpringMvcContract</span></span></span><br><span class="line"><span class="class">			.<span class="title">contract</span>(<span class="title">get</span>(<span class="title">context</span>, <span class="title">Contract</span>.<span class="title">class</span>))</span>; </span><br><span class="line"></span><br><span class="line">		<span class="comment">// 配置feign的其他可选参数</span></span><br><span class="line">		configureFeign(context, builder);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> builder;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 配置feign其他参数</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureFeign</span><span class="params">(FeignContext context, Feign.Builder builder)</span> </span>{</span><br><span class="line">		FeignClientProperties properties = <span class="keyword">this</span>.applicationContext.getBean(FeignClientProperties<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (properties != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 判断client的独立可选配置是否可以覆盖全局的可选配置</span></span><br><span class="line">			<span class="keyword">if</span> (properties.isDefaultToProperties()) {</span><br><span class="line">				<span class="comment">// 配置可选参数，全局的可选配置可以被client独立的配置覆盖</span></span><br><span class="line">				<span class="comment">// 配置可选配置（日志级别、拦截器、重试、查询参数编码器、错误解码器、是否解码404响应）</span></span><br><span class="line">				configureUsingConfiguration(context, builder);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 使用feign.client.config.default的默认配置</span></span><br><span class="line">				configureUsingProperties(properties.getConfig().get(properties.getDefaultConfig()), builder);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 使用feign.client.config.{contextId}的feign client独立的配置，</span></span><br><span class="line">				<span class="comment">// 这样达到了默认使用全局配置，每个client又可以覆盖全局默认配置，实现配置个性化的目的</span></span><br><span class="line">				configureUsingProperties(properties.getConfig().get(<span class="keyword">this</span>.contextId), builder);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="comment">// 使用feign.client.config.default的默认配置</span></span><br><span class="line">				configureUsingProperties(properties.getConfig().get(properties.getDefaultConfig()), builder);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 使用feign.client.config.{contextId}的feign client独立的配置，</span></span><br><span class="line">				<span class="comment">// 这样达到了默认使用全局配置，每个client又可以覆盖全局默认配置，实现配置个性化的目的</span></span><br><span class="line">				configureUsingProperties(properties.getConfig().get(<span class="keyword">this</span>.contextId), builder);</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 配置可选参数，全局的可选配置覆盖client独立的配置</span></span><br><span class="line">				<span class="comment">// 配置可选配置（日志级别、拦截器、重试、查询参数编码器、错误解码器、是否解码404响应）</span></span><br><span class="line">				configureUsingConfiguration(context, builder);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			<span class="comment">// 配置可选配置（日志级别、拦截器、重试、查询参数编码器、错误解码器、是否解码404响应）</span></span><br><span class="line">			configureUsingConfiguration(context, builder);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureUsingConfiguration</span><span class="params">(FeignContext context, Feign.Builder builder)</span> </span>{</span><br><span class="line">		<span class="comment">// 获取可选配置：日志级别</span></span><br><span class="line">		Logger.Level level = getOptional(context, Logger.Level<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (level != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 设置日志级别</span></span><br><span class="line">			builder.logLevel(level);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 获取可选配置：重试条件</span></span><br><span class="line">		Retryer retryer = getOptional(context, Retryer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (retryer != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 设置重试条件</span></span><br><span class="line">			builder.retryer(retryer);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 获取可选配置：错误解码器（非2xx、不解码404时的使用它将响应数据翻译为相应的异常抛出）</span></span><br><span class="line">		ErrorDecoder errorDecoder = getOptional(context, ErrorDecoder<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (errorDecoder != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 设置错误解码器</span></span><br><span class="line">			builder.errorDecoder(errorDecoder);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 获取可选配置：http请求相关参数(connectTimeout、readTimeout等，</span></span><br><span class="line">		<span class="comment">// 它会传递给具体的发送http请求的client， 例如ApacheHttpClient、OkHttpClient等)</span></span><br><span class="line">		Request.Options options = getOptional(context, Request.Options<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (options != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 设置http请求相关参数</span></span><br><span class="line">			builder.options(options);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 获取可选配置：发送请求前的拦截器</span></span><br><span class="line">		Map<string, requestinterceptor> requestInterceptors = context.getInstances(<span class="keyword">this</span>.contextId, RequestInterceptor<span class="class">.<span class="keyword">class</span>)</span>;</string,></span><br><span class="line">		<span class="keyword">if</span> (requestInterceptors != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 设置请求拦截器</span></span><br><span class="line">			builder.requestInterceptors(requestInterceptors.values());</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 获取可选配置：查询参数编码器</span></span><br><span class="line">		<span class="comment">// 用于将方法参数的java bean、Map对象序列化为http请求url的?后的查询参数，如a=b&c=d</span></span><br><span class="line">		QueryMapEncoder queryMapEncoder = getOptional(context, QueryMapEncoder<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (queryMapEncoder != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 设置查询参数编码器</span></span><br><span class="line">			builder.queryMapEncoder(queryMapEncoder);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//是否解码404响应</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.decode404) {</span><br><span class="line">			<span class="comment">// 设置当响应状态码为404时是否使用decoder解码response，</span></span><br><span class="line">			<span class="comment">// 若该参数为false，则会使用errorDecoder翻译为相应的异常抛出</span></span><br><span class="line">			builder.decode404();</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>feign()方法设置了<code>Feign.Builder</code>所必须的参数<code>Encoder</code>/<code>Decoder</code>/<code>Contract</code>，其他参数都是可选的。这三个必须的参数从哪里来的呢？答案是在<code>FeignContext</code>的构造器中，传入了默认的配置<code>FeignClientsConfiguration</code>，这个配置类里面初始化了这三个参数。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignClientsConfiguration</span> </span>{</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ObjectFactory<httpmessageconverters> messageConverters;</httpmessageconverters></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> List<annotatedparameterprocessor> parameterProcessors = <span class="keyword">new</span> ArrayList<>();</annotatedparameterprocessor></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> List<feignformatterregistrar> feignFormatterRegistrars = <span class="keyword">new</span> ArrayList<>();</feignformatterregistrar></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> Logger logger;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> SpringDataWebProperties springDataWebProperties;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Decoder bean，默认通过HttpMessageConverters进行处理</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Decoder <span class="title">feignDecoder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> OptionalDecoder(</span><br><span class="line">			<span class="keyword">new</span> ResponseEntityDecoder(<span class="keyword">new</span> SpringDecoder(<span class="keyword">this</span>.messageConverters)));</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Encoder bean，默认通过HttpMessageConverters进行处理</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingClass</span>(<span class="string">"org.springframework.data.domain.Pageable"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Encoder <span class="title">feignEncoder</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SpringEncoder(<span class="keyword">this</span>.messageConverters);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Encoder bean</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(name = <span class="string">"org.springframework.data.domain.Pageable"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Encoder <span class="title">feignEncoderPageable</span><span class="params">()</span> </span>{</span><br><span class="line">		PageableSpringEncoder encoder = <span class="keyword">new</span> PageableSpringEncoder(</span><br><span class="line">			<span class="keyword">new</span> SpringEncoder(<span class="keyword">this</span>.messageConverters));</span><br><span class="line">		<span class="keyword">if</span> (springDataWebProperties != <span class="keyword">null</span>) {</span><br><span class="line">			encoder.setPageParameter(</span><br><span class="line">				springDataWebProperties.getPageable().getPageParameter());</span><br><span class="line">			encoder.setSizeParameter(</span><br><span class="line">				springDataWebProperties.getPageable().getSizeParameter());</span><br><span class="line">			encoder.setSortParameter(</span><br><span class="line">				springDataWebProperties.getSort().getSortParameter());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> encoder;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Contract bean，通过SpringMvcContract进行处理接口</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Contract <span class="title">feignContract</span><span class="params">(ConversionService feignConversionService)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SpringMvcContract(<span class="keyword">this</span>.parameterProcessors, feignConversionService);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FormattingConversionService <span class="title">feignConversionService</span><span class="params">()</span> </span>{</span><br><span class="line">		FormattingConversionService conversionService = <span class="keyword">new</span> DefaultFormattingConversionService();</span><br><span class="line">		<span class="keyword">for</span> (FeignFormatterRegistrar feignFormatterRegistrar : <span class="keyword">this</span>.feignFormatterRegistrars) {</span><br><span class="line">			feignFormatterRegistrar.registerFormatters(conversionService);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> conversionService;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//默认不重试</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Retryer <span class="title">feignRetryer</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Retryer.NEVER_RETRY;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认的builder</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">(Retryer retryer)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Feign.builder().retryer(retryer);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 日志工厂</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(FeignLoggerFactory<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	<span class="title">public</span> <span class="title">FeignLoggerFactory</span> <span class="title">feignLoggerFactory</span>() </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultFeignLoggerFactory(<span class="keyword">this</span>.logger);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// jackson处理spring data的Page对象</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(name = <span class="string">"org.springframework.data.domain.Page"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Module <span class="title">pageJacksonModule</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> PageJacksonModule();</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 存在hystrix时，hystrix自动注入</span></span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>({ HystrixCommand<span class="class">.<span class="keyword">class</span>, <span class="title">HystrixFeign</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class">	<span class="title">protected</span> <span class="title">static</span> <span class="title">class</span> <span class="title">HystrixFeignConfiguration</span> </span>{</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// HystrixFeign的builder，全局关掉Hystrix配置feign.hystrix.enabled=false</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">		<span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"feign.hystrix.enabled"</span>)</span><br><span class="line">		<span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignHystrixBuilder</span><span class="params">()</span> </span>{</span><br><span class="line">			<span class="keyword">return</span> HystrixFeign.builder();</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到，feign需要的decoder/enoder通过适配器共用springMVC中的<code>HttpMessageConverters</code>引入。</p>
<p>feign有自己的注解体系，这里通过<code>SpringMvcContract</code>适配了springMVC的注解体系。</p>
<h3 id="2-9-4、SpringMvcContract-适配feign注解体系"><a href="#2-9-4、SpringMvcContract-适配feign注解体系" class="headerlink" title="2.9.4、SpringMvcContract 适配feign注解体系"></a>2.9.4、SpringMvcContract 适配feign注解体系</h3><p>SpringMvcContract继承了feign的类<code>Contract.BaseContract</code>，作用是解析接口方法上的注解和方法参数，生成<code>MethodMetadata</code>用于接口方法调用过程中组装http请求。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringMvcContract</span> <span class="keyword">extends</span> <span class="title">Contract</span>.<span class="title">BaseContract</span> <span class="keyword">implements</span> <span class="title">ResourceLoaderAware</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MethodMetadata <span class="title">parseAndValidateMetadata</span><span class="params">(Class<!--?--> targetType, Method method)</span> </span>{</span><br><span class="line">		<span class="keyword">this</span>.processedMethods.put(Feign.configKey(targetType, method), method);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 调用父类Contract.BaseContract的处理逻辑</span></span><br><span class="line">		<span class="comment">// 而父类处理过程中会调用processAnnotationOnClass、processAnnotationOnMethod、processAnnotationsOnParameter</span></span><br><span class="line">		<span class="comment">// 这3个方法来解析类、方法、参数上的注解，SpringMvcContract通过重写了这3个方法解析spring mvc自己的</span></span><br><span class="line">		<span class="comment">// @RequestMapping、@RequestParam、@RequestBody、@GetMapping...等等注解</span></span><br><span class="line">		<span class="comment">// 来实现利用spring这套解决方案实现微服务间互相调用的闭环</span></span><br><span class="line">		MethodMetadata md = <span class="keyword">super</span>.parseAndValidateMetadata(targetType, method);</span><br><span class="line"></span><br><span class="line">		RequestMapping classAnnotation = findMergedAnnotation(targetType, RequestMapping<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (classAnnotation != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// produces - use from class annotation only if method has not specified this</span></span><br><span class="line">			<span class="keyword">if</span> (!md.template().headers().containsKey(ACCEPT)) {</span><br><span class="line">				parseProduces(md, method, classAnnotation);</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="comment">// consumes -- use from class annotation only if method has not specified this</span></span><br><span class="line">			<span class="keyword">if</span> (!md.template().headers().containsKey(CONTENT_TYPE)) {</span><br><span class="line">				parseConsumes(md, method, classAnnotation);</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="comment">// headers -- class annotation is inherited to methods, always write these if</span></span><br><span class="line">			<span class="comment">// present</span></span><br><span class="line">			parseHeaders(md, method, classAnnotation);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> md;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 处理class上的注解</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAnnotationOnClass</span><span class="params">(MethodMetadata data, Class<!--?--> clz)</span> </span>{</span><br><span class="line">		...省略代码</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 处理方法上的注解：<span class="doctag">@RequestMapping</span>、</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processAnnotationOnMethod</span><span class="params">(MethodMetadata data,</span></span></span><br><span class="line"><span class="function"><span class="params">			Annotation methodAnnotation, Method method)</span> </span>{</span><br><span class="line">		...省略代码</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 处理参数上的注解</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processAnnotationsOnParameter</span><span class="params">(MethodMetadata data,</span></span></span><br><span class="line"><span class="function"><span class="params">			Annotation[] annotations, <span class="keyword">int</span> paramIndex)</span> </span>{</span><br><span class="line">		...省略代码</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>几个覆盖方法分别是处理类上的注解，处理方法，处理方法上的注解，处理方法参数注解，最终生成完整的<code>MethodMetadata</code>。feign自己提供的Contract和扩展javax.ws.rx的Contract原理都是类似的。</p>
<h2 id="2-9-5、FeignAutoConfiguration"><a href="#2-9-5、FeignAutoConfiguration" class="headerlink" title="2.9.5、FeignAutoConfiguration"></a>2.9.5、FeignAutoConfiguration</h2><p><code>Feign.Builder</code>生成后，就要用Target生成feign客户端的动态代理，这里<code>FeignClientFactoryBean</code>中使用<code>Targeter</code>，Targeter有两个实现类，分别是<code>HystrixTargeter</code>和<code>DefaultTargeter</code>，那么默认的Targeter又是怎么来的呢？</p>
<p>在spring-cloud-openfeign-core项目的<code>META-INF\spring.factories</code>文件中有<code>FeignAutoConfiguration</code>的自动化配置，关于spring.factories自动化配置的原理见<a href="https://my.oschina.net/zhaopeng2012/blog/3144983" target="_blank" rel="noopener" title="springboot2.2自动注入文件spring.factories如何加载详解">springboot2.2自动注入文件spring.factories如何加载详解</a></p>
<ul>
<li><p><strong>spring.factories</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.cloud.openfeign.ribbon.FeignRibbonClientAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.hateoas.FeignHalAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.FeignAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.encoding.FeignAcceptGzipEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.encoding.FeignContentGzipEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.loadbalancer.FeignLoadBalancerAutoConfiguration</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><strong>FeignAutoConfiguration</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(Feign<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(</span>{ FeignClientProperties<span class="class">.<span class="keyword">class</span>, <span class="title">FeignHttpClientProperties</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(<span class="title">DefaultGzipDecoderConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">FeignAutoConfiguration</span> </span>{</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> 	* FeignClientSpecification包含了feign配置类，配置来源有2种：</span></span><br><span class="line"><span class="comment">	* 1. <span class="doctag">@EnableFeignClients</span>注解的defaultConfiguration属性注册时（全局默认配置），name为default.xxx</span></span><br><span class="line"><span class="comment">	* 2. <span class="doctag">@FeignClient</span>注解的configuration属性注册时（服务私有配置），name为contextId、name、value属性的值</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 有2个地方会调用该方法产生FeignClientSpecification：</span></span><br><span class="line"><span class="comment">	* 1. FeignClientsRegistrar.registerDefaultConfiguration()</span></span><br><span class="line"><span class="comment">	* 2. FeignClientsRegistrar.registerFeignClients()</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> List<feignclientspecification> configurations = <span class="keyword">new</span> ArrayList<>();</feignclientspecification></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* spring cloud commons项目中的HasFeatures，表示使用了Feign特性，用于spring boot actuator监控</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HasFeatures <span class="title">feignFeature</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> HasFeatures.namedFeature(<span class="string">"Feign"</span>, Feign<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 关键代码：feign客户端配置隔离的实现</span></span><br><span class="line"><span class="comment">	* 创建FeignClientSpecification， 每个feign客户端能够有各自私有的configuration就靠它了，</span></span><br><span class="line"><span class="comment">	* 他是命名空间隔离的applicationContext， 每个feign客户端都有自己的applicationContext</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FeignContext <span class="title">feignContext</span><span class="params">()</span> </span>{</span><br><span class="line">		FeignContext context = <span class="keyword">new</span> FeignContext();</span><br><span class="line">		<span class="comment">// 一定要注意这里把所有的配置都设置进去了</span></span><br><span class="line">		<span class="comment">// 包括@EnableFeignClients的全局defaultConfiguration和@FeignClient的私有configuration配置</span></span><br><span class="line">		<span class="comment">// FeignClientFactoryBean类中getTarget创建Feign.Bulider的get(context, beanType)都是从它里面取的</span></span><br><span class="line">		<span class="comment">// feign客户端自身的applicationContext取不到就到父applicationContext中去取，</span></span><br><span class="line">		<span class="comment">// 达到先取私有配置bean(例如encoder、client、logger、decoder、loggerLevel)，</span></span><br><span class="line">		<span class="comment">// 私有配置取不到再取全局配置bean的功能</span></span><br><span class="line">		context.setConfigurations(<span class="keyword">this</span>.configurations);</span><br><span class="line">		<span class="keyword">return</span> context;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 类路径中存在HystrixFeign这个类，使用hystrix实现的Targeter</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(name = <span class="string">"feign.hystrix.HystrixFeign"</span>)</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixFeignTargeterConfiguration</span> </span>{</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 实现了熔断降级功能的Targeter</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Targeter <span class="title">feignTargeter</span><span class="params">()</span> </span>{</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> HystrixTargeter();</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 类路径中没有HystrixFeign这个类，使用默认实现DefaultTargeter</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingClass</span>(<span class="string">"feign.hystrix.HystrixFeign"</span>)</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFeignTargeterConfiguration</span> </span>{</span><br><span class="line">		</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Targeter <span class="title">feignTargeter</span><span class="params">()</span> </span>{</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> DefaultTargeter();</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 引入了feign-httpclient.jar，使用apache HttpClient发送请求</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(ApacheHttpClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">	@ConditionalOnMissingClass("com.netflix.loadbalancer.ILoadBalancer")</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(CloseableHttpClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">ConditionalOnProperty</span>(<span class="title">value</span> </span>= <span class="string">"feign.httpclient.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientFeignConfiguration</span> </span>{</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span>(Client<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">		<span class="title">public</span> <span class="title">Client</span> <span class="title">feignClient</span>(<span class="title">HttpClient</span> <span class="title">httpClient</span>) </span>{</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ApacheHttpClient(httpClient);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 引入了feign-okhttp.jar， 使用okhttp发送请求</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(OkHttpClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">	@ConditionalOnMissingClass("com.netflix.loadbalancer.ILoadBalancer")</span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(okhttp3.OkHttpClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">	@ConditionalOnProperty("feign.okhttp.enabled")</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpFeignConfiguration</span> </span>{</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="keyword">public</span> okhttp3.<span class="function">OkHttpClient <span class="title">client</span><span class="params">(OkHttpClientFactory httpClientFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">				ConnectionPool connectionPool,</span></span></span><br><span class="line"><span class="function"><span class="params">				FeignHttpClientProperties httpClientProperties)</span> </span>{</span><br><span class="line">			Boolean followRedirects = httpClientProperties.isFollowRedirects();</span><br><span class="line">			Integer connectTimeout = httpClientProperties.getConnectionTimeout();</span><br><span class="line">			Boolean disableSslValidation = httpClientProperties.isDisableSslValidation();</span><br><span class="line">			<span class="keyword">this</span>.okHttpClient = httpClientFactory.createBuilder(disableSslValidation)</span><br><span class="line">					.connectTimeout(connectTimeout, TimeUnit.MILLISECONDS)</span><br><span class="line">					.followRedirects(followRedirects).connectionPool(connectionPool)</span><br><span class="line">					.build();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.okHttpClient;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>


</li>
</ul>
<ul>
<li><strong>@FeignClient配置隔离体系总结</strong></li>
</ul>
<p>需要注意的是<code>FeignAutoConfiguration</code>中的bean都是默认的全局配置， 而每个<code>@FeignClient</code>都可以有其私有的configuration属性配置，在<code>FeignClientFactoryBean.feign()</code>方法中创建<code>Feign.builder().enocder(xx).decoder(xxx).targeter()</code>时调用的<br><code>get(context, xx.class)</code>方法都是先从自身命名空间上下文中找bean（私有配置），如果找不到会从父上下文中找bean使用全局配置, 这就是为什么<code>@FeignClient的configuration</code>属性可以没有的原因。</p>
<h3 id="2-9-6、Targeter-生成接口动态代理"><a href="#2-9-6、Targeter-生成接口动态代理" class="headerlink" title="2.9.6、Targeter 生成接口动态代理"></a>2.9.6、Targeter 生成接口动态代理</h3><ul>
<li><strong>DefaultTargeter</strong></li>
</ul>
<p><code>DefaultTargeter</code>很简单，直接调用<code>HardCodedTarget</code>生成动态代理，<code>HystrixTargeter</code>源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultTargeter</span> <span class="keyword">implements</span> <span class="title">Targeter</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <t> <span class="function">T <span class="title">target</span><span class="params">(FeignClientFactoryBean factory, Feign.Builder feign,</span></span></t></span><br><span class="line"><span class="function"><span class="params">			FeignContext context, Target.HardCodedTarget<t> target)</t></span> </span>{</span><br><span class="line">		<span class="comment">// 直接由feign自身的实现产生jdk 动态代理工厂产生代理对象</span></span><br><span class="line">		<span class="keyword">return</span> feign.target(target);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><p><strong>HystrixTargeter</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HystrixTargeter</span> <span class="keyword">implements</span> <span class="title">Targeter</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <t> <span class="function">T <span class="title">target</span><span class="params">(FeignClientFactoryBean factory, Feign.Builder feign,</span></span></t></span><br><span class="line"><span class="function"><span class="params">			FeignContext context, Target.HardCodedTarget<t> target)</t></span> </span>{</span><br><span class="line">		<span class="comment">// 如果不是HystrixFeign.Builder，直接调用target生成代理</span></span><br><span class="line">		<span class="keyword">if</span> (!(feign <span class="keyword">instanceof</span> feign.hystrix.HystrixFeign.Builder)) {</span><br><span class="line">			<span class="keyword">return</span> feign.target(target);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">	</span><br><span class="line">		feign.hystrix.HystrixFeign.Builder builder = (feign.hystrix.HystrixFeign.Builder) feign;</span><br><span class="line">		<span class="comment">// 优先使用contextId属性,  如果contextId为空则使用name属性</span></span><br><span class="line">		String name = StringUtils.isEmpty(factory.getContextId()) ? factory.getName()</span><br><span class="line">				: factory.getContextId();</span><br><span class="line">		<span class="comment">// context是配置隔离的applicationContext</span></span><br><span class="line">		<span class="comment">// 优先取client私有配置中的SetterFactory，若未配置私有的，则取全局默认的</span></span><br><span class="line">		SetterFactory setterFactory = getOptional(name, context, SetterFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 私有的或全局的配置了SetterFactory</span></span><br><span class="line">		<span class="keyword">if</span> (setterFactory != <span class="keyword">null</span>) {</span><br><span class="line">			builder.setterFactory(setterFactory);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//找到fallback或者fallbackFactory，设置到hystrix中</span></span><br><span class="line">		Class<!--?--> fallback = factory.getFallback();</span><br><span class="line">		<span class="keyword">if</span> (fallback != <span class="keyword">void</span><span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">			<span class="keyword">return</span> targetWithFallback(name, context, target, builder, fallback);</span><br><span class="line">		}</span><br><span class="line">		Class<!--?--> fallbackFactory = factory.getFallbackFactory();</span><br><span class="line">		<span class="keyword">if</span> (fallbackFactory != <span class="keyword">void</span><span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">			<span class="keyword">return</span> targetWithFallbackFactory(name, context, target, builder,</span><br><span class="line">					fallbackFactory);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 无降级策略，直接调用target生成代理</span></span><br><span class="line">		<span class="keyword">return</span> feign.target(target);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <t> <span class="function">T <span class="title">targetWithFallbackFactory</span><span class="params">(String feignClientName, </span></span></t></span><br><span class="line"><span class="function"><span class="params">							FeignContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">							Target.HardCodedTarget<t> target, </t></span></span></span><br><span class="line"><span class="function"><span class="params">							HystrixFeign.Builder builder,</span></span></span><br><span class="line"><span class="function"><span class="params">							Class<!--?--> fallbackFactoryClass)</span> </span>{</span><br><span class="line">		</span><br><span class="line">		FallbackFactory<!--? extends T--> fallbackFactory = (FallbackFactory<!--? extends T-->) getFromContext(</span><br><span class="line">			<span class="string">"fallbackFactory"</span>, feignClientName, context, fallbackFactoryClass,</span><br><span class="line">			FallbackFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">return</span> builder.target(target, fallbackFactory);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <t> <span class="function">T <span class="title">targetWithFallback</span><span class="params">(String feignClientName, </span></span></t></span><br><span class="line"><span class="function"><span class="params">					FeignContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">					Target.HardCodedTarget<t> target, </t></span></span></span><br><span class="line"><span class="function"><span class="params">					HystrixFeign.Builder builder,</span></span></span><br><span class="line"><span class="function"><span class="params">					Class<!--?--> fallback)</span> </span>{</span><br><span class="line">		</span><br><span class="line">		T fallbackInstance = getFromContext(<span class="string">"fallback"</span>, feignClientName, context, fallback, target.type());</span><br><span class="line">		<span class="keyword">return</span> builder.target(target, fallbackInstance);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
<li><p>HystrixFeign.Builder</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixFeign</span> </span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> <span class="keyword">extends</span> <span class="title">feign</span>.<span class="title">Feign</span>.<span class="title">Builder</span> </span>{</span><br><span class="line">		<span class="keyword">private</span> Contract contract = <span class="keyword">new</span> Default();</span><br><span class="line">		<span class="keyword">private</span> SetterFactory setterFactory = <span class="keyword">new</span> feign.hystrix.SetterFactory.Default();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <t> <span class="function">T <span class="title">target</span><span class="params">(Target<t> target, T fallback)</t></span> </span>{</t></span><br><span class="line">			<span class="keyword">return</span> build(fallback != <span class="keyword">null</span> ? <span class="keyword">new</span> FallbackFactory.Default<t>(fallback) : <span class="keyword">null</span>).newInstance(target);</t></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">public</span> <t> <span class="function">T <span class="title">target</span><span class="params">(Target<t> target, FallbackFactory<!--? extends T--> fallbackFactory)</t></span> </span>{</t></span><br><span class="line">			<span class="keyword">return</span> build(fallbackFactory).newInstance(target);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="function">Feign <span class="title">build</span><span class="params">(<span class="keyword">final</span> FallbackFactory<!--?--> nullableFallbackFactory)</span> </span>{</span><br><span class="line">			<span class="comment">// 替换掉Feign.Bulider中默认的</span></span><br><span class="line">			<span class="comment">// private InvocationHandlerFactory invocationHandlerFactory = new InvocationHandlerFactory.Default();</span></span><br><span class="line">			<span class="comment">// 由此可知当hystrix启用时feign客户端的动态代理实现是在HystrixInvocationHandler中</span></span><br><span class="line">			<span class="comment">// 也就是说我们在contrller层调用feign客户端(例如UserFeignClient)时会进入到HystrixInvocationHandler中</span></span><br><span class="line">			<span class="comment">// 拦截方法调用</span></span><br><span class="line">			<span class="keyword">super</span>.invocationHandlerFactory(<span class="keyword">new</span> InvocationHandlerFactory() {</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> InvocationHandler <span class="title">create</span><span class="params">(Target target, Map<method, methodhandler> dispatch)</method,></span> </span>{</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">new</span> HystrixInvocationHandler(target, dispatch, setterFactory, nullableFallbackFactory);</span><br><span class="line">				}</span><br><span class="line">			});</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">super</span>.contract(<span class="keyword">new</span> HystrixDelegatingContract(contract));</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">super</span>.build();</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>HystrixInvocationHandler</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Target<!--?--> target;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<method, methodhandler> dispatch;</method,></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> FallbackFactory<!--?--> fallbackFactory; <span class="comment">// Nullable</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<method, method> fallbackMethodMap;</method,></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map<method, setter> setterMethodMap;</method,></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Object proxy, <span class="keyword">final</span> Method method, <span class="keyword">final</span> Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">		...省略部分代码</span><br><span class="line">			</span><br><span class="line">		HystrixCommand<object> hystrixCommand = <span class="keyword">new</span> HystrixCommand<object>(setterMethodMap.get(method)) {<br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">protected</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">					<span class="keyword">try</span> {</span><br><span class="line">						<span class="keyword">return</span> HystrixInvocationHandler.<span class="keyword">this</span>.dispatch.get(method).invoke(args);</span><br><span class="line">					} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">						<span class="keyword">throw</span> e;</span><br><span class="line">					} <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">						<span class="keyword">throw</span> (Error) t;</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">protected</span> Object <span class="title">getFallback</span><span class="params">()</span> </span>{</span><br><span class="line">					<span class="keyword">if</span> (fallbackFactory == <span class="keyword">null</span>) {</span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">super</span>.getFallback();</span><br><span class="line">					}</span><br><span class="line">					<span class="keyword">try</span> {</span><br><span class="line">						Object fallback = fallbackFactory.create(getExecutionException());</span><br><span class="line">						Object result = fallbackMethodMap.get(method).invoke(fallback, args);</span><br><span class="line">						<span class="keyword">if</span> (isReturnsHystrixCommand(method)) {</span><br><span class="line">							<span class="keyword">return</span> ((HystrixCommand) result).execute();</span><br><span class="line">						} <span class="keyword">else</span> <span class="keyword">if</span> (isReturnsObservable(method)) {</span><br><span class="line">							<span class="comment">// Create a cold Observable</span></span><br><span class="line">							<span class="keyword">return</span> ((Observable) result).toBlocking().first();</span><br><span class="line">						} <span class="keyword">else</span> <span class="keyword">if</span> (isReturnsSingle(method)) {</span><br><span class="line">							<span class="comment">// Create a cold Observable as a Single</span></span><br><span class="line">							<span class="keyword">return</span> ((Single) result).toObservable().toBlocking().first();</span><br><span class="line">						} <span class="keyword">else</span> <span class="keyword">if</span> (isReturnsCompletable(method)) {</span><br><span class="line">							((Completable) result).await();</span><br><span class="line">							<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">						} <span class="keyword">else</span> <span class="keyword">if</span> (isReturnsCompletableFuture(method)) {</span><br><span class="line">							<span class="keyword">return</span> ((Future) result).get();</span><br><span class="line">						} <span class="keyword">else</span> {</span><br><span class="line">							<span class="keyword">return</span> result;</span><br><span class="line">						}</span><br><span class="line">					} <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line">						<span class="comment">// shouldn't happen as method is public due to being an interface</span></span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e);</span><br><span class="line">					} <span class="keyword">catch</span> (InvocationTargetException | ExecutionException e) {</span><br><span class="line">						<span class="comment">// Exceptions on fallback are tossed by Hystrix</span></span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e.getCause());</span><br><span class="line">					} <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">						<span class="comment">// Exceptions on fallback are tossed by Hystrix</span></span><br><span class="line">						Thread.currentThread().interrupt();</span><br><span class="line">						<span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(e.getCause());</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">		};</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 是jdk8的接口中的default方法，直接执行</span></span><br><span class="line">		<span class="keyword">if</span> (Util.isDefault(method)) {</span><br><span class="line">			<span class="keyword">return</span> hystrixCommand.execute();</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 返回值是HystrixCommand类型，不真正执行，直接返回上面创建的hystrixCommand</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (isReturnsHystrixCommand(method)) {</span><br><span class="line">			<span class="keyword">return</span> hystrixCommand;</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//返回值类型是Observable</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (isReturnsObservable(method)) {</span><br><span class="line">			<span class="comment">// Create a cold Observable</span></span><br><span class="line">			<span class="keyword">return</span> hystrixCommand.toObservable();</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 返回值类型是Single</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (isReturnsSingle(method)) {</span><br><span class="line">			<span class="comment">// Create a cold Observable as a Single</span></span><br><span class="line">			<span class="keyword">return</span> hystrixCommand.toObservable().toSingle();</span><br><span class="line">		} </span><br><span class="line">		<span class="comment">// 返回值类型是Completable</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (isReturnsCompletable(method)) {</span><br><span class="line">			<span class="keyword">return</span> hystrixCommand.toObservable().toCompletable();</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 返回值类型是CompletableFuture</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (isReturnsCompletableFuture(method)) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ObservableCompletableFuture<>(hystrixCommand);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 其他情况直接执行</span></span><br><span class="line">		<span class="keyword">return</span> hystrixCommand.execute();</span><br><span class="line">		</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnsCompletable</span><span class="params">(Method method)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Completable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">method</span>.<span class="title">getReturnType</span>())</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnsHystrixCommand</span><span class="params">(Method method)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> HystrixCommand<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">method</span>.<span class="title">getReturnType</span>())</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnsObservable</span><span class="params">(Method method)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Observable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">method</span>.<span class="title">getReturnType</span>())</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnsCompletableFuture</span><span class="params">(Method method)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> CompletableFuture<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">method</span>.<span class="title">getReturnType</span>())</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReturnsSingle</span><span class="params">(Method method)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Single<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">method</span>.<span class="title">getReturnType</span>())</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></object></object></span></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<h2 id="3、loadBalance方法，客户端负载均衡"><a href="#3、loadBalance方法，客户端负载均衡" class="headerlink" title="3、loadBalance方法，客户端负载均衡"></a>3、loadBalance方法，客户端负载均衡</h2><h3 id="3-1、loadBalance方法的调用"><a href="#3-1、loadBalance方法的调用" class="headerlink" title="3.1、loadBalance方法的调用"></a>3.1、loadBalance方法的调用</h3><p>如果<code>@FeignClient</code>注解中没有配置url参数，将会通过<code>loadBalance</code>方法生成Ribbon的动态代理：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeignClientFactoryBean</span></span></span><br><span class="line"><span class="class">	<span class="keyword">implements</span> <span class="title">FactoryBean</span><<span class="title">Object</span>>, <span class="title">InitializingBean</span>, <span class="title">ApplicationContextAware</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String contextId;</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">		</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">		<span class="keyword">return</span> getTarget();</span><br><span class="line">	}</span><br><span class="line">		</span><br><span class="line">	<t> <span class="function">T <span class="title">getTarget</span><span class="params">()</span> </span>{</t></span><br><span class="line">		...省略部分代码</span><br><span class="line">			</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(<span class="keyword">this</span>.url)) {</span><br><span class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.name.startsWith(<span class="string">"http"</span>)) {</span><br><span class="line">				<span class="keyword">this</span>.url = <span class="string">"http://"</span> + <span class="keyword">this</span>.name;</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">this</span>.url = <span class="keyword">this</span>.name;</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">this</span>.url += cleanPath();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">return</span> (T) loadBalance(builder, context,</span><br><span class="line">					<span class="keyword">new</span> HardCodedTarget<>(<span class="keyword">this</span>.type, <span class="keyword">this</span>.name, <span class="keyword">this</span>.url));</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		...省略部分代码</span><br><span class="line">	}</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">protected</span> <t> <span class="function">T <span class="title">loadBalance</span><span class="params">(Feign.Builder builder, FeignContext context,</span></span></t></span><br><span class="line"><span class="function"><span class="params">								HardCodedTarget<t> target)</t></span> </span>{</span><br><span class="line">		<span class="comment">// 这里获取到的Client是LoadBalancerFeignClient</span></span><br><span class="line">		Client client = getOptional(context, Client<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br><span class="line">			builder.client(client);</span><br><span class="line">			Targeter targeter = get(context, Targeter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			<span class="keyword">return</span> targeter.target(<span class="keyword">this</span>, builder, context, target);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">			<span class="string">"No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?"</span>);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="3-2、FeignRibbonClientAutoConfiguration"><a href="#3-2、FeignRibbonClientAutoConfiguration" class="headerlink" title="3.2、FeignRibbonClientAutoConfiguration"></a>3.2、FeignRibbonClientAutoConfiguration</h3><p>之前我们我们已经分析过在spring-cloud-openfeign-core项目的<code>META-INF\spring.factories</code>文件中有<code>FeignAutoConfiguration</code>的自动化配置，这里我们可以看到<code>spring.factories</code>文件里面还有个<code>FeignRibbonClientAutoConfiguration</code>自动化配置类，从名称就可以知道它与负载均衡相关。</p>
<ul>
<li><p><strong>spring.factories</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.cloud.openfeign.ribbon.FeignRibbonClientAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.hateoas.FeignHalAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.FeignAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.encoding.FeignAcceptGzipEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.encoding.FeignContentGzipEncodingAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.openfeign.loadbalancer.FeignLoadBalancerAutoConfiguration</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><strong>FeignRibbonClientAutoConfiguration</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnClass</span>({ ILoadBalancer<span class="class">.<span class="keyword">class</span>, <span class="title">Feign</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">value</span> </span>= <span class="string">"spring.cloud.loadbalancer.ribbon.enabled"</span>,</span><br><span class="line">		matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(FeignAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(</span>{ FeignHttpClientProperties<span class="class">.<span class="keyword">class</span> })</span></span><br><span class="line"><span class="class">// <span class="title">Order</span> <span class="title">is</span> <span class="title">important</span> <span class="title">here</span>, <span class="title">last</span> <span class="title">should</span> <span class="title">be</span> <span class="title">the</span> <span class="title">default</span>, <span class="title">first</span> <span class="title">should</span> <span class="title">be</span> <span class="title">optional</span></span></span><br><span class="line"><span class="class">// <span class="title">see</span></span></span><br><span class="line">// https://github.com/spring-cloud/spring-cloud-netflix/issues/2086#issuecomment-316281653</span><br><span class="line"><span class="meta">@Import</span>({ HttpClientFeignLoadBalancedConfiguration<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">OkHttpFeignLoadBalancedConfiguration</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">DefaultFeignLoadBalancedConfiguration</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">FeignRibbonClientAutoConfiguration</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>可以看到它引入了HttpClientFeignLoadBalancedConfiguration、OkHttpFeignLoadBalancedConfiguration、DefaultFeignLoadBalancedConfiguration这3个类，我们接下来先看不引入apache http client、okhttp这些http库时的执行流程</p>
</li>
<li><p>LoadBalancerFeignClient的创建</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultFeignLoadBalancedConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Client <span class="title">feignClient</span><span class="params">(CachingSpringLoadBalancerFactory cachingFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">			SpringClientFactory clientFactory)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LoadBalancerFeignClient(<span class="keyword">new</span> Client.Default(<span class="keyword">null</span>, <span class="keyword">null</span>), cachingFactory,</span><br><span class="line">				clientFactory);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>LoadBalancerFeignClient</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadBalancerFeignClient</span> <span class="keyword">implements</span> <span class="title">Client</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> Request.Options DEFAULT_OPTIONS = <span class="keyword">new</span> Request.Options();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Client delegate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> CachingSpringLoadBalancerFactory lbClientFactory;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SpringClientFactory clientFactory;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> request 是feign自身的Request对象，持有发送http请求的Client实现</span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> options  http请求的相关配置(connectTimeout、readTimeout)</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="comment">//获取URI</span></span><br><span class="line">			URI asUri = URI.create(request.url());</span><br><span class="line">			<span class="comment">//获取客户端的名称</span></span><br><span class="line">			String clientName = asUri.getHost();</span><br><span class="line">			URI uriWithoutHost = cleanUrl(request.url(), clientName);</span><br><span class="line">			<span class="comment">//创建RibbonRequest</span></span><br><span class="line">			FeignLoadBalancer.RibbonRequest ribbonRequest = <span class="keyword">new</span> FeignLoadBalancer.RibbonRequest(</span><br><span class="line">				<span class="keyword">this</span>.delegate, request, uriWithoutHost);</span><br><span class="line">			<span class="comment">//配置</span></span><br><span class="line">			IClientConfig requestConfig = getClientConfig(options, clientName);</span><br><span class="line">			<span class="comment">//获取FeignLoadBalancer，发请求，转换Response</span></span><br><span class="line">			<span class="keyword">return</span> lbClient(clientName)</span><br><span class="line">				.executeWithLoadBalancer(ribbonRequest, requestConfig).toResponse();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (ClientException e) {</span><br><span class="line">			IOException io = findIOException(e);</span><br><span class="line">			<span class="keyword">if</span> (io != <span class="keyword">null</span>) {</span><br><span class="line">				<span class="keyword">throw</span> io;</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> FeignLoadBalancer <span class="title">lbClient</span><span class="params">(String clientName)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.lbClientFactory.create(clientName);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>CachingSpringLoadBalancerFactory</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingSpringLoadBalancerFactory</span> </span>{</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> SpringClientFactory factory;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> LoadBalancedRetryFactory loadBalancedRetryFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">volatile</span> Map<string, feignloadbalancer> cache = <span class="keyword">new</span> ConcurrentReferenceHashMap<>();</string,></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FeignLoadBalancer <span class="title">create</span><span class="params">(String clientName)</span> </span>{</span><br><span class="line">		<span class="comment">// 先从缓存获取，缓存中没有再创建</span></span><br><span class="line">		FeignLoadBalancer client = <span class="keyword">this</span>.cache.get(clientName);</span><br><span class="line">		<span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">return</span> client;</span><br><span class="line">		}</span><br><span class="line">		IClientConfig config = <span class="keyword">this</span>.factory.getClientConfig(clientName);</span><br><span class="line">		<span class="comment">// 取出负载均衡实现</span></span><br><span class="line">		ILoadBalancer lb = <span class="keyword">this</span>.factory.getLoadBalancer(clientName);</span><br><span class="line">		ServerIntrospector serverIntrospector = <span class="keyword">this</span>.factory.getInstance(clientName, ServerIntrospector<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 创建FeignLoadBalancer或带有重试功能的RetryableFeignLoadBalancer</span></span><br><span class="line">		client = <span class="keyword">this</span>.loadBalancedRetryFactory != <span class="keyword">null</span></span><br><span class="line">			? <span class="keyword">new</span> RetryableFeignLoadBalancer(lb, config, serverIntrospector, <span class="keyword">this</span>.loadBalancedRetryFactory)</span><br><span class="line">			: <span class="keyword">new</span> FeignLoadBalancer(lb, config, serverIntrospector);</span><br><span class="line">		<span class="comment">// 放到内存缓存中</span></span><br><span class="line">		<span class="keyword">this</span>.cache.put(clientName, client);</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>FeignLoadBalancer</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignLoadBalancer</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">	<span class="title">AbstractLoadBalancerAwareClient</span><<span class="title">FeignLoadBalancer</span>.<span class="title">RibbonRequest</span>, <span class="title">FeignLoadBalancer</span>.<span class="title">RibbonResponse</span>> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RibbonProperties ribbon;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> connectTimeout;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> readTimeout;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> IClientConfig clientConfig;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> ServerIntrospector serverIntrospector;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 注意此时的RibbonRequest参数的url属性已经从抽象的服务名经过ribbon负载均衡算法变成具体的域名或ip地址了</span></span><br><span class="line"><span class="comment">	* 负载均衡的逻辑在其父类AbstractLoadBalancerAwareClient.executeWithLoadBalancer()方法中</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RibbonResponse <span class="title">execute</span><span class="params">(RibbonRequest request, IClientConfig configOverride)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IOException </span>{</span><br><span class="line">		<span class="comment">// http请求相关配置（connectTimeout、readTimeout）</span></span><br><span class="line">		Request.Options options;</span><br><span class="line">		<span class="keyword">if</span> (configOverride != <span class="keyword">null</span>) {</span><br><span class="line">			RibbonProperties override = RibbonProperties.from(configOverride);</span><br><span class="line">			options = <span class="keyword">new</span> Request.Options(override.connectTimeout(<span class="keyword">this</span>.connectTimeout),</span><br><span class="line">										  override.readTimeout(<span class="keyword">this</span>.readTimeout));</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			options = <span class="keyword">new</span> Request.Options(<span class="keyword">this</span>.connectTimeout, <span class="keyword">this</span>.readTimeout);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 关键代码： request.client()返回的是feign的Client接口的实现(OkHttpClient、ApacheHttpClient)</span></span><br><span class="line">		<span class="comment">// 它是在FeignClientFactoryBean.loadBalance()方法中将Client的实现设置到Feign.Builder中的</span></span><br><span class="line">		<span class="comment">// 这里调用http请求框架真正发送请求获取响应</span></span><br><span class="line">		Response response = request.client().execute(request.toRequest(), options);</span><br><span class="line">		<span class="comment">// 将feign的Reponse对象包装为ribbon的response</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> RibbonResponse(request.getUri(), response);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p>AbstractLoadBalancerAwareClient</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractLoadBalancerAwareClient</span><<span class="title">S</span> <span class="keyword">extends</span> <span class="title">ClientRequest</span>, <span class="title">T</span> <span class="keyword">extends</span> <span class="title">IResponse</span>> <span class="keyword">extends</span> <span class="title">LoadBalancerContext</span> <span class="keyword">implements</span> <span class="title">IClient</span><<span class="title">S</span>, <span class="title">T</span>>, <span class="title">IClientConfigAware</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">executeWithLoadBalancer</span><span class="params">(<span class="keyword">final</span> S request, <span class="keyword">final</span> IClientConfig requestConfig)</span> <span class="keyword">throws</span> ClientException </span>{</span><br><span class="line">		LoadBalancerCommand<t> command = buildLoadBalancerCommand(request, requestConfig);</t></span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="comment">// LoadBalancerCommand.submit()方法里面使用了rx-java，看起来很复杂。。。</span></span><br><span class="line">			<span class="keyword">return</span> command.submit(</span><br><span class="line">				<span class="keyword">new</span> ServerOperation<t>() {</t></span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> Observable<t> <span class="title">call</span><span class="params">(Server server)</span> </t></span>{</span><br><span class="line">						<span class="comment">// 这里负载均衡已经完成, server就是通过负载均衡算法选择的服务实例</span></span><br><span class="line">						<span class="comment">// reconstructURIWithServer就是把抽象地址转换为server的具体域名或ip</span></span><br><span class="line">						<span class="comment">// 得到最终http请求url</span></span><br><span class="line">						URI finalUri = reconstructURIWithServer(server, request.getUri());</span><br><span class="line">						<span class="comment">// 将executeWithLoadBalancer方法参数的request中的uri替换成最终具体域名或ip的uri</span></span><br><span class="line">						S requestForServer = (S) request.replaceUri(finalUri);</span><br><span class="line">						<span class="keyword">try</span> {</span><br><span class="line">							<span class="comment">// 调用了IClient接口中声明的 T execute(S request, IClientConfig requestConfig) 方法</span></span><br><span class="line">							<span class="comment">// 该方法由该类的子类FeignLoadBalancer实现了，来真正发出http请求</span></span><br><span class="line">							<span class="keyword">return</span> Observable.just(AbstractLoadBalancerAwareClient.<span class="keyword">this</span>.execute(requestForServer, requestConfig));</span><br><span class="line">						} </span><br><span class="line">						<span class="keyword">catch</span> (Exception e) {</span><br><span class="line">							<span class="keyword">return</span> Observable.error(e);</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">				})</span><br><span class="line">				.toBlocking()</span><br><span class="line">				.single();</span><br><span class="line">		} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">			Throwable t = e.getCause();</span><br><span class="line">			<span class="keyword">if</span> (t <span class="keyword">instanceof</span> ClientException) {</span><br><span class="line">				<span class="keyword">throw</span> (ClientException) t;</span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> ClientException(e);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> LoadBalancerCommand<t> <span class="title">buildLoadBalancerCommand</span><span class="params">(<span class="keyword">final</span> S request, <span class="keyword">final</span> IClientConfig config)</span> </t></span>{</span><br><span class="line">		RequestSpecificRetryHandler handler = getRequestSpecificRetryHandler(request, config);</span><br><span class="line">		LoadBalancerCommand.Builder<t> builder = LoadBalancerCommand.<t>builder()</t></t></span><br><span class="line">			.withLoadBalancerContext(<span class="keyword">this</span>)</span><br><span class="line">			.withRetryHandler(handler)</span><br><span class="line">			.withLoadBalancerURI(request.getUri());</span><br><span class="line">		customizeLoadBalancerCommandBuilder(request, config, builder);</span><br><span class="line">		<span class="keyword">return</span> builder.build();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<h3 id="3-3、FeignLoadBalancerAutoConfiguration"><a href="#3-3、FeignLoadBalancerAutoConfiguration" class="headerlink" title="3.3、FeignLoadBalancerAutoConfiguration"></a>3.3、<strong>FeignLoadBalancerAutoConfiguration</strong></h3><p>具有负载均衡功能的feign自动配置, </p>
<p>注意<br><strong>@AutoConfigureAfter(FeignRibbonClientAutoConfiguration.class)</strong><br>这个自动化配置条件，表明这个类的自动化配置在<code>FeignRibbonClientAutoConfiguration</code>之后才执行，回顾上面的<br><code>FeignRibbonClientAutoConfiguration</code>的执行流程可以知道，当启用ribbon时，<code>FeignRibbonClientAutoConfiguration</code>引入的3个类<br><code>HttpClientFeignLoadBalancedConfiguration</code>、<code>OkHttpFeignLoadBalancedConfiguration</code>、<code>DefaultFeignLoadBalancedConfiguration</code>本身会创建Feign的<code>Client</code>接口的实现<code>LoadBalancerFeignClient</code>，所以由<code>FeignLoadBalancerAutoConfiguration</code>自动化配置的<code>FeignBlockingLoadBalancerClient</code>不会被创建，因为<code>Client</code>接口<code>的实现已经由</code>FeignRibbonClientAutoConfiguration<code>的自动化配置创建好了</code>LoadBalancerFeignClient`。</p>
<p><strong>下面的源码分析建立在spring.cloud.loadbalancer.ribbon.enabled=false的情况下进行分析的</strong></p>
<ul>
<li>FeignLoadBalancerAutoConfiguration源码如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnClass</span>(Feign<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnBean</span>(<span class="title">BlockingLoadBalancerClient</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureBefore</span>(<span class="title">FeignAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(<span class="title">FeignRibbonClientAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">FeignHttpClientProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Configuration</span>(<span class="title">proxyBeanMethods</span> </span>= <span class="keyword">false</span>)</span><br><span class="line"><span class="comment">// Order is important here, last should be the default, first should be optional</span></span><br><span class="line"><span class="comment">// see</span></span><br><span class="line"><span class="comment">// https://github.com/spring-cloud/spring-cloud-netflix/issues/2086#issuecomment-316281653</span></span><br><span class="line"><span class="meta">@Import</span>({ HttpClientFeignLoadBalancerConfiguration<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">OkHttpFeignLoadBalancerConfiguration</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">DefaultFeignLoadBalancerConfiguration</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">FeignLoadBalancerAutoConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>可以看到同时引入了带有负载均衡功能的apache httpclient、okhttp及默认实现的feign client实现</p>
<ul>
<li>DefaultFeignLoadBalancerConfiguration</li>
</ul>
<p>Client.Default底层使用jdk自带的HttpURLConnection发送请求</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultFeignLoadBalancerConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Client <span class="title">feignClient</span><span class="params">(BlockingLoadBalancerClient loadBalancerClient)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FeignBlockingLoadBalancerClient(<span class="keyword">new</span> Client.Default(<span class="keyword">null</span>, <span class="keyword">null</span>),</span><br><span class="line">				loadBalancerClient);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<ul>
<li>OkHttpFeignLoadBalancerConfiguration<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(OkHttpClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">@ConditionalOnProperty("feign.okhttp.enabled")</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(BlockingLoadBalancerClient<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(<span class="title">OkHttpFeignConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">OkHttpFeignLoadBalancerConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Client <span class="title">feignClient</span><span class="params">(okhttp3.OkHttpClient okHttpClient,</span></span></span><br><span class="line"><span class="function"><span class="params">			BlockingLoadBalancerClient loadBalancerClient)</span> </span>{</span><br><span class="line">		OkHttpClient delegate = <span class="keyword">new</span> OkHttpClient(okHttpClient);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FeignBlockingLoadBalancerClient(delegate, loadBalancerClient);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p>可以看到无论是<code>DefaultFeignLoadBalancerConfiguration</code>还是<code>OkHttpFeignLoadBalancerConfiguration</code>都是使用<code>FeignBlockingLoadBalancerClient</code>，传入了具体http请求的实现，可以知道具体的负载均衡功能是由<code>FeignBlockingLoadBalancerClient</code>实现的</p>
<ul>
<li>FeignBlockingLoadBalancerClient<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeignBlockingLoadBalancerClient</span> <span class="keyword">implements</span> <span class="title">Client</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Client delegate;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BlockingLoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">		<span class="keyword">final</span> URI originalUri = URI.create(request.url());</span><br><span class="line">		String serviceId = originalUri.getHost();</span><br><span class="line">		Assert.state(serviceId != <span class="keyword">null</span>,</span><br><span class="line">					 <span class="string">"Request URI does not contain a valid hostname: "</span> + originalUri);</span><br><span class="line">		<span class="comment">// 使用负载均衡实现选择服务实例</span></span><br><span class="line">		ServiceInstance instance = loadBalancerClient.choose(serviceId);</span><br><span class="line">		<span class="keyword">if</span> (instance == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 无可用实例</span></span><br><span class="line">			String message = <span class="string">"Load balancer does not contain an instance for the service "</span></span><br><span class="line">				+ serviceId;</span><br><span class="line">			<span class="keyword">if</span> (LOG.isWarnEnabled()) {</span><br><span class="line">				LOG.warn(message);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">return</span> Response.builder().request(request)</span><br><span class="line">				.status(HttpStatus.SERVICE_UNAVAILABLE.value())</span><br><span class="line">				.body(message, StandardCharsets.UTF_8).build();</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 将抽象的服务名替换成具体的域名、ip地址</span></span><br><span class="line">		String reconstructedUrl = loadBalancerClient.reconstructURI(instance, originalUri)</span><br><span class="line">			.toString();</span><br><span class="line">		<span class="comment">// 重新构造请求</span></span><br><span class="line">		Request newRequest = Request.create(request.httpMethod(), reconstructedUrl,</span><br><span class="line">											request.headers(), request.requestBody());</span><br><span class="line">		<span class="comment">// 委托给Client的具体实现（(OkHttpClient、ApacheHttpClient)）真正发出http请求</span></span><br><span class="line">		<span class="keyword">return</span> delegate.execute(newRequest, options);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p>相比而言spring-cloud-loadbalancer与feign适配的代码比ribbon就简洁了很多很多。。。</p>
<h1 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h1><p>feign本身是一款优秀的开源组件，spring cloud feign又非常巧妙的将feign集成到spring boot中。<br>本文通过对spring cloud feign源代码的解读，详细的分析了feign集成到spring boot中的原理，使我们更加全面的了解到feign的使用。</p>
<p>spring cloud feign也是一个很好的学习spring boot的例子，从中我们可以学习到：</p>
<ul>
<li>spring boot注解声明注入bean</li>
<li>spring类扫描机制</li>
<li>spring接口动态注册bean</li>
<li>spring命名空间隔离ApplicationContext</li>
</ul>
<blockquote>
<p>文章大部分来源于：<a href="http://techblog.ppdai.com/2018/05/28/20180528/" target="_blank" rel="noopener">http://techblog.ppdai.com/2018/05/28/20180528/</a><br>本人在其基础上加入自己的理解</p>
</blockquote>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">calebzhao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://calebzhao.github.io/2019/12/29/spring-cloud-openfeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://calebzhao.github.io/2019/12/29/spring-cloud-openfeign%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://calebzhao.github.io">calebzhao的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring-cloud/">spring cloud    </a><a class="post-meta__tags" href="/tags/feign/">feign    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229151714.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229152519.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-full"><a href="/2019/12/29/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>java并发编程入门</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/12/29/feign使用教程/" title="feign使用教程"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">feign使用教程</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/Feign源码学习/" title="Feign源码学习"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Feign源码学习</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/06/spring cloud - bootstrapContext(一)/" title="spring cloud - bootstrapContext(一)"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring cloud - bootstrapContext(一)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/02/Spring中的ResolvableType/" title="Spring中的ResolvableType详解."><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring中的ResolvableType详解.</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring.factories自动化配置归类/" title="spring.factories自动化配置归类"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring.factories自动化配置归类</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/2、spring-cloud-ribbon源码分析/" title="2、spring cloud ribbon源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">2、spring cloud ribbon源码分析</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = '昵称,邮箱,链接'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'HgchHaGng3F6hbefP0mcTaYh-gzGzoHsz',
  appKey:'j47kWakblNYEeDic8riu7flK',
  placeholder:'请留下你的足迹',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By calebzhao</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div><img src="https://api.travis-ci.com/calebzhao/calebzhao.github.io.svg?branch=hexo"></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>