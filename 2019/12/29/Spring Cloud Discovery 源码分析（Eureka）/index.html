<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="never"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>3、Spring Cloud Discovery 源码分析（Eureka） | calebzhao的博客</title><meta name="description" content="3、Spring Cloud Discovery 源码分析（Eureka）"><meta name="keywords" content="spring cloud"><meta name="author" content="calebzhao"><meta name="copyright" content="calebzhao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229155709.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="3、Spring Cloud Discovery 源码分析（Eureka）"><meta name="twitter:description" content="3、Spring Cloud Discovery 源码分析（Eureka）"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="3、Spring Cloud Discovery 源码分析（Eureka）"><meta property="og:url" content="https://calebzhao.github.io/2019/12/29/Spring%20Cloud%20Discovery%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88Eureka%EF%BC%89/"><meta property="og:site_name" content="calebzhao的博客"><meta property="og:description" content="3、Spring Cloud Discovery 源码分析（Eureka）"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://calebzhao.github.io/2019/12/29/Spring%20Cloud%20Discovery%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88Eureka%EF%BC%89/"><link rel="prev" title="Spring Cloud Context总览" href="https://calebzhao.github.io/2019/12/29/Spring%20Cloud%20Context%E6%80%BB%E8%A7%88/"><link rel="next" title="feign使用教程" href="https://calebzhao.github.io/2019/12/29/feign%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"EU39VTKAPM","apiKey":"9108b7c9e302dddcc64205e00d26f470","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://calebzhao.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">calebzhao的博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Eureka-中的-region-和-Zone"><span class="toc_mobile_items-text">Eureka 中的 region 和 Zone</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#背景"><span class="toc_mobile_items-text">背景</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#概念"><span class="toc_mobile_items-text">概念</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#分区服务架构图"><span class="toc_mobile_items-text">分区服务架构图</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Eureka-中-Regin-和-Zone-的相关配置"><span class="toc_mobile_items-text">Eureka 中 Regin 和 Zone 的相关配置</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#服务调用"><span class="toc_mobile_items-text">服务调用</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#总结spring-cloud-nextflix-eureka-client启动流程："><span class="toc_mobile_items-text">总结spring-cloud-nextflix-eureka-client启动流程：</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Eureka-中的-region-和-Zone"><span class="toc-text">Eureka 中的 region 和 Zone</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#概念"><span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分区服务架构图"><span class="toc-text">分区服务架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-中-Regin-和-Zone-的相关配置"><span class="toc-text">Eureka 中 Regin 和 Zone 的相关配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务调用"><span class="toc-text">服务调用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结spring-cloud-nextflix-eureka-client启动流程："><span class="toc-text">总结spring-cloud-nextflix-eureka-client启动流程：</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">3、Spring Cloud Discovery 源码分析（Eureka）</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-12-29<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-01-10</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/spring-cloud/">spring cloud</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">9.6k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 38 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/12/29/Spring%20Cloud%20Discovery%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88Eureka%EF%BC%89/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/12/29/Spring%20Cloud%20Discovery%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88Eureka%EF%BC%89/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><p>我们在将一个普通的Spring Boot应用注册到Eureka Server中，或是从Eureka Server中获取服务列表时，主要就做了两件事：</p>
<ul>
<li>在应用主类he中配置了<code>@EnableDiscoveryClient</code>注解  </li>
<li>在<code>application.properties</code>中用<code>eureka.client.serviceUrl.defaultZone</code>参数指定了服务注册中心的位置  </li>
</ul>
<p>顺着上面的线索，我们先查看具体实现:</p>
<ul>
<li><strong>@EnableDiscoveryClient的源码如下:</strong><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Annotation to enable a DiscoveryClient implementation.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(EnableDiscoveryClientImportSelector<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">EnableDiscoveryClient</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * If true, the ServiceRegistry will automatically register the local server.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> - {<span class="doctag">@code</span> true} if you want to automatically register.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">autoRegister</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<code>@EnableDiscoveryClient</code>注解的作用主要是用来引入<code>EnableDiscoveryClientImportSelector</code>这个类</li>
</ul>
<ul>
<li><p><strong>EnableDiscoveryClientImportSelector的源码：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Order</span>(Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnableDiscoveryClientImportSelector</span></span></span><br><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">SpringFactoryImportSelector</span><<span class="title">EnableDiscoveryClient</span>> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) {</span><br><span class="line">		String[] imports = <span class="keyword">super</span>.selectImports(metadata);</span><br><span class="line"></span><br><span class="line">		AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">				metadata.getAnnotationAttributes(getAnnotationClass().getName(), <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">boolean</span> autoRegister = attributes.getBoolean(<span class="string">"autoRegister"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (autoRegister) {</span><br><span class="line">			List<string> importsList = <span class="keyword">new</span> ArrayList<>(Arrays.asList(imports));</string></span><br><span class="line">			importsList.add(</span><br><span class="line">					<span class="string">"org.springframework.cloud.client.serviceregistry.AutoServiceRegistrationConfiguration"</span>);</span><br><span class="line">			imports = importsList.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			Environment env = getEnvironment();</span><br><span class="line">			<span class="keyword">if</span> (ConfigurableEnvironment<span class="class">.<span class="keyword">class</span>.<span class="title">isInstance</span>(<span class="title">env</span>)) </span>{</span><br><span class="line">				ConfigurableEnvironment configEnv = (ConfigurableEnvironment) env;</span><br><span class="line">				LinkedHashMap<string, object> map = <span class="keyword">new</span> LinkedHashMap<>();</string,></span><br><span class="line">				map.put(<span class="string">"spring.cloud.service-registry.auto-registration.enabled"</span>, <span class="keyword">false</span>);</span><br><span class="line">				MapPropertySource propertySource = <span class="keyword">new</span> MapPropertySource(</span><br><span class="line">						<span class="string">"springCloudDiscoveryClient"</span>, map);</span><br><span class="line">				configEnv.getPropertySources().addLast(propertySource);</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> imports;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> getEnvironment().getProperty(<span class="string">"spring.cloud.discovery.enabled"</span>,</span><br><span class="line">				Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">Boolean</span>.<span class="title">TRUE</span>)</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">hasDefaultFactory</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p><code>EnableDiscoveryClientImportSelector</code>继承了<code>SpringFactoryImportSelector</code>并指定了泛型<code>EnableDiscoveryClient</code>. 这里的泛型是重点.</p>
</li>
<li><p><strong>SpringFactoryImportSelector源码</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Selects configurations to load, defined by the generic type T. Loads implementations</span></span><br><span class="line"><span class="comment"> * using {<span class="doctag">@link</span> SpringFactoriesLoader}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <t> type of annotation class</t></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringFactoryImportSelector</span><<span class="title">T</span>></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">EnvironmentAware</span> </span>{</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Log log = LogFactory.getLog(SpringFactoryImportSelector<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Class<t> annotationClass;</t></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">SpringFactoryImportSelector</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">this</span>.annotationClass = (Class<t>) GenericTypeResolver</t></span><br><span class="line">				.resolveTypeArgument(<span class="keyword">this</span>.getClass(), SpringFactoryImportSelector<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] selectImports(AnnotationMetadata metadata) {</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled()) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">		}</span><br><span class="line">		AnnotationAttributes attributes = AnnotationAttributes.fromMap(</span><br><span class="line">				metadata.getAnnotationAttributes(<span class="keyword">this</span>.annotationClass.getName(), <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">		Assert.notNull(attributes, <span class="string">"No "</span> + getSimpleName() + <span class="string">" attributes found. Is "</span></span><br><span class="line">				+ metadata.getClassName() + <span class="string">" annotated with @"</span> + getSimpleName() + <span class="string">"?"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Find all possible auto configuration classes, filtering duplicates</span></span><br><span class="line">		List<string> factories = <span class="keyword">new</span> ArrayList<>(<span class="keyword">new</span> LinkedHashSet<>(SpringFactoriesLoader</string></span><br><span class="line">				.loadFactoryNames(<span class="keyword">this</span>.annotationClass, <span class="keyword">this</span>.beanClassLoader)));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (factories.isEmpty() && !hasDefaultFactory()) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Annotation @"</span> + getSimpleName()</span><br><span class="line">					+ <span class="string">" found, but there are no implementations. Did you forget to include a starter?"</span>);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (factories.size() > <span class="number">1</span>) {</span><br><span class="line">			<span class="comment">// there should only ever be one DiscoveryClient, but there might be more than</span></span><br><span class="line">			<span class="comment">// one factory</span></span><br><span class="line">			<span class="keyword">this</span>.log.warn(<span class="string">"More than one implementation "</span> + <span class="string">"of @"</span> + getSimpleName()</span><br><span class="line">					+ <span class="string">" (now relying on @Conditionals to pick one): "</span> + factories);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> factories.toArray(<span class="keyword">new</span> String[factories.size()]);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">		</span><br><span class="line">	...省略</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这里只截取了部分变量和方法， <code>SpringFactoryImportSelector</code>是spring cloud common包中的一个抽象类, 主要作用是检查泛型T是否有指定的factory实现, 即<code>spring.factories</code>中有对应类的配置并启动自动化配置（由<code>SpringFactoriesLoader</code>加载并解析<code>spring.factories</code>文件, 具体加载原理见<a href="https://my.oschina.net/zhaopeng2012/blog/3144983" target="_blank" rel="noopener" title="springboot2.2自动注入文件spring.factories如何加载详解">springboot2.2自动注入文件spring.factories如何加载详解</a>）</p>
</li>
<li><p><strong>spring.factories</strong></p>
</li>
</ul>
<p>在<code>spring-cloud-netflix-eureka-client.jar!/META-INF/spring.factories</code>中<code>EnableDiscoveryClient</code>的指定factory实现是</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaClientConfigServerAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.ribbon.eureka.RibbonEurekaAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration,\</span><br><span class="line"><span class="attr">org.springframework.cloud.netflix.eureka.reactive.EurekaReactiveDiscoveryClientConfiguration</span></span><br><span class="line"></span><br><span class="line"><span class="meta">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><code>EnableAutoConfiguration</code>中包含了<code>EurekaClientAutoConfiguration</code>, <code>EurekaClientAutoConfiguration</code>会为```EurekaDiscoveryClientConfiguration`的实例依赖进行初始化。</p>
<p>下面对<code>spring.factories</code>中的eureka自动化配置一个个分析源码：</p>
<ul>
<li><strong>EurekaClientConfigServerAutoConfiguration 配置服务器自动化配置</strong><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>({ EurekaInstanceConfigBean<span class="class">.<span class="keyword">class</span>, <span class="title">EurekaClient</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">ConfigServerProperties</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">EurekaClientConfigServerAutoConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> EurekaInstanceConfig instance;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> ConfigServerProperties server;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.instance == <span class="keyword">null</span> || <span class="keyword">this</span>.server == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		}</span><br><span class="line">		String prefix = <span class="keyword">this</span>.server.getPrefix();</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(prefix) && !StringUtils</span><br><span class="line">				.hasText(<span class="keyword">this</span>.instance.getMetadataMap().get(<span class="string">"configPath"</span>))) {</span><br><span class="line">			<span class="keyword">this</span>.instance.getMetadataMap().put(<span class="string">"configPath"</span>, prefix);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p>从源码看到注入了<code>EurekaInstanceConfig instance</code>配置，<code>EurekaInstanceConfig</code>这个bean是在<code>org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration#eurekaInstanceConfigBean()</code>中创建的， 另外 init()方法上有<code>@PostConstruct</code>注解，说明在创建这个bean后执行了init()方法， 方法内部获取<code>ConfigServerProperties</code> 中的prefix, 如果<code>eureka.instance.metadata.configPath</code>没有配置，则使用prefix的值。</p>
<ul>
<li><strong>EurekaClientAutoConfiguration 客户端自动化配置</strong></li>
</ul>
<p>实例化application.yml中eureka.instance及eureka.client相关属性配置的bean以及创建EurekaClient</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(EurekaClientConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(<span class="title">DiscoveryClientOptionalArgsConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">value</span> </span>= <span class="string">"eureka.client.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@ConditionalOnDiscoveryEnabled</span></span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>({ NoopDiscoveryClientAutoConfiguration<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">		<span class="title">CommonsClientAutoConfiguration</span>.<span class="title">class</span>, <span class="title">ServiceRegistryAutoConfiguration</span>.<span class="title">class</span> })</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(<span class="title">name</span> </span>= {</span><br><span class="line">		<span class="string">"org.springframework.cloud.autoconfigure.RefreshAutoConfiguration"</span>,</span><br><span class="line">		<span class="string">"org.springframework.cloud.netflix.eureka.EurekaDiscoveryClientConfiguration"</span>,</span><br><span class="line">		<span class="string">"org.springframework.cloud.client.serviceregistry.AutoServiceRegistrationAutoConfiguration"</span> })</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientAutoConfiguration</span> </span>{</span><br><span class="line">	<span class="comment">// spring cloud commons中的HasFeatures, 声明了使用了Eureka Client这个特性</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> HasFeatures <span class="title">eurekaFeature</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> HasFeatures.namedFeature(<span class="string">"Eureka Client"</span>, EurekaClient<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 关键配置：eureka.client为前缀的相关配置属性bean(EurekaClientConfig的实现)</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(value = EurekaClientConfig<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">			<span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> EurekaClientConfigBean <span class="title">eurekaClientConfigBean</span><span class="params">(ConfigurableEnvironment env)</span> </span>{</span><br><span class="line">		EurekaClientConfigBean client = <span class="keyword">new</span> EurekaClientConfigBean();</span><br><span class="line">		<span class="keyword">if</span> (<span class="string">"bootstrap"</span>.equals(<span class="keyword">this</span>.env.getProperty(<span class="string">"spring.config.name"</span>))) {</span><br><span class="line">			<span class="comment">// We don't register during bootstrap by default, but there will be another</span></span><br><span class="line">			<span class="comment">// chance later.</span></span><br><span class="line">			client.setRegisterWithEureka(<span class="keyword">false</span>);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> client;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 关键配置：eureka.instance位前缀的配置属性bean（EurekaInstanceConfig的实现）</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span>(value = EurekaInstanceConfig<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">			<span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> EurekaInstanceConfigBean <span class="title">eurekaInstanceConfigBean</span><span class="params">(InetUtils inetUtils,</span></span></span><br><span class="line"><span class="function"><span class="params">			ManagementMetadataProvider managementMetadataProvider)</span> </span>{</span><br><span class="line">		<span class="comment">// 获取配置的主机名</span></span><br><span class="line">		String hostname = getProperty(<span class="string">"eureka.instance.hostname"</span>);</span><br><span class="line">		<span class="comment">// 是否优先使用ip地址注册到注册中心</span></span><br><span class="line">		<span class="keyword">boolean</span> preferIpAddress = Boolean</span><br><span class="line">				.parseBoolean(getProperty(<span class="string">"eureka.instance.prefer-ip-address"</span>));</span><br><span class="line">		<span class="comment">// 指定ip地址		</span></span><br><span class="line">		String ipAddress = getProperty(<span class="string">"eureka.instance.ip-address"</span>);</span><br><span class="line">		<span class="comment">// 是否启用安全端口 </span></span><br><span class="line">		<span class="keyword">boolean</span> isSecurePortEnabled = Boolean</span><br><span class="line">				.parseBoolean(getProperty(<span class="string">"eureka.instance.secure-port-enabled"</span>));</span><br><span class="line">		<span class="comment">// servlet上下文路径</span></span><br><span class="line">		String serverContextPath = env.getProperty(<span class="string">"server.servlet.context-path"</span>, <span class="string">"/"</span>);</span><br><span class="line">		<span class="comment">// 启动端口号，如果没配置则默认8080</span></span><br><span class="line">		<span class="keyword">int</span> serverPort = Integer.parseInt(</span><br><span class="line">				env.getProperty(<span class="string">"server.port"</span>, env.getProperty(<span class="string">"port"</span>, <span class="string">"8080"</span>)));</span><br><span class="line">		<span class="comment">// 管理端口号</span></span><br><span class="line">		Integer managementPort = env.getProperty(<span class="string">"management.server.port"</span>, Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 管理上下文路径</span></span><br><span class="line">		String managementContextPath = env</span><br><span class="line">				.getProperty(<span class="string">"management.server.servlet.context-path"</span>);</span><br><span class="line">		<span class="comment">// jmx端口号		</span></span><br><span class="line">		Integer jmxPort = env.getProperty(<span class="string">"com.sun.management.jmxremote.port"</span>,</span><br><span class="line">				Integer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">// 最终返回的bean		</span></span><br><span class="line">		EurekaInstanceConfigBean instance = <span class="keyword">new</span> EurekaInstanceConfigBean(inetUtils);</span><br><span class="line"></span><br><span class="line">		instance.setNonSecurePort(serverPort);</span><br><span class="line">		<span class="comment">// 实例id， 默认为:主机名:服务名:[实例id | 端口号] </span></span><br><span class="line">		<span class="comment">// 具体格式为${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id}或erver.port}</span></span><br><span class="line">		instance.setInstanceId(getDefaultInstanceId(env));</span><br><span class="line">		<span class="comment">// 是否优先使用ip地址</span></span><br><span class="line">		instance.setPreferIpAddress(preferIpAddress);</span><br><span class="line">		instance.setSecurePortEnabled(isSecurePortEnabled);</span><br><span class="line">		<span class="comment">// ip地址</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(ipAddress)) {</span><br><span class="line">			instance.setIpAddress(ipAddress);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 安全端口号是否启用</span></span><br><span class="line">		<span class="keyword">if</span> (isSecurePortEnabled) {</span><br><span class="line">			instance.setSecurePort(serverPort);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 主机名设置</span></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(hostname)) {</span><br><span class="line">			instance.setHostname(hostname);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 实例状态页url路径</span></span><br><span class="line">		String statusPageUrlPath = getProperty(<span class="string">"eureka.instance.status-page-url-path"</span>);</span><br><span class="line">		<span class="comment">// 健康检查url路径</span></span><br><span class="line">		String healthCheckUrlPath = getProperty(<span class="string">"eureka.instance.health-check-url-path"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(statusPageUrlPath)) {</span><br><span class="line">			instance.setStatusPageUrlPath(statusPageUrlPath);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(healthCheckUrlPath)) {</span><br><span class="line">			instance.setHealthCheckUrlPath(healthCheckUrlPath);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		...省略代码</span><br><span class="line"></span><br><span class="line">		setupJmxPort(instance, jmxPort);</span><br><span class="line">		<span class="keyword">return</span> instance;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 关键配置：实例注册的实现bean（spring cloud commons项目中ServiceRegistry的实现）</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> EurekaServiceRegistry <span class="title">eurekaServiceRegistry</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> EurekaServiceRegistry();</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 关键配置：启动时自动注册服务实现(spring cloud commons项目中AutoServiceRegistration的实现）)</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnBean</span>(AutoServiceRegistrationProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">ConditionalOnProperty</span>(</span></span><br><span class="line"><span class="class">			<span class="title">value</span> </span>= <span class="string">"spring.cloud.service-registry.auto-registration.enabled"</span>,</span><br><span class="line">			matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> EurekaAutoServiceRegistration <span class="title">eurekaAutoServiceRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			ApplicationContext context, EurekaServiceRegistry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">			EurekaRegistration registration)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> EurekaAutoServiceRegistration(context, registry, registration);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnMissingRefreshScope</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientConfiguration</span> </span>{</span><br><span class="line">	</span><br><span class="line">		<span class="meta">@Autowired</span></span><br><span class="line">		<span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Autowired</span></span><br><span class="line">		<span class="keyword">private</span> AbstractDiscoveryClientOptionalArgs<!--?--> optionalArgs;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 关键配置：实例化netflix的EurekaClient， 提供最终的服务注册发现功能， 该类具体源码后续分析。</span></span><br><span class="line"><span class="comment">		*</span></span><br><span class="line"><span class="comment">		* 在该类的构造方法中会做非常多的事情：</span></span><br><span class="line"><span class="comment">		* 1、时候会根据eureka.client.serviceUrl的值依次遍历得到eureka server的地址向eureka server发送url路径</span></span><br><span class="line"><span class="comment">		*    为/apps的rest请求来获取已注册的服务信息，得到一个Applications对象，最终存储到localRegionApps属性中，</span></span><br><span class="line"><span class="comment">		*    如果获取失败则尝试使用当前zone的下一个url地址重新发送请求，直到成果(如果是集群，即eureka.client.serviceUrl的值是逗号分隔的多个地址)， 但是最多重试3次</span></span><br><span class="line"><span class="comment">		*</span></span><br><span class="line"><span class="comment">		* 2、 然后启动一系列的定时任务（cluster resolvers, heartbeat, instanceInfo replicator, fetch），具体源码</span></span><br><span class="line"><span class="comment">		*    后面会分析，这里只要知道什么时候第一次获取的服务注册信息、以后怎么更新的服务注册信息，存到哪就可以了。</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Bean</span>(destroyMethod = <span class="string">"shutdown"</span>)</span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span>(value = EurekaClient<span class="class">.<span class="keyword">class</span>, <span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line">		<span class="function"><span class="keyword">public</span> EurekaClient <span class="title">eurekaClient</span><span class="params">(ApplicationInfoManager manager, EurekaClientConfig config)</span> </span>{</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> CloudEurekaClient(manager, config, <span class="keyword">this</span>.optionalArgs, <span class="keyword">this</span>.context);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@ConditionalOnMissingBean</span>(value = ApplicationInfoManager<span class="class">.<span class="keyword">class</span>, <span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line">		<span class="function"><span class="keyword">public</span> ApplicationInfoManager <span class="title">eurekaApplicationInfoManager</span><span class="params">(EurekaInstanceConfig config)</span> </span>{</span><br><span class="line">			InstanceInfo instanceInfo = <span class="keyword">new</span> InstanceInfoFactory().create(config);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ApplicationInfoManager(config, instanceInfo);</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 关键配置：注册服务实例到注册中心时的承载实例信息的类（spring cloud commons项目中Registration的实现）</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="meta">@org</span>.springframework.cloud.context.config.annotation.RefreshScope</span><br><span class="line">		<span class="meta">@ConditionalOnBean</span>(AutoServiceRegistrationProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">		@<span class="title">ConditionalOnProperty</span>(<span class="title">value</span> </span>= <span class="string">"spring.cloud.service-registry.auto-registration.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line">		<span class="function"><span class="keyword">public</span> EurekaRegistration <span class="title">eurekaRegistration</span><span class="params">(EurekaClient eurekaClient, </span></span></span><br><span class="line"><span class="function"><span class="params">				CloudEurekaInstanceConfig instanceConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">				ApplicationInfoManager applicationInfoManager, </span></span></span><br><span class="line"><span class="function"><span class="params">				@Autowired(required = <span class="keyword">false</span>)</span> ObjectProvider<healthcheckhandler> healthCheckHandler) </healthcheckhandler></span>{</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">return</span> EurekaRegistration.builder(instanceConfig).with(applicationInfoManager)</span><br><span class="line">					.with(eurekaClient).with(healthCheckHandler).build();</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>


<ul>
<li><strong>EurekaInstanceConfigBean 实例配置信息</strong><br>实例化<code>eureka.instance</code>为前缀的配置信息<code>EurekaInstanceConfigBean</code>(实现了<code>EurekaInstanceConfig</code>)</li>
</ul>
<p>用户承载eureka.instance配置信息的<code>EurekaInstanceConfigBean</code>类的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">import static org.springframework.cloud.commons.util.IdUtils.getDefaultInstanceId;</span><br><span class="line"></span><br><span class="line">@ConfigurationProperties("eureka.instance")</span><br><span class="line">public class EurekaInstanceConfigBean implements CloudEurekaInstanceConfig, EnvironmentAware {</span><br><span class="line"></span><br><span class="line">	private static final String UNKNOWN = "unknown";</span><br><span class="line">		</span><br><span class="line">	// 当前机器信息</span><br><span class="line">	private HostInfo hostInfo;</span><br><span class="line">	</span><br><span class="line">	// 应用名，setEnvironment(Enviroment)方法会设置该属性为spring.application.name的值</span><br><span class="line">	private String appname = UNKNOWN;</span><br><span class="line">	</span><br><span class="line">	// 默认心跳时间， 每隔30秒客户端向服务端发送1次心跳，告诉服务端自己还活着，</span><br><span class="line">	// 如果服务端在指定的leaseExpirationDurationInSeconds时间内还没有收到来自客户端的心跳，则服务端会从自己内部移除该实例, 这会导致禁止与该实例通信</span><br><span class="line">	private int leaseRenewalIntervalInSeconds = 30;</span><br><span class="line">	</span><br><span class="line">	// 租约有效期，默认90秒，服务端从上一次心跳时间开始算起若经过90秒还没有收到来自客户端的心跳则会移除该实例</span><br><span class="line">	// 该时间设置的过长会导致即使客户端已经死了，服务端仍然认为他还活着，那么当服务消费者真正访问该服务提供者实例时就会把请求路由给可已经死去的服务提供者，导致服务调用失败</span><br><span class="line">	// 将此值设置得太小可能意味着，由于临时网络故障，实例可能会从流量中删除(比如10秒， 那么如果由于网络波动导致某次没能成功续约，但是客户端并不是真正死了，可能过一会就恢复了，服务端由于这1次网络波动没收到心跳就把客户端剔除了使得服务不可用就浪费了1个服务实例)</span><br><span class="line">	private int leaseExpirationDurationInSeconds = 90;</span><br><span class="line">	</span><br><span class="line">	// 虚拟主机名，setEnvironment(Enviroment)方法会设置该属性为spring.application.name的值</span><br><span class="line">	private String virtualHostName = UNKNOWN;</span><br><span class="line">	</span><br><span class="line">	// 实例id， 由EurekaClientAutoConfiguration设置默认值及最终值</span><br><span class="line">	private String instanceId;</span><br><span class="line">	</span><br><span class="line">	// 实例元数据</span><br><span class="line">	private Map<string, string> metadataMap = new HashMap<>();</string,></span><br><span class="line">	</span><br><span class="line">	// 实例ip地址，由EurekaClientAutoConfiguration设置最终值，默认值由构造方法设置(若存在则设置）</span><br><span class="line">	private String ipAddress;</span><br><span class="line">	</span><br><span class="line">	// 状态页url路径</span><br><span class="line">	private String statusPageUrlPath = actuatorPrefix + "/info"</span><br><span class="line">	</span><br><span class="line">	// 健康检查页面地址</span><br><span class="line">	private String healthCheckUrlPath = actuatorPrefix + "/health";</span><br><span class="line">	</span><br><span class="line">	// 命名空间</span><br><span class="line">	private String namespace = "eureka";</span><br><span class="line">	</span><br><span class="line">	// 主机名，默认值由构造方法设置，最终值由EurekaClientAutoConfiguration设置（若存在则设置）</span><br><span class="line">	private String hostname;</span><br><span class="line">	</span><br><span class="line">	//  是否优先使用ip地址注册，最终值由EurekaClientAutoConfiguration设置</span><br><span class="line">	private boolean preferIpAddress = false;</span><br><span class="line">	</span><br><span class="line">	// 实例初始状态</span><br><span class="line">	private InstanceStatus initialStatus = InstanceStatus.UP;</span><br><span class="line">	</span><br><span class="line">	// 实例环境变量， 当前类实现了EnvironmentAware接口，通过setEnvironment(Environment environment)回调方法赋值</span><br><span class="line">	private Environment environment;</span><br><span class="line">	</span><br><span class="line">	public EurekaInstanceConfigBean(InetUtils inetUtils) {</span><br><span class="line">		this.inetUtils = inetUtils;</span><br><span class="line">		// 获取主机信息</span><br><span class="line">		this.hostInfo = this.inetUtils.findFirstNonLoopbackHostInfo();</span><br><span class="line">		// 设置默认的ip地址，由EurekaClientAutoConfiguration覆盖</span><br><span class="line">		this.ipAddress = this.hostInfo.getIpAddress();</span><br><span class="line">		//设置默认主机名，由EurekaClientAutoConfiguration覆盖</span><br><span class="line">		this.hostname = this.hostInfo.getHostname();</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	// 当前类实现了EnvironmentAware接口</span><br><span class="line">	@Override</span><br><span class="line">	public void setEnvironment(Environment environment) {</span><br><span class="line">		this.environment = environment;</span><br><span class="line"></span><br><span class="line">		//取spring.application.name的值</span><br><span class="line">		String springAppName = this.environment.getProperty("spring.application.name", "");</span><br><span class="line">		if (StringUtils.hasText(springAppName)) {</span><br><span class="line">			setAppname(springAppName);</span><br><span class="line">			setVirtualHostName(springAppName);</span><br><span class="line">			setSecureVirtualHostName(springAppName);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>从EurekaInstanceConfigBean的构造方法中可以看到它接收1个参数<code>InetUtils</code>,  <code>this.hostInfo = this.inetUtils.findFirstNonLoopbackHostInfo();</code>这行代码使用传入的InetUtils获取主机信息， 接下来分析InetUtils网络工具类源码。</p>
<ul>
<li><strong>InetUtils网络工具类</strong><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public class InetUtils implements Closeable {</span><br><span class="line">	</span><br><span class="line">	public HostInfo findFirstNonLoopbackHostInfo() {</span><br><span class="line">		InetAddress address = findFirstNonLoopbackAddress();</span><br><span class="line">		if (address != null) {</span><br><span class="line">			return convertAddress(address);</span><br><span class="line">		}</span><br><span class="line">		HostInfo hostInfo = new HostInfo();</span><br><span class="line">		hostInfo.setHostname(this.properties.getDefaultHostname());</span><br><span class="line">		hostInfo.setIpAddress(this.properties.getDefaultIpAddress());</span><br><span class="line">		return hostInfo;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	public InetAddress findFirstNonLoopbackAddress() {</span><br><span class="line">		InetAddress result = null;</span><br><span class="line">		try {</span><br><span class="line">			int lowest = Integer.MAX_VALUE;</span><br><span class="line">			// 通过jdk的NetworkInterface获取所有网络接口</span><br><span class="line">			for (Enumeration<networkinterface> nics = NetworkInterface</networkinterface></span><br><span class="line">					.getNetworkInterfaces(); nics.hasMoreElements();) {</span><br><span class="line">				NetworkInterface ifc = nics.nextElement();</span><br><span class="line">				// 当前遍历的网络接口是否已启用</span><br><span class="line">				if (ifc.isUp()) {</span><br><span class="line">					this.log.trace("Testing interface: " + ifc.getDisplayName());</span><br><span class="line">					// 找出索引最小的网络接口</span><br><span class="line">					if (ifc.getIndex() < lowest || result == null) {</span><br><span class="line">						lowest = ifc.getIndex();</span><br><span class="line">					}</span><br><span class="line">					else if (result != null) {</span><br><span class="line">						continue;</span><br><span class="line">					}</span><br><span class="line"></span><br><span class="line">					// 判断是否需要忽略当前网络接口</span><br><span class="line">					if (!ignoreInterface(ifc.getDisplayName())) {</span><br><span class="line">						// 不忽略当前网络接口，获取当前网络接口的所有网络地址</span><br><span class="line">						for (Enumeration<inetaddress> addrs = ifc</inetaddress></span><br><span class="line">								.getInetAddresses(); addrs.hasMoreElements();) {</span><br><span class="line">							InetAddress address = addrs.nextElement();</span><br><span class="line">							// 是ipv4地址，且不是本地回环地址(127.xxx.xxx.xx这种地址)， 且是优先需要使用的地址</span><br><span class="line">							if (address instanceof Inet4Address</span><br><span class="line">									&& !address.isLoopbackAddress()</span><br><span class="line">									&& isPreferredAddress(address)) {</span><br><span class="line">								this.log.trace("Found non-loopback interface: "</span><br><span class="line">										+ ifc.getDisplayName());</span><br><span class="line">								result = address;</span><br><span class="line">							}</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">					// @formatter:on</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		catch (IOException ex) {</span><br><span class="line">			this.log.error("Cannot get first non-loopback address", ex);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		if (result != null) {</span><br><span class="line">			return result;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		try {</span><br><span class="line">			return InetAddress.getLocalHost();</span><br><span class="line">		}</span><br><span class="line">		catch (UnknownHostException e) {</span><br><span class="line">			this.log.warn("Unable to retrieve localhost");</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		return null;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p><code>org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration#eurekaInstanceConfigBean</code>方法中获取<code>EurekaInstanceConfigBean</code>实例时设置了实例id(<code>instance.setInstanceId(getDefaultInstanceId(env));</code>)中的<code>getDefaultInstanceId()</code>方法是<code>IdUtils</code>类中的方法，这里的<code>getDefaultInstanceId()</code>方法是静态导入的，所以没有看到通过Class.methods()这种形式调用，<code>IdUtils</code>的实现源码如下：</p>
<ul>
<li><strong>IdUtils 实例id工具类</strong><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IdUtils</span> </span>{</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDefaultInstanceId</span><span class="params">(PropertyResolver resolver)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> getDefaultInstanceId(resolver, <span class="keyword">true</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认实例id(主机名:服务名:[实例id | 端口号])</span></span><br><span class="line">	<span class="comment">// 具体格式为${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id}或${server.port}</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDefaultInstanceId</span><span class="params">(PropertyResolver resolver,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="keyword">boolean</span> includeHostname)</span> </span>{</span><br><span class="line">		String vcapInstanceId = resolver.getProperty(<span class="string">"vcap.application.instance_id"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(vcapInstanceId)) {</span><br><span class="line">			<span class="keyword">return</span> vcapInstanceId;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		String hostname = <span class="keyword">null</span></span><br><span class="line">		<span class="comment">// 实例id是否包含主机名，上面重载的getDefaultInstanceId方法内部传递的第2个参数为true，所以会包含主机名	;</span></span><br><span class="line">		<span class="keyword">if</span> (includeHostname) {</span><br><span class="line">			hostname = resolver.getProperty(<span class="string">"spring.cloud.client.hostname"</span>);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// spring.application.name的属性值</span></span><br><span class="line">		String appName = resolver.getProperty(<span class="string">"spring.application.name"</span>);</span><br><span class="line">		<span class="comment">//  值为${spring.cloud.client.hostname}:${spring.application.name} , 把hostname和appName用冒号拼接起来</span></span><br><span class="line">		String namePart = combineParts(hostname, SEPARATOR, appName);</span><br><span class="line">		<span class="comment">// 值为${spring.application.instance_id}或${server.port}</span></span><br><span class="line">		String indexPart = resolver.getProperty(<span class="string">"spring.application.instance_id"</span>,</span><br><span class="line">				resolver.getProperty(<span class="string">"server.port"</span>));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//  把namePart和indexPart用冒号拼接起来</span></span><br><span class="line">		<span class="comment">// ${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id}或${server.port}</span></span><br><span class="line">		<span class="keyword">return</span> combineParts(namePart, SEPARATOR, indexPart);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">combineParts</span><span class="params">(String firstPart, String separator,</span></span></span><br><span class="line"><span class="function"><span class="params">			String secondPart)</span> </span>{</span><br><span class="line">		String combined = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">if</span> (firstPart != <span class="keyword">null</span> && secondPart != <span class="keyword">null</span>) {</span><br><span class="line">			combined = firstPart + separator + secondPart;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (firstPart != <span class="keyword">null</span>) {</span><br><span class="line">			combined = firstPart;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (secondPart != <span class="keyword">null</span>) {</span><br><span class="line">			combined = secondPart;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> combined;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div></li>
<li><strong>EurekaClientConfigBean 客户端配置</strong></li>
</ul>
<p>实例化eureka.client为前缀的配置信息EurekaClientConfigBean(实现了EurekaClientConfig)</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(EurekaClientConfigBean.PREFIX)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientConfigBean</span> <span class="keyword">implements</span> <span class="title">EurekaClientConfig</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MINUTES = <span class="number">60</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 配置前缀</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"eureka.client"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认eureka server的地址</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_URL = <span class="string">"http://localhost:8761"</span> + DEFAULT_PREFIX + <span class="string">"/"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 表示默认zone的名称</span></span><br><span class="line">	<span class="comment">// region可以理解为数据中心, zone可以理解为1个数据中的机房， instance理解为具体主机</span></span><br><span class="line">	<span class="comment">// 例如 亚马逊、阿里云2个数据中心</span></span><br><span class="line">	<span class="comment">// 阿里云有多个跨区的机房，如北京、广东</span></span><br><span class="line">	<span class="comment">// 而1个机房里又有很多主机（实例）</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ZONE = <span class="string">"defaultZone"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 每隔多长时间从eureka server拉取1次注服务册信息，单位秒</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> registryFetchIntervalSeconds = <span class="number">30</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 指示将实例更改信息复制到eureka服务器的频率(以秒为单位)</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> instanceInfoReplicationIntervalSeconds = <span class="number">30</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 指示最初(以秒为单位)将实例信息复制到eureka需要多长时间</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> initialInstanceInfoReplicationIntervalSeconds = <span class="number">40</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 指定多久1次轮训eureka server服务器信息的变更， Eureka服务器可以被添加或移除，该设置可以控制Eureka客户端应该多快知道eureka server的添加和移除。</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> eurekaServiceUrlPollIntervalSeconds = <span class="number">5</span> * MINUTES;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 代理端口</span></span><br><span class="line">	<span class="keyword">private</span> String proxyPort;</span><br><span class="line">	<span class="comment">// 代理主机</span></span><br><span class="line">	<span class="keyword">private</span> String proxyHost;</span><br><span class="line">	<span class="comment">// 代理用户名</span></span><br><span class="line">	<span class="keyword">private</span> String proxyUserName;</span><br><span class="line">	<span class="comment">// 代理密码</span></span><br><span class="line">	<span class="keyword">private</span> String proxyPassword;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 从eureka server读信息的超时时间设置</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> eurekaServerReadTimeoutSeconds = <span class="number">8</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 与eureka server建立连接的超时时间设置</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> eurekaServerConnectTimeoutSeconds = <span class="number">5</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 从eureka server获取注册信息的后备实现（须实现BackupRegistry接口）</span></span><br><span class="line">	<span class="keyword">private</span> String backupRegistryImpl;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 指示eureka客户端是否应该使用DNS机制获取要与之通信的eureka服务器列表。</span></span><br><span class="line"><span class="comment">	* 当更新DNS名称以拥有其他服务器时，将在eureka客户端轮询eurekaServiceUrlPollIntervalSeconds中指定的信息之后立即使用该信息。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> useDnsForFetchingServiceUrls = <span class="keyword">false</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取用来构造服务url的上下文路径，以便在eureka的服务器地址列表来源于dns时与eureka进行通信，当从eurekaServerServiceUrls返回服务url信息时该配置是不需要的。</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 当useDnsForFetchingServiceUrls设置为true时，将使用DNS机制，eureka客户端希望DNS以某种方式配置，以便它能够动态获取变化的eureka服务器。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">private</span> String eurekaServerURLContext;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取用来构造服务url的端口，以便在eureka的服务器地址列表来源于dns时与eureka进行通信，当从eurekaServerServiceUrls返回服务url信息时该配置是不需要的。</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 当useDnsForFetchingServiceUrls设置为true时，将使用DNS机制，eureka客户端希望DNS以某种方式配置，以便它能够动态获取变化的eureka服务器。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">private</span> String eurekaServerPort;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取要查询的DNS名称，以获得eureka服务器的列表。如果契约通过实现serviceUrls返回服务url，则不需要此信息。</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 当useDnsForFetchingServiceUrls设置为true时，将使用DNS机制，eureka客户端希望DNS以某种方式配置，以便它能够动态获取变化的eureka服务器。</span></span><br><span class="line"><span class="comment">	* 更改在运行时有效。</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	private String eurekaServerDNSName;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 数据中心名称</span></span><br><span class="line"><span class="comment">	private String region = "us-east-1";</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 指定与eureka server建立的http连接在关闭前可以空闲多少时间（以秒位单位）</span></span><br><span class="line"><span class="comment">	private int eurekaConnectionIdleTimeoutSeconds = 30;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 心跳线程池的初始大小</span></span><br><span class="line"><span class="comment">	private int heartbeatExecutorThreadPoolSize = 2</span></span><br><span class="line"><span class="comment">	// 心跳执行器指数回退相关属性。它是重试延迟的最大乘法器值，用于发生一系列超时的情况。	</span></span><br><span class="line"><span class="comment">	private int heartbeatExecutorExponentialBackOffBound = 10;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// cacheRefreshExecutor线程池的初始大小。</span></span><br><span class="line"><span class="comment">	private int cacheRefreshExecutorThreadPoolSize = 2;</span></span><br><span class="line"><span class="comment">	//  cacheRefreshExecutor执行器指数回退相关属性。它是重试延迟的最大乘法器值，用于发生一系列超时的情况。	</span></span><br><span class="line"><span class="comment">	private int cacheRefreshExecutorExponentialBackOffBound = 10;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// eureka服务地址，这里设置了默认值defaultZone=http://localhost:8761/eureka/</span></span><br><span class="line"><span class="comment">	private Map<string, string> serviceUrl = new HashMap<>();</string,></span></span><br><span class="line"><span class="comment">	{</span></span><br><span class="line"><span class="comment">		this.serviceUrl.put(DEFAULT_ZONE, DEFAULT_URL);</span></span><br><span class="line"><span class="comment">	}</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 指定当前实例是否应该将它自己的信息注册到eureka server中用于服务发现</span></span><br><span class="line"><span class="comment">	private boolean registerWithEureka = true;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 指定当前实例是否应出于延迟和/或其他原因尝试使用同一区域中的eureka服务器。</span></span><br><span class="line"><span class="comment">	// 理想情况下，eureka客户端被配置为与同一区域中的服务器通信</span></span><br><span class="line"><span class="comment">	// 正如 registryFetchIntervalSeconds 指定的那样，这些更改在运行时在下一个注册表获取周期生效</span></span><br><span class="line"><span class="comment">	private boolean preferSameZoneEureka = true;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 用逗号分隔的区域(region)列表，用于获取eureka注册信息， 必须为每个region定义可用机房（availability zones）来作为availabilityZones的返回值，如果不这样做会导致启动失败</span></span><br><span class="line"><span class="comment">	private String fetchRemoteRegionsRegistry;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 获取此实例所在区域的可用性区域列表(在AWS数据中心中使用)。</span></span><br><span class="line"><span class="comment">	// 正如 registryFetchIntervalSeconds 指定的那样，这些更改在运行时在下一个注册表获取周期生效</span></span><br><span class="line"><span class="comment">	private Map<string, string> availabilityZones = new HashMap<>();</string,></span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 指定是否在筛选只具有 instanceatus UP 状态的实例的应用程序后获取应用程序。</span></span><br><span class="line"><span class="comment">	private boolean filterOnlyUpInstances = true;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 指定当前客户端是否应该从eureka server获取服务注册信息</span></span><br><span class="line"><span class="comment">	private boolean fetchRegistry = true;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 指定服务端是否可以将一个客户端请求重定向到后备服务器或者集群中</span></span><br><span class="line"><span class="comment">	private boolean allowRedirects = false;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	// 如果设置为true，通过ApplicationInfoManager进行的本地状态更新将触发按需(但速率有限)注册/更新到远程eureka服务器。</span></span><br><span class="line"><span class="comment">	private boolean onDemandUpdateStatusChange = true;</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	/**</span></span><br><span class="line"><span class="comment">	* 根据region获取机房列表， 如果找不到则返回默认机房(defaultZone)</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] getAvailabilityZones(String region) {</span><br><span class="line">		<span class="comment">// 根据region获取机房列表</span></span><br><span class="line">		String value = <span class="keyword">this</span>.availabilityZones.get(region);</span><br><span class="line">		<span class="keyword">if</span> (value == <span class="keyword">null</span>) {</span><br><span class="line">			<span class="comment">// 默认机房</span></span><br><span class="line">			value = DEFAULT_ZONE;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> value.split(<span class="string">","</span>);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 根据机房获取eureka server地址， 一个机房可以部署多台eureka server组成高可用集群</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List<string> <span class="title">getEurekaServerServiceUrls</span><span class="params">(String myZone)</span> </string></span>{</span><br><span class="line">		<span class="comment">// 根据机房id获取eureka server地址（逗号分隔的多个url）</span></span><br><span class="line">		String serviceUrls = <span class="keyword">this</span>.serviceUrl.get(myZone);</span><br><span class="line">		<span class="keyword">if</span> (serviceUrls == <span class="keyword">null</span> || serviceUrls.isEmpty()) {</span><br><span class="line">			<span class="comment">// 使用默认机房(defaultZone)的eureka server地址</span></span><br><span class="line">			serviceUrls = <span class="keyword">this</span>.serviceUrl.get(DEFAULT_ZONE);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.isEmpty(serviceUrls)) {</span><br><span class="line">			<span class="comment">// 用逗号分隔</span></span><br><span class="line">			<span class="keyword">final</span> String[] serviceUrlsSplit = StringUtils</span><br><span class="line">					.commaDelimitedListToStringArray(serviceUrls);</span><br><span class="line">			List<string> eurekaServiceUrls = <span class="keyword">new</span> ArrayList<>(serviceUrlsSplit.length);</string></span><br><span class="line">			<span class="keyword">for</span> (String eurekaServiceUrl : serviceUrlsSplit) {</span><br><span class="line">				<span class="comment">// eureka server地址如果不是以/结尾则追加/</span></span><br><span class="line">				<span class="keyword">if</span> (!endsWithSlash(eurekaServiceUrl)) {</span><br><span class="line">					eurekaServiceUrl += <span class="string">"/"</span>;</span><br><span class="line">				}</span><br><span class="line">				eurekaServiceUrls.add(eurekaServiceUrl.trim());</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">return</span> eurekaServiceUrls;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ArrayList<>();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<h1 id="Eureka-中的-region-和-Zone"><a href="#Eureka-中的-region-和-Zone" class="headerlink" title="Eureka 中的 region 和 Zone"></a>Eureka 中的 region 和 Zone</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>像亚马逊这种大型的跨境电商平台，会有很多个机房。这时如果上线一个服务的话，我们希望一个机房内的服务优先调用同一个机房内的服务，当同一个机房的服务不可用的时候，再去调用其它机房的服务，以达到减少延时的作用。<br>于是亚马逊的 AWS 提供了 region 和 zone 两个概念</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>region：可以简单理解为地理上的分区。比如亚洲地区，或者华北地区，再或者北京地区等等，没有具体大小的限制，根据项目具体的情况，可以自行划分region。</li>
<li>zone：可以简单理解为 region 内的具体机房，比如说 region 划分为华北地区，然后华北地区有两个机房，就可以在此 region 之下划分出 zone1、zone2 两个 zone</li>
</ul>
<p>eureka 也借用了 region 和 zone 的概念</p>
<h2 id="分区服务架构图"><a href="#分区服务架构图" class="headerlink" title="分区服务架构图"></a>分区服务架构图</h2><p><a href="https://oscimg.oschina.net/oscnet/up-ead4f9c1eb120c96fd03904c821accd0018.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-ead4f9c1eb120c96fd03904c821accd0018.png" class="lazyload"></a></p>
<p>如图所示，有一个 region:华北地区，下面有两个机房，机房A 和机房B<br>每个机房内有一个 Eureka Server 集群 和两个服务提供者 ServiceA 和 ServerB<br>现在假设 serverA 需要调用 ServerB 服务，按照就近原则，serverA 会优先调用同一个 zone 内的 ServiceB，当 ServiceB 不可用时，才会去调用另一个 zone 内的 ServiceB</p>
<h2 id="Eureka-中-Regin-和-Zone-的相关配置"><a href="#Eureka-中-Regin-和-Zone-的相关配置" class="headerlink" title="Eureka 中 Regin 和 Zone 的相关配置"></a>Eureka 中 Regin 和 Zone 的相关配置</h2><ul>
<li>服务注册：要保证服务注册到同一个zone内的注册中心，因为如果注册到别zone的注册中心的话，网络延时比较大，心跳检测很可能出问题。</li>
<li>服务调用：要保证优先调用同一个zone内的服务，只有在同一个zone内的服务不可用时，才去调用别zone的服务。<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 尽量向同一区域的 eureka 注册,默认为true</span></span><br><span class="line">    <span class="attr">prefer-same-zone-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#地区</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">huabei</span></span><br><span class="line">    <span class="attr">availability-zones:</span></span><br><span class="line">      <span class="attr">huabei:</span> <span class="string">zone-1,zone-2</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">zone-1:</span> <span class="string">http://localhost:30000/eureka/</span></span><br><span class="line">      <span class="attr">zone-2:</span> <span class="string">http://localhost:30001/eureka/</span></span><br></pre></td></tr></tbody></table></figure></div>
当存在多个注册中心时，选择逻辑为:</li>
</ul>
<ol>
<li>如果 prefer-same-zone-eureka 为 false，按照 service-url 下的 list 取第一个注册中心来注册，并和其维持心跳检测，不再向list内的其它的注册中心注册和维持心跳。<br>只有在第一个注册失败的情况下，才会依次向其它的注册中心注册，总共重试3次，如果3个service-url都没有注册成功，则注册失败。<br>注册失败后每隔一个心跳时间，会再次尝试。</li>
</ol>
<ol start="2">
<li>如果 prefer-same-zone-eureka 为true，先通过 region 取 availability-zones 内的第一个zone，然后通过这个zone取 service-url 下的list，并向list内的第一个注册中心进行注册和维持心跳，不再向list内的其它的注册中心注册和维持心跳。<br>只有在第一个注册失败的情况下，才会依次向其它的注册中心注册，总共重试3次，如果3个service-url都没有注册成功，则注册失败。<br>注册失败后每隔一个心跳时间，会再次尝试。</li>
</ol>
<p>为了保证服务注册到同一个 zone 的注册中心，一定要注意 availability-zones 的顺序，必须把同一 zone 写在最前面</p>
<h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">yml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 服务和注册中心的心跳间隔时间，默认为30s</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 服务和注册中心的心跳超时时间，默认为90s</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">90</span></span><br><span class="line">    <span class="attr">metadata-map:</span></span><br><span class="line">      <span class="comment"># 当前服务所属的 zone</span></span><br><span class="line">      <span class="attr">zone:</span> <span class="string">zone1</span></span><br></pre></td></tr></tbody></table></figure></div>
<p>服务消费者和服务提供者分别属于哪个zone，均是通过 eureka.instance.metadata-map.zone 来判定的。  </p>
<p>服务消费者会先通过 ribbon 去注册中心拉取一份服务提供者的列表，然后通过 eureka.instance.metadata-map.zone 指定的 zone 进行过滤，过滤之后如果同一个 zone 内的服务提供者有多个实例，则会轮流调用。  </p>
<p>只有在同一个 zone 内的所有服务提供者都不可用时，才会调用其它zone内的服务提供者。</p>
<blockquote>
<p>作者：我妻礼弥<br>链接：<a href="https://juejin.im/post/5d68b73af265da03b12061be" target="_blank" rel="noopener">https://juejin.im/post/5d68b73af265da03b12061be</a><br>来源：掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
<ul>
<li><strong>EurekaClient</strong><br>以下图片来自Netflix官方，图中显示Eureka Client会向注册中心发起Get Registry请求来获取服务列表：<br><a href="https://oscimg.oschina.net/oscnet/up-3ba973845dacb74c2edf4b188caf17e14d1.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-3ba973845dacb74c2edf4b188caf17e14d1.png" class="lazyload"></a><br>在<code>org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration</code>中实例化了该bean, 源码如下：<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class EurekaClientAutoConfiguration{</span><br><span class="line"></span><br><span class="line">	@Configuration(proxyBeanMethods = false)</span><br><span class="line">	@ConditionalOnMissingRefreshScope</span><br><span class="line">	protected static class EurekaClientConfiguration {</span><br><span class="line">	</span><br><span class="line">		@Autowired</span><br><span class="line">		private ApplicationContext context;</span><br><span class="line"></span><br><span class="line">		@Autowired</span><br><span class="line">		private AbstractDiscoveryClientOptionalArgs<!--?--> optionalArgs;</span><br><span class="line"></span><br><span class="line">		/**</span><br><span class="line">		* 关键配置：实例化netflix的EurekaClient， 提供最终的服务注册发现功能， 该类具体源码后续分析。</span><br><span class="line">		*</span><br><span class="line">		* 在该类的构造方法中会做非常多的事情：</span><br><span class="line">		* 1、时候会根据eureka.client.serviceUrl的值依次遍历得到eureka server的地址向eureka server发送url路径</span><br><span class="line">		*    为/apps的rest请求来获取已注册的服务信息，得到一个Applications对象，最终存储到localRegionApps属性中，</span><br><span class="line">		*    如果获取失败则尝试使用当前zone的下一个url地址重新发送请求，直到成果(如果是集群，即eureka.client.serviceUrl的值是逗号分隔的多个地址)， 但是最多重试3次</span><br><span class="line">		*</span><br><span class="line">		* 2、 然后启动一系列的定时任务（cluster resolvers, heartbeat, instanceInfo replicator, fetch），具体源码</span><br><span class="line">		*    后面会分析，这里只要知道什么时候第一次获取的服务注册信息、以后怎么更新的服务注册信息，存到哪就可以了。</span><br><span class="line">		*/</span><br><span class="line">		@Bean(destroyMethod = "shutdown")</span><br><span class="line">		@ConditionalOnMissingBean(value = EurekaClient.class, search = SearchStrategy.CURRENT)</span><br><span class="line">		public EurekaClient eurekaClient(ApplicationInfoManager manager, EurekaClientConfig config) {</span><br><span class="line">			return new CloudEurekaClient(manager, config, this.optionalArgs, this.context);</span><br><span class="line">		}</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p>下面看<code>EurekaClient</code>这个类的源码，注意重点是该类的<strong>构造方法创建了一系列的定时任务（心跳、更新服务注册信息、根据dns更新serviceUrl、注册实例信息到eurekaserver）以及注册了事件监听器StatusChangeListener用于监听实例自身状态变化，当发生变化时上报服务实例信息到eureka server</strong></p>
<p>该类的继承关系如下：<br><a href="https://oscimg.oschina.net/oscnet/up-b975a3a81fb408329867b2d1795f4061061.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://oscimg.oschina.net/oscnet/up-b975a3a81fb408329867b2d1795f4061061.png" class="lazyload"></a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Singleton</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiscoveryClient</span> <span class="keyword">implements</span> <span class="title">EurekaClient</span> </span>{</span><br><span class="line">	<span class="comment">// 用于执行如下几种列定时任务：更新服务地址、</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line">	<span class="comment">// additional executors for supervised subtasks</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor heartbeatExecutor;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor cacheRefreshExecutor;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 存储调用/apps这个Url从eureka server获取的服务注册信息， 返回的信息被封装成Applications对象</span></span><br><span class="line">	<span class="comment">// 而Applications对象内部会持有private final AbstractQueue<application> applications;这个队列，1个Application代表1个服务，1个服务可能有多个实例，</application></span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicReference<applications> localRegionApps = <span class="keyword">new</span> AtomicReference<applications>();</applications></applications></span><br><span class="line">	</span><br><span class="line">	...省略部分代码</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Inject</span></span><br><span class="line"> 	DiscoveryClient(ApplicationInfoManager applicationInfoManager, </span><br><span class="line">					EurekaClientConfig config, </span><br><span class="line">					AbstractDiscoveryClientOptionalArgs args,</span><br><span class="line">					Provider<backupregistry> backupRegistryProvider, </backupregistry></span><br><span class="line">					EndpointRandomizer endpointRandomizer) {</span><br><span class="line">		<span class="keyword">this</span>.applicationInfoManager = applicationInfoManager;</span><br><span class="line"> 		InstanceInfo myInfo = applicationInfoManager.getInfo();</span><br><span class="line"></span><br><span class="line">		clientConfig = config;</span><br><span class="line">		staticClientConfig = clientConfig;</span><br><span class="line">		transportConfig = config.getTransportConfig();</span><br><span class="line">		instanceInfo = myInfo;</span><br><span class="line">		</span><br><span class="line">		 ...省略部分代码</span><br><span class="line">		</span><br><span class="line">		 <span class="keyword">try</span> {</span><br><span class="line">			 <span class="comment">// default size of 2 - 1 each for heartbeat and cacheRefresh</span></span><br><span class="line">			 scheduler = Executors.newScheduledThreadPool(<span class="number">2</span>,</span><br><span class="line">					<span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">						.setNameFormat(<span class="string">"DiscoveryClient-%d"</span>)</span><br><span class="line">						.setDaemon(<span class="keyword">true</span>)</span><br><span class="line">						 .build());</span><br><span class="line"></span><br><span class="line">			 heartbeatExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">				 <span class="number">1</span>, clientConfig.getHeartbeatExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">				 <span class="keyword">new</span> SynchronousQueue<runnable>(),</runnable></span><br><span class="line">				 <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">				 .setNameFormat(<span class="string">"DiscoveryClient-HeartbeatExecutor-%d"</span>)</span><br><span class="line">				 .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">				 .build()</span><br><span class="line">			 );  <span class="comment">// use direct handoff</span></span><br><span class="line"></span><br><span class="line">			 cacheRefreshExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">				 <span class="number">1</span>, clientConfig.getCacheRefreshExecutorThreadPoolSize(), <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">				 <span class="keyword">new</span> SynchronousQueue<runnable>(),</runnable></span><br><span class="line">				 <span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">				 .setNameFormat(<span class="string">"DiscoveryClient-CacheRefreshExecutor-%d"</span>)</span><br><span class="line">				 .setDaemon(<span class="keyword">true</span>)</span><br><span class="line">				 .build()</span><br><span class="line">			 );  <span class="comment">// use direct handoff</span></span><br><span class="line"></span><br><span class="line">			 eurekaTransport = <span class="keyword">new</span> EurekaTransport();</span><br><span class="line">			 scheduleServerEndpointTask(eurekaTransport, args);</span><br><span class="line"></span><br><span class="line">			 AzToRegionMapper azToRegionMapper;</span><br><span class="line">			 <span class="keyword">if</span> (clientConfig.shouldUseDnsForFetchingServiceUrls()) {</span><br><span class="line">				 azToRegionMapper = <span class="keyword">new</span> DNSBasedAzToRegionMapper(clientConfig);</span><br><span class="line">			 } <span class="keyword">else</span> {</span><br><span class="line">				 azToRegionMapper = <span class="keyword">new</span> PropertyBasedAzToRegionMapper(clientConfig);</span><br><span class="line">			 }</span><br><span class="line">			 <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegionsToFetch.get()) {</span><br><span class="line">				 azToRegionMapper.setRegionsToFetch(remoteRegionsToFetch.get().split(<span class="string">","</span>));</span><br><span class="line">			 }</span><br><span class="line">			 instanceRegionChecker = <span class="keyword">new</span> InstanceRegionChecker(azToRegionMapper, clientConfig.getRegion());</span><br><span class="line">		 } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">			 <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to initialize DiscoveryClient!"</span>, e);</span><br><span class="line">		 }</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 关键代码：第1次发送/apps这个rest请求从eureka server获取所有的服务注册信息，并封装到Applications对象中，然后存储到localRegionApps这个属性中</span></span><br><span class="line">		<span class="keyword">if</span> (clientConfig.shouldFetchRegistry() && !fetchRegistry(<span class="keyword">false</span>)) {</span><br><span class="line">			fetchRegistryFromBackup();</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 在所有的后台 任务启动前调用并执行前置注册处理器</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.preRegistrationHandler != <span class="keyword">null</span>) {</span><br><span class="line">			<span class="keyword">this</span>.preRegistrationHandler.beforeRegistration();</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 是否应该将自己注册到eureka server中，并且强制在初始化的时候注册，默认false，不会进入if中</span></span><br><span class="line">		<span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka() && clientConfig.shouldEnforceRegistrationAtInit()) {</span><br><span class="line">			<span class="keyword">try</span> {</span><br><span class="line">				<span class="keyword">if</span> (!register() ) {</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Registration error at startup. Invalid server response."</span>);</span><br><span class="line">				}</span><br><span class="line">			} <span class="keyword">catch</span> (Throwable th) {</span><br><span class="line">				logger.error(<span class="string">"Registration error at startup: {}"</span>, th.getMessage());</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(th);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// finally, init the schedule tasks (e.g. cluster resolvers, heartbeat, instanceInfo replicator, fetch</span></span><br><span class="line">		<span class="comment">// 关键代码：初始化定时任务（比如：集群解析、心跳、实例信息复制、更新服务注册信息）</span></span><br><span class="line">		initScheduledTasks();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 将自己放到单例对象DiscoveryManager中，这样可以在任意位置很方便的获取EurekaClient的相关信息</span></span><br><span class="line">		DiscoveryManager.getInstance().setDiscoveryClient(<span class="keyword">this</span>);</span><br><span class="line">		<span class="comment">// 存储客户端配置信息到DiscoveryManager中</span></span><br><span class="line">		DiscoveryManager.getInstance().setEurekaClientConfig(config);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 服务注册实现</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">		EurekaHttpResponse<void> httpResponse;</void></span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</span><br><span class="line">		} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">			logger.warn(PREFIX + <span class="string">"{} - registration failed {}"</span>, appPathIdentifier, e.getMessage(), e);</span><br><span class="line">			<span class="keyword">throw</span> e;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 发送/apps请求到eureka server获取所有服务注册信息，并存储到localRegionApps属性中</span></span><br><span class="line"><span class="comment">	* 在第一次调用时会获取全部的服务注册信息，以后调用该方法只会获取增量的服务注册信息</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	 <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>{</span><br><span class="line">		 </span><br><span class="line">		 Applications applications = getApplications();</span><br><span class="line"></span><br><span class="line">		 </span><br><span class="line">		 <span class="keyword">if</span> (clientConfig.shouldDisableDelta() <span class="comment">// 是否禁用增量获取</span></span><br><span class="line">			 || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</span><br><span class="line">			 || forceFullRegistryFetch <span class="comment">// 是否强制刷新，获取全量的服务注册信息</span></span><br><span class="line">			 || (applications == <span class="keyword">null</span>) <span class="comment">// 是否已经获取过服务注册信息</span></span><br><span class="line">			 || (applications.getRegisteredApplications().size() == <span class="number">0</span>)</span><br><span class="line">			 || (applications.getVersion() == -<span class="number">1</span>)) { <span class="comment">// 没有获取过</span></span><br><span class="line">			</span><br><span class="line">			 <span class="comment">// 获取全量的服务注册信息</span></span><br><span class="line">			getAndStoreFullRegistry();	</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			<span class="comment">//获取增量的服务注册信息</span></span><br><span class="line">			 getAndUpdateDelta(applications);</span><br><span class="line">		}</span><br><span class="line">		 </span><br><span class="line">		...省略部分代码</span><br><span class="line">	 }</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 服务发现：</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 发送/apps请求到eureka server全量获取所有服务注册信息，并存储到localRegionApps属性中</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndStoreFullRegistry</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">		Applications apps = <span class="keyword">null</span>;</span><br><span class="line">		EurekaHttpResponse<applications> httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></applications></span><br><span class="line">			<span class="comment">// 真正发送/apps请求获取服务注册信息</span></span><br><span class="line">			? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get()) </span><br><span class="line">			: eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());</span><br><span class="line">		<span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) {</span><br><span class="line">			apps = httpResponse.getEntity();</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (apps == <span class="keyword">null</span>) {</span><br><span class="line">			logger.error(<span class="string">"The application is null for some reason. Not storing this information"</span>);</span><br><span class="line">		} </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) {</span><br><span class="line">			<span class="comment">// 1、 filterAndShuffle方法返回的Applications对象中除了维护全部的服务注册信息集合外，</span></span><br><span class="line">			<span class="comment">//     这里还通过过滤操作维护了一个服务状态正常的服务注册信息集合</span></span><br><span class="line">			<span class="comment">// 2、将Applications对象存储到localRegionApps属性中</span></span><br><span class="line">			localRegionApps.set(<span class="keyword">this</span>.filterAndShuffle(apps));</span><br><span class="line">			</span><br><span class="line">			logger.debug(<span class="string">"Got full registry with apps hashcode {}"</span>, apps.getAppsHashCode());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			logger.warn(<span class="string">"Not updating applications as another thread is updating it already"</span>);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 返回localRegionApps属性中保存的服务注册信息</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> localRegionApps.get();</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 初始化所有的定时任务</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initScheduledTasks</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// 是否需要从eureka server获取服务注册信息</span></span><br><span class="line">		<span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) {</span><br><span class="line">			<span class="comment">// registry cache refresh timer</span></span><br><span class="line">			<span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">			<span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">			<span class="comment">// 启动定时任务， 获取服务注册信息</span></span><br><span class="line">			scheduler.schedule(</span><br><span class="line">				<span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">					<span class="string">"cacheRefresh"</span>,</span><br><span class="line">					scheduler,</span><br><span class="line">					cacheRefreshExecutor,</span><br><span class="line">					registryFetchIntervalSeconds,</span><br><span class="line">					TimeUnit.SECONDS,</span><br><span class="line">					expBackOffBound,</span><br><span class="line">					<span class="comment">// 获取服务注册信息的任务</span></span><br><span class="line">					<span class="keyword">new</span> CacheRefreshThread()</span><br><span class="line">				),</span><br><span class="line">				registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 是否应该将自己注册到eureka server上，如果需要则启动心跳线程向服务端发送/renew请求进行续约</span></span><br><span class="line">		<span class="keyword">if</span> (clientConfig.shouldRegisterWithEureka()) {</span><br><span class="line">			<span class="keyword">int</span> renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();</span><br><span class="line">			<span class="keyword">int</span> expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();</span><br><span class="line">			logger.info(<span class="string">"Starting heartbeat executor: "</span> + <span class="string">"renew interval is: {}"</span>, renewalIntervalInSecs);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 启动心跳定时任务</span></span><br><span class="line">			scheduler.schedule(</span><br><span class="line">				<span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">					<span class="string">"heartbeat"</span>,</span><br><span class="line">					scheduler,</span><br><span class="line">					heartbeatExecutor,</span><br><span class="line">					renewalIntervalInSecs,</span><br><span class="line">					TimeUnit.SECONDS,</span><br><span class="line">					expBackOffBound,</span><br><span class="line">					<span class="comment">// 发送/renew请求的任务</span></span><br><span class="line">					<span class="keyword">new</span> HeartbeatThread()</span><br><span class="line">				),</span><br><span class="line">				renewalIntervalInSecs, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 上报自身信息到eureka server的定时任务， 它实现了Runnable接口</span></span><br><span class="line">			instanceInfoReplicator = <span class="keyword">new</span> InstanceInfoReplicator(</span><br><span class="line">				<span class="keyword">this</span>,</span><br><span class="line">				instanceInfo,</span><br><span class="line">				clientConfig.getInstanceInfoReplicationIntervalSeconds(),</span><br><span class="line">				<span class="number">2</span>); <span class="comment">// burstSize</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// 监听本地实例状态变更（如由UP变为DOWN状态）</span></span><br><span class="line">			statusChangeListener = <span class="keyword">new</span> ApplicationInfoManager.StatusChangeListener() {</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>{</span><br><span class="line">					<span class="keyword">return</span> <span class="string">"statusChangeListener"</span>;</span><br><span class="line">				}</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(StatusChangeEvent statusChangeEvent)</span> </span>{</span><br><span class="line">					<span class="keyword">if</span> (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||</span><br><span class="line">						InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) {</span><br><span class="line">						<span class="comment">// log at warn level if DOWN was involved</span></span><br><span class="line">						logger.warn(<span class="string">"Saw local status change event {}"</span>, statusChangeEvent);</span><br><span class="line">					} <span class="keyword">else</span> {</span><br><span class="line">						logger.info(<span class="string">"Saw local status change event {}"</span>, statusChangeEvent);</span><br><span class="line">					}</span><br><span class="line">					</span><br><span class="line">					<span class="comment">// 实例自身状态发生变更，立即注册实例信息到eureka server</span></span><br><span class="line">					instanceInfoReplicator.onDemandUpdate();</span><br><span class="line">				}</span><br><span class="line">			};</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (clientConfig.shouldOnDemandUpdateStatusChange()) {</span><br><span class="line">				<span class="comment">// 注册实例状态变更监听器， 在com.netflix.appinfo.ApplicationInfoManager#setInstanceStatus中发布了该事件</span></span><br><span class="line">				applicationInfoManager.registerStatusChangeListener(statusChangeListener);</span><br><span class="line">			}</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 内部会使用Future next = scheduler.schedule(this, initialDelayMs, TimeUnit.SECONDS);启动当前定时任务</span></span><br><span class="line">			instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			logger.info(<span class="string">"Not registering with Eureka server per configuration"</span>);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@VisibleForTesting</span></span><br><span class="line"> 	<span class="function"><span class="keyword">void</span> <span class="title">refreshRegistry</span><span class="params">()</span> </span>{</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			...省略部分代码</span><br><span class="line">				</span><br><span class="line">			<span class="comment">// 重新从eureka server获取服务注册列表	</span></span><br><span class="line">			<span class="keyword">boolean</span> success = fetchRegistry(remoteRegionsModified);</span><br><span class="line">			<span class="keyword">if</span> (success) {</span><br><span class="line">				registrySize = localRegionApps.get().size();</span><br><span class="line">				lastSuccessfulRegistryFetchTimestamp = System.currentTimeMillis();</span><br><span class="line">			}</span><br><span class="line">		} <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">			logger.error(<span class="string">"Cannot fetch registry from server"</span>, e);</span><br><span class="line">		}</span><br><span class="line">	｝</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 用于服务注册定时任务，见com.netflix.discovery.InstanceInfoReplicator#run</span></span><br><span class="line"><span class="comment">	* 该方法会重新获取本地配置信息变化，如果变化了会调用com.netflix.appinfo.InstanceInfo#setIsDirty()</span></span><br><span class="line"><span class="comment">	* 将实例状态设置已变更脏数据状态，以便InstanceInfoReplicator任务感知到实例状态变化将心的实例信息注册到eureka server</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">refreshInstanceInfo</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="comment">// 刷新hostname、ipAddress变更信息</span></span><br><span class="line">		applicationInfoManager.refreshDataCenterInfoIfRequired();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 刷新租约配置变更（leaseExpirationDurationInSeconds、leaseRenewalIntervalInSeconds）</span></span><br><span class="line">		applicationInfoManager.refreshLeaseInfoIfRequired();</span><br><span class="line">		</span><br><span class="line">		...省略部分代码</span><br><span class="line">	｝</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 从eureka server刷新服务注册信息的线程</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">CacheRefreshThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">			refreshRegistry();</span><br><span class="line">		}</span><br><span class="line">	}	</span><br><span class="line">		</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">  	 * 心跳线程任务</span></span><br><span class="line"><span class="comment">  	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">HeartbeatThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">			<span class="keyword">if</span> (renew()) {</span><br><span class="line">				lastSuccessfulHeartbeatTimestamp = System.currentTimeMillis();</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><strong>InstanceInfoReplicator</strong></li>
</ul>
<ol>
<li>InstanceInfoReplicator是个任务类，负责将自身的信息周期性的上报到Eureka server；</li>
<li>有两个场景触发上报：周期性任务、服务状态变化(onDemandUpdate被调用)，因此，在同一时刻有可能有两个上报的任务同时出现；</li>
<li>单线程执行上报的操作，如果有多个上报任务，也能确保是串行的；</li>
<li>有频率限制，通过burstSize参数来控制；</li>
<li>先创建的任务总是先执行，但是onDemandUpdate方法中创建的任务会将周期性任务给丢弃掉；<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用于更新本地instanceinfo并将其复制到远程服务器的任务。这个任务的属性是:</span></span><br><span class="line"><span class="comment">* 1. 使用单个更新线程进行配置，以确保对远程服务器进行连续更新</span></span><br><span class="line"><span class="comment">* 2. 可以通过onDemandUpdate()按需调度更新任务</span></span><br><span class="line"><span class="comment">* 3. 任务处理的速率受到burstSize的限制</span></span><br><span class="line"><span class="comment">* 4. 新的更新任务总是在较早的更新任务之后自动调度。但是，如果启动了随需应变任务，</span></span><br><span class="line"><span class="comment">*    则会丢弃调度的自动更新任务(并在* 新的随需应变更新之后调度新的自动更新任务)。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceInfoReplicator</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> InstanceInfo instanceInfo;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> replicationIntervalSeconds;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicReference<future> scheduledPeriodicRef;</future></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean started;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RateLimiter rateLimiter;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> burstSize;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> allowedRatePerMinute;</span><br><span class="line">	</span><br><span class="line">	InstanceInfoReplicator(DiscoveryClient discoveryClient,</span><br><span class="line">		InstanceInfo instanceInfo,</span><br><span class="line">		<span class="keyword">int</span> replicationIntervalSeconds, </span><br><span class="line">		<span class="keyword">int</span> burstSize) {</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">this</span>.discoveryClient = discoveryClient;</span><br><span class="line">		<span class="keyword">this</span>.instanceInfo = instanceInfo;</span><br><span class="line">		<span class="comment">//线程池，core size为1，使用DelayedWorkQueue队列</span></span><br><span class="line">		<span class="keyword">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="number">1</span>,</span><br><span class="line">				<span class="keyword">new</span> ThreadFactoryBuilder()</span><br><span class="line">					.setNameFormat(<span class="string">"DiscoveryClient-InstanceInfoReplicator-%d"</span>)</span><br><span class="line">					.setDaemon(<span class="keyword">true</span>)</span><br><span class="line">					.build());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.scheduledPeriodicRef = <span class="keyword">new</span> AtomicReference<future>();</future></span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.started = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">		<span class="keyword">this</span>.rateLimiter = <span class="keyword">new</span> RateLimiter(TimeUnit.MINUTES);</span><br><span class="line">		<span class="keyword">this</span>.replicationIntervalSeconds = replicationIntervalSeconds;</span><br><span class="line">		<span class="keyword">this</span>.burstSize = burstSize;</span><br><span class="line"> 		<span class="comment">//通过周期间隔，和burstSize参数，计算每分钟允许的任务数</span></span><br><span class="line">		<span class="keyword">this</span>.allowedRatePerMinute = <span class="number">60</span> * <span class="keyword">this</span>.burstSize / <span class="keyword">this</span>.replicationIntervalSeconds;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 启动定时任务（通过scheduledPeriodicRef持有的引用可以获得启动的任务，并可以取消该定时任务）</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> initialDelayMs)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) { <span class="comment">// cas更新设置为为已启用状态</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			* setIsDirty()方法的作用是：设置脏标志，以便在下一次心跳时将实例信息传送到发现服务器，com.netflix.appinfo.InstanceInfo#setIsDirty()内部代码为：</span></span><br><span class="line"><span class="comment">			*</span></span><br><span class="line"><span class="comment">			* isInstanceInfoDirty = true;</span></span><br><span class="line"><span class="comment">  			* lastDirtyTimestamp = System.currentTimeMillis();</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 这里是为了启动后立即将实例信息上报到eureka server</span></span><br><span class="line">			instanceInfo.setIsDirty(); </span><br><span class="line">			<span class="comment">// 启动定时任务， 执行run方法中的逻辑</span></span><br><span class="line">			Future next = scheduler.schedule(<span class="keyword">this</span>, initialDelayMs, TimeUnit.SECONDS);</span><br><span class="line">			<span class="comment">// 持有启动的任务，后续可以获得该任务然后调用其cancel方法取消执行</span></span><br><span class="line">			scheduledPeriodicRef.set(next);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* com.netflix.discovery.DiscoveryClient#initScheduledTasks类中的statusChangeListener实例状态事件监听器中的notify放啊会调用该方法，当实例状态发生变化时立即同步（取消定时未完成的任务）实例信息到eureka server</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDemandUpdate</span><span class="params">()</span> </span>{</span><br><span class="line">		 <span class="comment">// 没有达到频率限制才会执行</span></span><br><span class="line">		<span class="keyword">if</span> (rateLimiter.acquire(burstSize, allowedRatePerMinute)) {</span><br><span class="line">			<span class="keyword">if</span> (!scheduler.isShutdown()) {</span><br><span class="line">				<span class="comment">//提交一个任务</span></span><br><span class="line">				scheduler.submit(<span class="keyword">new</span> Runnable() {</span><br><span class="line">					<span class="meta">@Override</span></span><br><span class="line">					<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">						logger.debug(<span class="string">"Executing on-demand update of local InstanceInfo"</span>);</span><br><span class="line"></span><br><span class="line">						<span class="comment">// 获取正在执行的定时任务</span></span><br><span class="line">						Future latestPeriodic = scheduledPeriodicRef.get();</span><br><span class="line">						<span class="comment">// 如果当前定时任务启动了，但是还没有执行完成，则立即取消任务</span></span><br><span class="line">						<span class="keyword">if</span> (latestPeriodic != <span class="keyword">null</span> && !latestPeriodic.isDone()) {</span><br><span class="line">							logger.debug(<span class="string">"Canceling the latest scheduled update, it will be rescheduled at the end of on demand update"</span>);</span><br><span class="line">							<span class="comment">// 取消本次正在执行的定时任务（仅仅是取消本次任务，下一个任务周期到了仍然会继续执行）</span></span><br><span class="line">							latestPeriodic.cancel(<span class="keyword">false</span>);</span><br><span class="line">						}</span><br><span class="line"></span><br><span class="line">						<span class="comment">// 直接调用run方法将变更的实例信息注册到eureka server</span></span><br><span class="line">						InstanceInfoReplicator.<span class="keyword">this</span>.run();</span><br><span class="line">					}</span><br><span class="line">				});</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				 <span class="comment">//如果超过了设置的频率限制，本次onDemandUpdate方法就提交任务了</span></span><br><span class="line">				logger.warn(<span class="string">"Ignoring onDemand update due to stopped scheduler"</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			}</span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			logger.warn(<span class="string">"Ignoring onDemand update due to rate limiter"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 关键代码：将服务信息注册到eureka server的实现</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="comment">// 刷新本地实例配置信息，如果本地配置信息发生了变化则调用com.netflix.appinfo.InstanceInfo#setIsDirty()将当前实例状态改为脏数据状态，以便下一步判断是否发生实例状态变化将实例信息注册到服务端</span></span><br><span class="line">			discoveryClient.refreshInstanceInfo();</span><br><span class="line">			<span class="comment">// 当前任务启动时start()方法会将实例信息状态设置为脏数据状态</span></span><br><span class="line">			<span class="comment">// 判断实例信息是否发生变化</span></span><br><span class="line">			Long dirtyTimestamp = instanceInfo.isDirtyWithTime();</span><br><span class="line">			<span class="keyword">if</span> (dirtyTimestamp != <span class="keyword">null</span>) {</span><br><span class="line">				<span class="comment">// 关键代码：服务注册，将实例信息注册到eureka server</span></span><br><span class="line">				discoveryClient.register();</span><br><span class="line">				<span class="comment">// 清除脏数据状态</span></span><br><span class="line">				instanceInfo.unsetIsDirty(dirtyTimestamp);</span><br><span class="line">			}</span><br><span class="line">		} <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">			logger.warn(<span class="string">"There was a problem with the instance info replicator"</span>, t);</span><br><span class="line">		} <span class="keyword">finally</span> {</span><br><span class="line">			Future next = scheduler.schedule(<span class="keyword">this</span>, replicationIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">			scheduledPeriodicRef.set(next);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
</li>
</ol>
<ul>
<li><strong>EurekaDiscoveryClientConfiguration （DiscoveryClient自动化配置）</strong></li>
</ul>
<p>spring cloud commons与eureka集成的自动化配置核心类</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(EurekaClientConfig<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnProperty</span>(<span class="title">value</span> </span>= <span class="string">"eureka.client.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@ConditionalOnDiscoveryEnabled</span></span><br><span class="line"><span class="meta">@ConditionalOnBlockingDiscoveryEnabled</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaDiscoveryClientConfiguration</span> </span>{</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 最最关键的配置：服务发现的具体实现bean（spring cloud commons项目中DiscoveryClient的具体实现）</span></span><br><span class="line"><span class="comment">	* 这里注入的EurekaClient和EurekaClientConfig参数都是在EurekaClientAutoConfiguration中实例化bean的，</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* 该类的作用是适配spring cloud commons中的DiscoveryClient与eureka， 起到一个桥梁作用，</span></span><br><span class="line"><span class="comment">	* 本身EurekaDiscoveryClient中的代码非常简洁，都是调用了netflix自身的EurekaClient, 所有关键的服务发现、</span></span><br><span class="line"><span class="comment">	* 服务注册、心跳都是在EurekaClient的构造方法中实现的（启用了一系列的定时任务、注册服务状态变更监听器）</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> EurekaDiscoveryClient <span class="title">discoveryClient</span><span class="params">(EurekaClient client,</span></span></span><br><span class="line"><span class="function"><span class="params">			EurekaClientConfig clientConfig)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> EurekaDiscoveryClient(client, clientConfig);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 监听了RefreshScopeRefreshedEvent事件</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(RefreshScopeRefreshedEvent<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	<span class="title">protected</span> <span class="title">static</span> <span class="title">class</span> <span class="title">EurekaClientConfigurationRefresher</span></span></span><br><span class="line"><span class="class">			<span class="keyword">implements</span> <span class="title">ApplicationListener</span><<span class="title">RefreshScopeRefreshedEvent</span>> </span>{</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* netflix原生的服务注册、获取服务列表等操作实现</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">		<span class="keyword">private</span> EurekaClient eurekaClient;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* 进行实例自动注册到注册中心的处理逻辑实现（spring cloud commons项目AutoServiceRegistration的实现）</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">		<span class="keyword">private</span> EurekaAutoServiceRegistration autoRegistration;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(RefreshScopeRefreshedEvent event)</span> </span>{</span><br><span class="line">			<span class="comment">// This will force the creation of the EurkaClient bean if not already created</span></span><br><span class="line">			<span class="comment">// to make sure the client will be reregistered after a refresh event</span></span><br><span class="line">			<span class="keyword">if</span> (eurekaClient != <span class="keyword">null</span>) {</span><br><span class="line">				eurekaClient.getApplications();</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">if</span> (autoRegistration != <span class="keyword">null</span>) {</span><br><span class="line">				<span class="comment">// register in case meta data changed</span></span><br><span class="line">				<span class="keyword">this</span>.autoRegistration.stop();</span><br><span class="line">				<span class="keyword">this</span>.autoRegistration.start();</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><strong>EurekaRegistration 实例信息， Registration的实现</strong></li>
</ul>
<p>实现了spring cloud commons项目中的<code>Registration</code>接口，代表要注册的实例信息</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaRegistration</span> <span class="keyword">implements</span> <span class="title">Registration</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> EurekaClient eurekaClient;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AtomicReference<cloudeurekaclient> cloudEurekaClient = <span class="keyword">new</span> AtomicReference<>();</cloudeurekaclient></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> CloudEurekaInstanceConfig instanceConfig;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ApplicationInfoManager applicationInfoManager;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ObjectProvider<healthcheckhandler> healthCheckHandler;</healthcheckhandler></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取实例id, 通过调用instanceConfig实现</span></span><br><span class="line"><span class="comment">	* 由EurekaClientAutoConfiguration中的EurekaInstanceConfigBean实例化设置的默认值为 </span></span><br><span class="line"><span class="comment">	* ${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id}或${server.port}</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getInstanceId</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getInstanceId();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取服务id, 通过调用instanceConfig实现，值为${spring.application.name}</span></span><br><span class="line"><span class="comment">	* 来源于org.springframework.cloud.netflix.eureka.EurekaInstanceConfigBean#setEnvironment中的setAppname方法</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getServiceId</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getAppname();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取实例主机名，来源于EurekaInstanceConfigBean的构造方法中的this.hostname = this.hostInfo.getHostname();赋的值</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getHostName(<span class="keyword">false</span>);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 获取实例端口号，来源于org.springframework.cloud.netflix.eureka.EurekaClientAutoConfiguration#eurekaInstanceConfigBean中的instance.setNonSecurePort(serverPort);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.instanceConfig.getSecurePortEnabled()) {</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getSecurePort();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getNonSecurePort();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 是否安全连接，来源类同上，由instance.setSecurePortEnabled(isSecurePortEnabled);方法设置值的</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSecure</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getSecurePortEnabled();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 调用的是spring cloud commons项目中方法</span></span><br><span class="line"><span class="comment">	* String uri = String.format("%s://%s:%s", scheme, instance.getHost(),</span></span><br><span class="line"><span class="comment">				instance.getPort()); </span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> URI <span class="title">getUri</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> DefaultServiceInstance.getUri(<span class="keyword">this</span>);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Map<string, string> <span class="title">getMetadata</span><span class="params">()</span> </string,></span>{</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.instanceConfig.getMetadataMap();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h1 id="总结spring-cloud-nextflix-eureka-client启动流程："><a href="#总结spring-cloud-nextflix-eureka-client启动流程：" class="headerlink" title="总结spring-cloud-nextflix-eureka-client启动流程："></a>总结spring-cloud-nextflix-eureka-client启动流程：</h1><ol>
<li><code>@EnableDiscoveryClient</code>引入<code>EnableDiscoveryClientImportSelector</code></li>
<li><code>spring-cloud-netflix-eureka-client-2.2.0.RELEASE.jar!\META-INF\spring.factories</code>中会自动化配置<code>EurekaClientConfigServerAutoConfiguration</code>、<code>EurekaDiscoveryClientConfigServiceAutoConfiguration</code>、<code>EurekaClientAutoConfiguration</code>、<code>EurekaDiscoveryClientConfiguration</code>、<code>RibbonEurekaAutoConfiguration</code>等几个类</li>
<li><code>EurekaClientAutoConfiguration</code>   会实例化如下几个类：</li>
</ol>
<ul>
<li><code>EurekaInstanceConfigBean</code><br>读取application.yml中eureka.instance为前缀的配置</li>
<li><code>EurekaServiceRegistry</code><br>spring cloud commons项目ServiceRegisity接口的实现</li>
<li><code>EurekaAutoServiceRegistration</code><br>spring cloud commons项目AutoServiceRegistration接口的实现</li>
<li><code>EurekaClient</code><br>netfliex的服务发现、服务注册、心跳实现，<strong>构造方法</strong>中会发送第一次rest请求，全量获取所有服务注册信息，然后启动一系列定时任务（心跳、刷新服务发现信息、实例状态变化时注册注册实例信息）</li>
<li><code>ApplicationInfoManager</code><br>持有实例信息</li>
<li><code>EurekaRegistration</code><br>spring cloud commons项目Registration接口的实现</li>
</ul>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">calebzhao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://calebzhao.github.io/2019/12/29/Spring%20Cloud%20Discovery%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88Eureka%EF%BC%89/">https://calebzhao.github.io/2019/12/29/Spring%20Cloud%20Discovery%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88Eureka%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://calebzhao.github.io">calebzhao的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring-cloud/">spring cloud    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229151714.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229152519.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/12/29/Spring%20Cloud%20Context%E6%80%BB%E8%A7%88/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Spring Cloud Context总览</span></div></a></div><div class="next-post pull_right"><a href="/2019/12/29/feign%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>feign使用教程</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/06/spring cloud - bootstrapContext(一)/" title="spring cloud - bootstrapContext(一)"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring cloud - bootstrapContext(一)</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/02/Spring中的ResolvableType/" title="Spring中的ResolvableType详解."><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring中的ResolvableType详解.</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring.factories自动化配置归类/" title="spring.factories自动化配置归类"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring.factories自动化配置归类</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/2、spring-cloud-ribbon源码分析/" title="2、spring cloud ribbon源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">2、spring cloud ribbon源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring-cloud-commons-源码分析/" title="spring-cloud-commons 源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring-cloud-commons 源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/Spring Cloud Context总览/" title="Spring Cloud Context总览"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring Cloud Context总览</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = '昵称,邮箱,链接'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'HgchHaGng3F6hbefP0mcTaYh-gzGzoHsz',
  appKey:'j47kWakblNYEeDic8riu7flK',
  placeholder:'请留下你的足迹',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By calebzhao</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div><img src="https://api.travis-ci.com/calebzhao/calebzhao.github.io.svg?branch=hexo"></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>