<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="never"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Spring Boot启动流程分析 | calebzhao的博客</title><meta name="description" content="Spring Boot启动流程分析"><meta name="keywords" content="spring boot"><meta name="author" content="calebzhao"><meta name="copyright" content="calebzhao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229155709.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring Boot启动流程分析"><meta name="twitter:description" content="Spring Boot启动流程分析"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Spring Boot启动流程分析"><meta property="og:url" content="https://calebzhao.github.io/2019/12/30/Spring%20Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="calebzhao的博客"><meta property="og:description" content="Spring Boot启动流程分析"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://calebzhao.github.io/2019/12/30/Spring%20Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><link rel="prev" title="Spring Boot的Environment源码分析" href="https://calebzhao.github.io/2019/12/31/Spring%20Boot%E7%9A%84Environment%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="next" title="深入理解jvm" href="https://calebzhao.github.io/2019/12/30/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"EU39VTKAPM","apiKey":"9108b7c9e302dddcc64205e00d26f470","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://calebzhao.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">calebzhao的博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#1、前言"><span class="toc_mobile_items-text">1、前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#2、分析-SpringApplication构造函数"><span class="toc_mobile_items-text">2、分析 SpringApplication构造函数</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-1、赋值资源加载器"><span class="toc_mobile_items-text">2.1、赋值资源加载器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-2、断言主要加载资源类不能为-null，否则报错"><span class="toc_mobile_items-text">2.2、断言主要加载资源类不能为 null，否则报错</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-3、初始化主要加载资源类集合并去重"><span class="toc_mobile_items-text">2.3、初始化主要加载资源类集合并去重</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-4、推断当前-WEB-应用类型"><span class="toc_mobile_items-text">2.4、推断当前 WEB 应用类型</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-5、设置ApplicationContextInitializer初始化器"><span class="toc_mobile_items-text">2.5、设置ApplicationContextInitializer初始化器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-6、设置ApplicationListener监听器"><span class="toc_mobile_items-text">2.6、设置ApplicationListener监听器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-7、推断主入口应用类"><span class="toc_mobile_items-text">2.7、推断主入口应用类</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#3、-分析-SpringApplication中-run方法"><span class="toc_mobile_items-text">3、 分析 SpringApplication中 run方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-1、创建并启动StopWatch"><span class="toc_mobile_items-text">3.1、创建并启动StopWatch</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-2、初始化SpringBootExceptionReporter"><span class="toc_mobile_items-text">3.2、初始化SpringBootExceptionReporter</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-3、设置系统属性-java-awt-headless-的值"><span class="toc_mobile_items-text">3.3、设置系统属性 java.awt.headless 的值</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent"><span class="toc_mobile_items-text">3.4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4-1、getRunListeners-方法"><span class="toc_mobile_items-text">3.4.1、getRunListeners()方法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4-2、创建SpringApplicationRunListeners"><span class="toc_mobile_items-text">3.4.2、创建SpringApplicationRunListeners</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4-3、listeners-starting"><span class="toc_mobile_items-text">3.4.3、listeners.starting()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4-4、EventPublishingRunListener-starting"><span class="toc_mobile_items-text">3.4.4、EventPublishingRunListener.starting()</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-4-5、SimpleApplicationEventMulticaster"><span class="toc_mobile_items-text">3.4.5、SimpleApplicationEventMulticaster</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-5、初始化默认应用参数类"><span class="toc_mobile_items-text">3.5、初始化默认应用参数类</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-6、创建Environment并发布ApplicationEnvironmentPreparedEvent"><span class="toc_mobile_items-text">3.6、创建Environment并发布ApplicationEnvironmentPreparedEvent</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-6-1、获取（或者创建）ConfigurableEnvironment"><span class="toc_mobile_items-text">3.6.1、获取（或者创建）ConfigurableEnvironment</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-6-2、-配置ConfigurableEnvironment"><span class="toc_mobile_items-text">3.6.2、 配置ConfigurableEnvironment</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-2-1、创建ConversionService并存到Environment中"><span class="toc_mobile_items-text">3.6.2.1、创建ConversionService并存到Environment中</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-2-2、将命令行的属性添加到Environment中"><span class="toc_mobile_items-text">3.6.2.2、将命令行的属性添加到Environment中</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-2-3、configureProfiles-environment-args"><span class="toc_mobile_items-text">3.6.2.3、configureProfiles(environment, args);</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-6-3、启动参数绑定到ConfigurableEnvironment中"><span class="toc_mobile_items-text">3.6.3、启动参数绑定到ConfigurableEnvironment中</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-6-4、发布ApplicationEnvironmentPreparedEvent事件"><span class="toc_mobile_items-text">3.6.4、发布ApplicationEnvironmentPreparedEvent事件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-4-1、SimpleApplicationEventMulticaster"><span class="toc_mobile_items-text">3.6.4.1、SimpleApplicationEventMulticaster</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-4-2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener"><span class="toc_mobile_items-text">3.6.4.2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-4-3、spring-cloud的BootstrapApplicationListener"><span class="toc_mobile_items-text">3.6.4.3、spring cloud的BootstrapApplicationListener</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#3-6-4-4、ConfigFileApplicationListener"><span class="toc_mobile_items-text">3.6.4.4、ConfigFileApplicationListener</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-6-5、绑定ConfigurableEnvironment到当前的SpringApplication实例中"><span class="toc_mobile_items-text">3.6.5、绑定ConfigurableEnvironment到当前的SpringApplication实例中</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-7、configureIgnoreBeanInfo-environment"><span class="toc_mobile_items-text">3.7、configureIgnoreBeanInfo(environment)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-8、创建并打印Banner"><span class="toc_mobile_items-text">3.8、创建并打印Banner</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-9、创建ApplicationContext"><span class="toc_mobile_items-text">3.9、创建ApplicationContext</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-9-1、ApplicationContext的创建"><span class="toc_mobile_items-text">3.9.1、ApplicationContext的创建</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-9-2、ApplicationContext接口"><span class="toc_mobile_items-text">3.9.2、ApplicationContext接口</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-9-3、ConfigurableApplicationContext"><span class="toc_mobile_items-text">3.9.3、ConfigurableApplicationContext</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-10、准备异常报告器"><span class="toc_mobile_items-text">3.10、准备异常报告器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-11、准备ApplicationContext"><span class="toc_mobile_items-text">3.11、准备ApplicationContext</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-11-1、将ConfigurationEnvironment存到ConfigurationApplicationContext中"><span class="toc_mobile_items-text">3.11.1、将ConfigurationEnvironment存到ConfigurationApplicationContext中</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-11-2、ConfigurableApplicationContext创建后的后置处理逻辑"><span class="toc_mobile_items-text">3.11.2、ConfigurableApplicationContext创建后的后置处理逻辑</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-11-3、回调ApplicationContextInitializer-initialize-context"><span class="toc_mobile_items-text">3.11.3、回调ApplicationContextInitializer.initialize(context)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-11-4、发布ApplicationContextInitializedEvent事件"><span class="toc_mobile_items-text">3.11.4、发布ApplicationContextInitializedEvent事件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3-11-5、打印启动信息"><span class="toc_mobile_items-text">3.11.5、打印启动信息</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-12、刷新ApplicationContext"><span class="toc_mobile_items-text">3.12、刷新ApplicationContext</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-13、ApplicationContext刷新后置处理"><span class="toc_mobile_items-text">3.13、ApplicationContext刷新后置处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-14、停止StopWatch"><span class="toc_mobile_items-text">3.14、停止StopWatch</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-15、输出日志记录执行主类名、时间信息"><span class="toc_mobile_items-text">3.15、输出日志记录执行主类名、时间信息</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-16、发布ApplicationStartedEvent事件"><span class="toc_mobile_items-text">3.16、发布ApplicationStartedEvent事件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-17、执行所有-Runner-运行器"><span class="toc_mobile_items-text">3.17、执行所有 Runner 运行器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-18、发布ApplicationReadyEvent事件"><span class="toc_mobile_items-text">3.18、发布ApplicationReadyEvent事件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-19、返回应用上下文"><span class="toc_mobile_items-text">3.19、返回应用上下文</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、前言"><span class="toc-text">1、前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、分析-SpringApplication构造函数"><span class="toc-text">2、分析 SpringApplication构造函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1、赋值资源加载器"><span class="toc-text">2.1、赋值资源加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2、断言主要加载资源类不能为-null，否则报错"><span class="toc-text">2.2、断言主要加载资源类不能为 null，否则报错</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3、初始化主要加载资源类集合并去重"><span class="toc-text">2.3、初始化主要加载资源类集合并去重</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4、推断当前-WEB-应用类型"><span class="toc-text">2.4、推断当前 WEB 应用类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5、设置ApplicationContextInitializer初始化器"><span class="toc-text">2.5、设置ApplicationContextInitializer初始化器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6、设置ApplicationListener监听器"><span class="toc-text">2.6、设置ApplicationListener监听器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7、推断主入口应用类"><span class="toc-text">2.7、推断主入口应用类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、-分析-SpringApplication中-run方法"><span class="toc-text">3、 分析 SpringApplication中 run方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1、创建并启动StopWatch"><span class="toc-text">3.1、创建并启动StopWatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2、初始化SpringBootExceptionReporter"><span class="toc-text">3.2、初始化SpringBootExceptionReporter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3、设置系统属性-java-awt-headless-的值"><span class="toc-text">3.3、设置系统属性 java.awt.headless 的值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent"><span class="toc-text">3.4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1、getRunListeners-方法"><span class="toc-text">3.4.1、getRunListeners()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2、创建SpringApplicationRunListeners"><span class="toc-text">3.4.2、创建SpringApplicationRunListeners</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3、listeners-starting"><span class="toc-text">3.4.3、listeners.starting()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-4、EventPublishingRunListener-starting"><span class="toc-text">3.4.4、EventPublishingRunListener.starting()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-5、SimpleApplicationEventMulticaster"><span class="toc-text">3.4.5、SimpleApplicationEventMulticaster</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5、初始化默认应用参数类"><span class="toc-text">3.5、初始化默认应用参数类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6、创建Environment并发布ApplicationEnvironmentPreparedEvent"><span class="toc-text">3.6、创建Environment并发布ApplicationEnvironmentPreparedEvent</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1、获取（或者创建）ConfigurableEnvironment"><span class="toc-text">3.6.1、获取（或者创建）ConfigurableEnvironment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-2、-配置ConfigurableEnvironment"><span class="toc-text">3.6.2、 配置ConfigurableEnvironment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-2-1、创建ConversionService并存到Environment中"><span class="toc-text">3.6.2.1、创建ConversionService并存到Environment中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-2-2、将命令行的属性添加到Environment中"><span class="toc-text">3.6.2.2、将命令行的属性添加到Environment中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-2-3、configureProfiles-environment-args"><span class="toc-text">3.6.2.3、configureProfiles(environment, args);</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-3、启动参数绑定到ConfigurableEnvironment中"><span class="toc-text">3.6.3、启动参数绑定到ConfigurableEnvironment中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-4、发布ApplicationEnvironmentPreparedEvent事件"><span class="toc-text">3.6.4、发布ApplicationEnvironmentPreparedEvent事件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-4-1、SimpleApplicationEventMulticaster"><span class="toc-text">3.6.4.1、SimpleApplicationEventMulticaster</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-4-2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener"><span class="toc-text">3.6.4.2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-4-3、spring-cloud的BootstrapApplicationListener"><span class="toc-text">3.6.4.3、spring cloud的BootstrapApplicationListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-4-4、ConfigFileApplicationListener"><span class="toc-text">3.6.4.4、ConfigFileApplicationListener</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-5、绑定ConfigurableEnvironment到当前的SpringApplication实例中"><span class="toc-text">3.6.5、绑定ConfigurableEnvironment到当前的SpringApplication实例中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7、configureIgnoreBeanInfo-environment"><span class="toc-text">3.7、configureIgnoreBeanInfo(environment)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8、创建并打印Banner"><span class="toc-text">3.8、创建并打印Banner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9、创建ApplicationContext"><span class="toc-text">3.9、创建ApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-1、ApplicationContext的创建"><span class="toc-text">3.9.1、ApplicationContext的创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-2、ApplicationContext接口"><span class="toc-text">3.9.2、ApplicationContext接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-3、ConfigurableApplicationContext"><span class="toc-text">3.9.3、ConfigurableApplicationContext</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10、准备异常报告器"><span class="toc-text">3.10、准备异常报告器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-11、准备ApplicationContext"><span class="toc-text">3.11、准备ApplicationContext</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-1、将ConfigurationEnvironment存到ConfigurationApplicationContext中"><span class="toc-text">3.11.1、将ConfigurationEnvironment存到ConfigurationApplicationContext中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-2、ConfigurableApplicationContext创建后的后置处理逻辑"><span class="toc-text">3.11.2、ConfigurableApplicationContext创建后的后置处理逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-3、回调ApplicationContextInitializer-initialize-context"><span class="toc-text">3.11.3、回调ApplicationContextInitializer.initialize(context)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-4、发布ApplicationContextInitializedEvent事件"><span class="toc-text">3.11.4、发布ApplicationContextInitializedEvent事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11-5、打印启动信息"><span class="toc-text">3.11.5、打印启动信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-12、刷新ApplicationContext"><span class="toc-text">3.12、刷新ApplicationContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-13、ApplicationContext刷新后置处理"><span class="toc-text">3.13、ApplicationContext刷新后置处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-14、停止StopWatch"><span class="toc-text">3.14、停止StopWatch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-15、输出日志记录执行主类名、时间信息"><span class="toc-text">3.15、输出日志记录执行主类名、时间信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-16、发布ApplicationStartedEvent事件"><span class="toc-text">3.16、发布ApplicationStartedEvent事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-17、执行所有-Runner-运行器"><span class="toc-text">3.17、执行所有 Runner 运行器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-18、发布ApplicationReadyEvent事件"><span class="toc-text">3.18、发布ApplicationReadyEvent事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-19、返回应用上下文"><span class="toc-text">3.19、返回应用上下文</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Spring Boot启动流程分析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-12-30<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-01-10</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/spring-boot/">spring boot</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">12.7k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 55 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/12/30/Spring%20Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/12/30/Spring%20Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><blockquote>
<p>有道无术,术可求;有术无道,止于术</p>
</blockquote>
<h1 id="1、前言"><a href="#1、前言" class="headerlink" title="1、前言"></a>1、前言</h1><p>学习过springboot的都知道，在Springboot的main入口函数中调用SpringApplication.run(DemoApplication.class,args)函数便可以启用SpringBoot应用程序，跟踪一下SpringApplication源码可以发现，最终还是调用了SpringApplication的动态run函数。</p>
<p>下面以SpringBoot2.2.1.RELEASE为例简单分析一下运行过程。</p>
<p>我们在编写一个spring boot应用时通常启动的方式是通过<code>SpringApplication.run(xxx.class, args)</code>来启动的</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">        SpringApplication.run(ClientApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h1 id="2、分析-SpringApplication构造函数"><a href="#2、分析-SpringApplication构造函数" class="headerlink" title="2、分析 SpringApplication构造函数"></a>2、分析 SpringApplication构造函数</h1><p><code>SpringApplication</code>源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(Class<!--?-->... primarySources)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, primarySources);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class<!--?-->... primarySources)</span> </span>{</span><br><span class="line">        <span class="comment">// 2.1、赋值资源加载器</span></span><br><span class="line">        <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">        <span class="comment">// 2.2、断言主要加载资源类不能为 null，否则报错</span></span><br><span class="line">        Assert.notNull(primarySources, <span class="string">"PrimarySources must not be null"</span>);</span><br><span class="line">        <span class="comment">// 2.3、初始化主要加载资源类集合并去重</span></span><br><span class="line">        <span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet<>(Arrays.asList(primarySources));</span><br><span class="line">        <span class="comment">// 2.4、推断当前应用类型是servlet环境、reactive反应式环境、标准环境</span></span><br><span class="line">        <span class="keyword">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.5、关键代码：加载classpath下META-INF/spring.factories中key为ApplicationContextInitializer的自动化配置类的名称</span></span><br><span class="line">        setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.6、关键代码：加载classpath下META-INF/spring.factories中key为ApplicationListener的自动化配置类的名称</span></span><br><span class="line">        setListeners((Collection) getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.7、推断main方法所在的类</span></span><br><span class="line">        <span class="keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个方法就是SpringApplication.run(ClientApplication.class, args);这段代码调用的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class<!--?--> primarySource, String... args)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> run(<span class="keyword">new</span> Class<!--?-->[] { primarySource }, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class<!--?-->[] primarySources, String[] args)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringApplication(primarySources).run(args);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>可知这个构造器类的初始化包括以下 7 个过程，下面逐一分析每个步骤的源码:</p>
<h2 id="2-1、赋值资源加载器"><a href="#2-1、赋值资源加载器" class="headerlink" title="2.1、赋值资源加载器"></a>2.1、赋值资源加载器</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="2-2、断言主要加载资源类不能为-null，否则报错"><a href="#2-2、断言主要加载资源类不能为-null，否则报错" class="headerlink" title="2.2、断言主要加载资源类不能为 null，否则报错"></a>2.2、断言主要加载资源类不能为 null，否则报错</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Assert.notNull(primarySources, <span class="string">"PrimarySources must not be null"</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="2-3、初始化主要加载资源类集合并去重"><a href="#2-3、初始化主要加载资源类集合并去重" class="headerlink" title="2.3、初始化主要加载资源类集合并去重"></a>2.3、初始化主要加载资源类集合并去重</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet<>(Arrays.asList(primarySources));</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="2-4、推断当前-WEB-应用类型"><a href="#2-4、推断当前-WEB-应用类型" class="headerlink" title="2.4、推断当前 WEB 应用类型"></a>2.4、推断当前 WEB 应用类型</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.webApplicationType = deduceWebApplicationType();</span><br></pre></td></tr></tbody></table></figure></div>
<p>来看下 deduceWebApplicationType 方法和相关的源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 应用类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> WebApplicationType {</span><br><span class="line">    <span class="comment">// 非servlet应用、非reactive应用</span></span><br><span class="line">    NONE,</span><br><span class="line">    <span class="comment">// servlet应用</span></span><br><span class="line">    SERVLET,</span><br><span class="line">    <span class="comment">// reactive反应式应用</span></span><br><span class="line">    REACTIVE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SERVLET_INDICATOR_CLASSES = { <span class="string">"javax.servlet.Servlet"</span>,</span><br><span class="line">                                                               <span class="string">"org.springframework.web.context.ConfigurableWebApplicationContext"</span> };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEBMVC_INDICATOR_CLASS = <span class="string">"org.springframework.web.servlet.DispatcherServlet"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEBFLUX_INDICATOR_CLASS = <span class="string">"org.springframework.web.reactive.DispatcherHandler"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JERSEY_INDICATOR_CLASS = <span class="string">"org.glassfish.jersey.servlet.ServletContainer"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVLET_APPLICATION_CONTEXT_CLASS = <span class="string">"org.springframework.web.context.WebApplicationContext"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REACTIVE_APPLICATION_CONTEXT_CLASS = <span class="string">"org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从类路径推倒应用类型</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> WebApplicationType <span class="title">deduceFromClasspath</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 当类路径中存在WEBFLUX_INDICATOR_CLASS</span></span><br><span class="line">        <span class="comment">// 并且不存在WEBMVC_INDICATOR_CLASS时</span></span><br><span class="line">        <span class="comment">// 且不存在JERSEY_INDICATOR_CLASS时</span></span><br><span class="line">        <span class="keyword">if</span> (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, <span class="keyword">null</span>) </span><br><span class="line">            && !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, <span class="keyword">null</span>)</span><br><span class="line">            && !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, <span class="keyword">null</span>)) {</span><br><span class="line">            <span class="comment">// 是reactive反应式程序</span></span><br><span class="line">            <span class="keyword">return</span> WebApplicationType.REACTIVE;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 当加载的类路径中不包含SERVLET_INDICATOR_CLASSES中定义的任何一个类时，返回标准应用</span></span><br><span class="line">        <span class="keyword">for</span> (String className : SERVLET_INDICATOR_CLASSES) {</span><br><span class="line">            <span class="keyword">if</span> (!ClassUtils.isPresent(className, <span class="keyword">null</span>)) {</span><br><span class="line">                <span class="comment">// 是标准应用</span></span><br><span class="line">                <span class="keyword">return</span> WebApplicationType.NONE;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 加载的类路径中包含了SERVLET_INDICATOR_CLASSES中定义的所有类型则判断为web应用</span></span><br><span class="line">        <span class="keyword">return</span> WebApplicationType.SERVLET;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="2-5、设置ApplicationContextInitializer初始化器"><a href="#2-5、设置ApplicationContextInitializer初始化器" class="headerlink" title="2.5、设置ApplicationContextInitializer初始化器"></a>2.5、设置ApplicationContextInitializer初始化器</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setInitializers((Collection)getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br></pre></td></tr></tbody></table></figure></div>

<p>初始化initializers属性，加载classpath下<code>META-INF/spring.factories</code>中配置的ApplicationContextInitializer。</p>
<p><code>ApplicationContextInitializer</code>的作用是什么？源码如下。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContextInitializer</span><<span class="title">C</span> <span class="keyword">extends</span> <span class="title">ConfigurableApplicationContext</span>> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Initialize the given application context.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> applicationContext the application to configure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">(C applicationContext)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>用来初始化指定的 Spring 应用上下文，如注册属性资源、激活 Profiles 等。</p>
<p>来看下 setInitializers 方法源码，其实就是初始化一个 ApplicationContextInitializer 应用上下文初始化器实例的集合。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInitializers</span><span class="params">(Collection<!--? extends ApplicationContextInitializer<?-->> initializers)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.initializers = <span class="keyword">new</span> ArrayList<>();</span><br><span class="line">    <span class="keyword">this</span>.initializers.addAll(initializers);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>再来看下这个初始化 <code>getSpringFactoriesInstances</code> 方法和相关的源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <t> <span class="function">Collection<t> <span class="title">getSpringFactoriesInstances</span><span class="params">(Class<t> type)</t></span> </t></span>{</t></span><br><span class="line">    <span class="keyword">return</span> getSpringFactoriesInstances(type, <span class="keyword">new</span> Class<!--?-->[] {});</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <t> <span class="function">Collection<t> <span class="title">getSpringFactoriesInstances</span><span class="params">(Class<t> type, Class<!--?-->[] parameterTypes, Object... args)</t></span> </t></span>{</t></span><br><span class="line">    ClassLoader classLoader = getClassLoader();</span><br><span class="line">    <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// SpringFactoriesLoader.loadFactoryNames()方法将会</span></span><br><span class="line">    <span class="comment">// 从calssptah下的META-INF/spring.factories中读取 key为</span></span><br><span class="line">    <span class="comment">// org.springframework.context.ApplicationContextInitializer的值，</span></span><br><span class="line">    <span class="comment">// 并以集合形式返回</span></span><br><span class="line">    Set<string> names = <span class="keyword">new</span> LinkedHashSet<>(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</string></span><br><span class="line">    <span class="comment">// 根据返回names集合逐个实例化,也就是初始化各种ApplicationContextInitializer,</span></span><br><span class="line">    <span class="comment">// 这些Initializer实际是在Spring上下文ApplicationContext执行refresh前调用</span></span><br><span class="line">    List<t> instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</t></span><br><span class="line">    <span class="comment">// 对上面创建的实例排序</span></span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这个方法会尝试从类路径的META-INF/spring.factories处读取相应配置文件，然后进行遍历，读取配置文件中Key   为：<code>org.springframework.context.ApplicationContextInitializer</code>的value。以spring-boot-autoconfigure这个包为例，它的<code>META-INF/spring.factories</code>部分定义如下所示：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initializers</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationContextInitializer</span>=<span class="string">\</span></span><br><span class="line">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>其中上面代码用到的<code>SpringFactoriesLoader.loadFactoryNames(xx.class)</code>的具体实现见另一篇文章<a href="https://calebzhao.github.io/2019/12/29/1、springboot2-2自动注入文件spring-factories如何加载详解/">springboot2.2自动注入文件spring.factories如何加载详解</a></p>
<h2 id="2-6、设置ApplicationListener监听器"><a href="#2-6、设置ApplicationListener监听器" class="headerlink" title="2.6、设置ApplicationListener监听器"></a>2.6、设置ApplicationListener监听器</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setListeners((Collection) getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p>setListeners 初始化属性listeners，加载classpath下<code>META-INF/spring.factories</code>中配置的<code>ApplicationListener</code>，此处入参为<code>getSpringFactoriesInstances</code>方法入参type= ApplicationListener.class</p>
<p>ApplicationListener 的作用是什么？源码如下。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationListener</span><<span class="title">E</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span>> <span class="keyword">extends</span> <span class="title">EventListener</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an application event.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event the event to respond to</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(E event)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>看源码，这个接口继承了 JDK 的<code>java.util.EventListener</code> 接口，实现了观察者模式，它一般用来定义感兴趣的事件类型，事件类型限定于 ApplicationEvent 的子类，这同样继承了 JDK 的 <code>java.util.EventObject</code> 接口。</p>
<p>设置监听器和设置初始化器调用的方法是一样的，只是传入的类型不一样，设置监听器的接口类型为：<code>getSpringFactoriesInstances</code>，对应的<code>spring-boot-autoconfigure-2.2.1.RELEASE.jar!/META-INF/spring.factories</code> 文件配置内容请见下方。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看出目前只有一个 <code>BackgroundPreinitializer</code> 监听器。</p>
<h2 id="2-7、推断主入口应用类"><a href="#2-7、推断主入口应用类" class="headerlink" title="2.7、推断主入口应用类"></a>2.7、推断主入口应用类</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deduceMainApplicationClass()</span><br></pre></td></tr></tbody></table></figure></div>

<p>deduceMainApplicationClass()方法的源码实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class<!--?--> deduceMainApplicationClass() {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        StackTraceElement[] stackTrace = <span class="keyword">new</span> RuntimeException().getStackTrace();</span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement stackTraceElement : stackTrace) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"main"</span>.equals(stackTraceElement.getMethodName())) {</span><br><span class="line">                <span class="keyword">return</span> Class.forName(stackTraceElement.getClassName());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (ClassNotFoundException ex) {</span><br><span class="line">        <span class="comment">// Swallow and continue</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>
<p>这个推断入口应用类的方式有点特别，通过构造一个运行时异常，再遍历异常栈中的方法名，获取方法名为 main 的栈帧，从来得到入口类的名字再返回该类。</p>
<h1 id="3、-分析-SpringApplication中-run方法"><a href="#3、-分析-SpringApplication中-run方法" class="headerlink" title="3、 分析 SpringApplication中 run方法"></a>3、 分析 SpringApplication中 run方法</h1><p>SpringApplication的run方法代码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>{</span><br><span class="line">    <span class="comment">// 1、创建并启动计时监控类</span></span><br><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">    stopWatch.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、初始化应用上下文和异常报告集合</span></span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    Collection<springbootexceptionreporter> exceptionReporters = <span class="keyword">new</span> ArrayList<>();</springbootexceptionreporter></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、设置系统属性 `java.awt.headless` 的值，默认值为：true</span></span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、加载classpath下面的META-INF/spring.factories中key为SpringApplicationRunListener的配置</span></span><br><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">    <span class="comment">// 执行所有runlistener的starting方法，实际上发布一个【ApplicationStartingEvent】事件</span></span><br><span class="line">    <span class="comment">// 内部会发布ApplicationStartingEvent事件，有以下监听器监听了该事件（按执行顺序列出）：</span></span><br><span class="line">    <span class="comment">// 括号中的代码表示该listener时是在哪个项目的spring.factories中声明的 </span></span><br><span class="line">    <span class="comment">// org.springframework.boot.context.logging.LoggingApplicationListener  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.autoconfigure.BackgroundPreinitializer       （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.context.config.DelegatingApplicationListener   （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener   （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    listeners.starting();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 5、实例化ApplicationArguments对象，初始化默认应用参数类</span></span><br><span class="line">        ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、 创建Environment （web环境 or 标准环境）+配置Environment，主要是把run方法的参数配置</span></span><br><span class="line">        <span class="comment">// 到Environment  发布【ApplicationEnvironmentPreparedEvent】事件，依次执行如下的listener：</span></span><br><span class="line">        <span class="comment">// 括号中的代码表示该listener时是在哪个项目的spring.factories中声明的 </span></span><br><span class="line">        <span class="comment">// org.springframework.cloud.bootstrap.BootstrapApplicationListener  (spring-cloud-context-2.2.0.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.cloud.bootstrap.LoggingSystemShutdownListener  (spring-cloud-context-2.2.0.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.ConfigFileApplicationListener (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.AnsiOutputApplicationListener  (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.logging.LoggingApplicationListener   (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.autoconfigure.BackgroundPreinitializer       (spring-boot-autoconfigure-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.logging.ClasspathLoggingApplicationListener (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.DelegatingApplicationListener    (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.FileEncodingApplicationListener         (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这段代码非常非常关键，spring cloud与spring boot的整合就是在这里开始的</span></span><br><span class="line">        <span class="comment">// spring cloud的BootstrapApplicationListener实现了ApplicationListener接口，并且接收ApplicationEnvironmentPreparedEvent事件</span></span><br><span class="line">        <span class="comment">// BootstrapApplicationListener中会创建一个新的SpringApplication，又会调用新创建的SpringApplication.run()方法产生id为bootstrap的</span></span><br><span class="line">        <span class="comment">// 父ApplicationContext</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回类型可能是StandardServletEnvironment(spring boot servlet环境)或StandardEnvironment(spring cloud使用)，</span></span><br><span class="line">        <span class="comment">// 下面列出environment中属性源的名称，属性源按照在ConfigurableEnvironment中的顺序包括:</span></span><br><span class="line">        <span class="comment">// 【springApplicationCommandLineArgs】 // 有命令参数才有该属性源</span></span><br><span class="line">        <span class="comment">//  configurationProperties </span></span><br><span class="line">        <span class="comment">// 【bootstrap】 //spring cloud中的， spring boot不存在该属性源</span></span><br><span class="line">        <span class="comment">// 【servletConfigInitParams】// servlet应用存在该属性源， spring cloud不存在</span></span><br><span class="line">        <span class="comment">// 【servletContextInitParams】// servlet应用存在该属性源， spring cloud不存在</span></span><br><span class="line">        <span class="comment">//  systemProperties jvm系统属性源</span></span><br><span class="line">        <span class="comment">//  systemEnvironment 系统环境变量属性源</span></span><br><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7、打印banner，SpringBoot启动时，控制台输出的一个歪歪扭扭的很不清楚的Spring几个大字母，</span></span><br><span class="line">        <span class="comment">// 也可以自定义，参考博客：http://majunwei.com/view/201708171646079868.html</span></span><br><span class="line">        Banner printedBanner = printBanner(environment);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8、 根据不同environment创建应用上下文（返回ConfigurableApplicationContext的子类实例）</span></span><br><span class="line">        context = createApplicationContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9、通过SpringFactoriesLoader检索META-INF/spring.factories中的SpringBootExceptionReporter，</span></span><br><span class="line">        <span class="comment">// 获取并实例化异常分析器</span></span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line">                                                         new Class[] { ConfigurableApplicationContext.class }, context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 10、 上下文相关预处理，发布【ApplicationPreparedEvent】事件 </span></span><br><span class="line">        <span class="comment">// 为ApplicationContext加载environment，之后逐个执行ApplicationContextInitializer的initialize()方法来进一步封装ApplicationContext，</span></span><br><span class="line">        <span class="comment">// 并调用所有的SpringApplicationRunListener的contextPrepared()方法，【EventPublishingRunListener只提供了一个空的contextPrepared()方法】，</span></span><br><span class="line">        <span class="comment">// 之后初始化IoC容器，并调用SpringApplicationRunListener的contextLoaded()方法，广播ApplicationContext的IoC加载完成，</span></span><br><span class="line">        <span class="comment">// 这里就包括通过@EnableAutoConfiguration导入的各种自动配置类。</span></span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 11、 执行context的refresh，并且调用context的registerShutdownHook方法</span></span><br><span class="line">        refreshContext(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 12、应用上下文刷新后置处理，是一个空方法</span></span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 13、停止计时监控类</span></span><br><span class="line">        stopWatch.stop();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 14、输出日志记录执行主类名、时间信息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) {</span><br><span class="line">            <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 15、执行所有runlisteners的started方法，发布【ApplicationStartedEvent】事件(应用已经启动的事件)</span></span><br><span class="line">        listeners.started(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 16、遍历所有注册的ApplicationRunner和CommandLineRunner，并执行其run()方法。</span></span><br><span class="line">        <span class="comment">// 我们可以实现自己的ApplicationRunner或者CommandLineRunner，来对SpringBoot的启动过程进行扩展。</span></span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 17、遍历前面14行获得SpringApplicationRunListeners局部变量中所维护的listeners属性,</span></span><br><span class="line">        <span class="comment">// 执行所有SpringApplicationRunListener的running方法，发布【ApplicationReadyEvent】事件（应用已经启动完成的监听事件）</span></span><br><span class="line">        listeners.running(context);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) {</span><br><span class="line">        handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 18、返回应用上下文</span></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>其实这个方法我们可以简单的总结下步骤为 ：</p>
<ol>
<li>配置属性 </li>
<li>获取监听器，发布应用开始启动事件 </li>
<li>初始化输入参数 </li>
<li>配置环境，输出banner </li>
<li>创建上下文 </li>
<li>预处理上下文 </li>
<li>刷新上下文</li>
<li>刷新上下文的后处理，空实现</li>
<li>发布应用已经启动事件</li>
<li>发布应用启动完成事件</li>
</ol>
<p>所以，我们可以按以下几步来分解 run 方法的启动过程。</p>
<h2 id="3-1、创建并启动StopWatch"><a href="#3-1、创建并启动StopWatch" class="headerlink" title="3.1、创建并启动StopWatch"></a>3.1、创建并启动StopWatch</h2><p>创建并启动计时监控类</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">stopWatch.start();</span><br></pre></td></tr></tbody></table></figure></div>

<p>来看下这个计时监控类 StopWatch 的相关源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StopWatch</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>{</span><br><span class="line">        start(<span class="string">""</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String taskName)</span> <span class="keyword">throws</span> IllegalStateException </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.currentTaskName != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't start StopWatch: it's already running"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">this</span>.currentTaskName = taskName;</span><br><span class="line">        <span class="keyword">this</span>.startTimeNanos = System.nanoTime();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>首先记录了当前任务的名称，默认为空字符串，然后记录当前 Spring Boot 应用启动的开始时间（单位纳秒）。</p>
<h2 id="3-2、初始化SpringBootExceptionReporter"><a href="#3-2、初始化SpringBootExceptionReporter" class="headerlink" title="3.2、初始化SpringBootExceptionReporter"></a>3.2、初始化SpringBootExceptionReporter</h2><p>初始化应用上下文和异常报告集合</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">Collection<springbootexceptionreporter> exceptionReporters = <span class="keyword">new</span> ArrayList<>();</springbootexceptionreporter></span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="3-3、设置系统属性-java-awt-headless-的值"><a href="#3-3、设置系统属性-java-awt-headless-的值" class="headerlink" title="3.3、设置系统属性 java.awt.headless 的值"></a>3.3、设置系统属性 <code>java.awt.headless</code> 的值</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configureHeadlessProperty();</span><br></pre></td></tr></tbody></table></figure></div>

<p>设置该默认值为：true，Java.awt.headless = true 有什么作用？</p>
<blockquote>
<p>对于一个 Java 服务器来说经常要处理一些图形元素，例如地图的创建或者图形和图表等。这些API基本上总是需要运行一个X-server以便能使用AWT（Abstract Window Toolkit，抽象窗口工具集）。然而运行一个不必要的 X-server 并不是一种好的管理方式。有时你甚至不能运行 X-server,因此最好的方案是运行 headless 服务器，来进行简单的图像处理。</p>
<p>参考：<a href="http://www.cnblogs.com/princessd8251/p/4000016.html" target="_blank" rel="noopener">www.cnblogs.com/princessd8251/p/4000016.html</a></p>
</blockquote>
<h2 id="3-4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent"><a href="#3-4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent" class="headerlink" title="3.4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent"></a>3.4、创建SpringApplicationRunListeners并发布ApplicationStartingEvent</h2><h3 id="3-4-1、getRunListeners-方法"><a href="#3-4-1、getRunListeners-方法" class="headerlink" title="3.4.1、getRunListeners()方法"></a>3.4.1、getRunListeners()方法</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line"><span class="comment">// 内部会发布ApplicationStartingEvent事件，有以下监听器监听了该事件（按执行顺序列出）：</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.logging.LoggingApplicationListener</span></span><br><span class="line"><span class="comment">// org.springframework.boot.autoconfigure.BackgroundPreinitializer</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.config.DelegatingApplicationListener</span></span><br><span class="line"><span class="comment">// org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener</span></span><br><span class="line">listeners.starting();</span><br></pre></td></tr></tbody></table></figure></div>

<p>来看下创建 SpringApplicationRunListeners运行监听器相关的源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title">getRunListeners</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">    Class<!--?-->[] types = new Class<!--?-->[] { SpringApplication.class, String[].class };</span><br><span class="line">    <span class="comment">// SpringApplicationRunListener的实现实际只有EventPublishingRunListener</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SpringApplicationRunListeners(logger,</span><br><span class="line">                                             getSpringFactoriesInstances(SpringApplicationRunListener<span class="class">.<span class="keyword">class</span>, <span class="title">types</span>, <span class="title">this</span>, <span class="title">args</span>))</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到返回了SpringApplicationRunListeners对象，</p>
<h3 id="3-4-2、创建SpringApplicationRunListeners"><a href="#3-4-2、创建SpringApplicationRunListeners" class="headerlink" title="3.4.2、创建SpringApplicationRunListeners"></a>3.4.2、创建SpringApplicationRunListeners</h3><p>返回的SpringApplicationRunListeners这个类的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationRunListeners</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List<springapplicationrunlistener> listeners;</springapplicationrunlistener></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> listeners 这个集合实际只有EventPublishingRunListener一个类的实例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    SpringApplicationRunListeners(Log log, Collection<!--? extends SpringApplicationRunListener--> listeners) {</span><br><span class="line">        <span class="keyword">this</span>.log = log;</span><br><span class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> ArrayList<>(listeners);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">starting</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) {</span><br><span class="line">            listener.starting();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>创建逻辑和之前实例化初始化器和监听器的一样，一样调用的是 <code>getSpringFactoriesInstances</code> 方法来获取配置的监听器名称并实例化所有的类。</p>
<p>SpringApplicationRunListener 所有监听器配置在 <code>spring-boot-2.2.1.RELEASE.jar!/META-INF/spring.factories</code> 这个配置文件里面。</p>
  <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run Listeners</span></span><br><span class="line"><span class="meta">org.springframework.boot.SpringApplicationRunListener</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">org.springframework.boot.context.event.EventPublishingRunListener</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到SpringApplicationRunListener的值是<code>org.springframework.boot.context.event.EventPublishingRunListener</code>这个类，所以创建SpringApplicationRunListeners这个对象时构造方法传递的2个参数就是这个EventPublishingRunListener的实例。</p>
<h3 id="3-4-3、listeners-starting"><a href="#3-4-3、listeners-starting" class="headerlink" title="3.4.3、listeners.starting()"></a>3.4.3、listeners.starting()</h3><p>所以<code>listeners.starting();</code>这行代码的实现SpringApplicationRunListeners.starting()方法中遍历的属性<code>this.listeners</code>实际就只有1个<code>EventPublishingRunListener</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationRunListeners</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List<springapplicationrunlistener> listeners;</springapplicationrunlistener></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">starting</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) {</span><br><span class="line">            listener.starting();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>


<p>接下来看<code>EventPublishingRunListener</code>类的starting方法的源码实现。</p>
<h3 id="3-4-4、EventPublishingRunListener-starting"><a href="#3-4-4、EventPublishingRunListener-starting" class="headerlink" title="3.4.4、EventPublishingRunListener.starting()"></a>3.4.4、EventPublishingRunListener.starting()</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用于发布多种SpringApplicationEvent事件。</span></span><br><span class="line"><span class="comment">* 在上下文ApplicationContext实际refresh之前使用ApplicationEventMulticaster来触发事件。</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventPublishingRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SpringApplication.run(xxx.class, args)运行时内部创建的SpringApplication实例，</span></span><br><span class="line">    <span class="comment">// 构造方法实例化时设置了List<applicationcontextinitializer<?>> initializers及List<applicationlistener<?>> listeners属性</applicationlistener<?></applicationcontextinitializer<?></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SpringApplication.run(xxx.class, args)传入的args参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在构造方法中初始化的，实例类型为SimpleApplicationEventMulticaster</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleApplicationEventMulticaster initialMulticaster;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventPublishingRunListener</span><span class="params">(SpringApplication application, String[] args)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.application = application;</span><br><span class="line">        <span class="keyword">this</span>.args = args;</span><br><span class="line">        <span class="comment">//创建了简单应用程序事件发布多播器SimpleApplicationEventMulticaster</span></span><br><span class="line">        <span class="keyword">this</span>.initialMulticaster = <span class="keyword">new</span> SimpleApplicationEventMulticaster();</span><br><span class="line">        <span class="comment">// 观察者模式的典型应用。</span></span><br><span class="line">        <span class="comment">// 将所有的ApplicationListener观察者加入到initialMulticaster中，当被观察者(SpringApplication)向观察者(ApplicationListener)</span></span><br><span class="line">        <span class="comment">// 发布事件时，内部遍历所有的ApplicationListener(观察者)找出对发布的事件(ApplicationEvent)感兴趣的ApplicationListener(观察者)</span></span><br><span class="line">        <span class="comment">// 然后调用ApplicationListener(观察者)的onEvent(ApplicationEvent event)方法回调观察者</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener<!--?--> listener : application.getListeners()) {</span><br><span class="line">            <span class="keyword">this</span>.initialMulticaster.addApplicationListener(listener);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">starting</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// 向所有注册的ApplicationListener(观察者)发布ApplicationStartingEvent事件，</span></span><br><span class="line">        <span class="comment">// 注意initialMulticaster内部会找出对发布的事件(ApplicationEvent)感兴趣的ApplicationListener(观察者)</span></span><br><span class="line">        <span class="comment">// 并回调观察者的onEvent(ApplicationEvent event)方法</span></span><br><span class="line">        <span class="keyword">this</span>.initialMulticaster.multicastEvent(<span class="keyword">new</span> ApplicationStartingEvent(<span class="keyword">this</span>.application, <span class="keyword">this</span>.args));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...省略发布其他事件的方法</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>需要注意的是这里是一个典型的<strong>观察者模式</strong>的应用，<code>SpringApplication</code>是被观察者，<code>ApplicationListener</code>接口的实现是观察者，spring启动时从<code>spring.factories</code>文件中根据找出所有的key为<code>org.springframework.context.ApplicationListener</code>的<code>ApplicationListener</code>接口的实现(观察者)，然后在<code>EventPublishingRunListener</code>类的构造方法将所有的ApplicationListener接口的实现(观察者)注册到类型为<code>SimpleApplicationEventMulticaster</code>的initialMulticaster属性中，而<code>SpringApplication</code>的run方法中又持有了EventPublishingRunListener这个类的引用(<code>SpringApplicationRunListeners listeners = getRunListeners(args);</code>)，所以在<code>SpringApplication</code>是中可以通过listeners.starting()方法调用委托给真正的<code>SimpleApplicationEventMulticaster</code>进行事件发布。</p>
<h3 id="3-4-5、SimpleApplicationEventMulticaster"><a href="#3-4-5、SimpleApplicationEventMulticaster" class="headerlink" title="3.4.5、SimpleApplicationEventMulticaster"></a>3.4.5、SimpleApplicationEventMulticaster</h3><p>SimpleApplicationEventMulticaster类的作用时真正的发布事件(ApplicationEvent event)。</p>
<p>SimpleApplicationEventMulticaster类的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ApplicationEventMulticaster接口的简单实现。</span></span><br><span class="line"><span class="comment">* 将所有事件(ApplicationEvent)广播给所有已注册的监听器(ApplicationEvent)，然后由监听器忽略他们不感兴趣的事件，</span></span><br><span class="line"><span class="comment">* 监听器通常对传入的事件执行相应的instanceof检查，来确定该事件是否是自己感兴趣的，如果对该事件不敢兴趣就忽略它，否则进行业务逻辑处理。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 默认情况下所有监听器在调用线程中被执行，但这带来了恶意的侦听器可能会阻塞整个应用的风险，但只增加了最小的开销，可以指定一个可选的</span></span><br><span class="line"><span class="comment">* 任务执行器(Executor taskExecutor)来让监听器(ApplicationListener)在不同的线程中执行，例如这个taskExecutor可以是一个线程池，</span></span><br><span class="line"><span class="comment">* 这样无论ApplicationListener的执行时间多长(比如ApplicationListener中存在耗时的网络请求、性能不好的数据库访问或是否是阻塞操作(比如io、等待CPU)），</span></span><br><span class="line"><span class="comment">* 都不会导致整个应用被阻塞</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleApplicationEventMulticaster</span> <span class="keyword">extends</span> <span class="title">AbstractApplicationEventMulticaster</span> </span>{</span><br><span class="line">    <span class="comment">// 指定ApplicationListener在哪个线程执行器中执行（可以不指定），具体含义参见上面类级别的文档</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Executor taskExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 错误处理器，作用参见invokeListener(ApplicationListener<!--?--> listener, ApplicationEvent event)方法内注释</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> ErrorHandler errorHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleApplicationEventMulticaster</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以指定ApplicationListener在哪个线程执行器中执行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTaskExecutor</span><span class="params">(@Nullable Executor taskExecutor)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.taskExecutor = taskExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以指定ApplicationListener的错误处理器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorHandler</span><span class="params">(@Nullable ErrorHandler errorHandler)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.errorHandler = errorHandler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br><span class="line">        multicastEvent(event, resolveDefaultEventType(event));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, @Nullable ResolvableType eventType)</span> </span>{</span><br><span class="line">        ResolvableType type = (eventType != <span class="keyword">null</span> ? eventType : resolveDefaultEventType(event));</span><br><span class="line">        <span class="comment">// 获得ApplicationListener的执行器（该执行器是可选的）</span></span><br><span class="line">        Executor executor = getTaskExecutor();</span><br><span class="line">        <span class="comment">// 找到对该ApplicationEvent感兴趣的监听器(ApplicationListener)</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener<!--?--> listener : getApplicationListeners(event, type)) {</span><br><span class="line">            <span class="comment">// 判断是否指定了ApplicationListener在哪个线程执行器中执行</span></span><br><span class="line">            <span class="keyword">if</span> (executor != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// 在指定的taskExecutor中执行，不会阻塞调用线程</span></span><br><span class="line">                executor.execute(() -> invokeListener(listener, event));</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 没有指定taskExecutor，执行在调用线程中执行（可能会阻塞调用线程）</span></span><br><span class="line">                invokeListener(listener, event);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeListener</span><span class="params">(ApplicationListener<!--?--> listener, ApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="comment">// 是否有错误处理器，如果有错误处理器，那么ApplicationListener方法内执行抛出异常时会捕获抛出的异常交由指定的错误处理器去处理</span></span><br><span class="line">        <span class="comment">// 否则spring不处理</span></span><br><span class="line">        ErrorHandler errorHandler = getErrorHandler();</span><br><span class="line">        <span class="keyword">if</span> (errorHandler != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                doInvokeListener(listener, event);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (Throwable err) {</span><br><span class="line">                <span class="comment">// 交由错误处理器处理异常</span></span><br><span class="line">                errorHandler.handleError(err);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 如果ApplicationListener方法执行时产生异常，则不处理，由上级处理</span></span><br><span class="line">            doInvokeListener(listener, event);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInvokeListener</span><span class="params">(ApplicationListener listener, ApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// onApplicationEvent方法就是我们平时使用ApplicationLisenter接口时要实现的方法，回调观察者</span></span><br><span class="line">            listener.onApplicationEvent(event);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (ClassCastException ex) {</span><br><span class="line">            String msg = ex.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="keyword">null</span> || matchesClassCastMessage(msg, event.getClass())) {</span><br><span class="line">                <span class="comment">// Possibly a lambda-defined listener which we could not resolve the generic event type for</span></span><br><span class="line">                <span class="comment">// -> let's suppress the exception and just log a debug message.</span></span><br><span class="line">                Log logger = LogFactory.getLog(getClass());</span><br><span class="line">                <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                    logger.trace(<span class="string">"Non-matching event type for listener: "</span> + listener, ex);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-5、初始化默认应用参数类"><a href="#3-5、初始化默认应用参数类" class="headerlink" title="3.5、初始化默认应用参数类"></a>3.5、初始化默认应用参数类</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br></pre></td></tr></tbody></table></figure></div>

<p>DefaultApplicationArguments类的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultApplicationArguments</span> <span class="keyword">implements</span> <span class="title">ApplicationArguments</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Source source;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultApplicationArguments</span><span class="params">(String... args)</span> </span>{</span><br><span class="line">        Assert.notNull(args, <span class="string">"Args must not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.source = <span class="keyword">new</span> Source(args);</span><br><span class="line">        <span class="keyword">this</span>.args = args;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Source</span> <span class="keyword">extends</span> <span class="title">SimpleCommandLinePropertySource</span> </span>{</span><br><span class="line"></span><br><span class="line">        Source(String[] args) {</span><br><span class="line">            <span class="keyword">super</span>(args);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List<string> <span class="title">getNonOptionArgs</span><span class="params">()</span> </string></span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getNonOptionArgs();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List<string> <span class="title">getOptionValues</span><span class="params">(String name)</span> </string></span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getOptionValues(name);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>从构造方法可以看到最主要的操作就是<code>this.source = new Source(args);</code>这一行代码，而Souce类是一个内部内，Source的构造方法中直接调用了父类SimpleCommandLinePropertySource的构造方法，下面看<code>SimpleCommandLinePropertySource</code>类构造方法的实现细节：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCommandLinePropertySource</span> <span class="keyword">extends</span> <span class="title">CommandLinePropertySource</span><<span class="title">CommandLineArgs</span>> </span>{</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SimpleCommandLinePropertySource</span><span class="params">(String... args)</span> </span>{</span><br><span class="line">		<span class="keyword">super</span>(<span class="keyword">new</span> SimpleCommandLineArgsParser().parse(args));</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到创建了SimpleCommandLineArgsParser类的实例，调用了它的parse(String… args)方法，从类名和方法命名可以就应该能猜到这个类是用来解析命令行参数的。</p>
<p>SimpleCommandLineArgsParser类源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleCommandLineArgsParser</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommandLineArgs <span class="title">parse</span><span class="params">(String... args)</span> </span>{</span><br><span class="line">        CommandLineArgs commandLineArgs = <span class="keyword">new</span> CommandLineArgs();</span><br><span class="line">        <span class="comment">// 比如命令 java --server.port=8888 --spring.profiles.active=prod -jar app.jar</span></span><br><span class="line">        <span class="keyword">for</span> (String arg : args) {</span><br><span class="line">            <span class="comment">// 参数是否以--打头，比如参数 --server.port=8888</span></span><br><span class="line">            <span class="keyword">if</span> (arg.startsWith(<span class="string">"--"</span>)) {</span><br><span class="line">                <span class="comment">// 截取--字符串后面的字符串，比如--server.port=8888变成server.port=8888</span></span><br><span class="line">                String optionText = arg.substring(<span class="number">2</span>, arg.length());</span><br><span class="line">                String optionName;</span><br><span class="line">                String optionValue = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 是否有值</span></span><br><span class="line">                <span class="keyword">if</span> (optionText.contains(<span class="string">"="</span>)) {</span><br><span class="line">                    <span class="comment">// 等号前面的字符串作为name</span></span><br><span class="line">                    optionName = optionText.substring(<span class="number">0</span>, optionText.indexOf(<span class="string">'='</span>));</span><br><span class="line">                    <span class="comment">// 等号后面的字符串作为value</span></span><br><span class="line">                    optionValue = optionText.substring(optionText.indexOf(<span class="string">'='</span>)+<span class="number">1</span>, optionText.length());</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// --后面的整个字符串作为name</span></span><br><span class="line">                    optionName = optionText;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">if</span> (optionName.isEmpty() || (optionValue != <span class="keyword">null</span> && optionValue.isEmpty())) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid argument syntax: "</span> + arg);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 存储name和value到CommandLineArgs中</span></span><br><span class="line">                commandLineArgs.addOptionArg(optionName, optionValue);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                commandLineArgs.addNonOptionArg(arg);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> commandLineArgs;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>到这里<code>ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);</code>这一行代码的作用就分析完了，可以看到做的事情就是解析命令行参数。</p>
<h2 id="3-6、创建Environment并发布ApplicationEnvironmentPreparedEvent"><a href="#3-6、创建Environment并发布ApplicationEnvironmentPreparedEvent" class="headerlink" title="3.6、创建Environment并发布ApplicationEnvironmentPreparedEvent"></a>3.6、创建Environment并发布ApplicationEnvironmentPreparedEvent</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">configureIgnoreBeanInfo(environment);</span><br></pre></td></tr></tbody></table></figure></div>

<p>下面我们主要来看下准备环境的 <code>prepareEnvironment</code> 源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                   ApplicationArguments applicationArguments)</span> </span>{</span><br><span class="line">    <span class="comment">// 3.6.1、 获取（或者创建）应用ConfigurableEnvironment</span></span><br><span class="line">    ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.6.2、 配置应用环境（启动参数绑定到ConfigurableEnvironment中、绑定ConfigurableConversionService到ConfigurableEnvironment中）</span></span><br><span class="line">    configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">    <span class="comment">// 3.6.3、</span></span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.6.4、这里的listeners是SpringApplicationRunListeners，发布ApplicationEnvironmentPreparedEvent事件</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这段代码非常非常重要，spring cloud与spring boot的整合就是在这里开始的</span></span><br><span class="line">    <span class="comment">// spring cloud的BootstrapApplicationListener实现了ApplicationListener接口，并且接收ApplicationEnvironmentPreparedEvent事件</span></span><br><span class="line">    <span class="comment">// BootstrapApplicationListener中会创建一个新的SpringApplication，又会调用新创建的SpringApplication.run()方法产生id为bootstrap的</span></span><br><span class="line">    <span class="comment">// 父ApplicationContext</span></span><br><span class="line">    listeners.environmentPrepared(environment);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.6.5、绑定ConfigurableEnvironment到当前的SpringApplication实例中</span></span><br><span class="line">    bindToSpringApplication(environment);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) {</span><br><span class="line">        environment = <span class="keyword">new</span> EnvironmentConverter(getClassLoader()).convertEnvironmentIfNecessary(environment,</span><br><span class="line">                                                                                               deduceEnvironmentClass());</span><br><span class="line">    }</span><br><span class="line">    ConfigurationPropertySources.attach(environment);</span><br><span class="line">    <span class="keyword">return</span> environment;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>上面的代码需要重点关注，和spring cloud的整合在这里开始</strong>。</p>
<h3 id="3-6-1、获取（或者创建）ConfigurableEnvironment"><a href="#3-6-1、获取（或者创建）ConfigurableEnvironment" class="headerlink" title="3.6.1、获取（或者创建）ConfigurableEnvironment"></a>3.6.1、获取（或者创建）ConfigurableEnvironment</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br></pre></td></tr></tbody></table></figure></div>

<p>getOrCreateEnvironment()方法实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">getOrCreateEnvironment</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.environment != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.environment;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) {</span><br><span class="line">        <span class="keyword">case</span> SERVLET:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StandardServletEnvironment();</span><br><span class="line">        <span class="keyword">case</span> REACTIVE:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StandardReactiveWebEnvironment();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里分为标准 Servlet 环境和标准环境。</p>
<h3 id="3-6-2、-配置ConfigurableEnvironment"><a href="#3-6-2、-配置ConfigurableEnvironment" class="headerlink" title="3.6.2、 配置ConfigurableEnvironment"></a>3.6.2、 配置ConfigurableEnvironment</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br></pre></td></tr></tbody></table></figure></div>

<p>configureEnvironment()实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureEnvironment</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>{</span><br><span class="line">    <span class="comment">// 3.6.2.1、创建ConversionService并存到Environment中</span></span><br><span class="line">    <span class="comment">// SpringApplication的成员变量，默认值为true。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.addConversionService) {</span><br><span class="line">        <span class="comment">// 创建ApplicationConversionService(类型转换器)并注册默认的Converter、Formatter类型转换器实现，spring mvc中经常使用ConversionService</span></span><br><span class="line">        ConversionService conversionService = ApplicationConversionService.getSharedInstance();</span><br><span class="line">        <span class="comment">// 将ConversionService存到ConfigurableEnvironment中</span></span><br><span class="line">        environment.setConversionService((ConfigurableConversionService) conversionService);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3.6.2.2、将命令行的属性添加到Environment中</span></span><br><span class="line">    configurePropertySources(environment, args);</span><br><span class="line">    <span class="comment">// 3.6.2.3、将additionalProfiles合并到Environment中，设置激活的profile</span></span><br><span class="line">    configureProfiles(environment, args);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h4 id="3-6-2-1、创建ConversionService并存到Environment中"><a href="#3-6-2-1、创建ConversionService并存到Environment中" class="headerlink" title="3.6.2.1、创建ConversionService并存到Environment中"></a>3.6.2.1、创建ConversionService并存到Environment中</h4><ul>
<li>ApplicationConversionService.getSharedInstance()源码如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 类型转换器服务，用于将</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConversionService</span> <span class="keyword">extends</span> <span class="title">FormattingConversionService</span> </span>{	</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> ApplicationConversionService sharedInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationConversionService</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationConversionService</span><span class="params">(StringValueResolver embeddedValueResolver)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (embeddedValueResolver != <span class="keyword">null</span>) {</span><br><span class="line">            setEmbeddedValueResolver(embeddedValueResolver);</span><br><span class="line">        }</span><br><span class="line">        configure(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConversionService <span class="title">getSharedInstance</span><span class="params">()</span> </span>{</span><br><span class="line">        ApplicationConversionService sharedInstance = ApplicationConversionService.sharedInstance;</span><br><span class="line">        <span class="keyword">if</span> (sharedInstance == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">synchronized</span> (ApplicationConversionService<span class="class">.<span class="keyword">class</span>) </span>{</span><br><span class="line">                sharedInstance = ApplicationConversionService.sharedInstance;</span><br><span class="line">                <span class="keyword">if</span> (sharedInstance == <span class="keyword">null</span>) {</span><br><span class="line">                    sharedInstance = <span class="keyword">new</span> ApplicationConversionService();</span><br><span class="line">                    ApplicationConversionService.sharedInstance = sharedInstance;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> sharedInstance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(FormatterRegistry registry)</span> </span>{</span><br><span class="line">        DefaultConversionService.addDefaultConverters(registry);</span><br><span class="line">        DefaultFormattingConversionService.addDefaultFormatters(registry);</span><br><span class="line">        addApplicationFormatters(registry);</span><br><span class="line">        addApplicationConverters(registry);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addApplicationFormatters</span><span class="params">(FormatterRegistry registry)</span> </span>{</span><br><span class="line">        registry.addFormatter(<span class="keyword">new</span> CharArrayFormatter());</span><br><span class="line">        registry.addFormatter(<span class="keyword">new</span> InetAddressFormatter());</span><br><span class="line">        registry.addFormatter(<span class="keyword">new</span> IsoOffsetFormatter());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addApplicationConverters</span><span class="params">(ConverterRegistry registry)</span> </span>{</span><br><span class="line">        addDelimitedStringConverters(registry);</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> StringToDurationConverter());</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> DurationToStringConverter());</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> NumberToDurationConverter());</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> DurationToNumberConverter());</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> StringToDataSizeConverter());</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> NumberToDataSizeConverter());</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> StringToFileConverter());</span><br><span class="line">        registry.addConverterFactory(<span class="keyword">new</span> LenientStringToEnumConverterFactory());</span><br><span class="line">        registry.addConverterFactory(<span class="keyword">new</span> LenientBooleanToEnumConverterFactory());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>可以看到getSharedInstance()方法就是一个典型的双重判断单例模式的实现，只是需要注意这里sharedInstance变量是成员变量使用volatile进行了修饰，禁止指令重排序及保证内存可见性，ApplicationConversionService的构造方法中最终调用了<code>configure(FormatterRegistry registry)</code>方法</p>
<p>从方法实现看默认注册了一些Convert、Formater接口的实现。</p>
<ul>
<li>DefaultConversionService.addDefaultConverters(registry);源码如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultConversionService</span> <span class="keyword">extends</span> <span class="title">GenericConversionService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultConversionService</span><span class="params">()</span> </span>{</span><br><span class="line">        addDefaultConverters(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addDefaultConverters</span><span class="params">(ConverterRegistry converterRegistry)</span> </span>{</span><br><span class="line">        addScalarConverters(converterRegistry);</span><br><span class="line">        addCollectionConverters(converterRegistry);</span><br><span class="line"></span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> ByteBufferConverter((ConversionService) converterRegistry));</span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> StringToTimeZoneConverter());</span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> ZoneIdToTimeZoneConverter());</span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> ZonedDateTimeToCalendarConverter());</span><br><span class="line"></span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> ObjectToObjectConverter());</span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> IdToEntityConverter((ConversionService) converterRegistry));</span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> FallbackObjectToStringConverter());</span><br><span class="line">        converterRegistry.addConverter(<span class="keyword">new</span> ObjectToOptionalConverter((ConversionService) converterRegistry));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...省略部分代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<ul>
<li>DefaultFormattingConversionService.addDefaultFormatters(registry);实现源码如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFormattingConversionService</span> <span class="keyword">extends</span> <span class="title">FormattingConversionService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jsr354Present;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jodaTimePresent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        ClassLoader classLoader = DefaultFormattingConversionService<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        jsr354Present = ClassUtils.isPresent(<span class="string">"javax.money.MonetaryAmount"</span>, classLoader);</span><br><span class="line">        jodaTimePresent = ClassUtils.isPresent(<span class="string">"org.joda.time.LocalDate"</span>, classLoader);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addDefaultFormatters</span><span class="params">(FormatterRegistry formatterRegistry)</span> </span>{</span><br><span class="line">        <span class="comment">// Default handling of number values</span></span><br><span class="line">        formatterRegistry.addFormatterForFieldAnnotation(<span class="keyword">new</span> NumberFormatAnnotationFormatterFactory());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default handling of monetary values</span></span><br><span class="line">        <span class="keyword">if</span> (jsr354Present) {</span><br><span class="line">            formatterRegistry.addFormatter(<span class="keyword">new</span> CurrencyUnitFormatter());</span><br><span class="line">            formatterRegistry.addFormatter(<span class="keyword">new</span> MonetaryAmountFormatter());</span><br><span class="line">            formatterRegistry.addFormatterForFieldAnnotation(<span class="keyword">new</span> Jsr354NumberFormatAnnotationFormatterFactory());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default handling of date-time values</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// just handling JSR-310 specific date and time types</span></span><br><span class="line">        <span class="keyword">new</span> DateTimeFormatterRegistrar().registerFormatters(formatterRegistry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jodaTimePresent) {</span><br><span class="line">            <span class="comment">// handles Joda-specific types as well as Date, Calendar, Long</span></span><br><span class="line">            <span class="keyword">new</span> JodaTimeFormatterRegistrar().registerFormatters(formatterRegistry);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// regular DateFormat-based Date, Calendar, Long converters</span></span><br><span class="line">            <span class="keyword">new</span> DateFormatterRegistrar().registerFormatters(formatterRegistry);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...省略部分代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="3-6-2-2、将命令行的属性添加到Environment中"><a href="#3-6-2-2、将命令行的属性添加到Environment中" class="headerlink" title="3.6.2.2、将命令行的属性添加到Environment中"></a>3.6.2.2、将命令行的属性添加到Environment中</h4><p><code>configurePropertySources</code>方法源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否添加命令行参数到ConfigurableEnvironment中</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> addCommandLineProperties = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认属性，如果有则会合并到ConfigurableEnvironment中</span></span><br><span class="line">    <span class="keyword">private</span> Map<string, object> defaultProperties;</string,></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultProperties</span><span class="params">(Map<string, object> defaultProperties)</string,></span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.defaultProperties = defaultProperties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureEnvironment</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>{</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.addConversionService) {</span><br><span class="line">            ConversionService conversionService = ApplicationConversionService.getSharedInstance();</span><br><span class="line">            environment.setConversionService((ConfigurableConversionService) conversionService);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 将命令行的属性添加到Environment中</span></span><br><span class="line">        configurePropertySources(environment, args);</span><br><span class="line">        configureProfiles(environment, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建一个基于命令行属性的PropertySource并将其添加到ConfigurableEnvironment中</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> environment 环境对象，根据应用类型可能是StandardEnvironment、StandardServletEnvironment、StandardReactiveWebEnvironment</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> args 要被添加的命令行参数数据，如 ['--server.port=9090', '--spring.profiles.active=prod']</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configurePropertySources</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>{</span><br><span class="line">        <span class="comment">// 获得AbstractEnvironment中的propertySources属性，代表可变属性源，</span></span><br><span class="line">        <span class="comment">// MutablePropertySources类中包含addFirst、addBefore、addLast、remove、replace等操纵属性源的方法</span></span><br><span class="line">        MutablePropertySources sources = environment.getPropertySources();</span><br><span class="line">        <span class="comment">// 判断是否有默认属性</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.defaultProperties != <span class="keyword">null</span> && !<span class="keyword">this</span>.defaultProperties.isEmpty()) {</span><br><span class="line">            <span class="comment">// 如果有默认属性，则将其添加到environment中</span></span><br><span class="line">            sources.addLast(<span class="keyword">new</span> MapPropertySource(<span class="string">"defaultProperties"</span>, <span class="keyword">this</span>.defaultProperties));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 判断是否添加命令行参数到ConfigurableEnvironment中，默认true</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.addCommandLineProperties && args.length > <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// 命令行属性源名称</span></span><br><span class="line">            String name = CommandLinePropertySource.COMMAND_LINE_PROPERTY_SOURCE_NAME;</span><br><span class="line">            <span class="comment">// 判断ConfigurableEnvironment中是否已经存在该属性源</span></span><br><span class="line">            <span class="keyword">if</span> (sources.contains(name)) {</span><br><span class="line">                <span class="comment">// 根据name获取ConfigurableEnvironment中已存在的属性源</span></span><br><span class="line">                PropertySource<!--?--> source = sources.get(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 声明1个有属性源复合功能的属性源，当复合属性源中维护的多个属性源都有相同的key时，位置靠前的属性源中的值优先返回</span></span><br><span class="line">                CompositePropertySource composite = <span class="keyword">new</span> CompositePropertySource(name);</span><br><span class="line">                <span class="comment">// 将参数args属性作为第1个属性源，由于它的位置在第1个，所以它的优先级最高</span></span><br><span class="line">                composite.addPropertySource(<span class="keyword">new</span> SimpleCommandLinePropertySource(<span class="string">"springApplicationCommandLineArgs"</span>, args));</span><br><span class="line">                <span class="comment">// 将ConfigurableEnvironment中已存在的属性源作为第2个属性源，优先级比上面一行的SimpleCommandLinePropertySource低</span></span><br><span class="line">                composite.addPropertySource(source);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//  将ConfigurableEnvironment中已存在的单一属性源替换为上面创建的复合属性源</span></span><br><span class="line">                sources.replace(name, composite);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// ConfigurableEnvironment中不存在该属性源</span></span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 将命令行参数添加ConfigurableEnvironment中的(底层维护着MutablePropertySources类型的propertySources属性)</span></span><br><span class="line">                sources.addFirst(<span class="keyword">new</span> SimpleCommandLinePropertySource(args));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...省略代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>接下来继续分析<code>configurePropertySources(environment, args);</code>这一行后面的代码<code>configureProfiles(environment, args);</code></p>
<h4 id="3-6-2-3、configureProfiles-environment-args"><a href="#3-6-2-3、configureProfiles-environment-args" class="headerlink" title="3.6.2.3、configureProfiles(environment, args);"></a>3.6.2.3、configureProfiles(environment, args);</h4><p>配置additionalProfiles到Environment中，设置激活的profile</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line">    <span class="comment">// 额外的profile的名称，可以是多个（表示同时启用多个profile）</span></span><br><span class="line">    <span class="keyword">private</span> Set<string> additionalProfiles = <span class="keyword">new</span> HashSet<>();</string></span><br><span class="line"></span><br><span class="line">    ...省略代码</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdditionalProfiles</span><span class="params">(String... profiles)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.additionalProfiles = <span class="keyword">new</span> LinkedHashSet<>(Arrays.asList(profiles));</span><br><span class="line">    }    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 这个方法的作用是将通过代码设置的profile的名称追加到environment中，例如如下实例：</span></span><br><span class="line"><span class="comment">    * SpringApplication app = new SpringApplication(TestApplication.class);</span></span><br><span class="line"><span class="comment">    * app.setAdditionalProfiles("dev", "test");</span></span><br><span class="line"><span class="comment">    * app.run(args);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureProfiles</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>{</span><br><span class="line">        Set<string> profiles = <span class="keyword">new</span> LinkedHashSet<>(<span class="keyword">this</span>.additionalProfiles);</string></span><br><span class="line">        <span class="comment">// environment.getActiveProfiles()获得当前激活的profile的名称集合(返回的是Set<string>类型)</string></span></span><br><span class="line">        <span class="comment">// 然后加入profiles集合中，此时profiles集合中包含2种profile来源：this.additionalProfiles及environment中的</span></span><br><span class="line">        profiles.addAll(Arrays.asList(environment.getActiveProfiles()));</span><br><span class="line">        <span class="comment">// 设置使用的profile</span></span><br><span class="line">        environment.setActiveProfiles(StringUtils.toStringArray(profiles));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ...省略代码</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>prepareEnvironment()方法的源码分析完了，现在让我们回到<code>public ConfigurableApplicationContext run(String... args)</code>方法中，继续看prepareEnvironment()方法之后的方法<code>configureIgnoreBeanInfo(environment)</code>。</p>
<h3 id="3-6-3、启动参数绑定到ConfigurableEnvironment中"><a href="#3-6-3、启动参数绑定到ConfigurableEnvironment中" class="headerlink" title="3.6.3、启动参数绑定到ConfigurableEnvironment中"></a>3.6.3、启动参数绑定到ConfigurableEnvironment中</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigurationPropertySources.attach(environment);</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>ConfigurationPropertySources</code>类的静态方法<code>attach(Environment environment)</code>源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationPropertySources</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The name of the {<span class="doctag">@link</span> PropertySource} {<span class="doctag">@link</span> #adapt adapter}.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ATTACHED_PROPERTY_SOURCE_NAME = <span class="string">"configurationProperties"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConfigurationPropertySources</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Environment environment)</span> </span>{</span><br><span class="line">        Assert.isInstanceOf(ConfigurableEnvironment<span class="class">.<span class="keyword">class</span>, <span class="title">environment</span>)</span>;</span><br><span class="line">        MutablePropertySources sources = ((ConfigurableEnvironment) environment).getPropertySources();</span><br><span class="line">        PropertySource<!--?--> attached = sources.get(ATTACHED_PROPERTY_SOURCE_NAME);</span><br><span class="line">        <span class="keyword">if</span> (attached != <span class="keyword">null</span> && attached.getSource() != sources) {</span><br><span class="line">            sources.remove(ATTACHED_PROPERTY_SOURCE_NAME);</span><br><span class="line">            attached = <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (attached == <span class="keyword">null</span>) {</span><br><span class="line">            sources.addFirst(<span class="keyword">new</span> ConfigurationPropertySourcesPropertySource(ATTACHED_PROPERTY_SOURCE_NAME,</span><br><span class="line">                                                                            <span class="keyword">new</span> SpringConfigurationPropertySources(sources)));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="3-6-4、发布ApplicationEnvironmentPreparedEvent事件"><a href="#3-6-4、发布ApplicationEnvironmentPreparedEvent事件" class="headerlink" title="3.6.4、发布ApplicationEnvironmentPreparedEvent事件"></a>3.6.4、发布ApplicationEnvironmentPreparedEvent事件</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内部会发布ApplicationEnvironmentPreparedEvent事件，依次执行如下的listener：</span></span><br><span class="line"><span class="comment">// 括号中的代码表示该listener时是在哪个项目的spring.factories中声明的 </span></span><br><span class="line"><span class="comment">// org.springframework.cloud.bootstrap.BootstrapApplicationListener  (spring-cloud-context-2.2.0.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.cloud.bootstrap.LoggingSystemShutdownListener  (spring-cloud-context-2.2.0.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.config.ConfigFileApplicationListener (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.config.AnsiOutputApplicationListener  (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.logging.LoggingApplicationListener   (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.autoconfigure.BackgroundPreinitializer       (spring-boot-autoconfigure-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.logging.ClasspathLoggingApplicationListener (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.config.DelegatingApplicationListener    (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line"><span class="comment">// org.springframework.boot.context.FileEncodingApplicationListener         (spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories)</span></span><br><span class="line">listeners.environmentPrepared(environment);</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>SpringApplicationRunListeners</code>类的<code>environmentPrepared</code>方法源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationRunListeners</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SpringApplicationRunListener`的实现类只有EventPublishingRunListener</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List<springapplicationrunlistener> listeners;</springapplicationrunlistener></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 该构造方法是在SpringApplication#getRunListeners(String[] args)中调用的</span></span><br><span class="line">    <span class="comment">// 传入的listeners集合就只有1个元素EventPublishingRunListener</span></span><br><span class="line">    SpringApplicationRunListeners(Log log, Collection<!--? extends SpringApplicationRunListener--> listeners) {</span><br><span class="line">		<span class="keyword">this</span>.log = log;</span><br><span class="line">		<span class="keyword">this</span>.listeners = <span class="keyword">new</span> ArrayList<>(listeners);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">        <span class="comment">// this.listeners集合就只有EventPublishingRunListener</span></span><br><span class="line">        <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) {</span><br><span class="line">            <span class="comment">// 调用EventPublishingRunListener.environmentPrepared(ConfigurableEnvironment environment)方法</span></span><br><span class="line">            listener.environmentPrepared(environment);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>SpringApplicationRunListener</code>的实现类只有<code>EventPublishingRunListener</code>，EventPublishingRunListener类的<code>environmentPrepared</code>方法的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventPublishingRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleApplicationEventMulticaster initialMulticaster;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.initialMulticaster</span><br><span class="line">            .multicastEvent(<span class="keyword">new</span> ApplicationEnvironmentPreparedEvent(<span class="keyword">this</span>.application, <span class="keyword">this</span>.args, environment));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="3-6-4-1、SimpleApplicationEventMulticaster"><a href="#3-6-4-1、SimpleApplicationEventMulticaster" class="headerlink" title="3.6.4.1、SimpleApplicationEventMulticaster"></a>3.6.4.1、SimpleApplicationEventMulticaster</h4><p>SimpleApplicationEventMulticaster类的作用时真正的发布事件(ApplicationEvent event)。</p>
<p>SimpleApplicationEventMulticaster类的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ApplicationEventMulticaster接口的简单实现。</span></span><br><span class="line"><span class="comment">* 将所有事件(ApplicationEvent)广播给所有已注册的监听器(ApplicationEvent)，然后由监听器忽略他们不感兴趣的事件，</span></span><br><span class="line"><span class="comment">* 监听器通常对传入的事件执行相应的instanceof检查，来确定该事件是否是自己感兴趣的，如果对该事件不敢兴趣就忽略它，否则进行业务逻辑处理。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 默认情况下所有监听器在调用线程中被执行，但这带来了恶意的侦听器可能会阻塞整个应用的风险，但只增加了最小的开销，可以指定一个可选的</span></span><br><span class="line"><span class="comment">* 任务执行器(Executor taskExecutor)来让监听器(ApplicationListener)在不同的线程中执行，例如这个taskExecutor可以是一个线程池，</span></span><br><span class="line"><span class="comment">* 这样无论ApplicationListener的执行时间多长(比如ApplicationListener中存在耗时的网络请求、性能不好的数据库访问或是否是阻塞操作(比如io、等待CPU)），</span></span><br><span class="line"><span class="comment">* 都不会导致整个应用被阻塞</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleApplicationEventMulticaster</span> <span class="keyword">extends</span> <span class="title">AbstractApplicationEventMulticaster</span> </span>{</span><br><span class="line">    <span class="comment">// 指定ApplicationListener在哪个线程执行器中执行（可以不指定），具体含义参见上面类级别的文档</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> Executor taskExecutor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 错误处理器，作用参见invokeListener(ApplicationListener<!--?--> listener, ApplicationEvent event)方法内注释</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> ErrorHandler errorHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleApplicationEventMulticaster</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以指定ApplicationListener在哪个线程执行器中执行</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTaskExecutor</span><span class="params">(@Nullable Executor taskExecutor)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.taskExecutor = taskExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以指定ApplicationListener的错误处理器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorHandler</span><span class="params">(@Nullable ErrorHandler errorHandler)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.errorHandler = errorHandler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br><span class="line">        multicastEvent(event, resolveDefaultEventType(event));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(<span class="keyword">final</span> ApplicationEvent event, @Nullable ResolvableType eventType)</span> </span>{</span><br><span class="line">        ResolvableType type = (eventType != <span class="keyword">null</span> ? eventType : resolveDefaultEventType(event));</span><br><span class="line">        <span class="comment">// 获得ApplicationListener的执行器（该执行器是可选的）</span></span><br><span class="line">        Executor executor = getTaskExecutor();</span><br><span class="line">        <span class="comment">// 找到对该ApplicationEvent感兴趣的监听器(ApplicationListener)</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationListener<!--?--> listener : getApplicationListeners(event, type)) {</span><br><span class="line">            <span class="comment">// 判断是否指定了ApplicationListener在哪个线程执行器中执行</span></span><br><span class="line">            <span class="keyword">if</span> (executor != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// 在指定的taskExecutor中执行，不会阻塞调用线程</span></span><br><span class="line">                executor.execute(() -> invokeListener(listener, event));</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 没有指定taskExecutor，执行在调用线程中执行（可能会阻塞调用线程）</span></span><br><span class="line">                invokeListener(listener, event);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeListener</span><span class="params">(ApplicationListener<!--?--> listener, ApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="comment">// 是否有错误处理器，如果有错误处理器，那么ApplicationListener方法内执行抛出异常时会捕获抛出的异常交由指定的错误处理器去处理</span></span><br><span class="line">        <span class="comment">// 否则spring不处理</span></span><br><span class="line">        ErrorHandler errorHandler = getErrorHandler();</span><br><span class="line">        <span class="keyword">if</span> (errorHandler != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                doInvokeListener(listener, event);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (Throwable err) {</span><br><span class="line">                <span class="comment">// 交由错误处理器处理异常</span></span><br><span class="line">                errorHandler.handleError(err);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 如果ApplicationListener方法执行时产生异常，则不处理，由上级处理</span></span><br><span class="line">            doInvokeListener(listener, event);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInvokeListener</span><span class="params">(ApplicationListener listener, ApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// onApplicationEvent方法就是我们平时使用ApplicationLisenter接口时要实现的方法，回调观察者</span></span><br><span class="line">            listener.onApplicationEvent(event);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (ClassCastException ex) {</span><br><span class="line">            String msg = ex.getMessage();</span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="keyword">null</span> || matchesClassCastMessage(msg, event.getClass())) {</span><br><span class="line">                <span class="comment">// Possibly a lambda-defined listener which we could not resolve the generic event type for</span></span><br><span class="line">                <span class="comment">// -> let's suppress the exception and just log a debug message.</span></span><br><span class="line">                Log logger = LogFactory.getLog(getClass());</span><br><span class="line">                <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br><span class="line">                    logger.trace(<span class="string">"Non-matching event type for listener: "</span> + listener, ex);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>从上面第47行代码可以看到这是一个for循环，for循环的对象是getApplications()方法的返回值，这里我们不关注是怎么找到对ApplicationEnvironmentPreparedEvent事件感兴趣的ApplicationListener的，重点看getApplicaitons()方法的返回值有哪些，有哪些ApplicationListener的实现类对ApplicationEnvironmentPreparedEvent事件感兴趣，下面具体分析这些监听器的实现。</p>
<h4 id="3-6-4-2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener"><a href="#3-6-4-2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener" class="headerlink" title="3.6.4.2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener"></a>3.6.4.2、接收ApplicationEnvironmentPreparedEvent事件的ApplicationListener</h4><p>使用idea调试时getApplications()方法的返回值(spring cloud环境)：</p>
<p><a href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20200104151616.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20200104151616.png" class="lazyload"></a></p>
<p>按照执行顺序这些监听器的实现出处如下（注意下面文件的内容不是实际的文件内容顺序，是按照实际执行顺序列出）：</p>
<ul>
<li><p><code>spring-cloud-context-2.2.0.RELEASE.jar!\META-INF\spring.factories</code> 共2个</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Application Listeners</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.bootstrap.BootstrapApplicationListener,\</span><br><span class="line">org.springframework.cloud.bootstrap.LoggingSystemShutdownListener,\</span><br><span class="line"><span class="attr">...省略不相关的</span></span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<ul>
<li><p><code>spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories</code> </p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Application Listeners</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line">org.springframework.boot.context.config.ConfigFileApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.LoggingApplicationListener,\</span><br><span class="line"><span class="attr">...省略不相关的</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>spring-boot-autoconfigure-2.2.1.RELEASE.jar!\META-INF\spring.factories</code>共1个</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories</code> </p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Application Listeners</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line">org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</span><br><span class="line"><span class="attr">...省略不相关的</span></span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p>根据<code>getApplications()</code>方法的返回值看到第一个监听了<code>ApplicationEnvironmentPreparedEvent</code>事件的<code>ApplicationListener</code>就是spring cloud的<code>org.springframework.cloud.bootstrap.BootstrapApplicationListener</code>, 下面开始分析BootstrapApplicationListener`类的源码</p>
<h4 id="3-6-4-3、spring-cloud的BootstrapApplicationListener"><a href="#3-6-4-3、spring-cloud的BootstrapApplicationListener" class="headerlink" title="3.6.4.3、spring cloud的BootstrapApplicationListener"></a>3.6.4.3、spring cloud的BootstrapApplicationListener</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootstrapApplicationListener</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ApplicationListener</span><<span class="title">ApplicationEnvironmentPreparedEvent</span>>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Property source name for bootstrap.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOTSTRAP_PROPERTY_SOURCE_NAME = <span class="string">"bootstrap"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The default order for this listener.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ORDER = Ordered.HIGHEST_PRECEDENCE + <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * The name of the default properties.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROPERTIES = <span class="string">"springCloudDefaultProperties"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = DEFAULT_ORDER;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{</span><br><span class="line">        <span class="comment">// 这里的environment是SpringApplication.run(xxx.class, args)时创建的StandardServletEnvironment</span></span><br><span class="line">        <span class="comment">// 属性源包括configurationProperties、servletConfigInitParams、servletContextInitParams、systemProperties、systemEnvironment</span></span><br><span class="line">        ConfigurableEnvironment environment = event.getEnvironment();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断spring.cloud.bootstrap.enabled的属性值，若未设置则默认true</span></span><br><span class="line">        <span class="comment">// 这段代码的意思是是否启用了springg cloud，默认true启动</span></span><br><span class="line">        <span class="keyword">if</span> (!environment.getProperty(<span class="string">"spring.cloud.bootstrap.enabled"</span>, Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">true</span>)) </span>{</span><br><span class="line">            <span class="comment">// 已经设置过spring.cloud.bootstrap.enabled属性为false，代表不启用spring cloud功能，直接返回</span></span><br><span class="line">            <span class="comment">// 那么就不会创建id为bootstrap的父ApplicationContext</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 运行到这里表示启用spring cloud</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// don't listen to events in a bootstrap context</span></span><br><span class="line">        <span class="comment">// 不监听bootstrap的发布的ApplicationEnvironmentPreparedEvent事件， 防止重复创建id为bootstrap的ApplicationContext</span></span><br><span class="line">        <span class="comment">// 这里判断environment中是否包含名称为"bootstrap"的属性源，</span></span><br><span class="line">        <span class="comment">// 注意后续的bootstrapServiceContext()方法中会为spring cloud的environment添加名称为"bootstrap"的属性源，</span></span><br><span class="line">        <span class="comment">// 所以bootstrapServiceContext()方法中为spring cloud创建的SpringApplication在调用其run()方法时发布</span></span><br><span class="line">        <span class="comment">// ApplicationEnvironmentPreparedEvent事件又会进入当前类中，但是由于该bootstrap的environment(spring cloud的)已经</span></span><br><span class="line">        <span class="comment">// 有名称为"bootstrap"的属性源，所以不会继续往后执行。</span></span><br><span class="line">        <span class="keyword">if</span> (environment.getPropertySources().contains(BOOTSTRAP_PROPERTY_SOURCE_NAME)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 从命令行参数、系统属性、系统环境变量解析spring.cloud.bootstrap.name的值，如果都未指定则使用默认名称bootstrap</span></span><br><span class="line">        String configName = environment.resolvePlaceholders(<span class="string">"${spring.cloud.bootstrap.name:bootstrap}"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里的event.getSpringApplication().getInitializers()返回的是SpringApplication.run()方法启动时SpringApplication的构造</span></span><br><span class="line">        <span class="comment">// 方法中通过SpringFacoriesLoader获取到的ApplicationContextInitializer。</span></span><br><span class="line">        <span class="comment">// 按照顺序如下, 括号中的jar文件名代表其对应的spring.factories文件出处：</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.DelegatingApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.ContextIdApplicationContextInitializer  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">//  org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationContextInitializer<!--?--> initializer : event.getSpringApplication().getInitializers()) {</span><br><span class="line">            <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ParentContextApplicationContextInitializer) {</span><br><span class="line">                <span class="comment">// 不会运行到这里，上面所有列出来的类都不是ParentContextApplicationContextInitializer类型</span></span><br><span class="line">                context = findBootstrapContext((ParentContextApplicationContextInitializer) initializer, configName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 运行到这里context为null</span></span><br><span class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 创建id为bootstrap的父ApplicationContext</span></span><br><span class="line">            context = bootstrapServiceContext(environment, event.getSpringApplication(), configName);</span><br><span class="line">            event.getSpringApplication()</span><br><span class="line">                .addListeners(<span class="keyword">new</span> CloseContextOnFailureApplicationListener(context));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        apply(context, event.getSpringApplication(), environment);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>创建spring cloud的ApplicationContext</p>
<p><code>context = bootstrapServiceContext(environment, event.getSpringApplication(), configName);</code>这行代码的实现如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableApplicationContext <span class="title">bootstrapServiceContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ConfigurableEnvironment environment, <span class="keyword">final</span> SpringApplication application, String configName)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建spring cloud 的environment</span></span><br><span class="line">    StandardEnvironment bootstrapEnvironment = <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">    <span class="comment">// 获取上面创建spring cloud 的可变属性源</span></span><br><span class="line">    MutablePropertySources bootstrapProperties = bootstrapEnvironment.getPropertySources();</span><br><span class="line">    <span class="keyword">for</span> (PropertySource<!--?--> source : bootstrapProperties) {</span><br><span class="line">        bootstrapProperties.remove(source.getName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从spring boot的environment获取"spring.cloud.bootstrap.location"属性</span></span><br><span class="line">    String configLocation = environment.resolvePlaceholders(<span class="string">"${spring.cloud.bootstrap.location:}"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建spring cloud的属性源的数据源，后面会把这个map加进去spring cloud的environment中</span></span><br><span class="line">    Map<string, object> bootstrapMap = <span class="keyword">new</span> HashMap<>();</string,></span><br><span class="line">    <span class="comment">// 特别注意："spring.config.name"是用于加载配置文件的名称，默认为bootstrap，</span></span><br><span class="line">    <span class="comment">// 在ConfigFileApplicationListener事件中会获取属性为"spring.config.name"的值作为配置文件的名称去加载配置文件</span></span><br><span class="line">    bootstrapMap.put(<span class="string">"spring.config.name"</span>, configName);</span><br><span class="line">    bootstrapMap.put(<span class="string">"spring.main.web-application-type"</span>, <span class="string">"none"</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(configLocation)) {</span><br><span class="line">        <span class="comment">// 特别注意："spring.config.location"是用于加载配置文件的搜索路径，默认为空，</span></span><br><span class="line">        <span class="comment">// 在ConfigFileApplicationListener事件中会获取属性为"spring.config.location"的值，从该路径下去加载配置文件</span></span><br><span class="line">        bootstrapMap.put(<span class="string">"spring.config.location"</span>, configLocation);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 为spring cloud的environment添加name为"bootstrap"的属性源，属性源中包括2个属性"spring.config.name"及"spring.config.location"</span></span><br><span class="line">    bootstrapProperties.addFirst(<span class="keyword">new</span> MapPropertySource(BOOTSTRAP_PROPERTY_SOURCE_NAME, bootstrapMap));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历spring boot的属性源</span></span><br><span class="line">    <span class="keyword">for</span> (PropertySource<!--?--> source : environment.getPropertySources()) {</span><br><span class="line">        <span class="comment">// 如果是占位符的属性源就跳过</span></span><br><span class="line">        <span class="keyword">if</span> (source <span class="keyword">instanceof</span> StubPropertySource) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 将spring boot的属性源添加到spring cloud的environment中，</span></span><br><span class="line">        <span class="comment">// 注意这里是addLast</span></span><br><span class="line">        bootstrapProperties.addLast(source);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建spring cloud自身的SpringApplication了，</span></span><br><span class="line">    <span class="comment">// SpringApplicationBuilder的构造方法会创建SpringApplication对象（又获取ApplicationContextInitializer和ApplicationListener）</span></span><br><span class="line">    SpringApplicationBuilder builder = <span class="keyword">new</span> SpringApplicationBuilder()</span><br><span class="line">        <span class="comment">// 指定激活的环境，此处activeProfiles是通过系统变量"spring.profiles.active"设置的</span></span><br><span class="line">        .profiles(environment.getActiveProfiles())</span><br><span class="line">        <span class="comment">// 关闭banner输出</span></span><br><span class="line">        .bannerMode(Mode.OFF)</span><br><span class="line">        <span class="comment">// 设置spring cloud的环境，设置后在调用run()方法时就不会再创建了</span></span><br><span class="line">        <span class="comment">// 这里可以回顾下SpringApplication.getOrCreateEnvironment()方法的实现</span></span><br><span class="line">        .environment(bootstrapEnvironment)</span><br><span class="line">        <span class="comment">// 不打印启动日志</span></span><br><span class="line">        .registerShutdownHook(<span class="keyword">false</span>).logStartupInfo(<span class="keyword">false</span>)</span><br><span class="line">        <span class="comment">// 非web</span></span><br><span class="line">        .web(WebApplicationType.NONE);</span><br><span class="line">    <span class="comment">// 返回SpringApplicationBuilder创建的SpringApplication</span></span><br><span class="line">    <span class="keyword">final</span> SpringApplication builderApplication = builder.application();</span><br><span class="line">    <span class="comment">// SpringApplication的构造方法中有this.mainApplicationClass = deduceMainApplicationClass();这行代码会获取mainApplicationClass</span></span><br><span class="line">    <span class="comment">// 所以builderApplication.getMainApplicationClass()一般不会返回为null</span></span><br><span class="line">    <span class="keyword">if</span> (builderApplication.getMainApplicationClass() == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// 不会进入这里</span></span><br><span class="line">        <span class="comment">// gh_425:</span></span><br><span class="line">        <span class="comment">// SpringApplication cannot deduce the MainApplicationClass here</span></span><br><span class="line">        <span class="comment">// if it is booted from SpringBootServletInitializer due to the</span></span><br><span class="line">        <span class="comment">// absense of the "main" method in stackTraces.</span></span><br><span class="line">        <span class="comment">// But luckily this method's second parameter "application" here</span></span><br><span class="line">        <span class="comment">// carries the real MainApplicationClass which has been explicitly</span></span><br><span class="line">        <span class="comment">// set by SpringBootServletInitializer itself already.</span></span><br><span class="line">        builder.main(application.getMainApplicationClass());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (environment.getPropertySources().contains(<span class="string">"refreshArgs"</span>)) {</span><br><span class="line">        <span class="comment">// If we are doing a context refresh, really we only want to refresh the</span></span><br><span class="line">        <span class="comment">// Environment, and there are some toxic listeners (like the</span></span><br><span class="line">        <span class="comment">// LoggingApplicationListener) that affect global static state, so we need a</span></span><br><span class="line">        <span class="comment">// way to switch those off.</span></span><br><span class="line">        builderApplication</span><br><span class="line">            .setListeners(filterListeners(builderApplication.getListeners()));</span><br><span class="line">    }</span><br><span class="line">    builder.sources(BootstrapImportSelectorConfiguration<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 关键代码，创建spring cloud自身的ApplicationContext，又会把spring boot的SpringApplication.run()方法的流程全部走一遍</span></span><br><span class="line">    <span class="keyword">final</span> ConfigurableApplicationContext context = builder.run();</span><br><span class="line">    <span class="comment">// gh-214 using spring.application.name=bootstrap to set the context id via</span></span><br><span class="line">    <span class="comment">// `ContextIdApplicationContextInitializer` prevents apps from getting the actual</span></span><br><span class="line">    <span class="comment">// spring.application.name</span></span><br><span class="line">    <span class="comment">// during the bootstrap phase.</span></span><br><span class="line">    <span class="comment">// 设置spring cloud的ApplicationContext的id为"bootstrap"</span></span><br><span class="line">    context.setId(<span class="string">"bootstrap"</span>);</span><br><span class="line">    <span class="comment">// 这里的addAncestorInitializer方法的第1个参数application是spring boot的SpringApplication对象</span></span><br><span class="line">    <span class="comment">// 而第2个参数context是上一行代码返回的spring cloud的ApplicationContext</span></span><br><span class="line">    addAncestorInitializer(application, context);</span><br><span class="line">    <span class="comment">// spring cloud的环境中现在有一些属性是我们不想在父ApplicationContext中看到的，所以把它移除(稍后会添加回来)</span></span><br><span class="line">    bootstrapProperties.remove(BOOTSTRAP_PROPERTY_SOURCE_NAME);</span><br><span class="line">    <span class="comment">// 合并spring cloud中name为"defaultProperties"属性源至spring boot中，注意同名属性不覆盖</span></span><br><span class="line">    mergeDefaultProperties(environment.getPropertySources(), bootstrapProperties);</span><br><span class="line">    <span class="comment">// 返回spring cloud的ApplicationContext</span></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  application   该属性是spring boot的SpringApplication对象</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span>  context       spring cloud的ApplicationContext</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAncestorInitializer</span><span class="params">(SpringApplication application,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">    <span class="keyword">boolean</span> installed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (ApplicationContextInitializer<!--?--> initializer : application</span><br><span class="line">         .getInitializers()) {</span><br><span class="line">        <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> AncestorInitializer) {</span><br><span class="line">            installed = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// New parent</span></span><br><span class="line">            ((AncestorInitializer) initializer).setParent(context);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!installed) {</span><br><span class="line">        application.addInitializers(<span class="keyword">new</span> AncestorInitializer(context));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这个方法的目的如下：</span></span><br><span class="line"><span class="comment">* 1、如果spring cloud中有name为"springCloudDefaultProperties"的属性源，而spring boot中没有该名称的属性源，则直接把</span></span><br><span class="line"><span class="comment">*    spring cloud的name为"springCloudDefaultProperties"的属性源加到spring boot的environment的末尾。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 2、如果spring cloud中有name为"springCloudDefaultProperties"的属性源，spring boot中也有该名称的属性源，则把spring cloud</span></span><br><span class="line"><span class="comment">*    的属性源合并到spring boot的environment中，如果在spring cloud中的属性在spring boot中不存在则追加到spring boot中，特别注意</span></span><br><span class="line"><span class="comment">*    如果spring cloud中的属性在spring boot中也存在，则不会覆盖，也就是说spring boot和spring cloud拥有相同key的属性时，spring boot的</span></span><br><span class="line"><span class="comment">*    配置文件中的属性优先级高，不会合并该属性。</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> environment 它是spring boot的environment</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> bootstrap 它是spring cloud的environment</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeDefaultProperties</span><span class="params">(MutablePropertySources environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    MutablePropertySources bootstrap)</span> </span>{</span><br><span class="line">    String name = DEFAULT_PROPERTIES;</span><br><span class="line">    <span class="comment">// 判断spring cloud中是否有name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">    <span class="keyword">if</span> (bootstrap.contains(name)) {</span><br><span class="line">        <span class="comment">// 获得spring cloud中name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">        PropertySource<!--?--> source = bootstrap.get(name);</span><br><span class="line">        <span class="comment">// 判断spring boot中是否有name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">        <span class="keyword">if</span> (!environment.contains(name)) {</span><br><span class="line">            <span class="comment">// 如果spring cloud中有name为"springCloudDefaultProperties"的属性源，而spring boot中没有该名称的属性源，则直接把</span></span><br><span class="line">            <span class="comment">// spring cloud的name为"springCloudDefaultProperties"的属性源加到spring boot的environment的末尾</span></span><br><span class="line">            environment.addLast(source);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// spring cloud中有name为"springCloudDefaultProperties"的属性源，spring boot中也有该名称的属性源</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 获得spring boot中name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">            PropertySource<!--?--> target = environment.get(name);</span><br><span class="line">            <span class="comment">// 判断spring boot和spring cloud的name为"springCloudDefaultProperties"的属性源的类型是否是MapPropertySource类型</span></span><br><span class="line">            <span class="keyword">if</span> (target <span class="keyword">instanceof</span> MapPropertySource && target != source</span><br><span class="line">                && source <span class="keyword">instanceof</span> MapPropertySource) {</span><br><span class="line">                <span class="comment">// 获得spring boot中name为"springCloudDefaultProperties"的属性源的底层数据源</span></span><br><span class="line">                Map<string, object> targetMap = ((MapPropertySource) target).getSource();</string,></span><br><span class="line">                <span class="comment">// 获得spring cloud中name为"springCloudDefaultProperties"的属性源的底层数据源</span></span><br><span class="line">                Map<string, object> map = ((MapPropertySource) source).getSource();</string,></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 遍历spring cloud中name为"springCloudDefaultProperties"的属性源的底层数据源</span></span><br><span class="line">                <span class="keyword">for</span> (String key : map.keySet()) {</span><br><span class="line">                    <span class="comment">// 判断spring cloud中的属性在spring boot是否存在，若spring cloud中的属性在spring boot中不存在则追加到spring boot中 </span></span><br><span class="line">                    <span class="keyword">if</span> (!target.containsProperty(key)) {</span><br><span class="line">                        targetMap.put(key, map.get(key));</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 若spring cloud中的属性在spring boot中存在则忽略，spring cloud不覆盖spring boot的同名属性</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    mergeAdditionalPropertySources(environment, bootstrap);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>







<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.cloud.bootstrap.BootstrapApplicationListener</span><br><span class="line">	org.springframework.cloud.bootstrap.LoggingSystemShutdownListener</span><br><span class="line">	org.springframework.boot.context.config.ConfigFileApplicationListener(SmartApplicationListener)</span><br><span class="line">    	org.springframework.boot.env.EnvironmentPostProcessor=</span><br><span class="line">    		org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor,\</span><br><span class="line">    		org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor,\</span><br><span class="line">    		org.springframework.cloud.client.HostInfoEnvironmentPostProcessor</span><br><span class="line">            org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor,\</span><br><span class="line">            org.springframework.boot.context.config.ConfigFileApplicationListener</span><br><span class="line">            	# PropertySource Loaders</span><br><span class="line">                org.springframework.boot.env.PropertySourceLoader=\</span><br><span class="line">                    org.springframework.boot.env.PropertiesPropertySourceLoader,\</span><br><span class="line">                    org.springframework.boot.env.YamlPropertySourceLoader</span><br><span class="line">            org.springframework.boot.reactor.DebugAgentEnvironmentPostProcessor</span><br></pre></td></tr></tbody></table></figure></div>



<h4 id="3-6-4-4、ConfigFileApplicationListener"><a href="#3-6-4-4、ConfigFileApplicationListener" class="headerlink" title="3.6.4.4、ConfigFileApplicationListener"></a>3.6.4.4、ConfigFileApplicationListener</h4><p>该类的作用是加载配置文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigFileApplicationListener</span> <span class="keyword">implements</span> <span class="title">EnvironmentPostProcessor</span>, <span class="title">SmartApplicationListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) {</span><br><span class="line">            onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationPreparedEvent) {</span><br><span class="line">            onApplicationPreparedEvent(event);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationEnvironmentPreparedEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{</span><br><span class="line">        List<environmentpostprocessor> postProcessors = loadPostProcessors();</environmentpostprocessor></span><br><span class="line">        <span class="comment">// 当前类本身实现了EnvironmentPostProcessor接口，把自己加到postProcessors集合中，</span></span><br><span class="line">        postProcessors.add(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">         <span class="comment">// 进行排序，排序后此时的postProcessors按照执行顺序如下：</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor   （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.cloud.client.HostInfoEnvironmentPostProcessor          （spring-cloud-commons-2.2.0.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor   （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.ConfigFileApplicationListener      （上一行把自己添加进来的，不是来源于spring.factories文件中）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.reactor.DebugAgentEnvironmentPostProcessor        （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        AnnotationAwareOrderComparator.sort(postProcessors);</span><br><span class="line">        <span class="comment">// 遍历处理每一个EnvironmentPostProcessor</span></span><br><span class="line">        <span class="keyword">for</span> (EnvironmentPostProcessor postProcessor : postProcessors) {</span><br><span class="line">            postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationPreparedEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.logger.switchTo(ConfigFileApplicationListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        addPostProcessors(((ApplicationPreparedEvent) event).getApplicationContext());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function">List<environmentpostprocessor> <span class="title">loadPostProcessors</span><span class="params">()</span> </environmentpostprocessor></span>{</span><br><span class="line">        <span class="comment">// 返回的EnvironmentPostProcessor按照执行顺序如下：</span></span><br><span class="line">        <span class="comment">// 括号中的代表该自动化配置的所在的spring.factories文件出处</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor   （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.cloud.client.HostInfoEnvironmentPostProcessor          （spring-cloud-commons-2.2.0.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor   （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.reactor.DebugAgentEnvironmentPostProcessor        （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="keyword">return</span> SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor<span class="class">.<span class="keyword">class</span>, <span class="title">getClass</span>().<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当前类实现了EnvironmentPostProcessor接口</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> </span>{</span><br><span class="line">		addPropertySources(environment, application.getResourceLoader());</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<ul>
<li><p><code>SystemEnvironmentPropertySourceEnvironmentPostProcessor</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemEnvironmentPropertySourceEnvironmentPostProcessor</span> <span class="keyword">implements</span> <span class="title">EnvironmentPostProcessor</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> </span>{</span><br><span class="line">        <span class="comment">// sourceName的值为"systemEnvironment"</span></span><br><span class="line">        String sourceName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;</span><br><span class="line">        <span class="comment">// 获取name为"systemEnvironment"的系统环境变量属性源</span></span><br><span class="line">        PropertySource<!--?--> propertySource = environment.getPropertySources().get(sourceName);</span><br><span class="line">        <span class="comment">// 一般都不会为null</span></span><br><span class="line">        <span class="keyword">if</span> (propertySource != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 会执行到这里，调用当前类的replacePropertySource方法</span></span><br><span class="line">            replacePropertySource(environment, sourceName, propertySource);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> environment spring boot/cloud的环境对象，servlet环境是StandardServletEnvironment</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> sourceName  值为"systemEnvironment"</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@parm</span> propertySource  名称为"systemEnvironment"的系统环境变量属性源</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replacePropertySource</span><span class="params">(ConfigurableEnvironment environment, String sourceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       PropertySource<!--?--> propertySource)</span> </span>{</span><br><span class="line">        <span class="comment">// 获取所有系统环境变量</span></span><br><span class="line">        Map<string, object> originalSource = (Map<string, object>) propertySource.getSource();</string,></string,></span><br><span class="line">        SystemEnvironmentPropertySource source = <span class="keyword">new</span> OriginAwareSystemEnvironmentPropertySource(sourceName,</span><br><span class="line">                                                                                                originalSource);</span><br><span class="line">        <span class="comment">// 把name为"systemEnvironment"的系统环境变量属性源替换为OriginAwareSystemEnvironmentPropertySource</span></span><br><span class="line">        <span class="comment">// 有什么作用？？目前还不清楚为什么要这样做。</span></span><br><span class="line">        environment.getPropertySources().replace(sourceName, source);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<ul>
<li><p><code>SpringApplicationJsonEnvironmentPostProcessor</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 找到environment中Key为"spring.application.json"的属性，将其值解析为Map对象，作为一个属性源，</span></span><br><span class="line"><span class="comment">* 向environment中添加1个name为"spring.application.json"的JsonPropertySource属性源，数据源是之前描述的解析得到的Map对象</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationJsonEnvironmentPostProcessor</span> <span class="keyword">implements</span> <span class="title">EnvironmentPostProcessor</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_APPLICATION_JSON_PROPERTY = <span class="string">"spring.application.json"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_APPLICATION_JSON_ENVIRONMENT_VARIABLE = <span class="string">"SPRING_APPLICATION_JSON"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> </span>{</span><br><span class="line">        <span class="comment">// 获取可变属性源，包括springApplicationCommandLineArgs、configurationProperties、bootstrap、systemProperties、systemEnvironment属性源</span></span><br><span class="line">        MutablePropertySources propertySources = environment.getPropertySources();</span><br><span class="line">        propertySources.stream()</span><br><span class="line">            <span class="comment">//  获取"spring.application.json" 或 "SPRING_APPLICATION_JSON"属性的实际值对应的JsonPropertyValue对象</span></span><br><span class="line">            <span class="comment">// 如果当前属性源不存在该属性则返回null</span></span><br><span class="line">            <span class="comment">// 返回的数据形式如[null, JsonPropertyValue, null, JsonPropertyValue, JsonPropertyValue, null...]</span></span><br><span class="line">            .map(JsonPropertyValue::get)</span><br><span class="line">            <span class="comment">// 找出第一个非null的JsonPropertyValue</span></span><br><span class="line">            .filter(Objects::nonNull).findFirst()</span><br><span class="line">            <span class="comment">// 如果存在"spring.application.json" 或 "SPRING_APPLICATION_JSON"属性的实际值对应的JsonPropertyValue对象则进行处理</span></span><br><span class="line">            .ifPresent((v) -> processJson(environment, v));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理spring boot/cloud环境中"spring.application.json" 或 "SPRING_APPLICATION_JSON"属性的实际值对应的JsonPropertyValue对象</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processJson</span><span class="params">(ConfigurableEnvironment environment, JsonPropertyValue propertyValue)</span> </span>{</span><br><span class="line">        <span class="comment">// 根据classpath类路径是否存在com.fasterxml.jackson.databind.ObjectMapper、com.google.gson.Gson、org.yaml.snakeyaml.Yaml</span></span><br><span class="line">        <span class="comment">// 类返回对应的解析器JacksonJsonParser、GsonJsonParser、YamlJsonParser、BasicJsonParser</span></span><br><span class="line">		JsonParser parser = JsonParserFactory.getJsonParser();</span><br><span class="line">         <span class="comment">// propertyValue.getJson()的值为environment中"spring.application.json" 或 "SPRING_APPLICATION_JSON"属性的值</span></span><br><span class="line">        <span class="comment">// 使用jackson、gson、yaml将字符串解析为Map类型对象</span></span><br><span class="line">		Map<string, object> map = parser.parseMap(propertyValue.getJson());</string,></span><br><span class="line">		<span class="keyword">if</span> (!map.isEmpty()) {</span><br><span class="line">             <span class="comment">// 添加name为"spring.application.json"的属性源 </span></span><br><span class="line">			addJsonPropertySource(environment, <span class="keyword">new</span> JsonPropertySource(propertyValue, flatten(map)));</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonPropertyValue</span> </span>{</span><br><span class="line">		<span class="comment">// 实际值为 ["spring.application.json", "SPRING_APPLICATION_JSON"]</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CANDIDATES = { SPRING_APPLICATION_JSON_PROPERTY,</span><br><span class="line">                                                    SPRING_APPLICATION_JSON_ENVIRONMENT_VARIABLE };</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> PropertySource<!--?--> propertySource;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String propertyName;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String json;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> propertySource "spring.application.json" 或 "SPRING_APPLICATION_JSON"属性所在的属性源</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> propertyName 表示根据哪个属性名找到的属性值的，值为字符串"spring.application.json" 或 "SPRING_APPLICATION_JSON"其中之一</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> json 在envorpnment中"spring.application.json" 或 "SPRING_APPLICATION_JSON"属性对应的值</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		JsonPropertyValue(PropertySource<!--?--> propertySource, String propertyName, String json) {</span><br><span class="line">			<span class="keyword">this</span>.propertySource = propertySource;</span><br><span class="line">			<span class="keyword">this</span>.propertyName = propertyName;</span><br><span class="line">			<span class="keyword">this</span>.json = json;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> propertySource  属性源</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> JsonPropertyValue <span class="title">get</span><span class="params">(PropertySource<!--?--> propertySource)</span> </span>{</span><br><span class="line">            <span class="keyword">for</span> (String candidate : CANDIDATES) {</span><br><span class="line">                <span class="comment">// 获取"spring.application.json" 或 "SPRING_APPLICATION_JSON"属性的实际值</span></span><br><span class="line">                Object value = propertySource.getProperty(candidate);</span><br><span class="line">                <span class="comment">// 判断属性的值是否是字符串并且有内容</span></span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String && StringUtils.hasLength((String) value)) {</span><br><span class="line">                    <span class="comment">// 返回当前类的实例</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> JsonPropertyValue(propertySource, candidate, (String) value);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonPropertySource</span> <span class="keyword">extends</span> <span class="title">MapPropertySource</span> <span class="keyword">implements</span> <span class="title">OriginLookup</span><<span class="title">String</span>> </span>{</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> JsonPropertyValue propertyValue;</span><br><span class="line"></span><br><span class="line">		JsonPropertySource(JsonPropertyValue propertyValue, Map<string, object> source) {</string,></span><br><span class="line">             <span class="comment">// 属性源的name为"spring.application.json"</span></span><br><span class="line">			<span class="keyword">super</span>(SPRING_APPLICATION_JSON_PROPERTY, source);</span><br><span class="line">			<span class="keyword">this</span>.propertyValue = propertyValue;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> Origin <span class="title">getOrigin</span><span class="params">(String key)</span> </span>{</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.propertyValue.getOrigin();</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<ul>
<li><p><code>HostInfoEnvironmentPostProcessor</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostInfoEnvironmentPostProcessor</span> <span class="keyword">implements</span> <span class="title">EnvironmentPostProcessor</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       SpringApplication application)</span> </span>{</span><br><span class="line">        <span class="comment">// 找到第1个非回环地址(非127.xxx.xxx.xxx)信息</span></span><br><span class="line">        InetUtils.HostInfo hostInfo = getFirstNonLoopbackHostInfo(environment);</span><br><span class="line">        LinkedHashMap<string, object> map = <span class="keyword">new</span> LinkedHashMap<>();</string,></span><br><span class="line">        <span class="comment">// 计算机名，例如我的电脑是calebzhao，win10系统在桌面图标“此电脑”右键菜单点击属性即可看到计算机名</span></span><br><span class="line">        map.put(<span class="string">"spring.cloud.client.hostname"</span>, hostInfo.getHostname());</span><br><span class="line">        <span class="comment">// 电脑ip地址，不是本地回环地址，一般个人计算机是192.168.xxx.xxx</span></span><br><span class="line">        map.put(<span class="string">"spring.cloud.client.ip-address"</span>, hostInfo.getIpAddress());</span><br><span class="line">        MapPropertySource propertySource = <span class="keyword">new</span> MapPropertySource(</span><br><span class="line">            <span class="string">"springCloudClientHostInfo"</span>, map);</span><br><span class="line">        <span class="comment">// 添加了一个名称为springCloudClientHostInfo的属性源</span></span><br><span class="line">        environment.getPropertySources().addLast(propertySource);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> HostInfo <span class="title">getFirstNonLoopbackHostInfo</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">        InetUtilsProperties target = <span class="keyword">new</span> InetUtilsProperties();</span><br><span class="line">        ConfigurationPropertySources.attach(environment);</span><br><span class="line">        Binder.get(environment).bind(InetUtilsProperties.PREFIX,</span><br><span class="line">                                     Bindable.ofInstance(target));</span><br><span class="line">        <span class="keyword">try</span> (InetUtils utils = <span class="keyword">new</span> InetUtils(target)) {</span><br><span class="line">            <span class="keyword">return</span> utils.findFirstNonLoopbackHostInfo();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<ul>
<li><p><code>ConfigFileApplicationListener</code></p>
<p>默认从<code>["file:./config/", "file:./", "classpath:/config/", "classpath:/"]</code>目录下加载配置文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigFileApplicationListener</span> <span class="keyword">implements</span> <span class="title">EnvironmentPostProcessor</span>, <span class="title">SmartApplicationListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROPERTIES = <span class="string">"defaultProperties"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTIVE_PROFILES_PROPERTY = <span class="string">"spring.profiles.active"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String INCLUDE_PROFILES_PROPERTY = <span class="string">"spring.profiles.include"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        Set<string> filteredProperties = <span class="keyword">new</span> HashSet<>();</string></span><br><span class="line">        filteredProperties.add(<span class="string">"spring.profiles.active"</span>);</span><br><span class="line">        filteredProperties.add(<span class="string">"spring.profiles.include"</span>);</span><br><span class="line">        LOAD_FILTERED_PROPERTY = Collections.unmodifiableSet(filteredProperties);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 入口</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> </span>{</span><br><span class="line">        addPropertySources(environment, application.getResourceLoader());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addPropertySources</span><span class="params">(ConfigurableEnvironment environment, ResourceLoader resourceLoader)</span> </span>{</span><br><span class="line">        <span class="comment">// 在systemEnvironment属性源之后添加能够获取随机数的属性源，属性源的名称为"random"</span></span><br><span class="line">        RandomValuePropertySource.addToEnvironment(environment);</span><br><span class="line">        <span class="comment">// 加载</span></span><br><span class="line">        <span class="keyword">new</span> Loader(environment, resourceLoader).load();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Loader</span> </span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> PropertySourcesPlaceholdersResolver placeholdersResolver;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List<propertysourceloader> propertySourceLoaders;</propertysourceloader></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Deque<profile> profiles;</profile></span><br><span class="line"></span><br><span class="line">        Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) {</span><br><span class="line">            <span class="keyword">this</span>.environment = environment;</span><br><span class="line">            <span class="keyword">this</span>.placeholdersResolver = <span class="keyword">new</span> PropertySourcesPlaceholdersResolver(<span class="keyword">this</span>.environment);</span><br><span class="line">            <span class="keyword">this</span>.resourceLoader = (resourceLoader != <span class="keyword">null</span>) ? resourceLoader : <span class="keyword">new</span> DefaultResourceLoader();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 这里非常关键，到spring.factories中找key为org.springframework.boot.env.PropertySourceLoader的属性源加载器,</span></span><br><span class="line">            <span class="comment">// 括号中的内容代表该PropertySourceLoader所在的spring.factories文件所在的jar文件，按照执行顺序找到的实现如下：</span></span><br><span class="line">            <span class="comment">// org.springframework.boot.env.PropertiesPropertySourceLoader  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">            <span class="comment">// org.springframework.boot.env.YamlPropertySourceLoader       （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">            <span class="keyword">this</span>.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                                                                             <span class="title">getClass</span>().<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实际处理逻辑：加载项目下的application.yml，，默认从["file:./config/", "file:./", "classpath:/config/", "classpath:/"]加载配置文件</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="comment">// environment包括springApplicationCommandLineArgs、configurationProperties、【bootstrap】、systemProperties、systemEnvironment属性源</span></span><br><span class="line">            FilteredPropertySource.apply(<span class="keyword">this</span>.environment, </span><br><span class="line">                                         DEFAULT_PROPERTIES,  <span class="comment">// defaultProperties</span></span><br><span class="line">                                         LOAD_FILTERED_PROPERTY, <span class="comment">// ["spring.profiles.active", "spring.profiles.include"]</span></span><br><span class="line">                                         (defaultProperties) -> {</span><br><span class="line"></span><br><span class="line">                                             <span class="keyword">this</span>.profiles = <span class="keyword">new</span> LinkedList<>();</span><br><span class="line">                                             <span class="keyword">this</span>.processedProfiles = <span class="keyword">new</span> LinkedList<>();</span><br><span class="line">                                             <span class="keyword">this</span>.activatedProfiles = <span class="keyword">false</span>;</span><br><span class="line">                                             <span class="keyword">this</span>.loaded = <span class="keyword">new</span> LinkedHashMap<>();</span><br><span class="line">                                             <span class="comment">// 1.把环境中的profiles取出来，默认会增加1个为null的profile</span></span><br><span class="line">                                             <span class="comment">// 如果用户如果自己通过命令行参数、jvm系统属性、系统环境变量指定了"spring.profiles.active"</span></span><br><span class="line">                                             <span class="comment">// 或"spring.profiles.include"属性值则不使用默认的profile，</span></span><br><span class="line">                                             <span class="comment">// 否则表明用户没有明确指定启用哪些profile，那么就使用spring默认的profile，</span></span><br><span class="line">                                             <span class="comment">// 用户设置可以覆盖spring默认设置</span></span><br><span class="line">                                             initializeProfiles();</span><br><span class="line">                                              <span class="comment">// 2.循环处理profiles，查找文件位置然后去加载文件</span></span><br><span class="line">                                             <span class="keyword">while</span> (!<span class="keyword">this</span>.profiles.isEmpty()) {</span><br><span class="line">                                                 Profile profile = <span class="keyword">this</span>.profiles.poll();</span><br><span class="line">                                                 <span class="comment">// 判断是否是默认profile</span></span><br><span class="line">                                                 <span class="keyword">if</span> (isDefaultProfile(profile)) {</span><br><span class="line">                                                     addProfileToEnvironment(profile.getName());</span><br><span class="line">                                                 }</span><br><span class="line"></span><br><span class="line">                                                 <span class="comment">// 重点：加载该环境的配置文件</span></span><br><span class="line">                                                 load(profile, <span class="keyword">this</span>::getPositiveProfileFilter,</span><br><span class="line">                                                      addToLoaded(MutablePropertySources::addLast, <span class="keyword">false</span>));</span><br><span class="line">                                                 <span class="keyword">this</span>.processedProfiles.add(profile);</span><br><span class="line">                                             }</span><br><span class="line">                                             load(<span class="keyword">null</span>, <span class="keyword">this</span>::getNegativeProfileFilter, addToLoaded(MutablePropertySources::addFirst, <span class="keyword">true</span>));</span><br><span class="line">                                             addLoadedPropertySources();</span><br><span class="line">                                             applyActiveProfiles(defaultProperties);</span><br><span class="line">                                         }</span><br><span class="line">                                        );</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeProfiles</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="comment">// The default profile for these purposes is represented as null. We add it</span></span><br><span class="line">            <span class="comment">// first so that it is processed first and has lowest priority.</span></span><br><span class="line">            <span class="keyword">this</span>.profiles.add(<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//  ACTIVE_PROFILES_PROPERTY常量的值为"spring.profiles.active"</span></span><br><span class="line">            <span class="comment">// 从environment中取key为"spring.profiles.active"的值，若未找到返回空集合</span></span><br><span class="line">            Set<profile> activatedViaProperty = getProfilesFromProperty(ACTIVE_PROFILES_PROPERTY);</profile></span><br><span class="line">            <span class="comment">// INCLUDE_PROFILES_PROPERTY常量的值为"spring.profiles.include"</span></span><br><span class="line">            <span class="comment">// 从environment中取key为"spring.profiles.include"的值，若未找到返回空集合</span></span><br><span class="line">            Set<profile> includedViaProperty = getProfilesFromProperty(INCLUDE_PROFILES_PROPERTY);</profile></span><br><span class="line">            <span class="comment">// 从environment中找到profile名称不在activatedViaProperty及includedViaProperty集合内的已激活的profile的名称</span></span><br><span class="line">            List<profile> otherActiveProfiles = getOtherActiveProfiles(activatedViaProperty, includedViaProperty);</profile></span><br><span class="line">            <span class="keyword">this</span>.profiles.addAll(otherActiveProfiles);</span><br><span class="line">            <span class="comment">// Any pre-existing active profiles set via property sources (e.g.</span></span><br><span class="line">            <span class="comment">// System properties) take precedence over those added in config files.</span></span><br><span class="line">            <span class="keyword">this</span>.profiles.addAll(includedViaProperty);</span><br><span class="line">            addActiveProfiles(activatedViaProperty);</span><br><span class="line">            <span class="comment">// 如果用户如果自己通过命令行参数、jvm系统属性、系统环境变量指定了"spring.profiles.active"或"spring.profiles.include"属性值</span></span><br><span class="line">            <span class="comment">// 则不使用默认的profile，否则表明用户没有明确指定启用哪些profile，那么就使用spring默认的profile，用户设置可以覆盖spring默认设置</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.profiles.size() == <span class="number">1</span>) { <span class="comment">// profiles集合中只包含1个null元素</span></span><br><span class="line">                <span class="comment">// 获取默认profile的名称，this.environment.getDefaultProfiles()方法默认返回字符串"default"</span></span><br><span class="line">                <span class="keyword">for</span> (String defaultProfileName : <span class="keyword">this</span>.environment.getDefaultProfiles()) {</span><br><span class="line">                    <span class="comment">// 创建name为"default"的Profile对象</span></span><br><span class="line">                    Profile defaultProfile = <span class="keyword">new</span> Profile(defaultProfileName, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 将默认profile加到profiles中，此时profiles集合变成 [ null, 名称为"default"的Profile对象 ]</span></span><br><span class="line">                    <span class="keyword">this</span>.profiles.add(defaultProfile);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Set<profile> <span class="title">getProfilesFromProperty</span><span class="params">(String profilesProperty)</span> </profile></span>{</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.environment.containsProperty(profilesProperty)) {</span><br><span class="line">                <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">            }</span><br><span class="line">            Binder binder = Binder.get(<span class="keyword">this</span>.environment);</span><br><span class="line">            Set<profile> profiles = getProfiles(binder, profilesProperty);</profile></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LinkedHashSet<>(profiles);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> </span>{</span><br><span class="line">            <span class="comment">// 确定从哪些位置搜索配置文件，默认从["file:./config/", "file:./", "classpath:/config/", "classpath:/"]搜索配置文件</span></span><br><span class="line">            getSearchLocations() </span><br><span class="line">                <span class="comment">// 遍历每个搜索路径</span></span><br><span class="line">                .forEach((location) -> {</span><br><span class="line">                    <span class="comment">// 判断搜索路径是否是以"/"结尾的，如果是说明指定的目录，否则说明指定的搜索路径精确到具体文件名了</span></span><br><span class="line">                    <span class="keyword">boolean</span> isFolder = location.endsWith(<span class="string">"/"</span>);</span><br><span class="line">                    <span class="comment">// NO_SEARCH_NAMES集合默认只有1个null元素</span></span><br><span class="line">                    <span class="comment">// 如果location路径是文件夹，在用户没有明确指定"spring.config.name"属性的情况下，</span></span><br><span class="line">                    <span class="comment">// 对于spring boot返回的是["application"]，对于spring cloud返回的是["bootstrap"]</span></span><br><span class="line">                    Set<string> names = isFolder ? getSearchNames() : NO_SEARCH_NAMES;</string></span><br><span class="line">                    <span class="comment">// 重点：根据names循环加载可能的配置文件</span></span><br><span class="line">                    names.forEach((name) -> load(location, name, profile, filterFactory, consumer));</span><br><span class="line">                });</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String location, String name, Profile profile, DocumentFilterFactory filterFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                          DocumentConsumer consumer)</span> </span>{</span><br><span class="line">            <span class="comment">// 判断name是否有值</span></span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.hasText(name)) {</span><br><span class="line">                <span class="keyword">for</span> (PropertySourceLoader loader : <span class="keyword">this</span>.propertySourceLoaders) {</span><br><span class="line">                    <span class="keyword">if</span> (canLoadFileExtension(loader, location)) {</span><br><span class="line">                        load(loader, location, profile, filterFactory.getDocumentFilter(profile), consumer);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File extension of config file location '"</span> + location</span><br><span class="line">                                                + <span class="string">"' is not known to any PropertySourceLoader. If the location is meant to reference "</span></span><br><span class="line">                                                + <span class="string">"a directory, it must end in '/'"</span>);</span><br><span class="line">            }</span><br><span class="line">            Set<string> processed = <span class="keyword">new</span> HashSet<>();</string></span><br><span class="line"></span><br><span class="line">            <span class="comment">// this.propertySourceLoaders的值是在Loader类的构造方法中通过</span></span><br><span class="line">            <span class="comment">// SpringFactoriesLoader.loadFactories(PropertySourceLoader.class, getClass().getClassLoader())初始化的。</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// this.propertySourceLoaders集合属性值按照顺序包括:</span></span><br><span class="line">            <span class="comment">// org.springframework.boot.env.PropertiesPropertySourceLoader</span></span><br><span class="line">            <span class="comment">// org.springframework.boot.env.YamlPropertySourceLoader</span></span><br><span class="line">            <span class="keyword">for</span> (PropertySourceLoader loader : <span class="keyword">this</span>.propertySourceLoaders) {</span><br><span class="line">                <span class="comment">// loader.getFileExtensions()方法返回值分如下2种情况：</span></span><br><span class="line">                <span class="comment">// 对于org.springframework.boot.env.PropertiesPropertySourceLoader返回 ["properties", "xml"]</span></span><br><span class="line">                <span class="comment">// 对于org.springframework.boot.env.YamlPropertySourceLoader返回 ["yml", "yaml"]</span></span><br><span class="line">                <span class="keyword">for</span> (String fileExtension : loader.getFileExtensions()) {</span><br><span class="line">                    <span class="keyword">if</span> (processed.add(fileExtension)) {</span><br><span class="line">                        <span class="comment">// 核心方法：加载spring boot、spring cloud的配置文件</span></span><br><span class="line">                        loadForFileExtension(loader, location + name, <span class="string">"."</span> + fileExtension, profile, filterFactory,</span><br><span class="line">                                             consumer);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> loader 属性加载器，PropertiesPropertySourceLoader或YamlPropertySourceLoader</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> prefix 不包括扩展名的路径，例如"file:./config/bootstrap"、"classpath:./config/application"、"classpath:/application"等</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> fileExtension 文件扩展名，例如".yml"、".yaml"、".properties"、".xml"</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> profile 启用的环境 </span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadForFileExtension</span><span class="params">(PropertySourceLoader loader, String prefix, String fileExtension,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> </span>{</span><br><span class="line">            DocumentFilter defaultFilter = filterFactory.getDocumentFilter(<span class="keyword">null</span>);</span><br><span class="line">            DocumentFilter profileFilter = filterFactory.getDocumentFilter(profile);</span><br><span class="line">            <span class="keyword">if</span> (profile != <span class="keyword">null</span>) {</span><br><span class="line">                <span class="comment">// 加载特定环境的配置文件</span></span><br><span class="line">                <span class="comment">// 例如"file:./config/bootstrap-default.yml" 、"classpath:/application-default.yml"</span></span><br><span class="line">                String profileSpecificFile = prefix + <span class="string">"-"</span> + profile + fileExtension;</span><br><span class="line">                load(loader, profileSpecificFile, profile, defaultFilter, consumer);</span><br><span class="line">                load(loader, profileSpecificFile, profile, profileFilter, consumer);</span><br><span class="line">                <span class="comment">// Try profile specific sections in files we've already processed</span></span><br><span class="line">                <span class="keyword">for</span> (Profile processedProfile : <span class="keyword">this</span>.processedProfiles) {</span><br><span class="line">                    <span class="keyword">if</span> (processedProfile != <span class="keyword">null</span>) {</span><br><span class="line">                        String previouslyLoaded = prefix + <span class="string">"-"</span> + processedProfile + fileExtension;</span><br><span class="line">                        load(loader, previouslyLoaded, profile, profileFilter, consumer);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 加载常规配置文件</span></span><br><span class="line">            <span class="comment">// 例如"file:./config/bootstrap.yml" 、"classpath:/application.yml"</span></span><br><span class="line">            load(loader, prefix + fileExtension, profile, profileFilter, consumer);</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">				DocumentConsumer consumer)</span> </span>{</span><br><span class="line">			<span class="keyword">try</span> {</span><br><span class="line">                  <span class="comment">// 真正加载配置文件了</span></span><br><span class="line">				Resource resource = <span class="keyword">this</span>.resourceLoader.getResource(location);</span><br><span class="line">				<span class="keyword">if</span> (resource == <span class="keyword">null</span> || !resource.exists()) {</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) {</span><br><span class="line">						StringBuilder description = getDescription(<span class="string">"Skipped missing config "</span>, location, resource,</span><br><span class="line">								profile);</span><br><span class="line">						<span class="keyword">this</span>.logger.trace(description);</span><br><span class="line">					}</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				}</span><br><span class="line">				<span class="keyword">if</span> (!StringUtils.hasText(StringUtils.getFilenameExtension(resource.getFilename()))) {</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) {</span><br><span class="line">						StringBuilder description = getDescription(<span class="string">"Skipped empty config extension "</span>, location,</span><br><span class="line">								resource, profile);</span><br><span class="line">						<span class="keyword">this</span>.logger.trace(description);</span><br><span class="line">					}</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				}</span><br><span class="line">				String name = <span class="string">"applicationConfig: ["</span> + location + <span class="string">"]"</span>;</span><br><span class="line">				List<document> documents = loadDocuments(loader, name, resource);</document></span><br><span class="line">				<span class="keyword">if</span> (CollectionUtils.isEmpty(documents)) {</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) {</span><br><span class="line">						StringBuilder description = getDescription(<span class="string">"Skipped unloaded config "</span>, location, resource,</span><br><span class="line">								profile);</span><br><span class="line">						<span class="keyword">this</span>.logger.trace(description);</span><br><span class="line">					}</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				}</span><br><span class="line">				List<document> loaded = <span class="keyword">new</span> ArrayList<>();</document></span><br><span class="line">				<span class="keyword">for</span> (Document document : documents) {</span><br><span class="line">					<span class="keyword">if</span> (filter.match(document)) {</span><br><span class="line">						addActiveProfiles(document.getActiveProfiles());</span><br><span class="line">						addIncludedProfiles(document.getIncludeProfiles());</span><br><span class="line">						loaded.add(document);</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">				Collections.reverse(loaded);</span><br><span class="line">				<span class="keyword">if</span> (!loaded.isEmpty()) {</span><br><span class="line">					loaded.forEach((document) -> consumer.accept(profile, document));</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) {</span><br><span class="line">						StringBuilder description = getDescription(<span class="string">"Loaded config file "</span>, location, resource, profile);</span><br><span class="line">						<span class="keyword">this</span>.logger.debug(description);</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to load property source from location '"</span> + location + <span class="string">"'"</span>, ex);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确定从哪些位置搜索配置文件</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Set<string> <span class="title">getSearchLocations</span><span class="params">()</span> </string></span>{</span><br><span class="line">            <span class="comment">// CONFIG_LOCATION_PROPERTY常量值为"spring.config.location"</span></span><br><span class="line">            <span class="comment">// 这里的意图是判断用户是否通过命令行参数、系统属性、系统环境变量指定了"spring.config.location"属性值</span></span><br><span class="line">            <span class="comment">// 如果指定了"spring.config.location"属性值则使用用户指定的配置文件路径</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.environment.containsProperty(CONFIG_LOCATION_PROPERTY)) {</span><br><span class="line">                <span class="keyword">return</span> getSearchLocations(CONFIG_LOCATION_PROPERTY);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// CONFIG_ADDITIONAL_LOCATION_PROPERTY常量值为"spring.config.additional-location"</span></span><br><span class="line">            <span class="comment">// 这里的意图是判断命令行参数、系统属性、系统环境变量是否指定了"spring.config.additional-location"属性值</span></span><br><span class="line">            <span class="comment">// 如果指定了说明除了要解析默认的配置文件路径外，还要额外解析指定位置的配置文件，这就是additional-location所表达的意思</span></span><br><span class="line">            Set<string> locations = getSearchLocations(CONFIG_ADDITIONAL_LOCATION_PROPERTY);</string></span><br><span class="line"></span><br><span class="line">            <span class="comment">// DEFAULT_SEARCH_LOCATIONS常量值为"classpath:/,classpath:/config/,file:./,file:./config/"</span></span><br><span class="line">            locations.addAll(</span><br><span class="line">                <span class="comment">// ConfigFileApplicationListener.this.searchLocations默认为null</span></span><br><span class="line">                <span class="comment">// asResolvedSet返回值为集合["file:./config/", "file:./", "classpath:/config/", "classpath:/"]</span></span><br><span class="line">                asResolvedSet(ConfigFileApplicationListener.<span class="keyword">this</span>.searchLocations, DEFAULT_SEARCH_LOCATIONS));</span><br><span class="line">            <span class="keyword">return</span> locations;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Set<string> <span class="title">getSearchLocations</span><span class="params">(String propertyName)</span> </string></span>{</span><br><span class="line">            Set<string> locations = <span class="keyword">new</span> LinkedHashSet<>();</string></span><br><span class="line">            <span class="comment">// 判断environment环境中是否包含指定属性</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.environment.containsProperty(propertyName)) {</span><br><span class="line">                <span class="keyword">for</span> (String path : asResolvedSet(<span class="keyword">this</span>.environment.getProperty(propertyName), <span class="keyword">null</span>)) {</span><br><span class="line">                    <span class="keyword">if</span> (!path.contains(<span class="string">"$"</span>)) {</span><br><span class="line">                        path = StringUtils.cleanPath(path);</span><br><span class="line">                        <span class="keyword">if</span> (!ResourceUtils.isUrl(path)) {</span><br><span class="line">                            <span class="comment">// ResourceUtils.FILE_URL_PREFIX常量值为"file:"</span></span><br><span class="line">                            path = ResourceUtils.FILE_URL_PREFIX + path;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    locations.add(path);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> locations;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 确定配置文件的名称</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Set<string> <span class="title">getSearchNames</span><span class="params">()</span> </string></span>{</span><br><span class="line">            <span class="comment">// CONFIG_NAME_PROPERTY常量值为"spring.config.name"</span></span><br><span class="line">            <span class="comment">// 这里的意图是判断用户是否通过命令行参数、系统属性、系统环境变量指定了"spring.config.name"属性</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 特别注意spring cloud的BootstrapApplicationListener中的bootstrapServiceContext()方法中，</span></span><br><span class="line">            <span class="comment">// 创建的environment添加了1个名称为bootstrap的属性源，该属性源中就指定了"spring.config.name"属性值为"bootstrap"</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.environment.containsProperty(CONFIG_NAME_PROPERTY)) {</span><br><span class="line">                <span class="comment">// 用户指定了"spring.config.name"属性，获取属性值</span></span><br><span class="line">                String property = <span class="keyword">this</span>.environment.getProperty(CONFIG_NAME_PROPERTY);</span><br><span class="line">                <span class="comment">// 对属性值以逗号分隔，返回倒序集合，例如用户通过命令行参数指定属性-D"spring.config.name=application.yml,config.yml"</span></span><br><span class="line">                <span class="comment">// 则返回["config.yml", "application.yml"]</span></span><br><span class="line">                <span class="keyword">return</span> asResolvedSet(property, <span class="keyword">null</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// DEFAULT_NAMES常量值为"application", ConfigFileApplicationListener.this.names属性默认值为null</span></span><br><span class="line">            <span class="comment">// 运行到这里说明用户没有指定"spring.config.name"属性，那么使用默认配置文件名称"application"</span></span><br><span class="line">            <span class="keyword">return</span> asResolvedSet(ConfigFileApplicationListener.<span class="keyword">this</span>.names, DEFAULT_NAMES);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 如果value为空则使用后备值fallback，否则从environment中解析value中的占位符，然后按逗号分隔并反转</span></span><br><span class="line"><span class="comment">        * 例如：value为null, fallback为"classpath:/,classpath:/config/,file:./,file:./config/"，则返回</span></span><br><span class="line"><span class="comment">        * 集合["file:./config/", "file:./", "classpath:/config/", "classpath:/"]</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Set<string> <span class="title">asResolvedSet</span><span class="params">(String value, String fallback)</span> </string></span>{</span><br><span class="line">            <span class="comment">// 以逗号分隔的字符串分割转集合</span></span><br><span class="line">            List<string> list = Arrays.asList(StringUtils.trimArrayElements(StringUtils.commaDelimitedListToStringArray(</string></span><br><span class="line">                (value != <span class="keyword">null</span>) ? <span class="keyword">this</span>.environment.resolvePlaceholders(value) : fallback)));</span><br><span class="line">            <span class="comment">// 对集合反转</span></span><br><span class="line">            Collections.reverse(list);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LinkedHashSet<>(list);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>FilteredPropertySource</code>源码</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.context.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.MutablePropertySources;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.PropertySource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Internal {<span class="doctag">@link</span> PropertySource} implementation used by</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ConfigFileApplicationListener} to filter out properties for specific operations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilteredPropertySource</span> <span class="keyword">extends</span> <span class="title">PropertySource</span><<span class="title">PropertySource</span><!--?-->> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set<string> filteredProperties;</string></span><br><span class="line"></span><br><span class="line">    FilteredPropertySource(PropertySource<!--?--> original, Set<string> filteredProperties) {</string></span><br><span class="line">        <span class="keyword">super</span>(original.getName(), original);</span><br><span class="line">        <span class="keyword">this</span>.filteredProperties = filteredProperties;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.filteredProperties.contains(name)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> getSource().getProperty(name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@parma</span> environment spring boot/cloud的环境对象，包含了springApplicationCommandLineArgs、</span></span><br><span class="line"><span class="comment">    *                     configurationProperties、【bootstrap】、systemProperties、systemEnvironment属性源</span></span><br><span class="line"><span class="comment">    *                     </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> propertySourceName 字符串"defaultProperties"</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@parm</span>  filteredProperties 集合["spring.profiles.active", "spring.profiles.include"]</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> operation 消费者</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(ConfigurableEnvironment environment, String propertySourceName, Set<string> filteredProperties,</string></span></span></span><br><span class="line"><span class="function"><span class="params">                      Consumer<propertysource<?>> operation)</propertysource<?></span> </span>{</span><br><span class="line">        MutablePropertySources propertySources = environment.getPropertySources();</span><br><span class="line">        <span class="comment">// 获取name为"defaultProperties"的属性源</span></span><br><span class="line">        PropertySource<!--?--> original = propertySources.get(propertySourceName);</span><br><span class="line">        <span class="keyword">if</span> (original == <span class="keyword">null</span>) {</span><br><span class="line">            operation.accept(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        propertySources.replace(propertySourceName, <span class="keyword">new</span> FilteredPropertySource(original, filteredProperties));</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            operation.accept(original);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">finally</span> {</span><br><span class="line">            propertySources.replace(propertySourceName, original);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<ul>
<li><code>DebugAgentEnvironmentPostProcessor</code></li>
</ul>
<h3 id="3-6-5、绑定ConfigurableEnvironment到当前的SpringApplication实例中"><a href="#3-6-5、绑定ConfigurableEnvironment到当前的SpringApplication实例中" class="headerlink" title="3.6.5、绑定ConfigurableEnvironment到当前的SpringApplication实例中"></a>3.6.5、绑定ConfigurableEnvironment到当前的SpringApplication实例中</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bindToSpringApplication(environment);</span><br></pre></td></tr></tbody></table></figure></div>

<p>bindToSpringApplication()方法的具体源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">bindToSpringApplication</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        Binder.get(environment).bind(<span class="string">"spring.main"</span>, Bindable.ofInstance(<span class="keyword">this</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot bind to SpringApplication"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-7、configureIgnoreBeanInfo-environment"><a href="#3-7、configureIgnoreBeanInfo-environment" class="headerlink" title="3.7、configureIgnoreBeanInfo(environment)"></a>3.7、configureIgnoreBeanInfo(environment)</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureIgnoreBeanInfo</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">    <span class="comment">// 获取jvm系统属性spring.beaninfo.ignore</span></span><br><span class="line">    <span class="keyword">if</span> (System.getProperty(CachedIntrospectionResults.IGNORE_BEANINFO_PROPERTY_NAME) == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// 如果jvm系统属性中不存在key为spring.beaninfo.ignore的系统属性，则从ConfigurableEnvironment中获取它的值</span></span><br><span class="line">        <span class="comment">// 如果ConfigurableEnvironment中也没有key为spring.beaninfo.ignore的属性，则使用默认值true</span></span><br><span class="line">        <span class="comment">// 如果从environment获取到了说明则属性可能来源于系统环境变量、命令行参数、代码设置</span></span><br><span class="line">        Boolean ignore = environment.getProperty(<span class="string">"spring.beaninfo.ignore"</span>, Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">Boolean</span>.<span class="title">TRUE</span>)</span>;</span><br><span class="line">        <span class="comment">// 设置到jvm系统属性中</span></span><br><span class="line">        System.setProperty(CachedIntrospectionResults.IGNORE_BEANINFO_PROPERTY_NAME, ignore.toString());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>该方法好像不太重要，不深究它。</p>
<h2 id="3-8、创建并打印Banner"><a href="#3-8、创建并打印Banner" class="headerlink" title="3.8、创建并打印Banner"></a>3.8、创建并打印Banner</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Banner printedBanner = printBanner(environment);</span><br></pre></td></tr></tbody></table></figure></div>

<p>这是用来打印 Banner 的处理类，这个没什么好说的。</p>
<h2 id="3-9、创建ApplicationContext"><a href="#3-9、创建ApplicationContext" class="headerlink" title="3.9、创建ApplicationContext"></a>3.9、创建ApplicationContext</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context = createApplicationContext();</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="3-9-1、ApplicationContext的创建"><a href="#3-9-1、ApplicationContext的创建" class="headerlink" title="3.9.1、ApplicationContext的创建"></a>3.9.1、ApplicationContext的创建</h3><p>来看下 <code>createApplicationContext()</code> 方法的源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONTEXT_CLASS = <span class="string">"org.springframework.context."</span></span><br><span class="line">        + <span class="string">"annotation.AnnotationConfigApplicationContext"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SERVLET_WEB_CONTEXT_CLASS = <span class="string">"org.springframework.boot."</span></span><br><span class="line">        + <span class="string">"web.servlet.context.AnnotationConfigServletWebServerApplicationContext"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_REACTIVE_WEB_CONTEXT_CLASS = <span class="string">"org.springframework."</span></span><br><span class="line">        + <span class="string">"boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该属性值是可选的，指定使用哪个类创建ConfigurableApplicationContext，如果不指定则根据应用类型创建相应的ApplicationContext</span></span><br><span class="line">    <span class="keyword">private</span> Class<!--? extends ConfigurableApplicationContext--> applicationContextClass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于创建ApplicationContext的策略方法。 </span></span><br><span class="line"><span class="comment">     * 默认情况下，此方法将使用任何明确设置的应用程序上下文或应用程序上下文类，然后再降级为使用合适的默认值。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>{</span><br><span class="line">        Class<!--?--> contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line">        <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) {</span><br><span class="line">                    <span class="keyword">case</span> SERVLET:</span><br><span class="line">                        <span class="comment">// servlet应用</span></span><br><span class="line">                        contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> REACTIVE:</span><br><span class="line">                        <span class="comment">// reactive应用</span></span><br><span class="line">                        contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="comment">// 标准应用</span></span><br><span class="line">                        contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (ClassNotFoundException ex) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"Unable create a default ApplicationContext, please specify an ApplicationContextClass"</span>, ex);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 创建ConfigurableApplicationContext实现类的实例</span></span><br><span class="line">        <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>其实就是如果指定了applicationContextClass则使用指定的applicationContextClass创建ConfigurableApplicationContext，如果没有明确设置applicationContextClass，则根据不同的应用类型初始化不同的上下文应用类，可以看到createApplicationContext()方法返回了ConfigurableApplicationContext。</p>
<p>那么这个ConfigurableApplicationContext又是什么？</p>
<p>查看ConfigurableApplicationContext的源码，可以发现它是个接口，又继承了ApplicationContext接口，下面先看ApplicationContext接口的源码。</p>
<h3 id="3-9-2、ApplicationContext接口"><a href="#3-9-2、ApplicationContext接口" class="headerlink" title="3.9.2、ApplicationContext接口"></a>3.9.2、ApplicationContext接口</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这是一个为应用程序提供配置的中央化的接口，在应用程序运行时，它是只读的，但是如果该接口的实现支持的话那么它的配置</span></span><br><span class="line"><span class="comment">* 是可以被重新加载的，即ApplicationContext的实现可以让配置变成可写的（非只读），在需要的时候可以重新加载配置，让配置发生变化。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 一个ApplicationContext提供了如下的功能：</span></span><br><span class="line"><span class="comment">* 1、用于访问应用程序组件的bean工厂方法，该能力继承于org.springframework.beans.factory.ListableBeanFactory接口</span></span><br><span class="line"><span class="comment">* 2、以通用方式加载文件资源的能力，该能力继承于org.springframework.core.io.ResourceLoader接口</span></span><br><span class="line"><span class="comment">* 3、向注册的监听器发布事件的能力，该能力继承于ApplicationEventPublisher接口</span></span><br><span class="line"><span class="comment">* 4、解析消息的能力，支持i18n国际化，该能力继承于MessageSource接口</span></span><br><span class="line"><span class="comment">* 5、可以继承父上下文，在子上下文中的定义总是具有更高的优先级（其实就是父子ApplicationContext中都有相同的bean时优先使用子上下</span></span><br><span class="line"><span class="comment">*    文中定义的bean）,这也就意味着可以在整个web应用中使用一个单一的父上下文，而每个servlet可以有它自己的子上下文，这些子上下文</span></span><br><span class="line"><span class="comment">*    之间是互相独立的，而他们拥有相同的父上下文</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContext</span> <span class="keyword">extends</span> <span class="title">EnvironmentCapable</span>, <span class="title">ListableBeanFactory</span>, <span class="title">HierarchicalBeanFactory</span>,</span></span><br><span class="line"><span class="class"><span class="title">MessageSource</span>, <span class="title">ApplicationEventPublisher</span>, <span class="title">ResourcePatternResolver</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回当前应用程序上下文的唯一id，如果没有可能返回null        </span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回此上下文所属的已部署应用的名称        </span></span><br><span class="line">    <span class="function">String <span class="title">getApplicationName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为这个上下文返回一个友好可读的名称        </span></span><br><span class="line">    <span class="function">String <span class="title">getDisplayName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回这个上下文第一次被加载的时间戳（毫秒）        </span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getStartupDate</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回这个上下文的父上下文        </span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function">ApplicationContext <span class="title">getParent</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为这个上下文公开AutowireCapableBeanFactory功能。</span></span><br><span class="line">    <span class="comment">// 除非用于初始化位于应用程序上下文之外的bean实例，并将Spring bean的生命周期(全部或部分)应用于这些实例，</span></span><br><span class="line">    <span class="comment">// 应用程序通常不会使用到此功能，        </span></span><br><span class="line">    <span class="function">AutowireCapableBeanFactory <span class="title">getAutowireCapableBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="3-9-3、ConfigurableApplicationContext"><a href="#3-9-3、ConfigurableApplicationContext" class="headerlink" title="3.9.3、ConfigurableApplicationContext"></a>3.9.3、ConfigurableApplicationContext</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这个接口是一个SPI接口，绝大多数应用(即便不是全部)程序上下文都实现了该接口，该接口除了有继承ApplicationContext接口中的</span></span><br><span class="line"><span class="comment">* 方法外，它还提供了用于配置应用程序上下文的功能。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 与配置和与生命周期相关的方法被封装在该接口中而不是父接口ApplicationContext中，这是为了避免开发人员开发的应用可以通过</span></span><br><span class="line"><span class="comment">* ApplicationContext直接访问到与配置和与生命周期相关的方法，这些与配置和与生命周期相关的方法应该只能被与启动和关闭应用相关</span></span><br><span class="line"><span class="comment">* 的代码所使用。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Lifecycle 接口则是负责对 context 的生命周期进行管理，提供了 start() 和 stop() 以及 isRunning() 方法。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Closeable 接口是JDK提供的接口，用于关闭组件，释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span>, <span class="title">Lifecycle</span>, <span class="title">Closeable</span> </span>{</span><br><span class="line">    <span class="comment">// 应用上下文配置时，这些符号用于分割多个配置路径</span></span><br><span class="line">    String CONFIG_LOCATION_DELIMITERS = <span class="string">",; \t\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工厂中ConversionService bean的名称。如果没有提供，则使用默认的转换规则。</span></span><br><span class="line">    <span class="comment">// 参见org.springframework.core.convert.ConversionService</span></span><br><span class="line">    String CONVERSION_SERVICE_BEAN_NAME = <span class="string">"conversionService"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// LoadTimeWaver类所对应的Bean在容器中的名字。如果提供了该实例，上下文会使用临时的ClassLoader</span></span><br><span class="line">    <span class="comment">// 这样，LoadTimeWaver就可以使用bean确切的类型了</span></span><br><span class="line">    <span class="comment">//参见org.springframework.instrument.classloading.LoadTimeWeaver</span></span><br><span class="line">    String LOAD_TIME_WEAVER_BEAN_NAME = <span class="string">"loadTimeWeaver"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Environment类在容器中的bean名称</span></span><br><span class="line">    String ENVIRONMENT_BEAN_NAME = <span class="string">"environment"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// System系统变量在容器中对应的Bean的名字，参见java.lang.System#getProperties()</span></span><br><span class="line">    String SYSTEM_PROPERTIES_BEAN_NAME = <span class="string">"systemProperties"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// System 环境变量在容器中对应的Bean的名字，参见java.lang.System#getenv()</span></span><br><span class="line">    String SYSTEM_ENVIRONMENT_BEAN_NAME = <span class="string">"systemEnvironment"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于关闭应用时钩子线程的名称，默认SpringContextShutdownHook，参见registerShutdownHook()方法</span></span><br><span class="line">    String SHUTDOWN_HOOK_THREAD_NAME = <span class="string">"SpringContextShutdownHook"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为应用上下文设置一个唯一的id</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为该上下文设置父上下文。</span></span><br><span class="line">    <span class="comment">// 需要注意的是，父上下文一经设定就不应该修改。并且一般不会在构造方法中对其进行配置，因为很多时候</span></span><br><span class="line">    <span class="comment">// 其父容器还不可用。比如WebApplicationContext。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setParent</span><span class="params">(@Nullable ApplicationContext parent)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置容器的Environment变量</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(ConfigurableEnvironment environment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以COnfigurableEnvironment的形式返回此容器的环境，以使用户更好的进行配置</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ConfigurableEnvironment <span class="title">getEnvironment</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此方法一般在读取应用上下文配置的时候调用，用以向此容器中增加BeanFactoryPostProcessor。</span></span><br><span class="line"><span class="comment">     * 增加的Processor会在容器refresh的时候使用。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addBeanFactoryPostProcessor</span><span class="params">(BeanFactoryPostProcessor postProcessor)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向容器增加一个ApplicationListener，增加的Listener用于发布上下文事件如refresh和shutdown等，</span></span><br><span class="line"><span class="comment">     * 需要注意的是，如果此上下文还没有启动，那么在此注册的Listener将会在上下文refresh的时候，全部被调用，</span></span><br><span class="line"><span class="comment">     * 如果上下文已经是active状态的了，就会在multicaster中使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener<!--?--> listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向容器中注入给定的Protocol resolver，允许多个实例同时存在。</span></span><br><span class="line"><span class="comment">     * 在此注册的每一个resolver都将会在上下的标准解析规则之前使用。因此，某种程度上来说</span></span><br><span class="line"><span class="comment">     * 这里注册的resolver可以覆盖上下文的resolver</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addProtocolResolver</span><span class="params">(ProtocolResolver resolver)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载或刷新资源配置文件（XML、properties, 与数据库相关的schema）。</span></span><br><span class="line"><span class="comment">     * 由于此方法是一个初始化方法，因此如果调用此方法失败的情况下，要将其已经创建的Bean销毁。</span></span><br><span class="line"><span class="comment">     * 换句话说，调用此方法以后，要么所有的Bean都实例化好了，要么就一个都没有实例化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向JVM注册一个回调函数，用以在JVM关闭时，销毁此应用上下文。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerShutdownHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭此应用上下文，释放其所占有的所有资源和锁。并销毁其所有创建好的singleton Beans</span></span><br><span class="line"><span class="comment">     * 实现的时候，此方法不应该调用其父上下文的close方法，因为其父上下文具有自己独立的生命周期</span></span><br><span class="line"><span class="comment">     * 多次调用此方法，除了第一次，后面的调用应该被忽略。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测此上下文是否时启动状态。</span></span><br><span class="line"><span class="comment">     * 也就是说在它关闭之前该上下文至少被refresh过一次</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 参见refresh()方法</span></span><br><span class="line"><span class="comment">     * 参见close()方法</span></span><br><span class="line"><span class="comment">     * 参见getBeanFactory()方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回此应用上下文的底层存储bean的容器。</span></span><br><span class="line"><span class="comment">     * 千万不要使用此方法来对BeanFactory生成的Bean做后置处理，因为单例Bean在此之前已经生成，</span></span><br><span class="line"><span class="comment">     * 这种情况下应该使用BeanFactoryPostProcessor来在Bean生成之前对其进行处理。</span></span><br><span class="line"><span class="comment">     * 通常情况下，底层bean容器只有在上下文是激活的情况下才能使用。因此，在使用此方法前，可以调用</span></span><br><span class="line"><span class="comment">     * isActive来判断bean容器是否可用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-10、准备异常报告器"><a href="#3-10、准备异常报告器" class="headerlink" title="3.10、准备异常报告器"></a>3.10、准备异常报告器</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang"></div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line">					new Class[] { ConfigurableApplicationContext.class }, context);</span><br></pre></td></tr></tbody></table></figure></div>

<p>逻辑和之前实例化ApplicationContextInitializer和ApplicationListener的一样，一样调用的是 <code>getSpringFactoriesInstances</code> 方法来获取配置的异常类名称并实例化所有的异常处理类。</p>
<p>该异常报告处理类配置在 <code>spring-boot-2.2.1.RELEASE.jar!/META-INF/spring.factories</code> 这个配置文件里面。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Error Reporters</span></span><br><span class="line"><span class="meta">org.springframework.boot.SpringBootExceptionReporter</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">org.springframework.boot.diagnostics.FailureAnalyzers</span></span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-11、准备ApplicationContext"><a href="#3-11、准备ApplicationContext" class="headerlink" title="3.11、准备ApplicationContext"></a>3.11、准备ApplicationContext</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br></pre></td></tr></tbody></table></figure></div>

<p>来看下 <code>prepareContext()</code> 方法的源码：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, </span></span></span><br><span class="line"><span class="function"><span class="params">                                Banner printedBanner)</span> </span>{</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.11.1、将environment保存到上一步创建的ConfigurableApplicationContext中</span></span><br><span class="line">        context.setEnvironment(environment);</span><br><span class="line">        <span class="comment">// 3.11.2、ConfigurableApplicationContext创建后的后置处理逻辑</span></span><br><span class="line">        postProcessApplicationContext(context);</span><br><span class="line">        <span class="comment">// 3.11.3、回调所有ApplicationContextInitializer的实现类的initialize(ConfigurableApplicationContext context)方法</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.DelegatingApplicationContextInitializer  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.ContextIdApplicationContextInitializer 				（spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">        applyInitializers(context);</span><br><span class="line">        <span class="comment">// 3.11.4、发布ApplicationContextInitializedEvent事件</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.autoconfigure.BackgroundPreinitializer （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">        <span class="comment">// org.springframework.boot.context.config.DelegatingApplicationListener  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">        listeners.contextPrepared(context);</span><br><span class="line">        <span class="comment">// 3.11.5、是否打印启动信息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) {</span><br><span class="line">            logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">            logStartupProfileInfo(context);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">"springApplicationArguments"</span>, applicationArguments);</span><br><span class="line">        <span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) {</span><br><span class="line">            beanFactory.registerSingleton(<span class="string">"springBootBanner"</span>, printedBanner);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) {</span><br><span class="line">            <span class="comment">// 注册bean时是否允许覆盖容器中已存在该名称的bean</span></span><br><span class="line">            ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">            .setAllowBeanDefinitionOverriding(<span class="keyword">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lazyInitialization) {</span><br><span class="line">            context.addBeanFactoryPostProcessor(<span class="keyword">new</span> LazyInitializationBeanFactoryPostProcessor());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Load the sources</span></span><br><span class="line">        Set<object> sources = getAllSources();<br><span class="line">        Assert.notEmpty(sources, <span class="string">"Sources must not be empty"</span>);</span><br><span class="line">        load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">        listeners.contextLoaded(context);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略部分代码</span></span><br><span class="line">}</span><br></object></span></pre></td></tr></tbody></table></figure></div>

<p>下面具体分析每一步</p>
<h3 id="3-11-1、将ConfigurationEnvironment存到ConfigurationApplicationContext中"><a href="#3-11-1、将ConfigurationEnvironment存到ConfigurationApplicationContext中" class="headerlink" title="3.11.1、将ConfigurationEnvironment存到ConfigurationApplicationContext中"></a>3.11.1、将ConfigurationEnvironment存到ConfigurationApplicationContext中</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将environment保存到上一步创建的ConfigurableApplicationContext中</span></span><br><span class="line">context.setEnvironment(environment);</span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="3-11-2、ConfigurableApplicationContext创建后的后置处理逻辑"><a href="#3-11-2、ConfigurableApplicationContext创建后的后置处理逻辑" class="headerlink" title="3.11.2、ConfigurableApplicationContext创建后的后置处理逻辑"></a>3.11.2、ConfigurableApplicationContext创建后的后置处理逻辑</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigurableApplicationContext创建后的后置处理逻辑</span></span><br><span class="line"> postProcessApplicationContext(context);</span><br></pre></td></tr></tbody></table></figure></div>

<p>postProcessApplicationContext方法的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...省略部分代码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成bean的名称时所使用的的生成器    </span></span><br><span class="line">    <span class="keyword">private</span> BeanNameGenerator beanNameGenerator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认ApplicationConversionService应该添加到应用上下文(ApplicationContext)的Environment中</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> addConversionService = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造方法及set方法均可赋值</span></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置在创建bean时bean的名称的生成器</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanNameGenerator</span><span class="params">(BeanNameGenerator beanNameGenerator)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.beanNameGenerator = beanNameGenerator;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置ApplicationConversionService是否应该添加到应用上下文(ApplicationContext)的Environment中</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAddConversionService</span><span class="params">(<span class="keyword">boolean</span> addConversionService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.addConversionService = addConversionService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ConfigurableApplicationContext创建后的后置处理</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessApplicationContext</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">        <span class="comment">// 判断是否设置了bean名称的生成器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.beanNameGenerator != <span class="keyword">null</span>) {</span><br><span class="line">            context.getBeanFactory().registerSingleton(AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR,</span><br><span class="line">                                                       <span class="keyword">this</span>.beanNameGenerator);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 是否指定了资源加载器，默认null</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.resourceLoader != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> GenericApplicationContext) {</span><br><span class="line">                ((GenericApplicationContext) context).setResourceLoader(<span class="keyword">this</span>.resourceLoader);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> DefaultResourceLoader) {</span><br><span class="line">                ((DefaultResourceLoader) context).setClassLoader(<span class="keyword">this</span>.resourceLoader.getClassLoader());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// ApplicationConversionService是否应该添加到应用上下文(ApplicationContext)的Environment中，默认true</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.addConversionService) {</span><br><span class="line">            <span class="comment">// 将ApplicationConversionService存到ConfigurableApplicationContext的底层存储bean的容器BeanFactory中</span></span><br><span class="line">            context.getBeanFactory().setConversionService(ApplicationConversionService.getSharedInstance());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="3-11-3、回调ApplicationContextInitializer-initialize-context"><a href="#3-11-3、回调ApplicationContextInitializer-initialize-context" class="headerlink" title="3.11.3、回调ApplicationContextInitializer.initialize(context)"></a>3.11.3、回调ApplicationContextInitializer.initialize(context)</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">applyInitializers(context);</span><br></pre></td></tr></tbody></table></figure></div>
<p>applyInitializers(context)的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List<applicationcontextinitializer<?>> initializers;</applicationcontextinitializer<?></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造方法的源码细节前面分析过，参见第2节</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class<!--?-->... primarySources)</span> </span>{</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...省略代码</span></span><br><span class="line"></span><br><span class="line">        setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...省略代码</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回调所有ApplicationContextInitializer的实现类的initialize(ConfigurableApplicationContext context)方法</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">applyInitializers</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">        <span class="comment">// 遍历spring.factories中key为org.springframework.context.ApplicationContextInitializer的实现类</span></span><br><span class="line">        <span class="keyword">for</span> (ApplicationContextInitializer initializer : getInitializers()) {</span><br><span class="line">            <span class="comment">// 针对给定的目标类解析给定泛型接口的单一参数，解析的时候会假设这个目标类实现了给定的泛型接口，</span></span><br><span class="line">            <span class="comment">// 并且可能为泛型接口的类型变量定义了具体类型。</span></span><br><span class="line">            <span class="comment">// resolveTypeArgument方法会返回解析到的泛型接口的单一参数类型，如果没解析到则返回nul</span></span><br><span class="line">            Class<!--?--> requiredType = GenericTypeResolver.resolveTypeArgument(initializer.getClass(),</span><br><span class="line">                                                                            ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="comment">// 上一行和这一行的目的就是判断在spring.factories文件中key为org.springframework.context.ApplicationContextInitializer的值</span></span><br><span class="line">            <span class="comment">// 是否实现了ApplicationContextInitializer接口，并且指定了具体的泛型参数类型</span></span><br><span class="line">            Assert.isInstanceOf(requiredType, context, <span class="string">"Unable to call initializer."</span>);</span><br><span class="line">            <span class="comment">//回调ApplicationContextInitializer的initialize方法来初始化，方法传入参数为ConfigurableApplicationContext</span></span><br><span class="line">            initializer.initialize(context);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对initializers排序</span></span><br><span class="line">    <span class="keyword">public</span> Set<applicationcontextinitializer<?>> getInitializers() {</applicationcontextinitializer<?></span><br><span class="line">        <span class="keyword">return</span> asUnmodifiableOrderedSet(<span class="keyword">this</span>.initializers);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对给定的集合elements使用AnnotationAwareOrderComparator排序</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <e> <span class="function">Set<e> <span class="title">asUnmodifiableOrderedSet</span><span class="params">(Collection<e> elements)</e></span> </e></span>{</e></span><br><span class="line">        List<e> list = <span class="keyword">new</span> ArrayList<>(elements);</e></span><br><span class="line">        list.sort(AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LinkedHashSet<>(list);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>这里的getInitializers()方法返回的是当前类中的<code>initializer</code>属性，而<code>initializer</code>属性是在<code>SpringApplication</code>的构造函数中加载的所有<code>spring.factories</code>中key为<code>org.springframework.context.ApplicationContextInitializer</code>的实现类，具体的<code>ApplicationContextInitializer</code>的加载源码参见前文第2小节。</p>
<p>spring<code>org.springframework.context.ApplicationContextInitializer</code>的实现类出处如下：</p>
<ul>
<li><p><code>spring-boot-2.2.1.RELEASE.jar!\META-INF\spring.factories</code></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Application Context Initializers</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationContextInitializer</span>=<span class="string">\</span></span><br><span class="line">org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer,\</span><br><span class="line"><span class="attr">org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer</span></span><br></pre></td></tr></tbody></table></figure></div>
</li>
<li><p><code>spring-boot-autoconfigure-2.2.1.RELEASE.jar!\META-INF\spring.factories</code> 共2个</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initializers</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationContextInitializer</span>=<span class="string">\</span></span><br><span class="line">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span></span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<h3 id="3-11-4、发布ApplicationContextInitializedEvent事件"><a href="#3-11-4、发布ApplicationContextInitializedEvent事件" class="headerlink" title="3.11.4、发布ApplicationContextInitializedEvent事件"></a>3.11.4、发布ApplicationContextInitializedEvent事件</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listeners.contextPrepared(context);</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>SpringApplicationRunListeners</code>类的contextPrepared方法源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationRunListeners</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List<springapplicationrunlistener> listeners;</springapplicationrunlistener></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) {</span><br><span class="line">            listener.contextPrepared(context);</span><br><span class="line">        }</span><br><span class="line">    }   </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>SpringApplicationRunListener</code>的实现类只有<code>EventPublishingRunListener</code>，contextPrepared方法的源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventPublishingRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleApplicationEventMulticaster initialMulticaster;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.initialMulticaster</span><br><span class="line">            .multicastEvent(<span class="keyword">new</span> ApplicationContextInitializedEvent(<span class="keyword">this</span>.application, <span class="keyword">this</span>.args, context));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h3 id="3-11-5、打印启动信息"><a href="#3-11-5、打印启动信息" class="headerlink" title="3.11.5、打印启动信息"></a>3.11.5、打印启动信息</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) {</span><br><span class="line">    logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">    logStartupProfileInfo(context);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">logStartupInfo</span><span class="params">(<span class="keyword">boolean</span> isRoot)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (isRoot) {</span><br><span class="line">        <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarting(getApplicationLog());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">logStartupProfileInfo</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">    Log log = getApplicationLog();</span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) {</span><br><span class="line">        String[] activeProfiles = context.getEnvironment().getActiveProfiles();</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(activeProfiles)) {</span><br><span class="line">            String[] defaultProfiles = context.getEnvironment().getDefaultProfiles();</span><br><span class="line">            log.info(<span class="string">"No active profile set, falling back to default profiles: "</span></span><br><span class="line">                     + StringUtils.arrayToCommaDelimitedString(defaultProfiles));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            log.info(<span class="string">"The following profiles are active: "</span></span><br><span class="line">                     + StringUtils.arrayToCommaDelimitedString(activeProfiles));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Log <span class="title">getApplicationLog</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 这个mainApplicationClass在当前类的构造函数中被赋值了</span></span><br><span class="line">    <span class="comment">// 赋值代码如下：this.mainApplicationClass = deduceMainApplicationClass();</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mainApplicationClass == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> logger;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 返回apache的commons-logging的Log对象</span></span><br><span class="line">    <span class="keyword">return</span> LogFactory.getLog(<span class="keyword">this</span>.mainApplicationClass);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>




<h2 id="3-12、刷新ApplicationContext"><a href="#3-12、刷新ApplicationContext" class="headerlink" title="3.12、刷新ApplicationContext"></a>3.12、刷新ApplicationContext</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refreshContext(context);</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个主要是刷新 Spring 的应用上下文，源码如下:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">    refresh(context);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.registerShutdownHook) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            context.registerShutdownHook();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (AccessControlException ex) {</span><br><span class="line">            <span class="comment">// Not allowed in some environments.</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-13、ApplicationContext刷新后置处理"><a href="#3-13、ApplicationContext刷新后置处理" class="headerlink" title="3.13、ApplicationContext刷新后置处理"></a>3.13、ApplicationContext刷新后置处理</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afterRefresh(context, applicationArguments);</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个方法的源码是空的，目前可以做一些自定义的后置处理操作。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protected void afterRefresh(ConfigurableApplicationContext context, ApplicationArguments args) {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="3-14、停止StopWatch"><a href="#3-14、停止StopWatch" class="headerlink" title="3.14、停止StopWatch"></a>3.14、停止StopWatch</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stopWatch.stop();</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentTaskName == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't stop StopWatch: it's not running"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">long</span> lastTime = System.nanoTime() - <span class="keyword">this</span>.startTimeNanos;</span><br><span class="line">    <span class="keyword">this</span>.totalTimeNanos += lastTime;</span><br><span class="line">    <span class="keyword">this</span>.lastTaskInfo = <span class="keyword">new</span> TaskInfo(<span class="keyword">this</span>.currentTaskName, lastTime);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.keepTaskList) {</span><br><span class="line">        <span class="keyword">this</span>.taskList.add(<span class="keyword">this</span>.lastTaskInfo);</span><br><span class="line">    }</span><br><span class="line">    ++<span class="keyword">this</span>.taskCount;</span><br><span class="line">    <span class="keyword">this</span>.currentTaskName = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>计时监听器停止，并统计一些任务执行信息。</p>
<h2 id="3-15、输出日志记录执行主类名、时间信息"><a href="#3-15、输出日志记录执行主类名、时间信息" class="headerlink" title="3.15、输出日志记录执行主类名、时间信息"></a>3.15、输出日志记录执行主类名、时间信息</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) {</span><br><span class="line">    <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-16、发布ApplicationStartedEvent事件"><a href="#3-16、发布ApplicationStartedEvent事件" class="headerlink" title="3.16、发布ApplicationStartedEvent事件"></a>3.16、发布ApplicationStartedEvent事件</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listeners.started(context);</span><br></pre></td></tr></tbody></table></figure></div>

<p>触发所有 SpringApplicationRunListener 监听器的 started 事件方法。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class SpringApplicationRunListeners {</span><br><span class="line"></span><br><span class="line">	private final Log log;</span><br><span class="line"></span><br><span class="line">	private final List<springapplicationrunlistener> listeners;</springapplicationrunlistener></span><br><span class="line">	</span><br><span class="line">	...省略</span><br><span class="line">	</span><br><span class="line">    void started(ConfigurableApplicationContext context) {</span><br><span class="line">       for (SpringApplicationRunListener listener : this.listeners) {</span><br><span class="line">          listener.started(context);</span><br><span class="line">       }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>SpringApplicationRunListener</code>的实现类只有<code>EventPublishingRunListener</code>，started源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventPublishingRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> SimpleApplicationEventMulticaster initialMulticaster;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">started</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">		context.publishEvent(<span class="keyword">new</span> ApplicationStartedEvent(<span class="keyword">this</span>.application, <span class="keyword">this</span>.args, context));</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="3-17、执行所有-Runner-运行器"><a href="#3-17、执行所有-Runner-运行器" class="headerlink" title="3.17、执行所有 Runner 运行器"></a>3.17、执行所有 Runner 运行器</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callRunners(context, applicationArguments);</span><br></pre></td></tr></tbody></table></figure></div>

<p>callRunners方法源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callRunners</span><span class="params">(ApplicationContext context, ApplicationArguments args)</span> </span>{</span><br><span class="line">    List<object> runners = <span class="keyword">new</span> ArrayList<>();<br><span class="line">    runners.addAll(context.getBeansOfType(ApplicationRunner<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>())</span>;</span><br><span class="line">    runners.addAll(context.getBeansOfType(CommandLineRunner<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>())</span>;</span><br><span class="line">    AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">    <span class="keyword">for</span> (Object runner : <span class="keyword">new</span> LinkedHashSet<>(runners)) {</span><br><span class="line">        <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> ApplicationRunner) {</span><br><span class="line">            callRunner((ApplicationRunner) runner, args);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> CommandLineRunner) {</span><br><span class="line">            callRunner((CommandLineRunner) runner, args);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callRunner</span><span class="params">(ApplicationRunner runner, ApplicationArguments args)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        (runner).run(args);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to execute ApplicationRunner"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callRunner</span><span class="params">(CommandLineRunner runner, ApplicationArguments args)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        (runner).run(args.getSourceArgs());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to execute CommandLineRunner"</span>, ex);</span><br><span class="line">    }</span><br><span class="line">}</span><br></object></span></pre></td></tr></tbody></table></figure></div>

<p>执行所有 <code>ApplicationRunner</code> 和 <code>CommandLineRunner</code> 这两种运行器。</p>
<h2 id="3-18、发布ApplicationReadyEvent事件"><a href="#3-18、发布ApplicationReadyEvent事件" class="headerlink" title="3.18、发布ApplicationReadyEvent事件"></a>3.18、发布ApplicationReadyEvent事件</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try {</span><br><span class="line">   listeners.running(context);</span><br><span class="line">}</span><br><span class="line">catch (Throwable ex) {</span><br><span class="line">   handleRunFailure(context, ex, exceptionReporters, null);</span><br><span class="line">   throw new IllegalStateException(ex);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>触发所有 SpringApplicationRunListener 监听器的 running 事件方法。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationRunListeners</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List<springapplicationrunlistener> listeners;</springapplicationrunlistener></span><br><span class="line">	</span><br><span class="line">	...省略</span><br><span class="line">	</span><br><span class="line">   	<span class="function"><span class="keyword">void</span> <span class="title">running</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">		<span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) {</span><br><span class="line">			listener.running(context);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p><code>SpringApplicationRunListener</code>的实现类只有<code>EventPublishingRunListener</code>，running源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventPublishingRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SpringApplication application;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpleApplicationEventMulticaster initialMulticaster;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">running</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br><span class="line">        context.publishEvent(<span class="keyword">new</span> ApplicationReadyEvent(<span class="keyword">this</span>.application, <span class="keyword">this</span>.args, context));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>



<h2 id="3-19、返回应用上下文"><a href="#3-19、返回应用上下文" class="headerlink" title="3.19、返回应用上下文"></a>3.19、返回应用上下文</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return context;</span><br></pre></td></tr></tbody></table></figure></div></body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">calebzhao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://calebzhao.github.io/2019/12/30/Spring%20Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">https://calebzhao.github.io/2019/12/30/Spring%20Boot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://calebzhao.github.io">calebzhao的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring-boot/">spring boot    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229151714.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229152519.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/12/31/Spring%20Boot%E7%9A%84Environment%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Spring Boot的Environment源码分析</span></div></a></div><div class="next-post pull_right"><a href="/2019/12/30/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3jvm/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>深入理解jvm</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/02/Spring中的ResolvableType/" title="Spring中的ResolvableType详解."><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring中的ResolvableType详解.</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/31/Spring Boot的Environment源码分析/" title="Spring Boot的Environment源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring Boot的Environment源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring.factories自动化配置归类/" title="spring.factories自动化配置归类"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring.factories自动化配置归类</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/1、springboot2-2自动注入文件spring-factories如何加载详解/" title="1、springboot2.2自动注入文件spring.factories如何加载详解"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">1、springboot2.2自动注入文件spring.factories如何加载详解</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = '昵称,邮箱,链接'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'HgchHaGng3F6hbefP0mcTaYh-gzGzoHsz',
  appKey:'j47kWakblNYEeDic8riu7flK',
  placeholder:'请留下你的足迹',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By calebzhao</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div><img src="https://api.travis-ci.com/calebzhao/calebzhao.github.io.svg?branch=hexo"></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>