<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="never"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>spring cloud - bootstrapContext(一) | calebzhao的博客</title><meta name="description" content="spring cloud - bootstrapContext(一)"><meta name="keywords" content="spring cloud"><meta name="author" content="calebzhao"><meta name="copyright" content="calebzhao"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229155709.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="spring cloud - bootstrapContext(一)"><meta name="twitter:description" content="spring cloud - bootstrapContext(一)"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="spring cloud - bootstrapContext(一)"><meta property="og:url" content="https://calebzhao.github.io/2020/01/06/spring%20cloud%20-%20bootstrapContext(%E4%B8%80)/"><meta property="og:site_name" content="calebzhao的博客"><meta property="og:description" content="spring cloud - bootstrapContext(一)"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://calebzhao.github.io/2020/01/06/spring%20cloud%20-%20bootstrapContext(%E4%B8%80)/"><link rel="prev" title="power designer日常使用" href="https://calebzhao.github.io/2020/01/09/power%20designer%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8/"><link rel="next" title="spring入门" href="https://calebzhao.github.io/2020/01/03/spring%E5%85%A5%E9%97%A8/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"EU39VTKAPM","apiKey":"9108b7c9e302dddcc64205e00d26f470","indexName":"hexo","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://calebzhao.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">calebzhao的博客</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">5</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#1、前言"><span class="toc_mobile_items-text">1、前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#2、spring-cloud-context"><span class="toc_mobile_items-text">2、spring cloud context</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-1、RestartListener"><span class="toc_mobile_items-text">2.1、RestartListener</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-2、BootstrapApplicationListener"><span class="toc_mobile_items-text">2.2、BootstrapApplicationListener</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-3、BootstrapImportSelector"><span class="toc_mobile_items-text">2.3、BootstrapImportSelector</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-3-1、PropertySourceBootstrapConfiguration"><span class="toc_mobile_items-text">2.3.1、PropertySourceBootstrapConfiguration</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-3-2、ConfigurationPropertiesRebinderAutoConfiguration"><span class="toc_mobile_items-text">2.3.2、ConfigurationPropertiesRebinderAutoConfiguration</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2-3-3、EncryptionBootstrapConfiguration"><span class="toc_mobile_items-text">2.3.3、EncryptionBootstrapConfiguration</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#3、Bean加载问题"><span class="toc_mobile_items-text">3、Bean加载问题</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1、前言"><span class="toc-text">1、前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2、spring-cloud-context"><span class="toc-text">2、spring cloud context</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1、RestartListener"><span class="toc-text">2.1、RestartListener</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2、BootstrapApplicationListener"><span class="toc-text">2.2、BootstrapApplicationListener</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3、BootstrapImportSelector"><span class="toc-text">2.3、BootstrapImportSelector</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1、PropertySourceBootstrapConfiguration"><span class="toc-text">2.3.1、PropertySourceBootstrapConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2、ConfigurationPropertiesRebinderAutoConfiguration"><span class="toc-text">2.3.2、ConfigurationPropertiesRebinderAutoConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3、EncryptionBootstrapConfiguration"><span class="toc-text">2.3.3、EncryptionBootstrapConfiguration</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3、Bean加载问题"><span class="toc-text">3、Bean加载问题</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">spring cloud - bootstrapContext(一)</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-01-06<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-01-10</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/spring-cloud/">spring cloud</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">5.8k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 22 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2020/01/06/spring%20cloud%20-%20bootstrapContext(%E4%B8%80)/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2020/01/06/spring%20cloud%20-%20bootstrapContext(%E4%B8%80)/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="1、前言"><a href="#1、前言" class="headerlink" title="1、前言"></a>1、前言</h1><p>springcloud是基于springboot开发的，所以读者在阅读此文前最好已经了解了<a href="https://www.cnblogs.com/question-sky/p/9360722.html" target="_blank" rel="noopener">springboot的工作原理</a>。本文将不阐述springboot的工作逻辑。</p>
<p>在整个 Spring Boot 启动的生命周期过程中，有一个阶段是 prepare environment。在这个阶段，会publish 一个 <code>ApplicationEnvironmentPreparedEvent</code>，通知所有对这个事件感兴趣的 Listener,提供对 Environment 做更多的定制化的操作。Spring Cloud 定义了一个<code>BootstrapApplicationListener</code>，在 <code>BootstrapApplicationListener</code> 的处理过程中会创建spring cloud的ApplicationContext。</p>
<h1 id="2、spring-cloud-context"><a href="#2、spring-cloud-context" class="headerlink" title="2、spring cloud context"></a>2、spring cloud context</h1><p>springboot cloud context在官方的文档中在第一点被提及，是用户ApplicationContext的父级上下文，笔者称呼为<strong>BootstrapContext</strong>。根据springboot的加载机制，很多第三方以及重要的Configuration配置均是保存在了<strong>spring.factories</strong>文件中。</p>
<p>笔者翻阅了<strong>spring-cloud-context</strong>模块下的对应文件，见如下:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AutoConfiguration</span></span><br><span class="line"><span class="meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.LifecycleMvcEndpointAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.RefreshAutoConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.RefreshEndpointAutoConfiguration,\</span><br><span class="line"><span class="attr">org.springframework.cloud.autoconfigure.WritableEnvironmentEndpointAutoConfiguration</span></span><br><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="meta">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.bootstrap.BootstrapApplicationListener,\</span><br><span class="line">org.springframework.cloud.bootstrap.LoggingSystemShutdownListener,\</span><br><span class="line"><span class="attr">org.springframework.cloud.context.restart.RestartListener</span></span><br><span class="line"><span class="comment"># Bootstrap components</span></span><br><span class="line"><span class="meta">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.bootstrap.config.PropertySourceBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.bootstrap.encrypt.EncryptionBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration,\</span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>涉及的主要分三类，笔者优先分析<strong>监听器</strong>，其一般拥有更高的优先级并跟其他两块有一定的关联性。<br>除了日志监听器笔者不太关注，其余两个分步骤来分析</p>
<h2 id="2-1、RestartListener"><a href="#2-1、RestartListener" class="headerlink" title="2.1、RestartListener"></a>2.1、RestartListener</h2><p>重启监听器，应该是用于刷新上下文的，直接查看下其复写的方法</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestartListener</span> <span class="keyword">implements</span> <span class="title">SmartApplicationListener</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ConfigurableApplicationContext context;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> ApplicationPreparedEvent event;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent input)</span> </span>{</span><br><span class="line">         <span class="comment">// 判断是否是ApplicationPreparedEvent事件, 如果是先缓存context</span></span><br><span class="line">		<span class="keyword">if</span> (input <span class="keyword">instanceof</span> ApplicationPreparedEvent) {</span><br><span class="line">			<span class="keyword">this</span>.event = (ApplicationPreparedEvent) input;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.context == <span class="keyword">null</span>) {</span><br><span class="line">				<span class="keyword">this</span>.context = <span class="keyword">this</span>.event.getApplicationContext();</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">         <span class="comment">// 上下文刷新结束事件(ContextRefreshedEvent)，重新发布ApplicationPreparedEvent事件</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (input <span class="keyword">instanceof</span> ContextRefreshedEvent) {</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.context != <span class="keyword">null</span> && input.getSource().equals(<span class="keyword">this</span>.context)</span><br><span class="line">					&& <span class="keyword">this</span>.event != <span class="keyword">null</span>) {</span><br><span class="line">                  <span class="comment">// 注意这里的this.event的赋值是在前面的ApplicationPreparedEvent事件发生时赋值的</span></span><br><span class="line">				<span class="keyword">this</span>.context.publishEvent(<span class="keyword">this</span>.event);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 上下文关闭事件传播至此，则开始清空所拥有的对象</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.context != <span class="keyword">null</span> && input.getSource().equals(<span class="keyword">this</span>.context)) {</span><br><span class="line">				<span class="keyword">this</span>.context = <span class="keyword">null</span>;</span><br><span class="line">				<span class="keyword">this</span>.event = <span class="keyword">null</span>;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>上述的刷新事件经过查阅，与<strong>org.springframework.cloud.context.restart.RestartEndpoint</strong>类有关，这个就后文再分析好了</p>
<h2 id="2-2、BootstrapApplicationListener"><a href="#2-2、BootstrapApplicationListener" class="headerlink" title="2.2、BootstrapApplicationListener"></a>2.2、BootstrapApplicationListener</h2><p>按照顺序分析此监听器</p>
<p><strong>1、优先看下其类结构</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootstrapApplicationListener</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">ApplicationListener</span><<span class="title">ApplicationEnvironmentPreparedEvent</span>>, <span class="title">Ordered</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>此监听器是用于响应<strong>ApplicationEnvironmentPreparedEvent</strong>应用环境变量预初始化事件，<strong>表明BootstrapContext的加载时机在用户上下文(spring boot的ApplicationContext)之前</strong>，且其<strong>加载顺序比ConfigFileApplicationListener监听器超前</strong>，这点稍微强调下，监听器的具体执行顺序见我的另一篇文章<a href="https://calebzhao.github.io/2019/12/30/Spring%20Boot启动流程分析/#3-6-4、发布ApplicationEnvironmentPreparedEvent事件">Spring Boot启动流程分析</a>。</p>
<p><strong>2、接下来分析下其复写的方法*onApplicationEvent(ApplicationEnvironmentPreparedEvent event)</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{</span><br><span class="line">    <span class="comment">// 获取spring boot的环境变量对象</span></span><br><span class="line">    ConfigurableEnvironment environment = event.getEnvironment();</span><br><span class="line">    <span class="comment">// 读取spring.cloud.bootstrap.enabled环境属性，默认为true。可通过系统变量设置</span></span><br><span class="line">    <span class="comment">// 这行代码的意图是用于配置是否启用spring cloud</span></span><br><span class="line">    <span class="keyword">if</span> (!environment.getProperty(<span class="string">"spring.cloud.bootstrap.enabled"</span>, Boolean<span class="class">.<span class="keyword">class</span>, <span class="title">true</span>)) </span>{</span><br><span class="line">        <span class="comment">// 已经设置过spring.cloud.bootstrap.enabled属性为false，代表不启用spring cloud功能，直接返回</span></span><br><span class="line">        <span class="comment">// 那么就不会创建id为bootstrap的父ApplicationContext</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 运行到这里表示启用spring cloud</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// don't listen to events in a bootstrap context</span></span><br><span class="line">    <span class="comment">// 不监听bootstrap的发布的ApplicationEnvironmentPreparedEvent事件， 防止重复创建id为bootstrap的ApplicationContext</span></span><br><span class="line">    <span class="comment">// 这里判断environment中是否包含名称为"bootstrap"的属性源，</span></span><br><span class="line">    <span class="comment">// 注意后续的bootstrapServiceContext()方法中会为spring cloud的environment添加名称为"bootstrap"的属性源，</span></span><br><span class="line">    <span class="comment">// 所以bootstrapServiceContext()方法中为spring cloud创建的SpringApplication在调用其run()方法时发布</span></span><br><span class="line">    <span class="comment">// ApplicationEnvironmentPreparedEvent事件又会进入当前类中，但是由于该bootstrap的environment(spring cloud的)已经</span></span><br><span class="line">    <span class="comment">// 有名称为"bootstrap"的属性源，所以不会继续往后执行。</span></span><br><span class="line">    <span class="keyword">if</span> (environment.getPropertySources().contains(BOOTSTRAP_PROPERTY_SOURCE_NAME)) {</span><br><span class="line">        <span class="comment">// 说明当前是spring cloud启动过程中发布的ApplicationEnvironmentPreparedEvent事件，不能再次启动spring cloud了</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 从命令行参数、系统属性、系统环境变量解析spring.cloud.bootstrap.name的值，如果都未指定则使用默认名称bootstrap</span></span><br><span class="line">    String configName = environment.resolvePlaceholders(<span class="string">"${spring.cloud.bootstrap.name:bootstrap}"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寻找当前环境是否已存在BootstrapContext，</span></span><br><span class="line">    <span class="comment">// 这里的event.getSpringApplication().getInitializers()返回的是SpringApplication.run()方法启动时SpringApplication的构造</span></span><br><span class="line">    <span class="comment">// 方法中通过SpringFacoriesLoader获取到的ApplicationContextInitializer。</span></span><br><span class="line">    <span class="comment">// 按照顺序如下, 括号中的jar文件名代表其对应的spring.factories文件出处：</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.context.config.DelegatingApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.context.ContextIdApplicationContextInitializer  （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">//  org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener （spring-boot-autoconfigure-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="comment">// org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer （spring-boot-2.2.1.RELEASE.jar）</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationContextInitializer<!--?--> initializer : event.getSpringApplication()</span><br><span class="line">         .getInitializers()) {</span><br><span class="line">        <span class="keyword">if</span> (initializer <span class="keyword">instanceof</span> ParentContextApplicationContextInitializer) {</span><br><span class="line">            context = findBootstrapContext(</span><br><span class="line">                (ParentContextApplicationContextInitializer) initializer,</span><br><span class="line">                configName);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 如果spring cloud的BootstrapContext还没有被创建，则开始创建</span></span><br><span class="line">    <span class="keyword">if</span> (context == <span class="keyword">null</span>) {</span><br><span class="line">        context = bootstrapServiceContext(environment, event.getSpringApplication(), configName);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注册注销监听器</span></span><br><span class="line">        event.getSpringApplication()</span><br><span class="line">            .addListeners(<span class="keyword">new</span> CloseContextOnFailureApplicationListener(context));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 将spring cloud的applicationContext中的ApplicationContextInitializers添加到spring boot的Context上</span></span><br><span class="line">    apply(context, event.getSpringApplication(), environment);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意调用apply时spring cloud已经启动完成了，而当前的spring boot还处于ApplicationEnvironmentPreparedEvent事件执行阶段</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(ConfigurableApplicationContext context, SpringApplication application, ConfigurableEnvironment environment)</span> </span>{</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">    <span class="comment">// 从spring cloud的applicationContext中获取bean类型为ApplicationContextInitializer的事件监听器</span></span><br><span class="line">    <span class="comment">// spring cloud启动过程中会注册所有的@Bean注解声明的组件, </span></span><br><span class="line">    List<applicationcontextinitializer> initializers = getOrderedBeansOfType(context, ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>)</span>;</applicationcontextinitializer></span><br><span class="line">    <span class="comment">// 将spring cloud的applicationContext中的ApplicationContextInitializers添加到spring boot的Context上</span></span><br><span class="line">    application.addInitializers(initializers</span><br><span class="line">                                .toArray(<span class="keyword">new</span> ApplicationContextInitializer[initializers.size()]));</span><br><span class="line">    addBootstrapDecryptInitializer(application);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>逻辑很简单，上面的代码注释已经给出每一步详细说明，这里再梳理下：</p>
<ul>
<li><strong>spring.cloud.bootstrap.enabled</strong> 用于配置是否启用BootstrapContext，默认为true。可通过命令行参数、系统属性、系统环境变量设定</li>
<li><strong>spring.cloud.bootstrap.name</strong> 用于加载bootstrap对应配置文件的别名，默认为bootstrap，在ConfigFileApplicationListener事件中会使用该名称加载配置文件</li>
<li>BootstrapContext上的beanType为<strong>ApplicationContextInitializer</strong>类型的bean对象集合会被注册至用户的Context上</li>
</ul>
<p><strong>3、重点看下BootstrapContext的创建过程，源码比较长</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableApplicationContext <span class="title">bootstrapServiceContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ConfigurableEnvironment environment, <span class="keyword">final</span> SpringApplication application, String configName)</span> </span>{</span><br><span class="line">    <span class="comment">// 创建spring cloud 的一个空的environment</span></span><br><span class="line">    StandardEnvironment bootstrapEnvironment = <span class="keyword">new</span> StandardEnvironment();</span><br><span class="line">    <span class="comment">// 获取上面创建spring cloud 的可变属性源</span></span><br><span class="line">    MutablePropertySources bootstrapProperties = bootstrapEnvironment.getPropertySources();</span><br><span class="line">    <span class="comment">// 移除spring cloud的所有属性源，让spring cloud的environment变成一个不包含任何属性源的空environment</span></span><br><span class="line">    <span class="keyword">for</span> (PropertySource<!--?--> source : bootstrapProperties) {</span><br><span class="line">        bootstrapProperties.remove(source.getName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从spring boot的environment获取"spring.cloud.bootstrap.location"属性, 一般通过命令行参数、jvm系统属性、系统环境变量设置，默认为空</span></span><br><span class="line">    String configLocation = environment.resolvePlaceholders(<span class="string">"${spring.cloud.bootstrap.location:}"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建spring cloud的属性源的数据源，后面会把这个map加进去spring cloud的environment中</span></span><br><span class="line">    Map<string, object> bootstrapMap = <span class="keyword">new</span> HashMap<>();</string,></span><br><span class="line">    <span class="comment">// 特别注意："spring.config.name"是用于加载配置文件的名称，默认为bootstrap，</span></span><br><span class="line">    <span class="comment">// 在ConfigFileApplicationListener事件中会获取属性为"spring.config.name"的值作为配置文件的名称去加载配置文件</span></span><br><span class="line">    bootstrapMap.put(<span class="string">"spring.config.name"</span>, configName);</span><br><span class="line">    bootstrapMap.put(<span class="string">"spring.main.web-application-type"</span>, <span class="string">"none"</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(configLocation)) {</span><br><span class="line">        <span class="comment">// 特别注意："spring.config.location"是用于加载配置文件的搜索路径，默认为空，</span></span><br><span class="line">        <span class="comment">// 在ConfigFileApplicationListener事件中会获取属性为"spring.config.location"的值，从该路径下去加载配置文件</span></span><br><span class="line">        bootstrapMap.put(<span class="string">"spring.config.location"</span>, configLocation);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 为spring cloud的environment添加name为"bootstrap"的属性源，属性源中包括2个属性"spring.config.name"及"spring.config.location"</span></span><br><span class="line">    bootstrapProperties.addFirst(<span class="keyword">new</span> MapPropertySource(BOOTSTRAP_PROPERTY_SOURCE_NAME, bootstrapMap));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历spring boot的属性源</span></span><br><span class="line">    <span class="keyword">for</span> (PropertySource<!--?--> source : environment.getPropertySources()) {</span><br><span class="line">        <span class="comment">// 如果是占位符的属性源就跳过</span></span><br><span class="line">        <span class="keyword">if</span> (source <span class="keyword">instanceof</span> StubPropertySource) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 将spring boot的属性源添加到spring cloud的environment中，</span></span><br><span class="line">        <span class="comment">// 注意这里是addLast</span></span><br><span class="line">        bootstrapProperties.addLast(source);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建spring cloud自身的SpringApplication了，</span></span><br><span class="line">    <span class="comment">// SpringApplicationBuilder的构造方法会创建SpringApplication对象（又获取ApplicationContextInitializer和ApplicationListener）</span></span><br><span class="line">    SpringApplicationBuilder builder = <span class="keyword">new</span> SpringApplicationBuilder()</span><br><span class="line">        <span class="comment">// 指定激活的环境，此处activeProfiles是通过系统变量"spring.profiles.active"设置的</span></span><br><span class="line">        .profiles(environment.getActiveProfiles())</span><br><span class="line">        <span class="comment">// 关闭banner输出</span></span><br><span class="line">        .bannerMode(Mode.OFF)</span><br><span class="line">        <span class="comment">// 设置spring cloud的环境，设置后在调用run()方法时就不会再创建了</span></span><br><span class="line">        <span class="comment">// 这里可以回顾下SpringApplication.getOrCreateEnvironment()方法的实现</span></span><br><span class="line">        .environment(bootstrapEnvironment)</span><br><span class="line">        <span class="comment">// 不打印启动日志</span></span><br><span class="line">        .registerShutdownHook(<span class="keyword">false</span>).logStartupInfo(<span class="keyword">false</span>)</span><br><span class="line">        <span class="comment">// 非web</span></span><br><span class="line">        .web(WebApplicationType.NONE);</span><br><span class="line">    <span class="comment">// 返回SpringApplicationBuilder创建的SpringApplication</span></span><br><span class="line">    <span class="keyword">final</span> SpringApplication builderApplication = builder.application();</span><br><span class="line">    <span class="comment">// SpringApplication的构造方法中有this.mainApplicationClass = deduceMainApplicationClass();这行代码会获取mainApplicationClass</span></span><br><span class="line">    <span class="comment">// 所以builderApplication.getMainApplicationClass()一般不会返回为null</span></span><br><span class="line">    <span class="keyword">if</span> (builderApplication.getMainApplicationClass() == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// 不会进入这里</span></span><br><span class="line">        builder.main(application.getMainApplicationClass());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (environment.getPropertySources().contains(<span class="string">"refreshArgs"</span>)) {</span><br><span class="line">        <span class="comment">// If we are doing a context refresh, really we only want to refresh the</span></span><br><span class="line">        <span class="comment">// Environment, and there are some toxic listeners (like the</span></span><br><span class="line">        <span class="comment">// LoggingApplicationListener) that affect global static state, so we need a</span></span><br><span class="line">        <span class="comment">// way to switch those off.</span></span><br><span class="line">        builderApplication.setListeners(filterListeners(builderApplication.getListeners()));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 增加入口类BootstrapImportSelectorConfiguration</span></span><br><span class="line">    builder.sources(BootstrapImportSelectorConfiguration<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 关键代码，创建spring cloud自身的ApplicationContext，又会把spring boot的SpringApplication.run()方法的流程全部走一遍</span></span><br><span class="line">    <span class="keyword">final</span> ConfigurableApplicationContext context = builder.run();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置spring cloud的ApplicationContext的id为"bootstrap"</span></span><br><span class="line">    context.setId(<span class="string">"bootstrap"</span>);</span><br><span class="line">    <span class="comment">// 这里的addAncestorInitializer方法的第1个参数application是spring boot的SpringApplication对象</span></span><br><span class="line">    <span class="comment">// 而第2个参数context是上一行代码返回的spring cloud的ApplicationContext</span></span><br><span class="line">    <span class="comment">// 这里的意图是配置spring cloud的bootstrapContext为spring boot的Context的父上下文</span></span><br><span class="line">    addAncestorInitializer(application, context);</span><br><span class="line">    <span class="comment">// spring cloud的环境中现在有一些属性是我们不想在父ApplicationContext中看到的，所以把它移除(稍后会添加回来)</span></span><br><span class="line">    bootstrapProperties.remove(BOOTSTRAP_PROPERTY_SOURCE_NAME);</span><br><span class="line">    <span class="comment">// 合并spring cloud中name为"defaultProperties"属性源至spring boot中，注意同名属性不覆盖</span></span><br><span class="line">    mergeDefaultProperties(environment.getPropertySources(), bootstrapProperties);</span><br><span class="line">    <span class="comment">// 返回spring cloud的ApplicationContext</span></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 这个方法的目的如下：</span></span><br><span class="line"><span class="comment">* 1、如果spring cloud中有name为"springCloudDefaultProperties"的属性源，而spring boot中没有该名称的属性源，则直接把</span></span><br><span class="line"><span class="comment">*    spring cloud的name为"springCloudDefaultProperties"的属性源加到spring boot的environment的末尾。</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 2、如果spring cloud中有name为"springCloudDefaultProperties"的属性源，spring boot中也有该名称的属性源，则把spring cloud</span></span><br><span class="line"><span class="comment">*    的属性源合并到spring boot的environment中，如果在spring cloud中的属性在spring boot中不存在则追加到spring boot中，特别注意</span></span><br><span class="line"><span class="comment">*    如果spring cloud中的属性在spring boot中也存在，则不会覆盖，也就是说spring boot和spring cloud拥有相同key的属性时，spring boot的</span></span><br><span class="line"><span class="comment">*    配置文件中的属性优先级高，不会合并该属性。</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> environment 它是spring boot的environment</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> bootstrap 它是spring cloud的environment</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeDefaultProperties</span><span class="params">(MutablePropertySources environment,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    MutablePropertySources bootstrap)</span> </span>{</span><br><span class="line">    String name = DEFAULT_PROPERTIES;</span><br><span class="line">    <span class="comment">// 判断spring cloud中是否有name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">    <span class="keyword">if</span> (bootstrap.contains(name)) {</span><br><span class="line">        <span class="comment">// 获得spring cloud中name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">        PropertySource<!--?--> source = bootstrap.get(name);</span><br><span class="line">        <span class="comment">// 判断spring boot中是否有name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">        <span class="keyword">if</span> (!environment.contains(name)) {</span><br><span class="line">            <span class="comment">// 如果spring cloud中有name为"springCloudDefaultProperties"的属性源，而spring boot中没有该名称的属性源，则直接把</span></span><br><span class="line">            <span class="comment">// spring cloud的name为"springCloudDefaultProperties"的属性源加到spring boot的environment的末尾</span></span><br><span class="line">            environment.addLast(source);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// spring cloud中有name为"springCloudDefaultProperties"的属性源，spring boot中也有该名称的属性源</span></span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 获得spring boot中name为"springCloudDefaultProperties"的属性源</span></span><br><span class="line">            PropertySource<!--?--> target = environment.get(name);</span><br><span class="line">            <span class="comment">// 判断spring boot和spring cloud的name为"springCloudDefaultProperties"的属性源的类型是否是MapPropertySource类型</span></span><br><span class="line">            <span class="keyword">if</span> (target <span class="keyword">instanceof</span> MapPropertySource && target != source</span><br><span class="line">                && source <span class="keyword">instanceof</span> MapPropertySource) {</span><br><span class="line">                <span class="comment">// 获得spring boot中name为"springCloudDefaultProperties"的属性源的底层数据源</span></span><br><span class="line">                Map<string, object> targetMap = ((MapPropertySource) target).getSource();</string,></span><br><span class="line">                <span class="comment">// 获得spring cloud中name为"springCloudDefaultProperties"的属性源的底层数据源</span></span><br><span class="line">                Map<string, object> map = ((MapPropertySource) source).getSource();</string,></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 遍历spring cloud中name为"springCloudDefaultProperties"的属性源的底层数据源</span></span><br><span class="line">                <span class="keyword">for</span> (String key : map.keySet()) {</span><br><span class="line">                    <span class="comment">// 判断spring cloud中的属性在spring boot是否存在，若spring cloud中的属性在spring boot中不存在则追加到spring boot中 </span></span><br><span class="line">                    <span class="keyword">if</span> (!target.containsProperty(key)) {</span><br><span class="line">                        targetMap.put(key, map.get(key));</span><br><span class="line">                    }</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 若spring cloud中的属性在spring boot中存在则忽略，spring cloud不覆盖spring boot的同名属性</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    mergeAdditionalPropertySources(environment, bootstrap);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>此处也对上述的代码作下简单的小结：</p>
<ul>
<li><strong>spring.cloud.bootstrap.location</strong>变量用于配置bootstrapContext配置文件的加载路径，可用System设置，默认则采取默认的文件搜寻路径；与<em>spring.cloud.bootstrap.name</em>搭配使用</li>
<li>bootstrapContext对应的activeProfiles可采用<em>spring.active.profiles</em>系统变量设置，注意是System变量。当然也可以通过<strong>bootstrap.properties/bootstrap.yml</strong>配置文件设置</li>
<li>bootstrapContext的重要入口类为<strong>BootstrapImportSelectorConfiguration</strong>，此也是下文的分析重点</li>
<li>bootstrapContext的contextId为<em>bootstrap</em>。即使配置了<em>spring.application.name</em>属性也会被设置为前者，且其会被设置为<strong>用户Context的父上下文</strong></li>
<li>bootstrap.(yml | properties)上的配置会被合并至用户级别的Environment中的<strong>defaultProperties</strong>集合中，且其相同的KEY会被丢弃，不同KEY会被保留。即其有最低的属性优先级</li>
</ul>
<p>通过上述的代码均可以得知，bootstrapContext也是通过springboot常见的<code>SpringApplication</code>方式来创建的，但其肯定有特别的地方。<br>特别之处就在<strong>BootstrapImportSelectorConfiguration</strong>类，其也与上述<code>spring.factories</code>文件中<strong>org.springframework.cloud.bootstrap.BootstrapConfiguration</strong>的Key有直接的关系，我们下文重点分析。</p>
<h2 id="2-3、BootstrapImportSelector"><a href="#2-3、BootstrapImportSelector" class="headerlink" title="2.3、BootstrapImportSelector"></a>2.3、BootstrapImportSelector</h2><p>首先回顾bootstrapServiceContext()方法中的BootstrapImportSelectorConfiguration设置过程。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableApplicationContext <span class="title">bootstrapServiceContext</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="comment">// ...省略代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 增加入口类BootstrapImportSelectorConfiguration</span></span><br><span class="line">    builder.sources(BootstrapImportSelectorConfiguration<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...省略代码</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>承接前文监听器对bootstrapContext创建的引导，可以看到到其主要入口类为<code>BootstrapImportSelectorConfiguration</code>。下文将基于此类进行简单的分析。</p>
<p>其源码如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@Import</span>(BootstrapImportSelector<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">BootstrapImportSelectorConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>嗯，引入了延迟加载类<strong>BootstrapImportSelector</strong>，那就继续往下看下此会延迟加载哪些类，直接去观察其主方法。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BootstrapImportSelector</span> <span class="keyword">implements</span> <span class="title">EnvironmentAware</span>, <span class="title">DeferredImportSelector</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MetadataReaderFactory metadataReaderFactory = <span class="keyword">new</span> CachingMetadataReaderFactory();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) {</span><br><span class="line">        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="comment">// 加载classpath路径下所有spring.factories文件中以org.springframework.cloud.bootstrap.BootstrapConfiguration作为Key的所有类</span></span><br><span class="line">        List<string> names = <span class="keyword">new</span> ArrayList<>(SpringFactoriesLoader.loadFactoryNames(BootstrapConfiguration<span class="class">.<span class="keyword">class</span>, <span class="title">classLoader</span>))</span>;</string></span><br><span class="line">        <span class="comment">// 支持通过设置spring.cloud.bootstrap.sources属性来加载指定的类</span></span><br><span class="line">        names.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(</span><br><span class="line">            <span class="keyword">this</span>.environment.getProperty(<span class="string">"spring.cloud.bootstrap.sources"</span>, <span class="string">""</span>))));</span><br><span class="line"></span><br><span class="line">        List<orderedannotatedelement> elements = <span class="keyword">new</span> ArrayList<>();</orderedannotatedelement></span><br><span class="line">        <span class="comment">// 创建用于排序的OrderedAnnotatedElement</span></span><br><span class="line">        <span class="keyword">for</span> (String name : names) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                elements.add(</span><br><span class="line">                    <span class="keyword">new</span> OrderedAnnotatedElement(<span class="keyword">this</span>.metadataReaderFactory, name));</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 对以org.springframework.cloud.bootstrap.BootstrapConfiguration作为Key的所有类进行就地排序</span></span><br><span class="line">        AnnotationAwareOrderComparator.sort(elements);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到排序后的名称</span></span><br><span class="line">        String[] classNames = elements.stream().map(e -> e.name).toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> classNames;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...省略后续代码</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>上述的代码很简单，其会去加载classpath路径下所有<strong>spring.factories</strong>文件中以<strong>org.springframework.cloud.bootstrap.BootstrapConfiguration</strong>作为Key的所有类；<br>同时springcloud也支持通过设置<strong>spring.cloud.bootstrap.sources</strong>属性来加载指定类。</p>
<p>下面就先以springcloud context板块内的<strong>spring.factories</strong>作为分析的源头</p>
<ul>
<li><p><code>spring-cloud-context-2.2.0.RELEASE.jar!\META-INF\spring.factories</code> 共4个</p>
  <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Bootstrap components</span></span><br><span class="line"><span class="meta">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line">org.springframework.cloud.bootstrap.config.PropertySourceBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.bootstrap.encrypt.EncryptionBootstrapConfiguration,\</span><br><span class="line">org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration,\</span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration</span></span><br></pre></td></tr></tbody></table></figure></div>



</li>
</ul>
<ul>
<li><p><code>spring-cloud-netflix-eureka-client-2.2.0.RELEASE.jar!\META-INF\spring.factories</code>共1个</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">properties</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="attr">org.springframework.cloud.netflix.eureka.config.EurekaDiscoveryClientConfigServiceBootstrapConfiguration</span></span><br></pre></td></tr></tbody></table></figure></div>

</li>
</ul>
<p>在分析上述的源码之前，笔者必须得清楚<strong>现在bootstrapContext加载的配置文件默认为bootstrap.properties抑或是bootstrap.yml，其属性已经被加入至相应的Environment对象中</strong>。基于此我们再往下走，以免犯糊涂。</p>
<h3 id="2-3-1、PropertySourceBootstrapConfiguration"><a href="#2-3-1、PropertySourceBootstrapConfiguration" class="headerlink" title="2.3.1、PropertySourceBootstrapConfiguration"></a>2.3.1、PropertySourceBootstrapConfiguration</h3><p><strong>配置源的加载</strong>，此Configuration主要用于确定是否外部加载的配置属性复写Spring内含的环境变量。注意其是<strong>ApplicationContextInitializer</strong>接口的实现类，<strong>前文已经提到，bootstrapContext上的此接口的bean类都会被注册至子级的SpringApplication对象上</strong>。<br>直接看下主要的代码片段吧</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* spring cloud通过 PropertySourceLocator 加载外部环境属性源</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(PropertySourceBootstrapProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">PropertySourceBootstrapConfiguration</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">    <span class="title">ApplicationContextInitializer</span><<span class="title">ConfigurableApplicationContext</span>>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BOOTSTRAP_PROPERTY_SOURCE_NAME常量的值为"bootstrapProperties"</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOTSTRAP_PROPERTY_SOURCE_NAME = BootstrapApplicationListener.BOOTSTRAP_PROPERTY_SOURCE_NAME + <span class="string">"Properties"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.HIGHEST_PRECEDENCE + <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意这里注入了PropertySourceLocator</span></span><br><span class="line">    <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> List<propertysourcelocator> propertySourceLocators = <span class="keyword">new</span> ArrayList<>();</propertysourcelocator></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertySourceLocators</span><span class="params">(Collection<propertysourcelocator> propertySourceLocators)</propertysourcelocator></span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.propertySourceLocators = <span class="keyword">new</span> ArrayList<>(propertySourceLocators);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> </span>{</span><br><span class="line">        <span class="comment">// 创建1个具有复合功能的属性源</span></span><br><span class="line">        CompositePropertySource composite = <span class="keyword">new</span> OriginTrackedCompositePropertySource(BOOTSTRAP_PROPERTY_SOURCE_NAME);</span><br><span class="line">        <span class="comment">// 对propertySourceLocators排序</span></span><br><span class="line">        AnnotationAwareOrderComparator.sort(<span class="keyword">this</span>.propertySourceLocators);</span><br><span class="line">        <span class="comment">// 一个flag, 标识是否加载到外部属性源</span></span><br><span class="line">        <span class="keyword">boolean</span> empty = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// 此处为子级的环境变量对象</span></span><br><span class="line">        ConfigurableEnvironment environment = applicationContext.getEnvironment();</span><br><span class="line">        </span><br><span class="line">         <span class="comment">// 通过PropertySourceLocator接口去加载外部配置</span></span><br><span class="line">        <span class="keyword">for</span> (PropertySourceLocator locator : <span class="keyword">this</span>.propertySourceLocators) {</span><br><span class="line">            PropertySource<!--?--> source = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 重点：加载外部配置， spring cloud config、nacos的集合就是通过PropertySourceLocator来实现的</span></span><br><span class="line">            source = locator.locate(environment);</span><br><span class="line">            <span class="keyword">if</span> (source == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            logger.info(<span class="string">"Located property source: "</span> + source);</span><br><span class="line">            <span class="comment">// 把从外部环境加载到的属性源加到前面定义的复合属性源中</span></span><br><span class="line">            composite.addPropertySource(source);</span><br><span class="line">            empty = <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 判断是否从外部环境加载到任何1个属性源</span></span><br><span class="line">        <span class="keyword">if</span> (!empty) {</span><br><span class="line">            <span class="comment">// 获取spring boot的可变属性源</span></span><br><span class="line">            MutablePropertySources propertySources = environment.getPropertySources();</span><br><span class="line">            String logConfig = environment.resolvePlaceholders(<span class="string">"${logging.config:}"</span>);</span><br><span class="line">            LogFile logFile = LogFile.get(environment);</span><br><span class="line">            <span class="comment">// 判断spring boot的environment中是否存在name为"bootstrapProperties"的属性源</span></span><br><span class="line">            <span class="keyword">if</span> (propertySources.contains(BOOTSTRAP_PROPERTY_SOURCE_NAME)) {</span><br><span class="line">                <span class="comment">// 移除spring boot的environment中name为"bootstrapProperties"的属性源</span></span><br><span class="line">                propertySources.remove(BOOTSTRAP_PROPERTY_SOURCE_NAME);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 确定属性读取的先后顺序</span></span><br><span class="line">            insertPropertySources(propertySources, composite);</span><br><span class="line">            <span class="comment">// 日志相关，不管</span></span><br><span class="line">            reinitializeLoggingSystem(environment, logConfig, logFile);</span><br><span class="line">            <span class="comment">// 设置日志级别，不管</span></span><br><span class="line">            setLogLevels(applicationContext, environment);</span><br><span class="line">            handleIncludedProfiles(environment);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 将远程属性源以适合的顺序插入到本地environment中：</span></span><br><span class="line"><span class="comment">    * 插入前要确定远程属性源与本地属性源的优先级哪个高(属性读取的先后顺序)，也就是通过key获取value时先读取谁的配置。</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 这里的相关代码与spring.cloud.config.allowOverride、spring.cloud.config.overrideNone、spring.cloud.config.overrideSystemProperties配置相关</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> propertySources 它是spring boot的可变属性源</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@parm</span> composite 复合属性源，里面的属性源是spring cloud从外部环境加载到的</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertPropertySources</span><span class="params">(MutablePropertySources propertySources,</span></span></span><br><span class="line"><span class="function"><span class="params">			CompositePropertySource composite)</span> </span>{</span><br><span class="line">         <span class="comment">// 将从外部环境加载的属性源添加到新创建的可变属性源中</span></span><br><span class="line">		MutablePropertySources incoming = <span class="keyword">new</span> MutablePropertySources();</span><br><span class="line">		incoming.addFirst(composite);</span><br><span class="line">        </span><br><span class="line">         <span class="comment">// 从外部环境加载的属性源中获取key为"spring.cloud.config"的值，并将其值封装到PropertySourceBootstrapProperties类中</span></span><br><span class="line">		PropertySourceBootstrapProperties remoteProperties = <span class="keyword">new</span> PropertySourceBootstrapProperties();</span><br><span class="line">		Binder.get(environment(incoming)).bind(<span class="string">"spring.cloud.config"</span>, Bindable.ofInstance(remoteProperties));</span><br><span class="line">         <span class="comment">// 关键代码了， 如果配置影响了远程配置与本地配置的优先级：</span></span><br><span class="line">         <span class="comment">// spring.cloud.config.allowOverride=true</span></span><br><span class="line">         <span class="comment">// spring.cloud.config.overrideNone=true</span></span><br><span class="line">         <span class="comment">// spring.cloud.config.overrideSystemProperties=false</span></span><br><span class="line">        </span><br><span class="line">         <span class="comment">// remoteProperties.isAllowOverride() </span></span><br><span class="line">         <span class="comment">// 1、远程配置是否允许被本地配置覆盖（是否允许允许本地属性配置覆盖远程属性配置）</span></span><br><span class="line">        </span><br><span class="line">         <span class="comment">//  remoteProperties.isOverrideNone()</span></span><br><span class="line">         <span class="comment">// 2、远程配置允许被本地配置覆盖的情况下，判断远程属性的任意配置是否都允许被本地配置覆盖</span></span><br><span class="line">        </span><br><span class="line">         <span class="comment">// remoteProperties.isOverrideSystemProperties()</span></span><br><span class="line">         <span class="comment">// 3、远程配置允许被本地配置覆盖的情况下，远程属性不能被本地配置任意覆盖， 再判断远程配置是否可以覆盖本地系统环境变量</span></span><br><span class="line">		<span class="keyword">if</span> (! remoteProperties.isAllowOverride() </span><br><span class="line">            	||  (!remoteProperties.isOverrideNone() && remoteProperties.isOverrideSystemProperties())) {</span><br><span class="line">            </span><br><span class="line">			propertySources.addFirst(composite);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		}</span><br><span class="line">         <span class="comment">// 判断远程属性的任意配置是否都允许被本地配置覆盖</span></span><br><span class="line">		<span class="keyword">if</span> (remoteProperties.isOverrideNone()) {</span><br><span class="line">             <span class="comment">// 运行到这里说明：远程属性的任意配置都允许被本地配置覆盖， 也就是说远程配置的优先级低于本地配置，</span></span><br><span class="line">             <span class="comment">// 那么把远程配置添加到environment的最后(属性源的位置越靠前代表其优先级越高，越靠后则优先级越低)</span></span><br><span class="line">			propertySources.addLast(composite);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		}</span><br><span class="line">        </span><br><span class="line">         <span class="comment">// 本地环境是否包含系统环境变量属性源， SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME常量的值为"systemEnvironment"</span></span><br><span class="line">		<span class="keyword">if</span> (propertySources</span><br><span class="line">				.contains(StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME)) {</span><br><span class="line">             <span class="comment">// 远程配置是否可以覆盖本地系统环境变量配置</span></span><br><span class="line">			<span class="keyword">if</span> (!remoteProperties.isOverrideSystemProperties()) {</span><br><span class="line">                  <span class="comment">// 远程配置不能覆盖本地系统环境变量配置，也就是说本地系统环境变量的优先级高于远程配置，</span></span><br><span class="line">                  <span class="comment">// 那么把远程属性源添加在本地系统环境变量属性源的后面</span></span><br><span class="line">				propertySources.addAfter(</span><br><span class="line">						StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME,</span><br><span class="line">						composite);</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span> {</span><br><span class="line">                 <span class="comment">// 运行到这里表示远程配置可以覆盖本地系统环境变量，也就是说远程配置的优先级高于本地系统环境变量，</span></span><br><span class="line">                 <span class="comment">// 那么把远程属性源添加到本地系统环境变量属性源的前面</span></span><br><span class="line">				propertySources.addBefore(</span><br><span class="line">						StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME,</span><br><span class="line">						composite);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> {</span><br><span class="line">			propertySources.addLast(composite);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>上述的代码就涉及两点：</p>
<ul>
<li>一个是通过<em>PropertySourceLocator</em>接口加载外部配置</li>
<li>一个是用于解析以<strong>spring.cloud.config</strong>为开头的<strong>PropertySourceBootstrapProperties</strong>属性，默认情况下，外部配置比内部变量有更高的优先级。</li>
</ul>
<h3 id="2-3-2、ConfigurationPropertiesRebinderAutoConfiguration"><a href="#2-3-2、ConfigurationPropertiesRebinderAutoConfiguration" class="headerlink" title="2.3.2、ConfigurationPropertiesRebinderAutoConfiguration"></a>2.3.2、ConfigurationPropertiesRebinderAutoConfiguration</h3><p>通过命名便会发现其跟刷新属性的功能有关，先看下其类结构：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>(proxyBeanMethods = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(ConfigurationPropertiesBindingPostProcessor<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ConfigurationPropertiesRebinderAutoConfiguration</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">SmartInitializingSingleton</span> </span>{</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p> 上述代码表示其依据于当前类环境存在<em>ConfigurationPropertiesBindingPostProcessor</em>Bean这个bean才会被应用，仔细查阅了下，发现只要有使用到<strong>@EnableConfigurationProperties</strong>注解即就会被注册。看来此配置跟<em>ConfigurationProperties</em>注解也有一定的关联性。</p>
<p>下面看看ConfigurationPropertiesBindingPostProcessor的源码：</p>
<ul>
<li><p>ConfigurationPropertiesBindingPostProcessor</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationPropertiesBindingPostProcessor</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">BeanPostProcessor</span>, <span class="title">PriorityOrdered</span>, <span class="title">ApplicationContextAware</span>, <span class="title">InitializingBean</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...省略代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 实现了InitializingBean接口， 在bean的属性初始化后会调用该方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">		<span class="keyword">this</span>.registry = (BeanDefinitionRegistry) <span class="keyword">this</span>.applicationContext.getAutowireCapableBeanFactory();</span><br><span class="line">		<span class="keyword">this</span>.binder = ConfigurationPropertiesBinder.get(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">	}</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 实现了BeanPostProcessor</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">		bind(ConfigurationPropertiesBean.get(<span class="keyword">this</span>.applicationContext, bean, beanName));</span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ConfigurationPropertiesBean bean)</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (bean == <span class="keyword">null</span> || hasBoundValueObject(bean.getName())) {</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		}</span><br><span class="line">		Assert.state(bean.getBindMethod() == BindMethod.JAVA_BEAN, <span class="string">"Cannot bind @ConfigurationProperties for bean '"</span></span><br><span class="line">				+ bean.getName() + <span class="string">"'. Ensure that @ConstructorBinding has not been applied to regular bean"</span>);</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			<span class="keyword">this</span>.binder.bind(bean);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationPropertiesBindException(bean, ex);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>本文就罗列笔者比较关注的几个地方</p>
<p>1.ConfigurationPropertiesRebinder对象的创建</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(search = SearchStrategy.CURRENT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ConfigurationPropertiesRebinder <span class="title">configurationPropertiesRebinder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ConfigurationPropertiesBeans beans)</span> </span>{</span><br><span class="line">    ConfigurationPropertiesRebinder rebinder = <span class="keyword">new</span> ConfigurationPropertiesRebinder(</span><br><span class="line">        beans);</span><br><span class="line">    <span class="keyword">return</span> rebinder;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>此类读者可以自行翻阅代码，可以发现其暴露了JMX接口以及监听了springcloud context自定义的<em>EnvironmentChangeEvent</em>事件。看来其主要用来刷新ApplicationContext上的beans(<strong>含@ConfigurationProperties注解</strong>)对象集合</p>
<p>2.ConfigurationPropertiesBeans对象的创建</p>
<p>BeanPostProcessor将PropertySources绑定到使用@ConfigurationProperties注释的bean。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(search = SearchStrategy.CURRENT)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ConfigurationPropertiesBeans <span class="title">configurationPropertiesBeans</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationPropertiesBeans();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>配合@ConfigurationProperties注解，其会缓存ApplicationContext上的所有含有<em>ConfigurationProperties</em>注解的bean。与第一点所提的<strong>ConfigurationPropertiesRebinder</strong>对象搭配使用</p>
</li>
</ul>
<p>  3.实例化结束后刷新父级ApplicationContext上的属性</p>
  <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// After all beans are initialized explicitly rebind beans from the parent</span></span><br><span class="line">    <span class="comment">// so that changes during the initialization of the current context are</span></span><br><span class="line">    <span class="comment">// reflected. In particular this can be important when low level services like</span></span><br><span class="line">    <span class="comment">// decryption are bootstrapped in the parent, but need to change their</span></span><br><span class="line">    <span class="comment">// configuration before the child context is processed.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.context.getParent() != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> make this optional? (E.g. when creating child contexts that prefer to</span></span><br><span class="line">        <span class="comment">// be isolated.)</span></span><br><span class="line">        ConfigurationPropertiesRebinder rebinder = <span class="keyword">this</span>.context</span><br><span class="line">            .getBean(ConfigurationPropertiesRebinder<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">for</span> (String name : <span class="keyword">this</span>.context.getParent().getBeanDefinitionNames()) {</span><br><span class="line">            rebinder.rebind(name);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="2-3-3、EncryptionBootstrapConfiguration"><a href="#2-3-3、EncryptionBootstrapConfiguration" class="headerlink" title="2.3.3、EncryptionBootstrapConfiguration"></a>2.3.3、EncryptionBootstrapConfiguration</h3><p>与属性读取的加解密有关，跟JDK的keystore也有一定的关联，具体就不去解析了。读者可自行分析</p>
<h1 id="3、Bean加载问题"><a href="#3、Bean加载问题" class="headerlink" title="3、Bean加载问题"></a>3、Bean加载问题</h1><p>此处本文插入这个Bean的加载问题，因为笔者发现SpringApplication会被调用两次，那么ApplicationContext实例也会被创建两次。那么基于<em>@Configuration</em>修饰过的自定义的Bean是不是也会被加载两次呢？？</p>
<p>经过在cloud环境下编写了一个简单的Bean</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.clouddemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> nanco</span></span><br><span class="line"><span class="comment"> * -------------</span></span><br><span class="line"><span class="comment"> * -------------</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 19/8/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestApplication</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>{</span><br><span class="line">        System.out.println(<span class="string">"application parent context id: "</span> + applicationContext.getParent().getId());</span><br><span class="line">        System.out.println(<span class="string">"application context id: "</span> + applicationContext.getId());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

<p>且在application.properties文件中指定<em>spring.application.name=springChild<em>以及bootstrap.properties文件中也指定</em>spring.application.name=springBootstrap</em></p>
<p>运行main方法之后打印的关键信息如下:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application parent context id: bootstrap</span><br><span class="line">application context id: springBootstrap-1</span><br></pre></td></tr></tbody></table></figure></div>

<p>经过在<em>org.springframework.boot.context.ContextIdApplicationContextInitializer</em>类上进行断点调试发现<strong>只有用户级ApplicationContext被创建的过程中会实例化用户自定义Bean</strong>。也就是说<strong>bootstrapContext并不会去实例化用户自定义的Bean</strong>，这样就很安全。</p>
<p><strong>那么为何如此呢???</strong></p>
<p>其实很简单，<strong>因为bootstrapContext指定的source类只有BootstrapImportSelectorConfiguration，并没有用户编写的启动类，也就无法影响用户级别Context的Bean加载实例化了，并且该类上无@EnableAutoConfiguration、@ComponentScan注解，表明其也不会去扫描我们自己的包以及处理spring.factories文件中@EnableAutoConfiguration注解key对应的配置集合</strong>， 而用户自己编写的启动类上都会有@SpringBootApplication注解，该注解是一个复合注解，里面会引入了@EnableAutoConfiguration、@ComponentScan、@SpringBootConfiguration，它会扫描我们自己的包以及处理spring.factories文件中@EnableAutoConfiguration注解key对应的配置集合。</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">calebzhao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://calebzhao.github.io/2020/01/06/spring%20cloud%20-%20bootstrapContext(%E4%B8%80)/">https://calebzhao.github.io/2020/01/06/spring%20cloud%20-%20bootstrapContext(%E4%B8%80)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://calebzhao.github.io">calebzhao的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring-cloud/">spring cloud    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229151714.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="https://cdn.jsdelivr.net/gh/calebzhao/cdn/img/20191229152519.jpg" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/01/09/power%20designer%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>power designer日常使用</span></div></a></div><div class="next-post pull_right"><a href="/2020/01/03/spring%E5%85%A5%E9%97%A8/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>spring入门</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/02/Spring中的ResolvableType/" title="Spring中的ResolvableType详解."><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring中的ResolvableType详解.</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring.factories自动化配置归类/" title="spring.factories自动化配置归类"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring.factories自动化配置归类</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/2、spring-cloud-ribbon源码分析/" title="2、spring cloud ribbon源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">2、spring cloud ribbon源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/spring-cloud-commons-源码分析/" title="spring-cloud-commons 源码分析"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">spring-cloud-commons 源码分析</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/Spring Cloud Context总览/" title="Spring Cloud Context总览"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">Spring Cloud Context总览</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/29/Spring Cloud Discovery 源码分析（Eureka）/" title="3、Spring Cloud Discovery 源码分析（Eureka）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-10</div><div class="relatedPosts_title">3、Spring Cloud Discovery 源码分析（Eureka）</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = '昵称,邮箱,链接'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'HgchHaGng3F6hbefP0mcTaYh-gzGzoHsz',
  appKey:'j47kWakblNYEeDic8riu7flK',
  placeholder:'请留下你的足迹',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By calebzhao</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div><img src="https://api.travis-ci.com/calebzhao/calebzhao.github.io.svg?branch=hexo"></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>